<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Generatore Mappe Mentali - MentoreStudio</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #4caf50;
            --danger: #f44336;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
        }
        
        .import-section {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed var(--primary);
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.success {
            background: var(--success);
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .template-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .template-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .template-title {
            font-weight: bold;
            color: #333;
        }
        
        #diagramContainer {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 30px;
            min-height: 600px;
            overflow-x: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .mermaid {
            max-width: 100%;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 60px;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .style-btn {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .style-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .style-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f0f0f0;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tips {
            background: #e8f4f8;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        .file-preview {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .file-content {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .material-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .material-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .material-item:hover {
            background: #f0f8ff;
        }
        
        .material-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† Generatore di Mappe Mentali</h1>
        <p class="subtitle">Crea mappe mentali visuali e interattive per qualsiasi argomento</p>
        
        <!-- Sezione Importa da File -->
        <div class="import-section">
            <h2 style="color: var(--primary); margin-bottom: 15px;">üìÅ Importa da File Esistente</h2>
            
            <div class="button-group">
                <button onclick="importFromMaterial()">
                    <span>üìö</span>
                    <span>Importa dal Materiale</span>
                </button>
                <button onclick="openFilePicker()">
                    <span>üìÑ</span>
                    <span>Carica File (PDF/DOCX/PPTX)</span>
                </button>
                <button onclick="openImageOCR()">
                    <span>üñºÔ∏è</span>
                    <span>OCR da Immagine</span>
                </button>
            </div>
            
            <div id="filePreview" class="file-preview">
                <h4>Anteprima Contenuto:</h4>
                <div id="fileContent" class="file-content"></div>
                <button onclick="generateFromFile()" class="success" style="margin-top: 10px;">
                    üß† Genera Mappa da questo Contenuto
                </button>
            </div>
        </div>
        
        <div class="input-section">
            <h2 style="color: var(--primary); margin-bottom: 20px;">üìù Crea la tua Mappa Mentale</h2>
            
            <div class="input-group">
                <label for="topicInput">Argomento Centrale</label>
                <input type="text" id="topicInput" placeholder="Es: Centralino Virtuale in Cloud, Marketing Digitale, Biologia Cellulare...">
            </div>
            
            <div class="input-group">
                <label for="detailsInput">Dettagli e Rami (opzionale)</label>
                <textarea id="detailsInput" placeholder="Inserisci i concetti principali, sottoconcetti e dettagli che vuoi includere nella mappa. Separa i concetti con virgole o vai a capo per ogni idea..."></textarea>
            </div>
            
            <div class="input-group">
                <label for="styleSelect">Tipo di Visualizzazione</label>
                <select id="styleSelect">
                    <option value="mindmap">üß† Mappa Mentale (Radiale)</option>
                    <option value="flowchart">üìä Diagramma di Flusso (Gerarchico)</option>
                    <option value="graph">üîó Grafo con Collegamenti (Network)</option>
                </select>
            </div>
            
            <div class="button-group">
                <button onclick="generateMindmap()" id="generateBtn">
                    <span>ü§ñ</span>
                    <span>Genera Mappa con AI</span>
                </button>
                <button onclick="clearAll()" class="secondary">
                    <span>üóëÔ∏è</span>
                    <span>Pulisci Tutto</span>
                </button>
                <button onclick="goBackToMaterial()" class="secondary">
                    <span>‚Üê</span>
                    <span>Torna al Materiale</span>
                </button>
            </div>
            
            <div class="template-section" style="margin-top: 30px;">
                <h3 style="color: var(--primary); margin-bottom: 15px;">üéØ Template Rapidi</h3>
                <div class="template-grid">
                    <div class="template-card" onclick="loadTemplate('business')">
                        <div class="template-icon">üíº</div>
                        <div class="template-title">Business Plan</div>
                    </div>
                    <div class="template-card" onclick="loadTemplate('project')">
                        <div class="template-icon">üìã</div>
                        <div class="template-title">Gestione Progetto</div>
                    </div>
                    <div class="template-card" onclick="loadTemplate('study')">
                        <div class="template-icon">üìö</div>
                        <div class="template-title">Piano di Studio</div>
                    </div>
                    <div class="template-card" onclick="loadTemplate('brainstorm')">
                        <div class="template-icon">üí°</div>
                        <div class="template-title">Brainstorming</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="resultSection" style="display: none;">
            <div class="controls">
                <button class="style-btn active" onclick="changeView('mindmap')">üß† Vista Mappa</button>
                <button class="style-btn" onclick="changeView('flowchart')">üìä Vista Flusso</button>
                <button class="style-btn" onclick="changeView('graph')">üîó Vista Grafo</button>
            </div>
            
            <div id="diagramContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üß†</div>
                    <p>La tua mappa mentale apparir√† qui</p>
                </div>
            </div>
            
            <div class="button-group">
                <button onclick="downloadImage()" class="success">
                    <span>üì•</span>
                    <span>Scarica Immagine</span>
                </button>
                <button onclick="copyCode()">
                    <span>üìã</span>
                    <span>Copia Codice</span>
                </button>
                <button onclick="editMindmap()">
                    <span>‚úèÔ∏è</span>
                    <span>Modifica Mappa</span>
                </button>
                <button onclick="saveMindmap()">
                    <span>üíæ</span>
                    <span>Salva in MentoreStudio</span>
                </button>
            </div>
        </div>
        
        <div class="tips">
            <h3>üí° Suggerimenti</h3>
            <ul>
                <li>Importa contenuti da file PDF, DOCX, PPTX o immagini con OCR</li>
                <li>Usa i template per iniziare velocemente</li>
                <li>Puoi modificare la mappa dopo la generazione</li>
                <li>Le mappe vengono salvate nel sistema MentoreStudio</li>
                <li>Esporta come immagine PNG per condividere</li>
            </ul>
        </div>
    </div>

    <script>
        // Inizializzazione Mermaid
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                rankSpacing: 50
            },
            mindmap: {
                useMaxWidth: true,
                padding: 20
            }
        });

        // Variabili globali
        let currentMindmapCode = '';
        let currentFlowchartCode = '';
        let currentGraphCode = '';
        let currentView = 'mindmap';

        // Template predefiniti
        const templates = {
            business: {
                topic: "Business Plan",
                details: "Analisi di mercato, Target clienti, Proposta di valore, Modello di revenue, Strategia di marketing, Piano operativo, Team e organizzazione, Proiezioni finanziarie, Rischi e opportunit√†"
            },
            project: {
                topic: "Gestione Progetto",
                details: "Obiettivi del progetto, Scope e deliverables, Timeline e milestones, Budget e risorse, Team e responsabilit√†, Risk management, Comunicazione stakeholder, Metriche di successo"
            },
            study: {
                topic: "Piano di Studio",
                details: "Obiettivi di apprendimento, Materie principali, Risorse didattiche, Calendario esami, Tecniche di memorizzazione, Sessioni di ripasso, Esercitazioni pratiche, Valutazione progressi"
            },
            brainstorm: {
                topic: "Sessione Brainstorming",
                details: "Problema da risolvere, Idee principali, Soluzioni proposte, Pro e contro, Fattibilit√†, Risorse necessarie, Next steps, Responsabili azioni"
            }
        };

        // ========== FUNZIONI IMPORT FILE ==========

        // Importa dal materiale esistente di MentoreStudio
        async function importFromMaterial() {
            try {
                const materials = await getSavedMaterials();
                
                if (materials.length === 0) {
                    alert('üìö Nessun materiale trovato in MentoreStudio!');
                    return;
                }
                
                // Mostra lista materiali
                const materialList = materials.map((m, index) => `
                    <div class="material-item" onclick="selectMaterial(${index})">
                        <strong>${m.title}</strong><br>
                        <small>Tipo: ${m.type} - ${new Date(m.createdAt).toLocaleDateString()}</small>
                    </div>
                `).join('');
                
                const selected = confirm(`Trovati ${materials.length} materiali. Vuoi selezionarne uno?`);
                if (selected) {
                    const index = prompt(`Inserisci il numero (1-${materials.length}):`);
                    if (index !== null) {
                        const materialIndex = parseInt(index) - 1;
                        if (materialIndex >= 0 && materialIndex < materials.length) {
                            selectMaterial(materialIndex);
                        }
                    }
                }
                
            } catch (error) {
                console.error('Errore importazione:', error);
                alert('‚ùå Errore nel caricamento del materiale');
            }
        }

        function selectMaterial(index) {
            getSavedMaterials().then(materials => {
                if (materials[index]) {
                    const material = materials[index];
                    document.getElementById('topicInput').value = material.title;
                    document.getElementById('detailsInput').value = material.content || '';
                    alert(`‚úÖ Importato: ${material.title}`);
                }
            });
        }

        // Carica file locale (PDF/DOCX/PPTX)
        function openFilePicker() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.docx,.pptx,.txt,.md';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await processUploadedFile(file);
                }
            };
            
            input.click();
        }

        // Elabora file caricato
        async function processUploadedFile(file) {
            try {
                document.getElementById('filePreview').style.display = 'block';
                document.getElementById('fileContent').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Elaborazione di "${file.name}"...</p>
                    </div>
                `;
                
                const content = await simulateFileProcessing(file);
                
                document.getElementById('fileContent').innerHTML = `
                    <p><strong>File:</strong> ${file.name}</p>
                    <p><strong>Dimensione:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                    <div style="max-height: 150px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <pre style="white-space: pre-wrap; font-size: 11px;">${content.substring(0, 800)}${content.length > 800 ? '...' : ''}</pre>
                    </div>
                `;
                
                document.getElementById('topicInput').value = file.name.replace(/\.[^/.]+$/, "");
                document.getElementById('detailsInput').value = content.substring(0, 2000);
                
            } catch (error) {
                console.error('Errore elaborazione file:', error);
                document.getElementById('fileContent').innerHTML = '<p style="color: red;">‚ùå Errore nell\'elaborazione del file</p>';
            }
        }

        // Simula OCR da immagine
        function openImageOCR() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await processImageOCR(file);
                }
            };
            
            input.click();
        }

        // Elabora OCR immagine
        async function processImageOCR(file) {
            try {
                document.getElementById('filePreview').style.display = 'block';
                document.getElementById('fileContent').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>OCR di "${file.name}" in corso...</p>
                    </div>
                `;
                
                const ocrResult = await simulateOCR(file);
                
                document.getElementById('fileContent').innerHTML = `
                    <p><strong>Immagine:</strong> ${file.name}</p>
                    <img src="${URL.createObjectURL(file)}" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 5px;">
                    <div style="max-height: 150px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <pre style="white-space: pre-wrap; font-size: 11px;">${ocrResult}</pre>
                    </div>
                `;
                
                document.getElementById('topicInput').value = `OCR - ${file.name.replace(/\.[^/.]+$/, "")}`;
                document.getElementById('detailsInput').value = ocrResult;
                
            } catch (error) {
                console.error('Errore OCR:', error);
                document.getElementById('fileContent').innerHTML = '<p style="color: red;">‚ùå Errore nell\'OCR</p>';
            }
        }

        // Genera mappa dal contenuto del file
        function generateFromFile() {
            generateMindmap();
        }

        // ========== FUNZIONI CORE ==========

        // Carica un template
        function loadTemplate(templateName) {
            const template = templates[templateName];
            if (template) {
                document.getElementById('topicInput').value = template.topic;
                document.getElementById('detailsInput').value = template.details;
            }
        }

        // Genera la mappa mentale
        async function generateMindmap() {
            const topic = document.getElementById('topicInput').value.trim();
            const details = document.getElementById('detailsInput').value.trim();
            const style = document.getElementById('styleSelect').value;
            
            if (!topic) {
                alert('‚ö†Ô∏è Inserisci almeno un argomento centrale!');
                return;
            }
            
            const container = document.getElementById('diagramContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>ü§ñ Generazione in corso...</h3>
                    <p>Sto creando la mappa mentale per "${topic}"</p>
                </div>
            `;
            
            document.getElementById('resultSection').style.display = 'block';
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1500));
                generateCodes(topic, details);
                changeView(style);
                
            } catch (error) {
                console.error('Errore:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Errore nella generazione. Riprova.</p>
                    </div>
                `;
            }
        }

        // Genera i codici Mermaid
        function generateCodes(topic, details) {
            let branches = [];
            
            if (details && details.length > 500) {
                branches = extractMainConcepts(details);
            } else {
                branches = details ? details.split(/[,\n]+/).map(d => d.trim()).filter(d => d) : [];
            }
            
            // Genera codice Mindmap
            currentMindmapCode = `mindmap
  root((${topic}))`;
            
            if (branches.length > 0) {
                const branchGroups = [];
                const itemsPerGroup = Math.ceil(branches.length / 4);
                
                for (let i = 0; i < branches.length; i += itemsPerGroup) {
                    branchGroups.push(branches.slice(i, i + itemsPerGroup));
                }
                
                branchGroups.forEach((group, index) => {
                    currentMindmapCode += `\n    Categoria ${index + 1}`;
                    group.forEach(item => {
                        currentMindmapCode += `\n      ${item}`;
                    });
                });
            } else {
                currentMindmapCode += `
    Aspetti Principali
      Definizione
      Caratteristiche
      Vantaggi
    Implementazione
      Pianificazione
      Esecuzione
      Monitoraggio
    Risultati
      Metriche
      Valutazione
      Miglioramenti`;
            }
            
            // Genera codice Flowchart
            currentFlowchartCode = `flowchart TB
    A[${topic}]`;
            
            if (branches.length > 0) {
                branches.forEach((branch, index) => {
                    const nodeId = String.fromCharCode(66 + index);
                    currentFlowchartCode += `\n    A --> ${nodeId}[${branch}]`;
                });
            } else {
                currentFlowchartCode += `
    A --> B[Aspetti Principali]
    A --> C[Implementazione]
    A --> D[Risultati]
    B --> B1[Definizione]
    B --> B2[Caratteristiche]
    B --> B3[Vantaggi]
    C --> C1[Pianificazione]
    C --> C2[Esecuzione]
    C --> C3[Monitoraggio]
    D --> D1[Metriche]
    D --> D2[Valutazione]
    D --> D3[Miglioramenti]`;
            }
            
            currentFlowchartCode += `\n    style A fill:#f9f,stroke:#333,stroke-width:4px`;
            
            // Genera codice Graph
            currentGraphCode = `graph LR
    A((${topic}))`;
            
            if (branches.length > 0) {
                branches.forEach((branch, index) => {
                    const nodeId = String.fromCharCode(66 + index);
                    currentGraphCode += `\n    A --- ${nodeId}[${branch}]`;
                });
                
                if (branches.length > 3) {
                    currentGraphCode += `\n    B -.-> D`;
                    currentGraphCode += `\n    C -.-> E`;
                }
            } else {
                currentGraphCode += `
    A --- B[Aspetti Principali]
    A --- C[Implementazione]
    A --- D[Risultati]
    B --- E[Analisi]
    C --- F[Sviluppo]
    D --- G[Valutazione]
    E -.-> F
    F -.-> G
    G -.-> B`;
            }
        }

        // Estrai concetti principali da testo lungo
        function extractMainConcepts(text) {
            const paragraphs = text.split('\n').filter(p => p.trim().length > 0);
            const concepts = [];
            
            paragraphs.slice(0, 8).forEach(paragraph => {
                const words = paragraph.split(' ').slice(0, 8);
                if (words.length > 3) {
                    concepts.push(words.join(' ') + '...');
                }
            });
            
            return concepts.length > 0 ? concepts : ['Concetto 1', 'Concetto 2', 'Concetto 3'];
        }

        // Cambia visualizzazione
        function changeView(view) {
            currentView = view;
            
            document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('active'));
            event.target?.classList.add('active');
            
            let code = '';
            switch(view) {
                case 'mindmap': code = currentMindmapCode; break;
                case 'flowchart': code = currentFlowchartCode; break;
                case 'graph': code = currentGraphCode; break;
            }
            
            const container = document.getElementById('diagramContainer');
            container.innerHTML = `<div class="mermaid">${code}</div>`;
            mermaid.run();
        }

        // Scarica come immagine
        async function downloadImage() {
            const svg = document.querySelector('#diagramContainer svg');
            if (!svg) {
                alert('‚ùå Nessuna mappa da scaricare');
                return;
            }
            
            const svgClone = svg.cloneNode(true);
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', '100%');
            rect.setAttribute('height', '100%');
            rect.setAttribute('fill', 'white');
            svgClone.insertBefore(rect, svgClone.firstChild);
            
            const svgData = new XMLSerializer().serializeToString(svgClone);
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const svgUrl = URL.createObjectURL(svgBlob);
            
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = img.width * 2;
                canvas.height = img.height * 2;
                ctx.scale(2, 2);
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const topic = document.getElementById('topicInput').value || 'mappa_mentale';
                    a.download = `${topic.replace(/[^a-z0-9]/gi, '_')}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    URL.revokeObjectURL(svgUrl);
                });
            };
            img.src = svgUrl;
        }

        // Copia codice
        function copyCode() {
            let code = '';
            switch(currentView) {
                case 'mindmap': code = currentMindmapCode; break;
                case 'flowchart': code = currentFlowchartCode; break;
                case 'graph': code = currentGraphCode; break;
            }
            
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Codice Mermaid copiato!');
            }).catch(() => {
                alert('‚ùå Errore nella copia');
            });
        }

        // Modifica mappa
        function editMindmap() {
            const newCode = prompt('Modifica il codice Mermaid:', 
                currentView === 'mindmap' ? currentMindmapCode : 
                currentView === 'flowchart' ? currentFlowchartCode : currentGraphCode);
            
            if (newCode) {
                switch(currentView) {
                    case 'mindmap': currentMindmapCode = newCode; break;
                    case 'flowchart': currentFlowchartCode = newCode; break;
                    case 'graph': currentGraphCode = newCode; break;
                }
                changeView(currentView);
            }
        }

        // Salva nel sistema MentoreStudio
        function saveMindmap() {
            const topic = document.getElementById('topicInput').value || 'Senza titolo';
            const data = {
                topic: topic,
                details: document.getElementById('detailsInput').value,
                mindmapCode: currentMindmapCode,
                flowchartCode: currentFlowchartCode,
                graphCode: currentGraphCode,
                timestamp: new Date().toISOString(),
                type: 'mindmap'
            };
            
            // Usa il sistema di salvataggio centralizzato
            if (window.MentoreStorage) {
                const savedId = MentoreStorage.saveMindmap(data);
                alert(`‚úÖ Mappa "${topic}" salvata in MentoreStudio!`);
            } else {
                // Fallback
                const savedMaps = JSON.parse(localStorage.getItem('mentore_studio_mindmaps') || '[]');
                savedMaps.push(data);
                localStorage.setItem('mentore_studio_mindmaps', JSON.stringify(savedMaps));
                alert(`‚úÖ Mappa "${topic}" salvata con successo!`);
            }
        }

        // Pulisci tutto
        function clearAll() {
            if (confirm('Vuoi cancellare tutto e ricominciare?')) {
                document.getElementById('topicInput').value = '';
                document.getElementById('detailsInput').value = '';
                document.getElementById('resultSection').style.display = 'none';
                document.getElementById('filePreview').style.display = 'none';
                currentMindmapCode = '';
                currentFlowchartCode = '';
                currentGraphCode = '';
            }
        }

        // Torna al materiale
        function goBackToMaterial() {
            window.location.href = 'materiale.html';
        }

        // ========== FUNZIONI UTILITY ==========

        // Simula il recupero del materiale
        async function getSavedMaterials() {
            // Cerca in diversi possibili storage
            const materials = 
                JSON.parse(localStorage.getItem('mentore_studio_materials') || '[]') ||
                JSON.parse(localStorage.getItem('savedMaterials') || '[]') ||
                [];
            
            return materials.map(material => ({
                id: material.id,
                title: material.title || material.topic || material.fileName || 'Senza titolo',
                type: material.type || 'document',
                content: material.content || material.details || material.text || '',
                createdAt: material.createdAt || material.timestamp || new Date().toISOString()
            }));
        }

        // Simula elaborazione file
        async function simulateFileProcessing(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const fakeContent = {
                        pdf: `Estratto da PDF: ${file.name}\n\nCapitolo 1: Introduzione\nIl sistema di centralini virtuali rappresenta una rivoluzione...\n\nCapitolo 2: Architettura\nL'architettura cloud-based permette...`,
                        docx: `Documento: ${file.name}\n\nTitolo: Analisi di Mercato\nIntroduzione: Il mercato dei centralini virtuali...\n\nMetodologia: Abbiamo analizzato...`,
                        pptx: `Presentazione: ${file.name}\n\nSlide 1: Titolo\nSlide 2: Agenda\nSlide 3: Problematica\nSlide 4: Soluzione`,
                        txt: `Contenuto file di testo: ${file.name}\n\nQuesto √® un esempio di contenuto estratto da un file di testo.`,
                        md: `# ${file.name}\n## Documento Markdown\nContenuto estratto dal file...`
                    };
                    
                    const ext = file.name.split('.').pop().toLowerCase();
                    resolve(fakeContent[ext] || `Contenuto del file: ${file.name}`);
                }, 2000);
            });
        }

        // Simula OCR
        async function simulateOCR(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve(`Testo estratto via OCR da ${file.name}:\n\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam auctor, nisl eget ultricies tincidunt, nisl nisl aliquam nisl, eget ultricies nisl nisl eget nisl.`);
                }, 3000);
            });
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const topic = urlParams.get('topic');
            const details = urlParams.get('details');
            
            if (topic) {
                document.getElementById('topicInput').value = decodeURIComponent(topic);
                if (details) {
                    document.getElementById('detailsInput').value = decodeURIComponent(details);
                }
                generateMindmap();
            }
        });
    </script>
</body>
</html>
