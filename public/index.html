<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MentoreStudio - Il tuo mentore personale per lo studio intelligente">
    <title>üìö MentoreStudio - Studia Intelligente</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <!-- NUOVE LIBRERIE PER MULTI-FORMATO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- LIBRERIA OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <!-- MERMAID.JS PER MAPPE MENTALI -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #4caf50;
            --danger: #f44336;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        body.dark-mode { background: #0f0f1e; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .header { background: #2a2a3e; color: #e0e0e0; }
        h1 { font-size: 1.8em; color: var(--primary); }
        body.dark-mode h1 { color: var(--accent); }
        .header-controls { display: flex; gap: 10px; }
        .toggle-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .upload-section { background: #2a2a3e; color: #e0e0e0; }
        body.dark-mode #uploadProgress { 
            background: #1a1a2e !important; 
            color: #e0e0e0 !important;
        }
        body.dark-mode #uploadProgress span,
        body.dark-mode #progressText {
            color: #e0e0e0 !important;
        }
        body.dark-mode #fileInfo {
            background: #1a1a2e !important;
            color: #e0e0e0 !important;
            border-left-color: var(--accent) !important;
        }
        /* Badge formati supportati */
        .supported-formats {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .format-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* NUOVI STILI UPLOAD AREA */
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            background: rgba(102, 126, 234, 0.05);
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: var(--secondary);
            transform: translateY(-2px);
        }
        .upload-area.drag-over {
            background: rgba(102, 126, 234, 0.15);
            border-color: var(--accent);
        }
        
        /* ANIMAZIONE BARRA PROGRESSO */
        #uploadProgress {
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #progressBar {
            transition: width 0.5s ease;
        }
        #progressText {
            font-weight: 600;
            color: var(--primary);
        }
        
        input[type="file"], input[type="text"] {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
        }
        body.dark-mode input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .subject-select {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            font-size: 1em;
        }
        body.dark-mode .subject-select { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn.loading {
            background: linear-gradient(90deg, var(--primary), var(--secondary)) !important;
            opacity: 0.9;
            cursor: wait;
            animation: pulse-btn 1.5s ease-in-out infinite;
        }
        @keyframes pulse-btn {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        .btn-delete { background: var(--danger); padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .btn-export { background: #2196F3; padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .tabs { background: #2a2a3e; }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f0f0f0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        body.dark-mode .tab-btn { background: #1a1a2e; color: #e0e0e0; }
        .tab-btn.active { background: var(--primary); color: white; }
        .content-area {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 500px;
        }
        body.dark-mode .content-area { background: #2a2a3e; color: #e0e0e0; }
        .hidden { display: none !important; }
        .section { margin-bottom: 30px; }
        .section h2 { color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        body.dark-mode .section h2 { color: var(--accent); border-color: var(--accent); }
        .card { background: #f5f7ff; padding: 20px; border-radius: 10px; margin: 10px 0; border-left: 4px solid var(--primary); }
        body.dark-mode .card { background: #1a1a2e; border-left-color: var(--accent); }
        .study-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        body.dark-mode .study-item { background: #1a1a2e; }
        .study-item:hover { transform: translateX(5px); background: #e8eaff; }
        .study-info { font-size: 0.9em; color: #666; margin-top: 5px; }
        body.dark-mode .study-info { color: #aaa; }
        .study-left { flex: 1; }
        .study-right { display: flex; gap: 10px; }
        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
        }
        body.dark-mode .search-box { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f0f0f0; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar { background: #e0e0e0; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; transition: width 0.3s; }
        
        .flashcard { 
            perspective: 1000px; 
            min-height: 350px; 
            cursor: pointer; 
            margin: 20px 0; 
            border: 3px solid transparent;
            border-radius: 10px;
        }
        .flashcard.easy { border-color: #4caf50; }
        .flashcard.medium { border-color: #ffa726; }
        .flashcard.difficult { border-color: #f44336; }
        .flashcard-inner { position: relative; width: 100%; min-height: 350px; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard-inner.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; min-height: 350px; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; text-align: center; border-radius: 10px; }
        .flashcard-front { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .flashcard-back { background: linear-gradient(135deg, var(--accent), #f5576c); color: white; transform: rotateY(180deg); }
        .flashcard-question { font-size: 1.3em; font-weight: bold; margin-bottom: 15px; }
        .flashcard-answer { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; }
        .flashcard-extra { 
            font-size: 0.9em; 
            margin-top: 15px; 
            padding-top: 15px; 
            border-top: 2px solid rgba(255,255,255,0.3);
            text-align: left;
            width: 100%;
            line-height: 1.6;
        }
        .flashcard-extra-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .expand-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            margin: 5px;
            transition: all 0.3s;
        }
        .expand-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        .controls { display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
        .quiz-option { 
            background: #f5f7ff; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: all 0.3s;
        }
        body.dark-mode .quiz-option { background: #1a1a2e; }
        .quiz-option:hover { background: #e8eaff; transform: translateX(5px); }
        .quiz-option.selected { border-color: var(--primary); background: #e8eaff; }
        .quiz-option.correct { border-color: var(--success); background: #c8e6c9; }
        .quiz-option.incorrect { border-color: var(--danger); background: #ffcdd2; }
        .timer-display {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 10px;
            margin: 20px 0;
        }
        .timer-display.warning {
            background: linear-gradient(135deg, #ffa726, #fb8c00);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .note-section { background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ffc107; }
        body.dark-mode .note-section { background: #3d3d1a; color: #e0e0e0; }
        .note-input { width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9em; }
        body.dark-mode .note-input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .key-concept { 
            display: inline-block; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px; 
            margin: 3px; 
            font-size: 0.95em;
            font-weight: 600;
        }
        .back-btn { display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--primary); margin-bottom: 20px; font-weight: bold; }
        body.dark-mode .back-btn { color: var(--accent); }
        .review-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
        .review-item.wrong { border-left-color: var(--danger); background: #ffebee; }
        .review-item.correct { border-left-color: var(--success); background: #e8f5e9; }

        .highlight-item {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .highlight-item { background: #1a1a2e; }
        .highlight-item:hover { transform: translateX(5px); background: #e8eaff; }
        body.dark-mode .highlight-item:hover { background: #2a2a3e; }
        .highlight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        .highlight-title {
            flex: 1;
            font-weight: 600;
            line-height: 1.6;
        }
        .highlight-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        .highlight-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(102, 126, 234, 0.2);
            color: #555;
            line-height: 1.8;
            display: none;
        }
        body.dark-mode .highlight-details { color: #bbb; border-top-color: rgba(240, 147, 251, 0.2); }
        .generate-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* CHAT STYLES */
        .chat-container { display: flex; flex-direction: column; height: 600px; max-height: 70vh; }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        body.dark-mode .chat-messages { background: #1a1a2e; }
        .chat-message { display: flex; gap: 10px; animation: slideIn 0.3s ease; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.user { flex-direction: row-reverse; }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }
        .chat-message.user .chat-avatar { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .chat-message.ai .chat-avatar { background: linear-gradient(135deg, var(--accent), #f5576c); color: white; }
        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-bottom-right-radius: 5px;
        }
        .chat-message.ai .chat-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        body.dark-mode .chat-message.ai .chat-bubble { background: #2a2a3e; color: #e0e0e0; }
        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        body.dark-mode .chat-input-container { background: #2a2a3e; }
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
            resize: none;
            font-family: inherit;
        }
        body.dark-mode .chat-input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .chat-send-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .chat-send-btn:disabled { background: #ccc; cursor: not-allowed; }
        .typing-indicator { display: flex; gap: 5px; padding: 10px; }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        .chat-context-info {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            font-size: 0.9em;
        }
        body.dark-mode .chat-context-info { background: rgba(102, 126, 234, 0.2); }
        .chat-suggestions { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .chat-suggestion {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .chat-suggestion { background: #1a1a2e; color: #e0e0e0; }
        .chat-suggestion:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }
        body.dark-mode .error-message { background: rgba(198, 40, 40, 0.2); color: #ff5252; }

        /* ========== NUOVE 4 CARDS - INTEGRAZIONE COMPLETA ========== */
        .category-selection {
            display: none;
        }
        
        .category-selection.active {
            display: block;
        }
        
        .category-title-section {
            text-align: center;
            margin-bottom: 48px;
        }
        
        .category-main-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        body.dark-mode .category-main-title {
            color: var(--accent);
        }
        
        .category-subtitle {
            font-size: 16px;
            color: #6b7280;
        }
        
        body.dark-mode .category-subtitle {
            color: #9ca3af;
        }
        
        .back-navigation {
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: var(--secondary);
            transform: translateX(-2px);
        }
        
        .back-btn.hidden {
            display: none;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .category-card {
            background: white;
            border-radius: 24px;
            padding: 48px 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .category-card {
            background: #2a2a3e;
        }
        
        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.9;
            z-index: 0;
            transition: opacity 0.3s;
        }
        
        .category-card:hover::before {
            opacity: 1;
        }
        
        .category-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.12);
        }
        
        .category-card.comprendi::before {
            background: linear-gradient(135deg, #d4f1e8 0%, #bae8d4 100%);
        }
        
        .category-card.memorizza::before {
            background: linear-gradient(135deg, #e8d4f1 0%, #d4bae8 100%);
        }
        
        .category-card.approfondisci::before {
            background: linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 100%);
        }
        
        .category-card.personalizza::before {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        }
        
        .category-card-content {
            position: relative;
            z-index: 1;
        }
        
        .category-card-icon {
            font-size: 64px;
            margin-bottom: 16px;
            display: block;
        }
        
        .category-card-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .category-card-description {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .category-grid {
                grid-template-columns: 1fr;
                max-width: 400px;
            }
            
            .category-main-title {
                font-size: 24px;
            }
            
            .category-card {
                padding: 40px 24px;
            }
            
            .category-card-icon {
                font-size: 56px;
            }
            
            .category-card-title {
                font-size: 20px;
            }
        }
        /* ========== FINE NUOVE 4 CARDS ========== */

        
        /* STUDY GUIDE & CONCEPT ANALYSIS STYLES */
        .question-card {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }
        body.dark-mode .question-card { background: #1a1a2e; }
        .question-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .question-number {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.85em;
            display: inline-block;
            margin-bottom: 10px;
        }
        .question-text {
            font-size: 1.05em;
            line-height: 1.7;
            margin-top: 10px;
            color: #333;
        }
        body.dark-mode .question-text { color: #e0e0e0; }
        .pillar-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05));
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid var(--primary);
            transition: all 0.3s;
        }
        body.dark-mode .pillar-card { background: rgba(102, 126, 234, 0.15); }
        .pillar-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .pillar-title {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        body.dark-mode .pillar-title { color: var(--accent); }
        .pillar-icon {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }
        .pillar-content {
            line-height: 1.8;
            color: #444;
            font-size: 1.05em;
        }
        body.dark-mode .pillar-content { color: #ccc; }
        .connection-box {
            background: rgba(240, 147, 251, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 3px solid var(--accent);
        }
        body.dark-mode .connection-box { background: rgba(240, 147, 251, 0.15); }
        
        /* CUSTOM FORMAT STYLES */
        .format-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        .format-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05));
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            text-align: center;
        }
        body.dark-mode .format-card { background: rgba(102, 126, 234, 0.15); }
        .format-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }
        .format-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .format-title {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }
        body.dark-mode .format-title { color: var(--accent); }
        .format-desc {
            font-size: 0.9em;
            color: #666;
            line-height: 1.5;
        }
        body.dark-mode .format-desc { color: #aaa; }
        .custom-input-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .custom-input-box { background: #2a2a3e; }
        .custom-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }
        body.dark-mode .custom-textarea { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .result-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1.05em;
        }
        body.dark-mode .result-box { background: #1a1a2e; color: #e0e0e0; }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .history-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid var(--secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .history-item { background: #1a1a2e; }
        .history-item:hover { transform: translateX(5px); background: #e8eaff; }
        body.dark-mode .history-item:hover { background: #2a2a3e; }
        .history-meta {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
        }

        /* MINDMAP STYLES - MERMAID */
        .mindmap-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        body.dark-mode .mindmap-container { background: #1a1a2e; }
        
        #mindmapDiagram {
            max-width: 100%;
            overflow-x: auto;
        }
        
        /* Stili per Mermaid */
        .mermaid {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Dark mode per Mermaid */
        body.dark-mode .mermaid {
            filter: invert(1) hue-rotate(180deg);
        }
        
        .mindmap-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .mindmap-style-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .mindmap-style-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .mindmap-style-btn.active {
            background: var(--primary);
            color: white;
        }
        
        body.dark-mode .mindmap-style-btn {
            background: #2a2a3e;
            color: var(--accent);
            border-color: var(--accent);
        }
        
        body.dark-mode .mindmap-style-btn:hover,
        body.dark-mode .mindmap-style-btn.active {
            background: var(--accent);
            color: #2a2a3e;
        }
        
        .mindmap-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        /* Vecchi stili mindmap ASCII - mantenuti per compatibilit√† */
        .mindmap-tree {
            font-family: 'Courier New', monospace;
            line-height: 2;
            font-size: 1.05em;
        }
        .mindmap-node {
            margin-left: 20px;
            padding: 5px 0;
        }
        .mindmap-root {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
        }
        body.dark-mode .mindmap-root { color: var(--accent); }
        .mindmap-branch {
            color: var(--secondary);
            font-weight: 600;
        }
        body.dark-mode .mindmap-branch { color: #f093fb; }
        .mindmap-leaf {
            color: #555;
        }
        body.dark-mode .mindmap-leaf { color: #aaa; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö MentoreStudio</h1>
            <div class="header-controls">
                <button class="toggle-btn" onclick="toggleDarkMode()">üåô</button>
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="supported-formats">
                <div class="format-badge">üìÑ PDF</div>
                <div class="format-badge">üìù TXT</div>
                <div class="format-badge">üìò DOCX</div>
                <div class="format-badge">üìä PPTX</div>
                <div class="format-badge">üñºÔ∏è OCR (JPG/PNG)</div>
            </div>
            
            <div style="max-width: 600px; margin: 30px auto;">
                <label style="font-weight: bold; margin-bottom: 10px; display: block;">üìö Materia:</label>
                <select id="subjectSelect" class="subject-select">
                    <option value="Generale">Generale</option>
                    <option value="Storia">Storia</option>
                    <option value="Matematica">Matematica</option>
                    <option value="Biologia">Biologia</option>
                    <option value="Diritto">Diritto</option>
                    <option value="Informatica">Informatica</option>
                    <option value="Letteratura">Letteratura</option>
                    <option value="Fisica">Fisica</option>
                    <option value="Chimica">Chimica</option>
                    <option value="Filosofia">Filosofia</option>
                    <option value="Inglese">Inglese</option>
                    <option value="Economia">Economia</option>
                </select>
                
                <!-- NUOVA AREA DI UPLOAD MIGLIORATA -->
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 3em; margin-bottom: 15px;">üìÅ</div>
                    <p style="font-size: 1.1em; margin-bottom: 15px; font-weight: 500;">Trascina i file qui o clicca per selezionarli</p>
                    <button class="btn" onclick="document.getElementById('pdfFile').click()" style="background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        Scegli file
                    </button>
                    <input type="file" id="pdfFile" accept=".pdf,.txt,.docx,.pptx,image/*" multiple style="display: none;">
                    <p style="font-size: 0.9em; color: #666; margin-top: 15px;">Supporta: PDF, TXT, DOCX, PPTX, JPG, PNG</p>
                </div>
                
                <div id="fileInfo" style="margin: 15px 0; padding: 10px; background: #f5f7ff; border-radius: 8px; border-left: 4px solid var(--primary); display: none;">
                    <strong>File selezionati:</strong>
                    <div id="selectedFilesList"></div>
                </div>
                
                <button class="btn" onclick="loadMultiplePDFs()" style="width: 100%; background: var(--success);" id="uploadBtn" disabled>üìÇ Carica File</button>
                
                <div id="uploadProgress" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #333;">Caricamento in corso...</span>
                        <span id="progressPercent" style="font-weight: bold; color: var(--primary);">0%</span>
                    </div>
                    <div style="background: #e0e0e0; height: 12px; border-radius: 6px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                        <div id="progressBar" style="background: linear-gradient(90deg, var(--primary), var(--secondary)); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 6px;"></div>
                    </div>
                    <p id="progressText" style="text-align: center; margin-top: 12px; font-size: 0.95em; color: #666; font-weight: 500; min-height: 24px;"></p>
                </div>
            </div>
            
            <p style="font-size: 0.9em; margin-top: 20px; color: #666;">Tutto salvato offline ‚Ä¢ Nessuna chiave API visibile</p>
        </div>

        <div id="mainApp" class="hidden">
            <!-- ========== NUOVE 4 CARDS - NAVIGAZIONE ========== -->
            <div class="category-selection" id="categorySelection">
                <div class="back-navigation">
                    <button class="back-btn" onclick="showLibrary()">‚Üê Torna alla Libreria</button>
                    <button class="back-btn hidden" id="backToCategories" onclick="showCategories()">‚Üê Indietro</button>
                </div>
                
                <div class="category-title-section">
                    <h1 class="category-main-title">Scegli come studiare</h1>
                    <p class="category-subtitle" id="currentStudyName">Seleziona una categoria</p>
                </div>

                <div class="category-grid">
                    <!-- Card 1: Comprendi -->
                    <div class="category-card comprendi" onclick="selectCategory('comprendi')">
                        <div class="category-card-content">
                            <span class="category-card-icon">üìù</span>
                            <h2 class="category-card-title">Comprendi</h2>
                            <p class="category-card-description">Analizza i contenuti della lezione</p>
                        </div>
                    </div>

                    <!-- Card 2: Memorizza -->
                    <div class="category-card memorizza" onclick="selectCategory('memorizza')">
                        <div class="category-card-content">
                            <span class="category-card-icon">üîñ</span>
                            <h2 class="category-card-title">Memorizza</h2>
                            <p class="category-card-description">Fissa i concetti nella memoria</p>
                        </div>
                    </div>

                    <!-- Card 3: Approfondisci -->
                    <div class="category-card approfondisci" onclick="selectCategory('approfondisci')">
                        <div class="category-card-content">
                            <span class="category-card-icon">üìä</span>
                            <h2 class="category-card-title">Approfondisci</h2>
                            <p class="category-card-description">Esplora e verifica le conoscenze</p>
                        </div>
                    </div>

                    <!-- Card 4: Personalizza -->
                    <div class="category-card personalizza" onclick="selectCategory('personalizza')">
                        <div class="category-card-content">
                            <span class="category-card-icon">‚ú®</span>
                            <h2 class="category-card-title">Personalizza</h2>
                            <p class="category-card-description">Crea materiali su misura</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ========== FINE NUOVE 4 CARDS ========== -->

            <div class="tabs" id="tabs">
                <button class="tab-btn active" onclick="switchTab('library', event)">üìö Libreria Studi</button>
                <button class="tab-btn hidden" id="tabSummary" onclick="switchTab('summary', event)">üìù Riassunto</button>
                <button class="tab-btn hidden" id="tabHighlights" onclick="switchTab('highlights', event)">‚≠ê Punti Salienti</button>
                <button class="tab-btn hidden" id="tabGlossary" onclick="switchTab('glossary', event)">üìñ Glossario</button>
                <button class="tab-btn hidden" id="tabTimeline" onclick="switchTab('timeline', event)">üìÖ Timeline</button>
                <button class="tab-btn hidden" id="tabMindmap" onclick="switchTab('mindmap', event)">üß† Mappa Mentale</button>
                <button class="tab-btn hidden" id="tabStudyGuide" onclick="switchTab('studyguide', event)">üìò Guida di Studio</button>
                <button class="tab-btn hidden" id="tabConceptAnalysis" onclick="switchTab('conceptanalysis', event)">üîç Analisi Concetto</button>
                <button class="tab-btn hidden" id="tabCustomFormat" onclick="switchTab('customformat', event)">‚ú® Crea il Tuo</button>
                <button class="tab-btn hidden" id="tabFlashcards" onclick="switchTab('flashcards', event)">üé¥ Flashcard</button>
                <button class="tab-btn hidden" id="tabQuiz" onclick="switchTab('quiz', event)">‚ùì Quiz</button>
                <button class="tab-btn hidden" id="tabChat" onclick="switchTab('chat', event)">üí¨ Chat AI</button>
            </div>
            <div class="content-area" id="contentArea"></div>
        </div>
    </div>

    <script>
        // Inizializzazione Mermaid
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                rankSpacing: 50
            },
            mindmap: {
                useMaxWidth: true,
                padding: 20
            }
        });

        let appState = {
            studies: JSON.parse(localStorage.getItem('mentorestudio_studies')) || {},
            currentStudyId: null,
            currentFlashcard: 0,
            currentFlashcardFiltered: 0,
            flashcardMode: 'all',
            currentQuiz: 0,
            currentQuizFiltered: 0,
            quizMode: 'all',
            quizScore: 0,
            quizAnswers: [],
            quizTimerEnabled: false,
            quizTimeRemaining: 0,
            quizTimerId: null,
            notes: JSON.parse(localStorage.getItem('flashcardNotes')) || {},
            darkMode: localStorage.getItem('darkMode') === 'true',
            chatHistory: JSON.parse(localStorage.getItem('chatHistory')) || {},
            isChatLoading: false,
            mindmapStyle: 'mindmap' // Nuovo stato per lo stile della mappa
        };

        let flashcardStats = JSON.parse(localStorage.getItem('flashcardStats')) || {};
        let quizStats = JSON.parse(localStorage.getItem('quizStats')) || {};
        let selectedFiles = [];

        if (appState.darkMode) document.body.classList.add('dark-mode');

        function toggleDarkMode() {
            appState.darkMode = !appState.darkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', appState.darkMode);
        }

        // ========== GESTIONE UPLOAD MIGLIORATA ==========
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('pdfFile');
        const fileInfo = document.getElementById('fileInfo');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressText = document.getElementById('progressText');
        const selectedFilesList = document.getElementById('selectedFilesList');

        // Event listeners per drag & drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelection();
            }
        });

        // Click sull'area di upload
        uploadArea.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') {
                fileInput.click();
            }
        });

        // Cambiamento selezione file
        fileInput.addEventListener('change', handleFileSelection);

        function handleFileSelection() {
            selectedFiles = Array.from(fileInput.files);
            
            if (selectedFiles.length > 0) {
                // Mostra info file
                fileInfo.style.display = 'block';
                selectedFilesList.innerHTML = '';
                
                selectedFiles.forEach((file, index) => {
                    const fileElement = document.createElement('div');
                    fileElement.style.padding = '5px 0';
                    fileElement.style.borderBottom = index < selectedFiles.length - 1 ? '1px solid #e0e0e0' : 'none';
                    fileElement.innerHTML = `
                        <span style="font-weight: 500;">${file.name}</span>
                        <span style="color: #666; font-size: 0.9em;"> (${formatFileSize(file.size)})</span>
                    `;
                    selectedFilesList.appendChild(fileElement);
                });
                
                // Abilita pulsante caricamento
                uploadBtn.disabled = false;
                uploadBtn.style.background = 'var(--success)';
            } else {
                fileInfo.style.display = 'none';
                uploadBtn.disabled = true;
                uploadBtn.style.background = '#ccc';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateUploadProgress(current, total, message) {
            const percent = Math.round((current / total) * 100);
            progressBar.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
            progressText.textContent = message;
        }

        async function loadMultiplePDFs() {
            const files = selectedFiles;
            if (files.length === 0) { 
                alert('Seleziona almeno un file'); 
                return; 
            }

            // IMPORTANTE: NON nascondere la schermata di upload!
            // L'utente deve vedere cosa sta succedendo
            
            // Disabilita il pulsante e mostra il progresso
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Elaborazione in corso...';
            uploadBtn.classList.add('loading');
            
            // Mostra la barra di progresso
            uploadProgress.style.display = 'block';
            updateUploadProgress(0, files.length, 'Avvio elaborazione...');
            
            // Aspetta un attimo per mostrare la UI
            await new Promise(resolve => setTimeout(resolve, 300));
            
            let processedCount = 0;
            let successCount = 0;

            for (let file of files) {
                try {
                    // Mostra quale file stiamo elaborando
                    updateUploadProgress(processedCount, files.length, `üìÑ Elaborando: ${file.name}`);
                    
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    let text = '';
                    let fileType = '';
                    let fileIcon = '';

                    console.log(`Elaborazione file: ${file.name} (${fileExtension})`);
                    
                    // Estrazione testo
                    updateUploadProgress(processedCount, files.length, `üîç Lettura ${file.name}...`);
                    
                    switch(fileExtension) {
                        case 'pdf':
                            text = await extractPDFText(file);
                            fileType = 'PDF';
                            fileIcon = 'üìÑ';
                            break;
                        case 'txt':
                            text = await extractTextFromTXT(file);
                            fileType = 'TXT';
                            fileIcon = 'üìù';
                            break;
                        case 'docx':
                            text = await extractTextFromDOCX(file);
                            fileType = 'DOCX';
                            fileIcon = 'üìò';
                            break;
                        case 'pptx':
                            text = await extractTextFromPPTX(file);
                            fileType = 'PPTX';
                            fileIcon = 'üìä';
                            break;
                        case 'jpg': case 'jpeg': case 'png': case 'gif': case 'bmp':
                            text = await extractTextFromImage(file);
                            fileType = 'OCR';
                            fileIcon = 'üñºÔ∏è';
                            break;
                        default:
                            throw new Error(`Formato non supportato: .${fileExtension}`);
                    }

                    console.log(`‚úÖ ${file.name}: ${text.length} caratteri estratti`);
                    
                    if (!text || text.trim().length < 100) {
                        throw new Error(`Il file contiene troppo poco testo (minimo 100 caratteri)`);
                    }
                    
                    // Generazione contenuti con AI
                    updateUploadProgress(processedCount, files.length, `ü§ñ Generazione contenuti AI per ${file.name}...`);
                    
                    const studyId = Date.now() + Math.random();
                    const data = await generateContent(text, document.getElementById('subjectSelect').value);
                    
                    appState.studies[studyId] = {
                        id: studyId,
                        name: file.name.replace(/\.[^/.]+$/, ''),
                        data: data,
                        date: new Date().toLocaleDateString('it-IT'),
                        subject: document.getElementById('subjectSelect').value,
                        fullText: text.substring(0, 8000),
                        type: fileExtension,
                        fileType: fileIcon + ' ' + fileType
                    };
                    
                    appState.chatHistory[studyId] = [];
                    
                    processedCount++;
                    successCount++;
                    updateUploadProgress(processedCount, files.length, `‚úÖ ${file.name} completato!`);
                    
                    // Breve pausa per mostrare il successo
                    await new Promise(resolve => setTimeout(resolve, 400));
                    
                } catch (e) {
                    console.error(`‚ùå Errore ${file.name}:`, e);
                    processedCount++;
                    updateUploadProgress(processedCount, files.length, `‚ùå Errore: ${file.name}`);
                    
                    // Mostra errore all'utente
                    alert(`Impossibile elaborare "${file.name}":\n${e.message}`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }

            // Salvataggio
            updateUploadProgress(files.length, files.length, 'üíæ Salvataggio dati...');
            saveStudies();
            saveChatHistory();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Mostra riepilogo finale
            updateUploadProgress(files.length, files.length, `‚úÖ Elaborazione completata! ${successCount}/${files.length} file caricati`);
            uploadBtn.textContent = '‚úÖ Completato!';
            uploadBtn.style.background = 'var(--success)';
            
            // Attendi prima di passare all'app
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Ora passa all'app principale
            showMainApp();
            renderLibrary();
            switchTab('library');
            
            // Reset upload dopo aver cambiato schermata
            setTimeout(() => {
                uploadProgress.style.display = 'none';
                progressBar.style.width = '0%';
                fileInput.value = '';
                selectedFiles = [];
                fileInfo.style.display = 'none';
                uploadBtn.disabled = true;
                uploadBtn.style.background = '#ccc';
                uploadBtn.textContent = 'üìÇ Carica File';
                uploadBtn.classList.remove('loading');
            }, 500);
        }

        async function extractPDFText(file) {
            const reader = new FileReader();
            return new Promise((resolve) => {
                reader.onload = async (e) => {
                    const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
                    let text = '';
                    for (let i = 0; i < Math.min(pdf.numPages, 20); i++) {
                        const page = await pdf.getPage(i + 1);
                        const content = await page.getTextContent();
                        text += content.items.map(x => x.str).join(' ') + '\n';
                    }
                    resolve(text);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function extractTextFromTXT(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    if (!text || text.trim().length < 50) {
                        reject(new Error('Il file TXT non contiene abbastanza testo'));
                        return;
                    }
                    resolve(text);
                };
                reader.onerror = () => reject(new Error('Errore lettura file TXT'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        async function extractTextFromDOCX(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        
                        if (!result.value || result.value.trim().length < 50) {
                            reject(new Error('Il documento DOCX non contiene abbastanza testo'));
                            return;
                        }
                        
                        const cleanText = result.value
                            .replace(/\r\n/g, '\n')
                            .replace(/\n{3,}/g, '\n\n')
                            .trim();
                        
                        resolve(cleanText);
                    } catch (error) {
                        reject(new Error('Errore lettura DOCX: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('Errore caricamento DOCX'));
                reader.readAsArrayBuffer(file);
            });
        }

        async function extractTextFromPPTX(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const zip = await JSZip.loadAsync(arrayBuffer);
                        let allText = '';
                        
                        const slideFiles = Object.keys(zip.files)
                            .filter(name => name.startsWith('ppt/slides/slide') && name.endsWith('.xml'))
                            .sort((a, b) => {
                                const numA = parseInt(a.match(/slide(\d+)/)[1]);
                                const numB = parseInt(b.match(/slide(\d+)/)[1]);
                                return numA - numB;
                            });
                        
                        for (let i = 0; i < slideFiles.length; i++) {
                            const slideFile = slideFiles[i];
                            const content = await zip.files[slideFile].async('string');
                            
                            const textMatches = content.match(/<a:t>([^<]+)<\/a:t>/g);
                            
                            if (textMatches && textMatches.length > 0) {
                                const slideText = textMatches
                                    .map(match => match.replace(/<\/?a:t>/g, ''))
                                    .join(' ')
                                    .trim();
                                
                                if (slideText) {
                                    allText += `\n\n‚îÅ‚îÅ‚îÅ SLIDE ${i + 1} ‚îÅ‚îÅ‚îÅ\n\n${slideText}`;
                                }
                            }
                        }
                        
                        if (allText.trim().length < 50) {
                            reject(new Error('La presentazione non contiene abbastanza testo estraibile'));
                            return;
                        }
                        
                        resolve(allText);
                    } catch (error) {
                        reject(new Error('Errore lettura PPTX: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('Errore caricamento PPTX'));
                reader.readAsArrayBuffer(file);
            });
        }

        async function extractTextFromImage(file) {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log(`üîç Avvio OCR per: ${file.name}`);
                    
                    const { data: { text } } = await Tesseract.recognize(
                        file,
                        'ita+eng',
                        {
                            logger: progress => {
                                if (progress.status === 'recognizing text') {
                                    const percent = Math.round(progress.progress * 100);
                                    console.log(`OCR progress: ${percent}%`);
                                }
                            }
                        }
                    );
                    
                    console.log(`‚úÖ OCR completato: ${text.length} caratteri estratti`);
                    
                    if (!text || text.trim().length < 50) {
                        reject(new Error('OCR non ha estratto testo sufficiente'));
                        return;
                    }
                    
                    resolve(text.trim());
                    
                } catch (error) {
                    console.error('‚ùå Errore OCR:', error);
                    reject(new Error(`Errore OCR: ${error.message}`));
                }
            });
        }

        function showMainApp() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        async function generateContent(text, subject) {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text.substring(0, 8000), subject: subject })
            });

            if (!response.ok) throw new Error('Errore server: ' + response.status);
            return await response.json();
        }

        function saveStudies() {
            localStorage.setItem('mentorestudio_studies', JSON.stringify(appState.studies));
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(appState.chatHistory));
        }

        function switchTab(tab, e) {
            if (e) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
            }
            switch(tab) {
                case 'library': renderLibrary(); break;
                case 'summary': renderSummary(); break;
                case 'highlights': renderHighlights(); break;
                case 'glossary': renderGlossary(); break;
                case 'timeline': renderTimeline(); break;
                case 'mindmap': renderMindMap(); break;
                case 'studyguide': renderStudyGuide(); break;
                case 'conceptanalysis': renderConceptAnalysis(); break;
                case 'customformat': renderCustomFormat(); break;
                case 'flashcards': renderFlashcardsAdvanced(); break;
                case 'quiz': renderQuizAdvanced(); break;
                case 'chat': renderChat(); break;
            }
        }

        function renderLibrary() {
            let html = '<h2>üìö Le tue lezioni</h2>';
            html += '<input type="text" class="search-box" id="librarySearch" placeholder="üîç Cerca un termine in tutte le lezioni..." onkeyup="filterLibrary()">';
            const studies = Object.values(appState.studies).sort((a, b) => b.id - a.id);
            
            if (studies.length === 0) {
                html += `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üìö</div>
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Nessuna lezione caricata</h3>
                        <p style="color: #999; margin-bottom: 30px;">
                            La tua libreria √® vuota. Inizia caricando i tuoi documenti!
                        </p>
                        <button class="btn" onclick="resetApp()" style="font-size: 1.1em; padding: 15px 30px;">
                            üìÇ Carica Nuovi Documenti
                        </button>
                    </div>
                `;
            } else {
                studies.forEach(study => {
                    html += `
                        <div class="study-item" onclick="selectStudy('${study.id}')" data-search="${study.name.toLowerCase()} ${(study.data.highlights || []).join(' ').toLowerCase()} ${(study.data.glossary || []).map(g => g.term.toLowerCase()).join(' ')}">
                            <div class="study-left">
                                <strong>${study.fileType || 'üìÑ PDF'} ${study.name}</strong>
                                <div class="study-info">üìÖ ${study.date} ‚Ä¢ üìö ${study.subject} ‚Ä¢ üé¥ ${study.data.flashcards?.length || 0} flashcard ‚Ä¢ ‚ùì ${study.data.quiz?.length || 0} quiz</div>
                            </div>
                            <div class="study-right">
                                <button class="btn btn-export" onclick="exportStudyPDF('${study.id}', event)">üì• PDF</button>
                                <button class="btn btn-delete" onclick="deleteStudy('${study.id}', event)">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                html += `
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="resetApp()" style="width: 100%;">üìÑ Carica Altri Documenti</button>
                    </div>
                `;
            }
            document.getElementById('contentArea').innerHTML = html;
        }

        function filterLibrary() {
            const searchTerm = document.getElementById('librarySearch').value.toLowerCase();
            const items = document.querySelectorAll('.study-item');
            items.forEach(item => {
                const searchData = item.getAttribute('data-search');
                item.style.display = searchData.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function exportStudyPDF(studyId, e) {
            e.stopPropagation();
            const study = appState.studies[studyId];
            if (!study) return;

            const element = document.createElement('div');
            element.style.padding = '20px';
            
            element.innerHTML = `
                <h1>${study.name}</h1>
                <p><strong>Tipo:</strong> ${study.fileType || 'üìÑ PDF'} | <strong>Materia:</strong> ${study.subject} | <strong>Data:</strong> ${study.date}</p>
                
                <h2>üìù Riassunto Breve</h2>
                <p>${study.data.summary_short}</p>
                
                <h2>üìñ Riassunto Completo</h2>
                <p>${study.data.summary_long}</p>
                
                <h2>‚≠ê Punti Salienti</h2>
                <ul>
                    ${(study.data.highlights || []).map(h => `<li>${h}</li>`).join('')}
                </ul>
                
                <h2>üìñ Glossario</h2>
                ${(study.data.glossary || []).map(g => `
                    <div style="margin-bottom: 10px;">
                        <strong>${g.term}:</strong> ${g.definition}
                    </div>
                `).join('')}
                
                <h2>üé¥ Flashcard</h2>
                ${(study.data.flashcards || []).map((f, i) => `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <strong>Domanda ${i+1}:</strong> ${f.q}<br>
                        <strong>Risposta:</strong> ${f.a}
                    </div>
                `).join('')}
                
                <h2>‚ùì Quiz</h2>
                ${(study.data.quiz || []).map((q, i) => `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <strong>Quiz ${i+1}:</strong> ${q.q}<br>
                        ${q.options.map((o, j) => `<div style="margin-left: 20px;">‚Ä¢ ${o}${j === q.correct ? ' ‚úì' : ''}</div>`).join('')}
                    </div>
                `).join('')}
            `;

            const opt = {
                margin: 10,
                filename: `${study.name.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };

            html2pdf().set(opt).from(element).save();
            alert('‚úÖ PDF scaricato!');
        }

        function selectStudy(studyId) {
            appState.currentStudyId = studyId;
            appState.currentFlashcard = 0;
            appState.currentFlashcardFiltered = 0;
            appState.flashcardMode = 'all';
            appState.currentQuiz = 0;
            appState.currentQuizFiltered = 0;
            appState.quizMode = 'all';
            appState.quizScore = 0;
            appState.quizAnswers = [];
            
            if (!appState.chatHistory[studyId]) {
                appState.chatHistory[studyId] = [];
            }
            
            // Mostra le 4 cards
            document.getElementById('categorySelection').classList.add('active');
            document.getElementById('tabs').style.display = 'none';
            document.getElementById('contentArea').style.display = 'none';
            document.getElementById('backToCategories').classList.add('hidden');
            
            // Aggiorna il nome del documento
            const study = getCurrentStudy();
            if (study) {
                document.getElementById('currentStudyName').textContent = study.name;
            }
        }

        function deleteStudy(studyId, e) {
            e.stopPropagation();
            if (confirm('Eliminare questa lezione?')) {
                delete appState.studies[studyId];
                delete appState.chatHistory[studyId];
                saveStudies();
                saveChatHistory();
                renderLibrary();
            }
        }

        function getCurrentStudy() {
            return appState.studies[appState.currentStudyId];
        }

        function goBack() {
            if (appState.quizTimerId) {
                clearInterval(appState.quizTimerId);
                appState.quizTimerId = null;
            }
            switchTab('library');
        }

        function renderSummary() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <p style="margin-bottom: 20px;"><strong>Tipo:</strong> ${study.fileType || 'üìÑ PDF'}</p>
                <div class="section"><h3>üìù Riassunto Breve</h3><div class="card">${study.data.summary_short || 'N/A'}</div></div>
                <div class="section"><h3>üìñ Riassunto Completo</h3><div class="card">${study.data.summary_long || 'N/A'}</div></div>
            `;
        }

        function renderHighlights() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>‚≠ê Punti Salienti (${(study.data.highlights || []).length})</h3>
                <p style="color: #666; margin-bottom: 20px;">Clicca su ogni punto per vedere la spiegazione dettagliata</p>
            `;
            
            if (!study.data.highlights || study.data.highlights.length === 0) {
                html += `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">‚≠ê</div>
                        <h3>Nessun punto saliente trovato</h3>
                        <p style="margin-top: 10px; color: #666;">
                            I punti chiave verranno estratti automaticamente dal contenuto.
                        </p>
                    </div>
                `;
            } else {
                (study.data.highlights || []).forEach((h, i) => {
                    const highlightId = `highlight_${i}`;
                    const hasExplanation = study.data.highlightDetails && study.data.highlightDetails[i];
                    
                    html += `
                        <div class="highlight-item" onclick="toggleHighlight('${highlightId}')">
                            <div class="highlight-header">
                                <div class="highlight-title">
                                    <strong style="color: var(--primary);">${i + 1}.</strong> 
                                    <span class="key-concept" style="display: inline; padding: 4px 10px;">${h}</span>
                                </div>
                                <span class="highlight-icon" id="${highlightId}_icon">‚ñº</span>
                            </div>
                            
                            <div class="highlight-details" id="${highlightId}_details">
                                ${hasExplanation ? `
                                    <p>${study.data.highlightDetails[i]}</p>
                                ` : `
                                    <p style="color: #999; font-style: italic;">
                                        Nessuna spiegazione disponibile. Generane una con l'AI!
                                    </p>
                                    <button class="generate-btn" onclick="generateHighlightExplanation(${i}, event)">
                                        ü§ñ Genera Spiegazione Dettagliata
                                    </button>
                                `}
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function toggleHighlight(highlightId) {
            const details = document.getElementById(`${highlightId}_details`);
            const icon = document.getElementById(`${highlightId}_icon`);
            
            if (details.style.display === 'none' || details.style.display === '') {
                details.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        async function generateHighlightExplanation(index, event) {
            event.stopPropagation();
            
            const study = getCurrentStudy();
            const highlight = study.data.highlights[index];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generazione in corso...';
            
            try {
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nContenuto: ${study.fullText.substring(0, 1000)}`;
                
                const prompt = `Fornisci una spiegazione dettagliata e approfondita di questo punto saliente:\n\n"${highlight}"\n\nContesto:\n${context}\n\nLa spiegazione deve essere:\n- Chiara e completa (4-6 frasi)\n- Con esempi concreti se possibile\n- Collegata al contesto della lezione\n- Utile per lo studio e la memorizzazione`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                if (!study.data.highlightDetails) {
                    study.data.highlightDetails = {};
                }
                study.data.highlightDetails[index] = data.response;
                
                saveStudies();
                renderHighlights();
                
                setTimeout(() => {
                    toggleHighlight(`highlight_${index}`);
                }, 100);
                
            } catch (error) {
                console.error('Errore:', error);
                alert('‚ùå Errore nella generazione: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'ü§ñ Genera Spiegazione Dettagliata';
            }
        }

        function renderGlossary() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>üìñ Glossario (${(study.data.glossary || []).length} termini)</h3>
                <p style="color: #666; margin-bottom: 15px;">Clicca su ogni termine per vedere definizione ed esempi</p>
            `;
            
            html += '<input type="text" class="search-box" id="glossarySearch" placeholder="üîç Cerca un termine..." onkeyup="filterGlossary()">';
            html += '<div id="glossaryContent">';
            
            if (!study.data.glossary || study.data.glossary.length === 0) {
                html += `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üìñ</div>
                        <h3>Nessun termine nel glossario</h3>
                        <p style="margin-top: 10px; color: #666;">
                            I termini chiave verranno estratti automaticamente dal contenuto.
                        </p>
                    </div>
                `;
            } else {
                (study.data.glossary || []).forEach((item, i) => {
                    const glossaryId = `glossary_${i}`;
                    const hasExample = study.data.glossaryExamples && study.data.glossaryExamples[i];
                    
                    html += `
                        <div class="highlight-item" data-term="${item.term.toLowerCase()}" onclick="toggleHighlight('${glossaryId}')">
                            <div class="highlight-header">
                                <div class="highlight-title">
                                    <strong style="color: var(--secondary); font-size: 1.1em;">${item.term}</strong>
                                </div>
                                <span class="highlight-icon" id="${glossaryId}_icon">‚ñº</span>
                            </div>
                            
                            <div class="highlight-details" id="${glossaryId}_details">
                                <p style="margin-bottom: 15px;"><strong>Definizione:</strong> ${item.definition}</p>
                                
                                ${hasExample ? `
                                    <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; margin-top: 10px;">
                                        <strong style="color: var(--primary);">üí° Esempio pratico:</strong>
                                        <p style="margin-top: 8px;">${study.data.glossaryExamples[i]}</p>
                                    </div>
                                ` : `
                                    <button class="generate-btn" onclick="generateGlossaryExample(${i}, event)">
                                        üí° Genera Esempio Pratico
                                    </button>
                                `}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        function filterGlossary() {
            const searchTerm = document.getElementById('glossarySearch').value.toLowerCase();
            const items = document.querySelectorAll('#glossaryContent .highlight-item');
            items.forEach(item => {
                const term = item.getAttribute('data-term');
                item.style.display = term.includes(searchTerm) ? 'block' : 'none';
            });
        }

        async function generateGlossaryExample(index, event) {
            event.stopPropagation();
            
            const study = getCurrentStudy();
            const glossaryItem = study.data.glossary[index];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generazione esempio...';
            
            try {
                const prompt = `Fornisci un esempio pratico e concreto per questo termine:\n\nTermine: ${glossaryItem.term}\nDefinizione: ${glossaryItem.definition}\n\nMateria: ${study.subject}\n\nL'esempio deve essere:\n- Pratico e dalla vita reale\n- Facile da ricordare\n- Collegato alla materia di studio\n- Massimo 3 frasi`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                if (!study.data.glossaryExamples) {
                    study.data.glossaryExamples = {};
                }
                study.data.glossaryExamples[index] = data.response;
                
                saveStudies();
                renderGlossary();
                
                setTimeout(() => {
                    toggleHighlight(`glossary_${index}`);
                }, 100);
                
            } catch (error) {
                console.error('Errore:', error);
                alert('‚ùå Errore nella generazione: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üí° Genera Esempio Pratico';
            }
        }

        function renderTimeline() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let timeline = study.data.timeline || [];
            
            if (timeline.length === 0 && study.data.highlights && study.data.highlights.length > 0) {
                timeline = study.data.highlights.slice(0, 8).map((highlight, index) => ({
                    date: `Punto ${index + 1}`,
                    event: highlight,
                    details: `Approfondimento su: ${highlight}`
                }));
            }
            
            if (timeline.length === 0) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                    <h2>${study.name}</h2>
                    <h3>üìÖ Timeline Cronologica</h3>
                    <p style="color: #666; margin-bottom: 20px;">Clicca su ogni evento per vedere i dettagli</p>
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üìÖ</div>
                        <h3>Nessun evento temporale trovato</h3>
                        <p style="margin-top: 10px; color: #666;">
                            Questa lezione non contiene date o eventi cronologici specifici.
                        </p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>üìÖ Timeline Cronologica (${timeline.length} eventi)</h3>
                <p style="color: #666; margin-bottom: 20px;">Clicca su ogni evento per vedere i dettagli</p>
                <div style="position: relative; padding: 20px 0;">
                    <div style="position: absolute; left: 30px; top: 0; bottom: 0; width: 3px; background: linear-gradient(to bottom, var(--primary), var(--secondary));"></div>
            `;
            
            timeline.forEach((item, index) => {
                const itemId = `timeline_${index}`;
                html += `
                    <div style="display: flex; align-items: flex-start; margin: 20px 0; position: relative;">
                        <div style="position: absolute; left: 21px; width: 20px; height: 20px; background: white; border: 4px solid var(--primary); border-radius: 50%; z-index: 1;"></div>
                        <div style="margin-left: 60px; flex: 1;">
                            <div class="timeline-item" onclick="toggleTimelineItem('${itemId}')" style="cursor: pointer; transition: all 0.3s;">
                                <div class="card" style="margin: 0; border-left: 4px solid var(--primary);">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
                                                ${item.date || `Evento ${index + 1}`}
                                            </span>
                                        </div>
                                        <span id="${itemId}_icon" style="font-size: 1.2em; transition: transform 0.3s;">‚ñº</span>
                                    </div>
                                    <p style="margin: 10px 0 0 0; line-height: 1.6; font-weight: 600;">
                                        ${item.event}
                                    </p>
                                    <div id="${itemId}_details" class="timeline-details" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                        <p style="color: #666; line-height: 1.8;">
                                            ${item.details || item.event}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        function toggleTimelineItem(itemId) {
            const details = document.getElementById(`${itemId}_details`);
            const icon = document.getElementById(`${itemId}_icon`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function renderMindMap() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>üß† Mappa Mentale Interattiva</h3>
                <p style="color: #666; margin-bottom: 20px;">Visualizza la struttura gerarchica dei concetti</p>
                
                <div class="mindmap-controls">
                    <button class="mindmap-style-btn ${appState.mindmapStyle === 'mindmap' ? 'active' : ''}" onclick="changeMindmapStyle('mindmap')">
                        üß† Mappa Mentale
                    </button>
                    <button class="mindmap-style-btn ${appState.mindmapStyle === 'flowchart' ? 'active' : ''}" onclick="changeMindmapStyle('flowchart')">
                        üìä Diagramma di Flusso
                    </button>
                </div>
            `;
            
            const mindmapData = study.data.mindmapMermaid;
            
            if (!mindmapData) {
                html += `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üß†</div>
                        <h3>Mappa Mentale non ancora generata</h3>
                        <p style="color: #666; margin: 20px 0;">
                            Genera una mappa mentale interattiva con collegamenti visivi<br>
                            tra i concetti principali della lezione.
                        </p>
                        <button class="btn" onclick="generateMermaidMindmap()">
                            ü§ñ Genera Mappa Mentale Visuale
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <div class="mindmap-container">
                        <div id="mindmapDiagram" class="mermaid">
                            ${mindmapData[appState.mindmapStyle] || mindmapData.mindmap}
                        </div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn" onclick="downloadMindmapImage()">
                            üì• Scarica Immagine
                        </button>
                        <button class="btn" onclick="copyMermaidCode()">
                            üìã Copia Codice Mermaid
                        </button>
                        <button class="btn" onclick="generateMermaidMindmap()">
                            üîÑ Rigenera Mappa
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('contentArea').innerHTML = html;
            
            // Se c'√® una mappa, renderizzala con Mermaid
            if (mindmapData) {
                setTimeout(() => {
                    mermaid.run();
                }, 100);
            }
        }

        function changeMindmapStyle(style) {
            appState.mindmapStyle = style;
            renderMindMap();
        }

        async function generateMermaidMindmap() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>üß† Generazione Mappa Mentale</h3>
                    <p>Sto creando la struttura visuale interattiva...</p>
                </div>
            `;
            
            try {
                const highlights = (study.data.highlights || []).slice(0, 8);
                const glossaryTerms = (study.data.glossary || []).slice(0, 5).map(g => g.term);
                
                const context = `Materia: ${study.subject}
Titolo: ${study.name}
Riassunto: ${study.data.summary_short}
Punti chiave: ${highlights.join(', ')}
Termini importanti: ${glossaryTerms.join(', ')}`;
                
                const prompt = `Crea DUE diagrammi Mermaid per visualizzare i concetti di questa lezione.

${context}

FORMATO 1 - MAPPA MENTALE:
Usa la sintassi Mermaid mindmap. Esempio:
mindmap
  root((Titolo Centrale))
    Ramo 1
      Sottoramo 1.1
      Sottoramo 1.2
    Ramo 2
      Sottoramo 2.1
      Sottoramo 2.2
    Ramo 3
      Sottoramo 3.1

FORMATO 2 - DIAGRAMMA DI FLUSSO:
Usa la sintassi Mermaid flowchart LR. Esempio:
flowchart LR
    A[Concetto Principale] --> B[Concetto 1]
    A --> C[Concetto 2]
    B --> D[Dettaglio 1.1]
    B --> E[Dettaglio 1.2]
    C --> F[Dettaglio 2.1]

Crea diagrammi con 3-4 rami principali e 2-3 sottorami ciascuno. Usa i concetti chiave della lezione.

Rispondi SOLO con i due diagrammi nel formato:
MINDMAP:
[codice mermaid mindmap]

FLOWCHART:
[codice mermaid flowchart]`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                const responseText = data.response;
                
                // Estrai i due formati dalla risposta
                const mindmapMatch = responseText.match(/MINDMAP:\s*([\s\S]*?)(?=FLOWCHART:|$)/i);
                const flowchartMatch = responseText.match(/FLOWCHART:\s*([\s\S]*?)$/i);
                
                let mindmapCode = mindmapMatch ? mindmapMatch[1].trim() : '';
                let flowchartCode = flowchartMatch ? flowchartMatch[1].trim() : '';
                
                // Se non troviamo i pattern, usa l'intera risposta come mindmap
                if (!mindmapCode && !flowchartCode) {
                    mindmapCode = responseText.trim();
                    // Genera un flowchart semplice di default
                    flowchartCode = `flowchart LR
    A[${study.name}] --> B[Concetti Base]
    A --> C[Applicazioni]
    A --> D[Collegamenti]
    B --> E[${highlights[0] || 'Dettaglio 1'}]
    C --> F[${highlights[1] || 'Dettaglio 2'}]
    D --> G[${highlights[2] || 'Dettaglio 3'}]`;
                }
                
                // Salva entrambi i formati
                study.data.mindmapMermaid = {
                    mindmap: mindmapCode,
                    flowchart: flowchartCode
                };
                
                saveStudies();
                renderMindMap();
                
            } catch (error) {
                console.error('Errore:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="error-message">
                        ‚ùå Errore nella generazione: ${error.message}
                        <button class="btn" onclick="renderMindMap()" style="margin-top: 15px;">
                            üîÑ Riprova
                        </button>
                    </div>
                `;
            }
        }

        function downloadMindmapImage() {
            const svg = document.querySelector('#mindmapDiagram svg');
            if (!svg) {
                alert('‚ùå Nessuna mappa da scaricare');
                return;
            }
            
            // Clona l'SVG per modificarlo
            const svgClone = svg.cloneNode(true);
            
            // Aggiungi uno sfondo bianco
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', '100%');
            rect.setAttribute('height', '100%');
            rect.setAttribute('fill', 'white');
            svgClone.insertBefore(rect, svgClone.firstChild);
            
            // Converti in stringa
            const svgData = new XMLSerializer().serializeToString(svgClone);
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const svgUrl = URL.createObjectURL(svgBlob);
            
            // Crea un canvas per convertire in PNG
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Imposta dimensioni
                canvas.width = img.width * 2; // Alta risoluzione
                canvas.height = img.height * 2;
                ctx.scale(2, 2);
                
                // Disegna sfondo bianco
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Disegna l'immagine
                ctx.drawImage(img, 0, 0);
                
                // Scarica come PNG
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `MappaMentale_${getCurrentStudy().name.replace(/[^a-z0-9]/gi, '_')}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    URL.revokeObjectURL(svgUrl);
                    
                    alert('‚úÖ Mappa mentale scaricata come immagine!');
                });
            };
            img.src = svgUrl;
        }

        function copyMermaidCode() {
            const study = getCurrentStudy();
            if (!study || !study.data.mindmapMermaid) return;
            
            const code = study.data.mindmapMermaid[appState.mindmapStyle];
            
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Codice Mermaid copiato! Puoi usarlo in qualsiasi editor Mermaid.');
            }).catch(() => {
                alert('‚ùå Errore nella copia');
            });
        }

        function renderStudyGuide() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>üìò Guida di Studio</h3>
                <p style="color: #666; margin-bottom: 30px;">Domande per saggi, esami orali e scritti</p>
            `;
            
            if (study.data.quiz && study.data.quiz.length > 0) {
                html += `
                    <div class="section">
                        <h3 style="color: var(--primary); margin-top: 30px;">‚ùì Quiz a Risposta Multipla</h3>
                        <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                            Vai alla sezione Quiz per esercitarti con ${study.data.quiz.length} domande
                        </p>
                        <button class="btn" onclick="switchTab('quiz')">
                            üéØ Vai ai Quiz
                        </button>
                    </div>
                `;
            }
            
            html += `
                <div class="section">
                    <h3 style="color: var(--primary); margin-top: 30px;">‚úèÔ∏è Domande per Saggi ed Esami</h3>
                    <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                        Domande aperte che richiedono analisi critica e ragionamento approfondito
                    </p>
            `;
            
            const essayQuestions = study.data.essayQuestions || [];
            
            if (essayQuestions.length === 0) {
                html += `
                    <div class="card" style="text-align: center; padding: 30px;">
                        <p style="color: #999; margin-bottom: 15px;">
                            Nessuna domanda per saggio ancora generata
                        </p>
                        <button class="btn" onclick="generateEssayQuestions()">
                            ü§ñ Genera Domande per Saggio
                        </button>
                    </div>
                `;
            } else {
                essayQuestions.forEach((question, i) => {
                    html += `
                        <div class="question-card">
                            <span class="question-number">Domanda ${i + 1}</span>
                            <div class="question-text">${question}</div>
                        </div>
                    `;
                });
                
                html += `
                    <button class="btn" onclick="generateEssayQuestions()" style="margin-top: 15px;">
                        üîÑ Genera Altre Domande
                    </button>
                `;
            }
            
            html += `</div>`;
            
            if (study.data.glossary && study.data.glossary.length > 0) {
                html += `
                    <div class="section">
                        <h3 style="color: var(--primary); margin-top: 30px;">üìñ Glossario dei Termini</h3>
                        <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                            ${study.data.glossary.length} termini chiave da conoscere
                        </p>
                        <button class="btn" onclick="switchTab('glossary')">
                            üìö Vai al Glossario
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        async function generateEssayQuestions() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>ü§ñ Generazione Domande per Saggio</h3>
                    <p>Sto creando domande di analisi critica...</p>
                </div>
            `;
            
            try {
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nRiassunto: ${study.data.summary_short}\n\nPunti chiave: ${(study.data.highlights || []).slice(0, 5).join(', ')}`;
                
                const prompt = `Genera 5 domande per saggi/esami scr
