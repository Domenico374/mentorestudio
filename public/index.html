<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MentoreStudio - Il tuo mentore personale per lo studio intelligente">
    <title>StudioPro - AI Learning Platform</title>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<!-- NUOVE LIBRERIE PER MULTI-FORMATO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<!-- LIBRERIA OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #0f172a;
            --secondary: #1e293b;
            --accent: #3b82f6;
            --success: #059669;
            --danger: #dc2626;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #fafaf9;
            min-height: 100vh;
            padding: 20px;
        }
        body.dark-mode { background: #0f0f1e; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .header { background: #2a2a3e; color: #e0e0e0; }
        h1 { font-size: 1.8em; color: var(--primary); }
        body.dark-mode h1 { color: var(--accent); }
        .header-controls { display: flex; gap: 10px; }
        .toggle-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .upload-section { background: #2a2a3e; color: #e0e0e0; }
        body.dark-mode #uploadProgress { 
            background: #1a1a2e !important; 
            color: #e0e0e0 !important;
        }
        body.dark-mode #uploadProgress span,
        body.dark-mode #progressText {
            color: #e0e0e0 !important;
        }
        body.dark-mode #fileInfo {
            background: #1a1a2e !important;
            color: #e0e0e0 !important;
            border-left-color: var(--accent) !important;
        }
        /* Badge formati supportati */
        .supported-formats {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .format-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* NUOVI STILI UPLOAD AREA */
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            background: rgba(102, 126, 234, 0.05);
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: var(--secondary);
            transform: translateY(-2px);
        }
        .upload-area.drag-over {
            background: rgba(102, 126, 234, 0.15);
            border-color: var(--accent);
        }
        
        /* ANIMAZIONE BARRA PROGRESSO */
        #uploadProgress {
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #progressBar {
            transition: width 0.5s ease;
        }
        #progressText {
            font-weight: 600;
            color: var(--primary);
        }
        
        input[type="file"], input[type="text"] {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
        }
        body.dark-mode input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .subject-select {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            font-size: 1em;
        }
        body.dark-mode .subject-select { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn.loading {
            background: linear-gradient(90deg, var(--primary), var(--secondary)) !important;
            opacity: 0.9;
            cursor: wait;
            animation: pulse-btn 1.5s ease-in-out infinite;
        }
        @keyframes pulse-btn {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        .btn-delete { background: var(--danger); padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .btn-export { background: #2196F3; padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .tabs { background: #2a2a3e; }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f0f0f0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        body.dark-mode .tab-btn { background: #1a1a2e; color: #e0e0e0; }
        .tab-btn.active { background: var(--primary); color: white; }
        .content-area {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 500px;
        }
        body.dark-mode .content-area { background: #2a2a3e; color: #e0e0e0; }
        .hidden { display: none !important; }
        .section { margin-bottom: 30px; }
        .section h2 { color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        body.dark-mode .section h2 { color: var(--accent); border-color: var(--accent); }
        .card { background: #f5f7ff; padding: 20px; border-radius: 10px; margin: 10px 0; border-left: 4px solid var(--primary); }
        body.dark-mode .card { background: #1a1a2e; border-left-color: var(--accent); }
        .study-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        body.dark-mode .study-item { background: #1a1a2e; }
        .study-item:hover { transform: translateX(5px); background: #e8eaff; }
        .study-info { font-size: 0.9em; color: #666; margin-top: 5px; }
        body.dark-mode .study-info { color: #aaa; }
        .study-left { flex: 1; }
        .study-right { display: flex; gap: 10px; }
        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
        }
        body.dark-mode .search-box { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f0f0f0; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar { background: #e0e0e0; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; transition: width 0.3s; }
        
        .flashcard { 
            perspective: 1000px; 
            min-height: 350px; 
            cursor: pointer; 
            margin: 20px 0; 
            border: 3px solid transparent;
            border-radius: 10px;
        }
        .flashcard.easy { border-color: #4caf50; }
        .flashcard.medium { border-color: #ffa726; }
        .flashcard.difficult { border-color: #f44336; }
        .flashcard-inner { position: relative; width: 100%; min-height: 350px; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard-inner.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; min-height: 350px; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; text-align: center; border-radius: 10px; }
        .flashcard-front { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .flashcard-back { background: linear-gradient(135deg, var(--accent), #f5576c); color: white; transform: rotateY(180deg); }
        .flashcard-question { font-size: 1.3em; font-weight: bold; margin-bottom: 15px; }
        .flashcard-answer { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; }
        .flashcard-extra { 
            font-size: 0.9em; 
            margin-top: 15px; 
            padding-top: 15px; 
            border-top: 2px solid rgba(255,255,255,0.3);
            text-align: left;
            width: 100%;
            line-height: 1.6;
        }
        .flashcard-extra-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .expand-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            margin: 5px;
            transition: all 0.3s;
        }
        .expand-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        .controls { display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
        .quiz-option { 
            background: #f5f7ff; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: all 0.3s;
        }
        body.dark-mode .quiz-option { background: #1a1a2e; }
        .quiz-option:hover { background: #e8eaff; transform: translateX(5px); }
        .quiz-option.selected { border-color: var(--primary); background: #e8eaff; }
        .quiz-option.correct { border-color: var(--success); background: #c8e6c9; }
        .quiz-option.incorrect { border-color: var(--danger); background: #ffcdd2; }
        .timer-display {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 10px;
            margin: 20px 0;
        }
        .timer-display.warning {
            background: linear-gradient(135deg, #ffa726, #fb8c00);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .note-section { background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ffc107; }
        body.dark-mode .note-section { background: #3d3d1a; color: #e0e0e0; }
        .note-input { width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9em; }
        body.dark-mode .note-input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .key-concept { 
            display: inline-block; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px; 
            margin: 3px; 
            font-size: 0.95em;
            font-weight: 600;
        }
        .back-btn { display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--primary); margin-bottom: 20px; font-weight: bold; }
        body.dark-mode .back-btn { color: var(--accent); }
        .review-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
        .review-item.wrong { border-left-color: var(--danger); background: #ffebee; }
        .review-item.correct { border-left-color: var(--success); background: #e8f5e9; }

        .highlight-item {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .highlight-item { background: #1a1a2e; }
        .highlight-item:hover { transform: translateX(5px); background: #e8eaff; }
        body.dark-mode .highlight-item:hover { background: #2a2a3e; }
        .highlight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        .highlight-title {
            flex: 1;
            font-weight: 600;
            line-height: 1.6;
        }
        .highlight-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        .highlight-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(102, 126, 234, 0.2);
            color: #555;
            line-height: 1.8;
            display: none;
        }
        body.dark-mode .highlight-details { color: #bbb; border-top-color: rgba(240, 147, 251, 0.2); }
        .generate-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* CHAT STYLES */
        .chat-container { display: flex; flex-direction: column; height: 600px; max-height: 70vh; }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        body.dark-mode .chat-messages { background: #1a1a2e; }
        .chat-message { display: flex; gap: 10px; animation: slideIn 0.3s ease; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.user { flex-direction: row-reverse; }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }
        .chat-message.user .chat-avatar { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .chat-message.ai .chat-avatar { background: linear-gradient(135deg, var(--accent), #f5576c); color: white; }
        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-bottom-right-radius: 5px;
        }
        .chat-message.ai .chat-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        body.dark-mode .chat-message.ai .chat-bubble { background: #2a2a3e; color: #e0e0e0; }
        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        body.dark-mode .chat-input-container { background: #2a2a3e; }
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
            resize: none;
            font-family: inherit;
        }
        body.dark-mode .chat-input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .chat-send-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .chat-send-btn:disabled { background: #ccc; cursor: not-allowed; }
        .typing-indicator { display: flex; gap: 5px; padding: 10px; }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        .chat-context-info {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            font-size: 0.9em;
        }
        body.dark-mode .chat-context-info { background: rgba(102, 126, 234, 0.2); }
        .chat-suggestions { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .chat-suggestion {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .chat-suggestion { background: #1a1a2e; color: #e0e0e0; }
        .chat-suggestion:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }
        body.dark-mode .error-message { background: rgba(198, 40, 40, 0.2); color: #ff5252; }

        /* ========== NUOVE 4 CARDS - INTEGRAZIONE COMPLETA ========== */
        .category-selection {
            display: none;
        }
        
        .category-selection.active {
            display: block;
        }
        
        .category-title-section {
            text-align: center;
            margin-bottom: 48px;
        }
        
        .category-main-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        body.dark-mode .category-main-title {
            color: var(--accent);
        }
        
        .category-subtitle {
            font-size: 16px;
            color: #6b7280;
        }
        
        body.dark-mode .category-subtitle {
            color: #9ca3af;
        }
        
        .back-navigation {
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: var(--secondary);
            transform: translateX(-2px);
        }
        
        .back-btn.hidden {
            display: none;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .category-card {
            background: white;
            border-radius: 24px;
            padding: 48px 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .category-card {
            background: #2a2a3e;
        }
        
        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.9;
            z-index: 0;
            transition: opacity 0.3s;
        }
        
        .category-card:hover::before {
            opacity: 1;
        }
        
        .category-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.12);
        }
        
        .category-card.comprendi::before {
            background: linear-gradient(135deg, #d4f1e8 0%, #bae8d4 100%);
        }
        
        .category-card.memorizza::before {
            background: linear-gradient(135deg, #e8d4f1 0%, #d4bae8 100%);
        }
        
        .category-card.approfondisci::before {
            background: linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 100%);
        }
        
        .category-card.personalizza::before {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        }
        
        .category-card-content {
            position: relative;
            z-index: 1;
        }
        
        .category-card-icon {
            font-size: 64px;
            margin-bottom: 16px;
            display: block;
        }
        
        .category-card-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .category-card-description {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .category-grid {
                grid-template-columns: 1fr;
                max-width: 400px;
            }
            
            .category-main-title {
                font-size: 24px;
            }
            
            .category-card {
                padding: 40px 24px;
            }
            
            .category-card-icon {
                font-size: 56px;
            }
            
            .category-card-title {
                font-size: 20px;
            }
        }
        /* ========== FINE NUOVE 4 CARDS ========== */

        
        /* STUDY GUIDE & CONCEPT ANALYSIS STYLES */
        .question-card {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }
        body.dark-mode .question-card { background: #1a1a2e; }
        .question-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .question-number {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.85em;
            display: inline-block;
            margin-bottom: 10px;
        }
        .question-text {
            font-size: 1.05em;
            line-height: 1.7;
            margin-top: 10px;
            color: #333;
        }
        body.dark-mode .question-text { color: #e0e0e0; }
        .pillar-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05));
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid var(--primary);
            transition: all 0.3s;
        }
        body.dark-mode .pillar-card { background: rgba(102, 126, 234, 0.15); }
        .pillar-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .pillar-title {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        body.dark-mode .pillar-title { color: var(--accent); }
        .pillar-icon {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }
        .pillar-content {
            line-height: 1.8;
            color: #444;
            font-size: 1.05em;
        }
        body.dark-mode .pillar-content { color: #ccc; }
        .connection-box {
            background: rgba(240, 147, 251, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 3px solid var(--accent);
        }
        body.dark-mode .connection-box { background: rgba(240, 147, 251, 0.15); }
        
        /* CUSTOM FORMAT STYLES */
        .format-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        .format-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05));
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            text-align: center;
        }
        body.dark-mode .format-card { background: rgba(102, 126, 234, 0.15); }
        .format-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }
        .format-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .format-title {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }
        body.dark-mode .format-title { color: var(--accent); }
        .format-desc {
            font-size: 0.9em;
            color: #666;
            line-height: 1.5;
        }
        body.dark-mode .format-desc { color: #aaa; }
        .custom-input-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .custom-input-box { background: #2a2a3e; }
        .custom-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }
        body.dark-mode .custom-textarea { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .result-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1.05em;
        }
        body.dark-mode .result-box { background: #1a1a2e; color: #e0e0e0; }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .history-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid var(--secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .history-item { background: #1a1a2e; }
        .history-item:hover { transform: translateX(5px); background: #e8eaff; }
        body.dark-mode .history-item:hover { background: #2a2a3e; }
        .history-meta {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
        }

        /* MINDMAP STYLES */
        .mindmap-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
        }
        body.dark-mode .mindmap-container { background: #1a1a2e; }
        .mindmap-tree {
            font-family: 'Courier New', monospace;
            line-height: 2;
            font-size: 1.05em;
        }
        .mindmap-node {
            margin-left: 20px;
            padding: 5px 0;
        }
        .mindmap-root {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
        }
        body.dark-mode .mindmap-root { color: var(--accent); }
        .mindmap-branch {
            color: var(--secondary);
            font-weight: 600;
        }
        body.dark-mode .mindmap-branch { color: #f093fb; }
        .mindmap-leaf {
            color: #555;
        }
        body.dark-mode .mindmap-leaf { color: #aaa; }
    
/* === LOGO BADGE ESAGONALE === */
.logo-container {
    display: flex;
    align-items: center;
    gap: 14px;
}
.logo-badge {
    width: 48px;
    height: 48px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}
.logo-hexagon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
    clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
}
.logo-initials {
    color: white;
    font-weight: 700;
    font-size: 16px;
    letter-spacing: 1px;
}
.logo-text {
    display: flex;
    flex-direction: column;
    gap: 3px;
}
.logo-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--primary);
    letter-spacing: -0.03em;
    line-height: 1;
}
.logo-tagline {
    font-size: 10px;
    font-weight: 600;
    color: #64748b;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}
body.dark-mode .logo-title { color: white; }
body.dark-mode .logo-tagline { color: #94a3b8; }
body.dark-mode .logo-hexagon {
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
}


/* === STEP 1: ENHANCED STUDY CARDS === */
.study-item {
    position: relative !important;
    padding: 20px 24px !important;
    margin: 12px 0 !important;
    border: 1px solid #e5e5e5 !important;
    border-radius: 12px !important;
    background: white !important;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
    overflow: hidden !important;
}

.study-item::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, #3b82f6 0%, #3b82f6 var(--progress, 0%), #e5e5e5 var(--progress, 0%), #e5e5e5 100%);
    transition: all 0.3s ease;
}

.study-item:hover {
    transform: translateY(-4px) !important;
    box-shadow: 0 12px 24px rgba(0,0,0,0.08) !important;
    border-color: #3b82f6 !important;
}

.study-status {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    transition: all 0.2s ease;
}

.study-status.new {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
}

.study-status.in-progress {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #bfdbfe;
}

.study-status.completed {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.study-item:hover .study-status {
    transform: scale(1.05);
}

.study-left {
    flex: 1;
    padding-right: 100px;
}

.study-progress-text {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-weight: 500;
    color: #3b82f6;
    font-size: 12px;
    margin-top: 4px;
}

.study-cta {
    padding: 8px 16px !important;
    background: var(--primary) !important;
    color: white !important;
    border: none !important;
    border-radius: 6px !important;
    font-weight: 500 !important;
    font-size: 14px !important;
    transition: all 0.2s ease !important;
}

.study-cta:hover {
    transform: translateX(2px) !important;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
}

.study-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

@keyframes slideInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.study-item {
    animation: slideInUp 0.3s ease backwards;
}

.study-item:nth-child(1) { animation-delay: 0.05s; }
.study-item:nth-child(2) { animation-delay: 0.1s; }
.study-item:nth-child(3) { animation-delay: 0.15s; }


/* === STEP 2: ZEN STUDY MODE === */
.content-area {
    max-width: 900px !important;
    margin: 0 auto !important;
    padding: 48px 40px !important;
    background: #fafaf9 !important;
    min-height: calc(100vh - 120px) !important;
}

body.dark-mode .content-area {
    background: #0a0a0a !important;
}

.content-area h2 {
    font-size: 28px !important;
    font-weight: 700 !important;
    letter-spacing: -0.03em !important;
    line-height: 1.2 !important;
    margin-bottom: 12px !important;
}

.content-area h3 {
    font-size: 20px !important;
    font-weight: 600 !important;
    letter-spacing: -0.02em !important;
    margin-top: 32px !important;
    margin-bottom: 16px !important;
}

.content-area p,
.content-area li {
    font-size: 17px !important;
    line-height: 1.8 !important;
    color: #3f3f46 !important;
    margin-bottom: 16px !important;
}

body.dark-mode .content-area p,
body.dark-mode .content-area li {
    color: #d4d4d4 !important;
}

.card {
    background: white !important;
    border: 1px solid #e5e5e5 !important;
    border-radius: 12px !important;
    padding: 28px 32px !important;
    margin: 24px 0 !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04) !important;
}

body.dark-mode .card {
    background: #0f0f0f !important;
    border-color: #262626 !important;
}

.highlight-item {
    background: white !important;
    border: 1px solid #e5e5e5 !important;
    border-left: 4px solid #3b82f6 !important;
    border-radius: 8px !important;
    padding: 24px 28px !important;
    margin: 20px 0 !important;
}

.highlight-item:hover {
    border-left-color: #2563eb !important;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.08) !important;
}

body.dark-mode .highlight-item {
    background: #0f0f0f !important;
    border-color: #262626 !important;
}

.highlight-title {
    font-size: 17px !important;
    font-weight: 600 !important;
    line-height: 1.6 !important;
    margin-bottom: 12px !important;
}

.highlight-details {
    font-size: 16px !important;
    line-height: 1.8 !important;
    color: #52525b !important;
    margin-top: 16px !important;
    padding-top: 16px !important;
    border-top: 1px solid #f4f4f5 !important;
}

body.dark-mode .highlight-details {
    color: #a1a1aa !important;
    border-top-color: #262626 !important;
}

.study-breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #71717a;
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 1px solid #f4f4f5;
}

.study-breadcrumb a {
    color: #3b82f6;
    text-decoration: none;
}

.study-breadcrumb a:hover {
    color: #2563eb;
}

.back-btn {
    display: inline-flex !important;
    align-items: center !important;
    gap: 8px !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    color: #71717a !important;
    margin-bottom: 24px !important;
    padding: 8px 12px !important;
    border-radius: 6px !important;
}

.back-btn:hover {
    color: var(--primary) !important;
    background: #f8fafc !important;
}

.section {
    margin-bottom: 48px !important;
}

.study-focus-mode {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.category-card {
    background: white !important;
    border: 1px solid #e5e5e5 !important;
    border-radius: 16px !important;
    padding: 32px 28px !important;
}

.category-card:hover {
    border-color: #3b82f6 !important;
    box-shadow: 0 8px 24px rgba(0,0,0,0.06) !important;
    transform: translateY(-4px) !important;
}

body.dark-mode .category-card {
    background: #0f0f0f !important;
    border-color: #262626 !important;
}

@media (max-width: 768px) {
    .content-area {
        padding: 32px 20px !important;
    }
    .content-area p,
    .content-area li {
        font-size: 16px !important;
    }
}


/* === STEP 3: BADGE PRO DISCRETO === */
.pro-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
    transition: all 0.2s ease;
}

.pro-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.pro-badge-icon {
    font-size: 12px;
}

body.dark-mode .pro-badge {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
}

body.dark-mode .pro-badge:hover {
    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
}


/* === ENHANCEMENTS 1-5 === */

/* === ENHANCEMENT 1: ANIMAZIONI PREMIUM === */

/* Skeleton Loading */
.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
    border-radius: 8px;
}

@keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.skeleton-card {
    height: 120px;
    margin: 12px 0;
}

.skeleton-text {
    height: 20px;
    margin: 8px 0;
}

.skeleton-text.short {
    width: 60%;
}

body.dark-mode .skeleton {
    background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
    background-size: 200% 100%;
}

/* Progress Bar Animata */
.progress-bar-animated {
    position: relative;
    overflow: hidden;
}

.progress-bar-animated::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Smooth Page Transitions */
.page-transition-enter {
    animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Parallax Effect Discreto */
.parallax-container {
    perspective: 1000px;
}

.parallax-item {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.parallax-item:hover {
    transform: translateZ(10px) scale(1.02);
}

/* Button Ripple Effect */
.btn-ripple {
    position: relative;
    overflow: hidden;
}

.btn-ripple::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255,255,255,0.5);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn-ripple:active::after {
    width: 300px;
    height: 300px;
}

/* Loading Spinner Premium */
.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f0f0f0;
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Pulse Animation */
.pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

/* Bounce Animation */
.bounce {
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

/* Success Checkmark Animation */
.success-checkmark {
    width: 80px;
    height: 80px;
    margin: 0 auto;
    border-radius: 50%;
    display: block;
    stroke-width: 3;
    stroke: #4caf50;
    stroke-miterlimit: 10;
    box-shadow: inset 0 0 0 #4caf50;
    animation: fill-success 0.4s ease-in-out 0.4s forwards, scale-success 0.3s ease-in-out 0.9s both;
}

.success-checkmark-circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 3;
    stroke-miterlimit: 10;
    stroke: #4caf50;
    fill: none;
    animation: stroke-success 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}

.success-checkmark-check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: stroke-success 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke-success {
    100% {
        stroke-dashoffset: 0;
    }
}

@keyframes scale-success {
    0%, 100% {
        transform: none;
    }
    50% {
        transform: scale3d(1.1, 1.1, 1);
    }
}

@keyframes fill-success {
    100% {
        box-shadow: inset 0 0 0 60px #4caf50;
    }
}

/* Stagger Animation for Lists */
.stagger-item {
    animation: fadeInUp 0.4s ease backwards;
}

.stagger-item:nth-child(1) { animation-delay: 0.05s; }
.stagger-item:nth-child(2) { animation-delay: 0.1s; }
.stagger-item:nth-child(3) { animation-delay: 0.15s; }
.stagger-item:nth-child(4) { animation-delay: 0.2s; }
.stagger-item:nth-child(5) { animation-delay: 0.25s; }
.stagger-item:nth-child(6) { animation-delay: 0.3s; }
.stagger-item:nth-child(7) { animation-delay: 0.35s; }
.stagger-item:nth-child(8) { animation-delay: 0.4s; }

/* === ENHANCEMENT 2: TOOLTIP E MICROCOPYING === */

/* Tooltip Base */
[data-tooltip] {
    position: relative;
    cursor: help;
}

[data-tooltip]::before,
[data-tooltip]::after {
    position: absolute;
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
}

[data-tooltip]::before {
    content: attr(data-tooltip);
    background: var(--primary);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%) translateY(-4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

[data-tooltip]::after {
    content: '';
    border: 6px solid transparent;
    border-top-color: var(--primary);
    bottom: calc(100% + 2px);
    left: 50%;
    transform: translateX(-50%);
}

[data-tooltip]:hover::before,
[data-tooltip]:hover::after {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

body.dark-mode [data-tooltip]::before {
    background: white;
    color: var(--primary);
}

body.dark-mode [data-tooltip]::after {
    border-top-color: white;
}

/* Tips Contestuali */
.context-tip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 12px 16px;
    background: #eff6ff;
    border-left: 3px solid #3b82f6;
    border-radius: 8px;
    margin: 16px 0;
    font-size: 14px;
    line-height: 1.6;
    color: #1e40af;
}

.context-tip-icon {
    font-size: 16px;
    flex-shrink: 0;
}

body.dark-mode .context-tip {
    background: rgba(59, 130, 246, 0.1);
    color: #93c5fd;
    border-left-color: #60a5fa;
}

/* Empty State Enhanced */
.empty-state {
    text-align: center;
    padding: 80px 40px;
    animation: fadeIn 0.4s ease;
}

.empty-state-icon {
    font-size: 80px;
    margin-bottom: 24px;
    opacity: 0.3;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.empty-state-title {
    font-size: 24px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 12px;
}

.empty-state-description {
    font-size: 16px;
    color: #71717a;
    margin-bottom: 32px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.6;
}

/* Onboarding Hints */
.onboarding-hint {
    position: relative;
    animation: pulse-hint 2s infinite;
}

@keyframes pulse-hint {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
    }
    50% {
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
    }
}

.hint-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ef4444;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    animation: bounce 1s infinite;
}

/* === ENHANCEMENT 3: FILTRI E SORTING === */

/* Filter Bar */
.filter-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

body.dark-mode .filter-bar {
    background: #0f0f0f;
    border-color: #262626;
}

.filter-select {
    padding: 8px 12px;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    background: white;
    color: var(--primary);
    cursor: pointer;
    transition: all 0.15s ease;
}

.filter-select:hover {
    border-color: var(--accent);
}

.filter-select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

body.dark-mode .filter-select {
    background: #1a1a1a;
    border-color: #2a2a2a;
    color: white;
}

/* Sort Buttons */
.sort-group {
    display: flex;
    gap: 4px;
    background: #f8fafc;
    padding: 4px;
    border-radius: 8px;
}

body.dark-mode .sort-group {
    background: #1a1a1a;
}

.sort-btn {
    padding: 6px 12px;
    border: none;
    background: transparent;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    color: #71717a;
    cursor: pointer;
    transition: all 0.15s ease;
}

.sort-btn:hover {
    background: white;
    color: var(--primary);
}

.sort-btn.active {
    background: white;
    color: var(--primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

body.dark-mode .sort-btn:hover,
body.dark-mode .sort-btn.active {
    background: #2a2a2a;
    color: white;
}

/* View Mode Toggle */
.view-mode-toggle {
    display: flex;
    gap: 4px;
    background: #f8fafc;
    padding: 4px;
    border-radius: 8px;
    margin-left: auto;
}

body.dark-mode .view-mode-toggle {
    background: #1a1a1a;
}

.view-mode-btn {
    padding: 8px;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.view-mode-btn:hover {
    background: white;
}

.view-mode-btn.active {
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

body.dark-mode .view-mode-btn:hover,
body.dark-mode .view-mode-btn.active {
    background: #2a2a2a;
}

/* Grid View */
.studies-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
}

.study-item-grid {
    display: flex;
    flex-direction: column;
    height: 100%;
}

/* Tag System */
.tag {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    background: #f8fafc;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    color: #64748b;
    margin: 2px;
}

.tag-removable {
    cursor: pointer;
    transition: all 0.15s ease;
}

.tag-removable:hover {
    background: #fee2e2;
    border-color: #fecaca;
    color: #dc2626;
}

body.dark-mode .tag {
    background: #1a1a1a;
    border-color: #2a2a2a;
    color: #a1a1aa;
}

body.dark-mode .tag-removable:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: #dc2626;
    color: #f87171;
}

/* Active Filter Chips */
.active-filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
}

.filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: #3b82f6;
    color: white;
    border-radius: 16px;
    font-size: 13px;
    font-weight: 500;
}

.filter-chip-remove {
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.15s ease;
}

.filter-chip-remove:hover {
    opacity: 1;
}

/* === ENHANCEMENT 4: STATS E DASHBOARD === */

/* Stats Overview */
.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
}

.stat-card {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

body.dark-mode .stat-card {
    background: #0f0f0f;
    border-color: #262626;
}

.stat-label {
    font-size: 13px;
    font-weight: 500;
    color: #71717a;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--primary);
    letter-spacing: -0.02em;
}

body.dark-mode .stat-value {
    color: white;
}

.stat-change {
    font-size: 12px;
    font-weight: 500;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.stat-change.positive {
    color: #059669;
}

.stat-change.negative {
    color: #dc2626;
}

/* Progress Chart */
.progress-chart {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
}

body.dark-mode .progress-chart {
    background: #0f0f0f;
    border-color: #262626;
}

.chart-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 20px;
}

body.dark-mode .chart-title {
    color: white;
}

.chart-bars {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    height: 200px;
    padding: 20px 0;
}

.chart-bar {
    flex: 1;
    background: linear-gradient(180deg, #3b82f6 0%, #60a5fa 100%);
    border-radius: 6px 6px 0 0;
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
}

.chart-bar:hover {
    opacity: 0.8;
    transform: scaleY(1.05);
}

.chart-bar-value {
    position: absolute;
    top: -24px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: 600;
    color: var(--primary);
    opacity: 0;
    transition: opacity 0.2s ease;
}

.chart-bar:hover .chart-bar-value {
    opacity: 1;
}

.chart-labels {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.chart-label {
    flex: 1;
    text-align: center;
    font-size: 11px;
    color: #71717a;
    font-weight: 500;
}

/* Streak Counter */
.streak-card {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border-radius: 16px;
    padding: 24px;
    position: relative;
    overflow: hidden;
}

.streak-card::before {
    content: '';
    position: absolute;
    top: -20px;
    right: -20px;
    font-size: 120px;
    opacity: 0.2;
}

.streak-value {
    font-size: 48px;
    font-weight: 700;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
}

.streak-label {
    font-size: 14px;
    font-weight: 500;
    opacity: 0.9;
    position: relative;
    z-index: 1;
}

/* Achievement Badges */
.achievements {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 12px;
    margin-top: 24px;
}

.achievement-badge {
    background: white;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
}

.achievement-badge:hover {
    border-color: #3b82f6;
    transform: translateY(-2px);
}

.achievement-badge.locked {
    opacity: 0.4;
    filter: grayscale(100%);
}

body.dark-mode .achievement-badge {
    background: #0f0f0f;
    border-color: #262626;
}

.achievement-icon {
    font-size: 32px;
    margin-bottom: 8px;
}

.achievement-name {
    font-size: 11px;
    font-weight: 600;
    color: var(--primary);
}

body.dark-mode .achievement-name {
    color: white;
}

/* Activity Heatmap */
.activity-heatmap {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-top: 16px;
}

.heatmap-cell {
    aspect-ratio: 1;
    background: #f0f0f0;
    border-radius: 3px;
    transition: all 0.2s ease;
    cursor: pointer;
}

.heatmap-cell:hover {
    transform: scale(1.1);
}

.heatmap-cell.level-0 { background: #f0f0f0; }
.heatmap-cell.level-1 { background: #c7d2fe; }
.heatmap-cell.level-2 { background: #93c5fd; }
.heatmap-cell.level-3 { background: #60a5fa; }
.heatmap-cell.level-4 { background: #3b82f6; }

body.dark-mode .heatmap-cell.level-0 { background: #1a1a1a; }

/* === ENHANCEMENT 5: MOBILE EXPERIENCE === */

/* Bottom Navigation Mobile */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid #e5e5e5;
    padding: 8px 16px 12px;
    display: none;
    z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
}

body.dark-mode .bottom-nav {
    background: #0f0f0f;
    border-top-color: #262626;
}

.bottom-nav-items {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.bottom-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    color: #71717a;
    text-decoration: none;
    transition: all 0.2s ease;
    border-radius: 12px;
    flex: 1;
    max-width: 80px;
}

.bottom-nav-item:active {
    background: #f8fafc;
    transform: scale(0.95);
}

.bottom-nav-item.active {
    color: var(--accent);
}

body.dark-mode .bottom-nav-item:active {
    background: #1a1a1a;
}

.bottom-nav-icon {
    font-size: 22px;
}

.bottom-nav-label {
    font-size: 11px;
    font-weight: 500;
}

/* FAB - Floating Action Button */
.fab {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 24px;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 999;
}

.fab:active {
    transform: scale(0.9);
}

.fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
}

/* Swipe Indicators */
.swipe-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    background: rgba(0,0,0,0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
}

.swipe-indicator.left {
    left: 20px;
}

.swipe-indicator.right {
    right: 20px;
}

.swipeable:hover .swipe-indicator {
    opacity: 1;
}

/* Touch-Optimized Spacing */
@media (max-width: 768px) {
    .bottom-nav,
    .fab {
        display: flex;
    }
    
    body {
        padding-bottom: 80px;
    }
    
    .header {
        position: sticky;
        top: 0;
        z-index: 100;
        margin-bottom: 12px !important;
    }
    
    .btn,
    .tab-btn,
    .filter-select {
        min-height: 44px;
        min-width: 44px;
    }
    
    .study-item {
        padding: 16px !important;
    }
    
    .study-status {
        top: 8px !important;
        right: 8px !important;
    }
    
    .study-actions {
        flex-direction: column;
        width: 100%;
        gap: 8px;
    }
    
    .study-cta {
        width: 100%;
        justify-content: center;
    }
    
    .filter-bar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .view-mode-toggle {
        margin-left: 0;
        justify-content: center;
    }
    
    .stats-overview {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .chart-bars {
        height: 150px;
    }
}

/* Tablet Optimizations */
@media (min-width: 769px) and (max-width: 1024px) {
    .studies-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stats-overview {
        grid-template-columns: repeat(3, 1fr);
    }
}

/* Pull to Refresh */
.pull-to-refresh {
    position: relative;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.pull-indicator {
    position: absolute;
    top: -60px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.pull-to-refresh.pulling .pull-indicator {
    top: 20px;
}

/* Safe Area Insets for Notched Devices */
@supports (padding: max(0px)) {
    .header {
        padding-left: max(24px, env(safe-area-inset-left));
        padding-right: max(24px, env(safe-area-inset-right));
    }
    
    .bottom-nav {
        padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
}

/* Landscape Mode Adjustments */
@media (max-height: 500px) and (orientation: landscape) {
    .bottom-nav {
        display: none;
    }
    
    .fab {
        bottom: 20px;
    }
    
    body {
        padding-bottom: 0;
    }
}


/* === ENHANCEMENTS 6-10 === */

/* === ENHANCEMENT 6: DARK MODE PERFEZIONATO === */

/* True Black for OLED */
body.dark-mode.true-black {
    background: #000000 !important;
}

body.dark-mode.true-black .content-area {
    background: #000000 !important;
}

body.dark-mode.true-black .card,
body.dark-mode.true-black .study-item,
body.dark-mode.true-black .category-card {
    background: #0a0a0a !important;
    border-color: #1a1a1a !important;
}

/* Smooth Transition */
body,
.header,
.content-area,
.card,
.study-item,
.category-card,
.btn,
.tab-btn {
    transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

/* Dark Mode Toggle Enhanced */
.dark-mode-options {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: none;
    z-index: 1000;
    min-width: 200px;
}

body.dark-mode .dark-mode-options {
    background: #1a1a1a;
    border-color: #2a2a2a;
}

.dark-mode-options.show {
    display: block;
    animation: fadeInDown 0.2s ease;
}

@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.dark-mode-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s ease;
    font-size: 14px;
}

.dark-mode-option:hover {
    background: #f8fafc;
}

body.dark-mode .dark-mode-option:hover {
    background: #2a2a2a;
}

.dark-mode-option.active {
    background: #eff6ff;
    color: var(--accent);
}

body.dark-mode .dark-mode-option.active {
    background: rgba(59, 130, 246, 0.1);
}

.dark-mode-option-icon {
    font-size: 18px;
}

.dark-mode-option-text {
    flex: 1;
}

/* Schedule Indicator */
.schedule-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    background: rgba(59, 130, 246, 0.1);
    color: var(--accent);
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    margin-left: 8px;
}

/* Improved Contrast */
body.dark-mode .highlight-details,
body.dark-mode .study-info {
    color: #c7c7c7 !important;
}

body.dark-mode .content-area p,
body.dark-mode .content-area li {
    color: #e0e0e0 !important;
}

/* === ENHANCEMENT 7: EXPORT E SHARING === */

/* Export Menu */
.export-menu {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    padding: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: none;
    z-index: 1000;
    min-width: 180px;
}

body.dark-mode .export-menu {
    background: #1a1a1a;
    border-color: #2a2a2a;
}

.export-menu.show {
    display: block;
    animation: fadeInDown 0.2s ease;
}

.export-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s ease;
    font-size: 14px;
    color: var(--primary);
}

.export-option:hover {
    background: #f8fafc;
}

body.dark-mode .export-option {
    color: white;
}

body.dark-mode .export-option:hover {
    background: #2a2a2a;
}

.export-option-icon {
    font-size: 16px;
}

/* Share Modal */
.share-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.share-modal.show {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.share-modal-content {
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body.dark-mode .share-modal-content {
    background: #1a1a1a;
}

@keyframes scaleIn {
    from {
        transform: scale(0.9);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

.share-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.share-modal-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--primary);
}

body.dark-mode .share-modal-title {
    color: white;
}

.share-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #71717a;
    padding: 4px;
    line-height: 1;
}

.share-modal-close:hover {
    color: var(--primary);
}

.share-link-box {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
}

.share-link-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    font-size: 14px;
    background: #f8fafc;
}

body.dark-mode .share-link-input {
    background: #0f0f0f;
    border-color: #2a2a2a;
    color: white;
}

.share-copy-btn {
    padding: 12px 20px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
}

.share-copy-btn:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

.share-copy-btn.copied {
    background: #059669;
}

/* Print-Friendly Styles */
@media print {
    .header,
    .tabs,
    .back-btn,
    .btn,
    .study-actions,
    .bottom-nav,
    .fab,
    .pro-badge {
        display: none !important;
    }
    
    body {
        background: white !important;
        color: black !important;
    }
    
    .content-area {
        max-width: 100% !important;
        padding: 20px !important;
    }
    
    .card {
        border: 1px solid #ddd !important;
        page-break-inside: avoid;
    }
}

/* QR Code Display */
.qr-code-container {
    text-align: center;
    padding: 20px;
    background: #f8fafc;
    border-radius: 12px;
    margin-top: 20px;
}

body.dark-mode .qr-code-container {
    background: #0f0f0f;
}

.qr-code-image {
    max-width: 200px;
    margin: 0 auto;
}

/* === ENHANCEMENT 8: AI FEATURES ENHANCED === */

/* Smart Suggestions */
.ai-suggestion {
    background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%);
    border: 1px solid #bfdbfe;
    border-left: 4px solid var(--accent);
    border-radius: 12px;
    padding: 16px 20px;
    margin: 16px 0;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    animation: slideInRight 0.4s ease;
}

body.dark-mode .ai-suggestion {
    background: rgba(59, 130, 246, 0.08);
    border-color: rgba(59, 130, 246, 0.3);
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.ai-suggestion-icon {
    font-size: 20px;
    flex-shrink: 0;
    margin-top: 2px;
}

.ai-suggestion-content {
    flex: 1;
}

.ai-suggestion-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 6px;
}

.ai-suggestion-text {
    font-size: 13px;
    color: #64748b;
    line-height: 1.6;
    margin-bottom: 10px;
}

body.dark-mode .ai-suggestion-text {
    color: #a1a1aa;
}

.ai-suggestion-actions {
    display: flex;
    gap: 8px;
}

.ai-suggestion-btn {
    padding: 6px 12px;
    border: 1px solid var(--accent);
    background: transparent;
    color: var(--accent);
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
}

.ai-suggestion-btn:hover {
    background: var(--accent);
    color: white;
}

.ai-suggestion-btn.dismiss {
    border-color: #e5e5e5;
    color: #71717a;
}

.ai-suggestion-btn.dismiss:hover {
    background: #f8fafc;
    color: var(--primary);
}

/* Auto-Category Badge */
.auto-category-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
    color: white;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.3px;
    text-transform: uppercase;
}

/* Difficulty Indicator */
.difficulty-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3px;
}

.difficulty-badge.easy {
    background: #d1fae5;
    color: #065f46;
}

.difficulty-badge.medium {
    background: #fed7aa;
    color: #92400e;
}

.difficulty-badge.hard {
    background: #fecaca;
    color: #991b1b;
}

body.dark-mode .difficulty-badge.easy {
    background: rgba(5, 150, 105, 0.2);
    color: #6ee7b7;
}

body.dark-mode .difficulty-badge.medium {
    background: rgba(251, 146, 60, 0.2);
    color: #fdba74;
}

body.dark-mode .difficulty-badge.hard {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
}

/* AI Processing Indicator */
.ai-processing {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f8fafc;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    font-size: 13px;
    color: #71717a;
}

body.dark-mode .ai-processing {
    background: #1a1a1a;
    border-color: #2a2a2a;
    color: #a1a1aa;
}

.ai-processing-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #e5e5e5;
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

/* Smart Highlights Priority */
.highlight-item.priority-high {
    border-left-width: 6px;
    border-left-color: #dc2626;
}

.highlight-item.priority-medium {
    border-left-width: 5px;
    border-left-color: #f59e0b;
}

.highlight-item.priority-low {
    border-left-width: 4px;
    border-left-color: #3b82f6;
}

/* === ENHANCEMENT 9: ACCESSIBILIT === */

/* Focus Indicators Enhanced */
*:focus {
    outline: 3px solid var(--accent) !important;
    outline-offset: 2px !important;
}

button:focus,
a:focus,
input:focus,
select:focus,
textarea:focus {
    outline: 3px solid var(--accent) !important;
    outline-offset: 2px !important;
}

/* Skip to Content Link */
.skip-to-content {
    position: fixed;
    top: -100px;
    left: 20px;
    background: var(--accent);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    z-index: 10000;
    font-weight: 600;
    transition: top 0.3s ease;
}

.skip-to-content:focus {
    top: 20px;
}

/* Screen Reader Only */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* Keyboard Navigation Hints */
.keyboard-hint {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    background: #f8fafc;
    border: 1px solid #e5e5e5;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    color: #71717a;
    font-family: 'Monaco', 'Courier New', monospace;
}

body.dark-mode .keyboard-hint {
    background: #1a1a1a;
    border-color: #2a2a2a;
    color: #a1a1aa;
}

/* High Contrast Mode */
body.high-contrast {
    background: #ffffff !important;
    color: #000000 !important;
}

body.high-contrast * {
    border-color: #000000 !important;
}

body.high-contrast .btn,
body.high-contrast .card,
body.high-contrast .study-item {
    border: 2px solid #000000 !important;
}

body.high-contrast a,
body.high-contrast .btn {
    color: #0000ff !important;
    text-decoration: underline;
}

body.high-contrast .btn:hover {
    background: #0000ff !important;
    color: #ffffff !important;
}

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* Keyboard Shortcuts Help */
.shortcuts-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.shortcuts-modal.show {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.shortcuts-content {
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

body.dark-mode .shortcuts-content {
    background: #1a1a1a;
}

.shortcuts-grid {
    display: grid;
    gap: 16px;
    margin-top: 24px;
}

.shortcut-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #f8fafc;
    border-radius: 8px;
}

body.dark-mode .shortcut-item {
    background: #0f0f0f;
}

.shortcut-description {
    font-size: 14px;
    color: var(--primary);
}

body.dark-mode .shortcut-description {
    color: white;
}

.shortcut-keys {
    display: flex;
    gap: 4px;
}

/* ARIA Live Region */
.live-region {
    position: absolute;
    left: -10000px;
    width: 1px;
    height: 1px;
    overflow: hidden;
}

/* Focus Trap for Modals */
.modal-open {
    overflow: hidden;
}

/* Larger Touch Targets on Mobile */
@media (max-width: 768px) {
    button,
    a,
    input,
    select {
        min-height: 44px;
        min-width: 44px;
    }
}

/* Contrast Enhancement */
body.enhanced-contrast {
    filter: contrast(1.2);
}

/* Text Spacing Override */
body.relaxed-spacing p,
body.relaxed-spacing li {
    line-height: 2 !important;
    letter-spacing: 0.05em !important;
    word-spacing: 0.1em !important;
}

/* === ENHANCEMENT 10: PERFORMANCE OPTIMIZATION === */

/* Lazy Loading Placeholder */
.lazy-load {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.lazy-load.loaded {
    opacity: 1;
}

.lazy-placeholder {
    background: #f0f0f0;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
}

body.dark-mode .lazy-placeholder {
    background: #1a1a1a;
}

/* Virtual Scroll Container */
.virtual-scroll-container {
    height: 600px;
    overflow-y: auto;
    position: relative;
}

.virtual-scroll-spacer {
    width: 100%;
}

.virtual-scroll-viewport {
    position: relative;
}

/* Content Visibility for Performance */
.content-section {
    content-visibility: auto;
    contain-intrinsic-size: 0 500px;
}

/* Will-Change for Animations */
.animated-element {
    will-change: transform, opacity;
}

.animated-element.animating {
    transform: translateZ(0);
}

/* GPU Acceleration */
.gpu-accelerated {
    transform: translateZ(0);
    backface-visibility: hidden;
    perspective: 1000px;
}

/* Image Optimization */
img {
    content-visibility: auto;
}

img.lazy {
    opacity: 0;
    transition: opacity 0.3s ease;
}

img.lazy.loaded {
    opacity: 1;
}

/* Reduce Layout Shifts */
.aspect-ratio-box {
    position: relative;
    width: 100%;
}

.aspect-ratio-box::before {
    content: '';
    display: block;
    padding-top: 56.25%; /* 16:9 aspect ratio */
}

.aspect-ratio-content {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

/* Optimize Repaints */
.no-repaint {
    contain: layout style paint;
}

/* Defer Non-Critical CSS */
.deferred-content {
    display: none;
}

.deferred-content.loaded {
    display: block;
}

/* Smooth Scrolling with Performance */
.smooth-scroll {
    scroll-behavior: smooth;
}

@media (prefers-reduced-motion: reduce) {
    .smooth-scroll {
        scroll-behavior: auto;
    }
}

/* Intersection Observer Visibility */
.fade-in-viewport {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease, transform 0.6s ease;
}

.fade-in-viewport.visible {
    opacity: 1;
    transform: translateY(0);
}

/* Optimize Shadows */
.optimized-shadow {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.optimized-shadow:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

/* CSS Containment */
.contained-element {
    contain: layout style;
}

/* Reduce JavaScript Reflow */
.no-reflow {
    transform: translateZ(0);
}

/* Debounced Resize Indicator */
.resize-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--accent);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 9999;
}

.resize-indicator.show {
    opacity: 1;
}

/* Loading State Optimization */
.loading-skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
}

/* Reduce Paint Area */
.isolated-layer {
    isolation: isolate;
}


/* === PROFESSIONAL MINDMAP === */

/* === PROFESSIONAL MINDMAP === */

.mindmap-container {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 16px;
    padding: 40px;
    margin: 24px 0;
    min-height: 500px;
    position: relative;
    overflow: hidden;
}

body.dark-mode .mindmap-container {
    background: #0f0f0f;
    border-color: #262626;
}

.mindmap-canvas {
    width: 100%;
    height: 600px;
    position: relative;
    overflow: visible;
}

.mindmap-svg {
    width: 100%;
    height: 100%;
}

/* Nodi della mappa */
.mindmap-node {
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.mindmap-node:hover {
    filter: brightness(1.1);
    transform: scale(1.05);
}

.mindmap-node-circle {
    fill: var(--accent);
    stroke: white;
    stroke-width: 3;
    transition: all 0.3s ease;
}

.mindmap-node.level-0 .mindmap-node-circle {
    fill: var(--primary);
    r: 60;
}

.mindmap-node.level-1 .mindmap-node-circle {
    fill: #3b82f6;
    r: 45;
}

.mindmap-node.level-2 .mindmap-node-circle {
    fill: #60a5fa;
    r: 35;
}

.mindmap-node.level-3 .mindmap-node-circle {
    fill: #93c5fd;
    r: 28;
}

body.dark-mode .mindmap-node-circle {
    stroke: #1a1a1a;
}

.mindmap-node-text {
    fill: white;
    font-size: 13px;
    font-weight: 600;
    text-anchor: middle;
    pointer-events: none;
    user-select: none;
}

.mindmap-node.level-0 .mindmap-node-text {
    font-size: 16px;
    font-weight: 700;
}

/* Connessioni */
.mindmap-connection {
    fill: none;
    stroke: #cbd5e1;
    stroke-width: 2;
    transition: all 0.3s ease;
}

body.dark-mode .mindmap-connection {
    stroke: #3f3f46;
}

.mindmap-connection.active {
    stroke: var(--accent);
    stroke-width: 3;
}

/* Badge contatore */
.mindmap-badge {
    fill: #ef4444;
    stroke: white;
    stroke-width: 2;
}

.mindmap-badge-text {
    fill: white;
    font-size: 10px;
    font-weight: 700;
    text-anchor: middle;
}

/* Tooltip */
.mindmap-tooltip {
    position: absolute;
    background: var(--primary);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-width: 250px;
}

.mindmap-tooltip.show {
    opacity: 1;
}

.mindmap-tooltip-title {
    font-weight: 600;
    margin-bottom: 6px;
}

.mindmap-tooltip-content {
    font-size: 12px;
    opacity: 0.9;
    line-height: 1.5;
}

/* Controlli */
.mindmap-controls {
    position: absolute;
    top: 16px;
    right: 16px;
    display: flex;
    gap: 8px;
    z-index: 10;
}

.mindmap-control-btn {
    width: 36px;
    height: 36px;
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 16px;
}

.mindmap-control-btn:hover {
    background: #f8fafc;
    border-color: var(--accent);
    transform: translateY(-2px);
}

body.dark-mode .mindmap-control-btn {
    background: #1a1a1a;
    border-color: #2a2a2a;
    color: white;
}

body.dark-mode .mindmap-control-btn:hover {
    background: #2a2a2a;
}

/* Animazioni */
@keyframes nodeAppear {
    from {
        opacity: 0;
        transform: scale(0);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.mindmap-node {
    animation: nodeAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1) backwards;
}

.mindmap-node:nth-child(1) { animation-delay: 0.1s; }
.mindmap-node:nth-child(2) { animation-delay: 0.15s; }
.mindmap-node:nth-child(3) { animation-delay: 0.2s; }
.mindmap-node:nth-child(4) { animation-delay: 0.25s; }
.mindmap-node:nth-child(5) { animation-delay: 0.3s; }

@keyframes connectionDraw {
    from {
        stroke-dashoffset: 1000;
    }
    to {
        stroke-dashoffset: 0;
    }
}

.mindmap-connection {
    stroke-dasharray: 1000;
    animation: connectionDraw 0.8s ease forwards;
}

/* Expanded state */
.mindmap-node.collapsed .mindmap-node-children {
    display: none;
}

.mindmap-node.expanded .mindmap-expand-indicator {
    transform: rotate(90deg);
}

/* Legend */
.mindmap-legend {
    position: absolute;
    bottom: 16px;
    left: 16px;
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    padding: 16px;
    display: flex;
    gap: 16px;
    font-size: 12px;
}

body.dark-mode .mindmap-legend {
    background: #1a1a1a;
    border-color: #2a2a2a;
}

.mindmap-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.mindmap-legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

/* Responsive */
@media (max-width: 768px) {
    .mindmap-container {
        padding: 20px;
    }
    
    .mindmap-canvas {
        height: 400px;
    }
    
    .mindmap-controls {
        top: 8px;
        right: 8px;
    }
    
    .mindmap-legend {
        flex-direction: column;
        gap: 8px;
        font-size: 11px;
    }
}

</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo-badge">
                    <div class="logo-hexagon">
                        <span class="logo-initials">SP</span>
                    </div>
                </div>
                <div class="logo-text">
                    <div class="logo-title">StudioPro</div>
                    <div class="logo-tagline">AI Learning Platform</div>
                </div>
            </div>
            <div class="header-controls">
                <span class="pro-badge">
                    <span class="pro-badge-icon"></span>
                    Pro
                </span>
                <button class="toggle-btn" onclick="toggleDarkMode()"></button>
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="supported-formats">
                <div class="format-badge"> PDF</div>
                <div class="format-badge"> TXT</div>
                <div class="format-badge"> DOCX</div>
                <div class="format-badge"> PPTX</div>
                <div class="format-badge"> OCR (JPG/PNG)</div>
            </div>
            
            <div style="max-width: 600px; margin: 30px auto;">
                <label style="font-weight: bold; margin-bottom: 10px; display: block;"> Materia:</label>
                <select id="subjectSelect" class="subject-select">
                    <option value="Generale">Generale</option>
                    <option value="Storia">Storia</option>
                    <option value="Matematica">Matematica</option>
                    <option value="Biologia">Biologia</option>
                    <option value="Diritto">Diritto</option>
                    <option value="Informatica">Informatica</option>
                    <option value="Letteratura">Letteratura</option>
                    <option value="Fisica">Fisica</option>
                    <option value="Chimica">Chimica</option>
                    <option value="Filosofia">Filosofia</option>
                    <option value="Inglese">Inglese</option>
                    <option value="Economia">Economia</option>
                </select>
                
                <!-- NUOVA AREA DI UPLOAD MIGLIORATA -->
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 3em; margin-bottom: 15px;"></div>
                    <p style="font-size: 1.1em; margin-bottom: 15px; font-weight: 500;">Trascina i file qui o clicca per selezionarli</p>
                    <button class="btn" onclick="document.getElementById('pdfFile').click()" style="background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        Scegli file
                    </button>
                    <input type="file" id="pdfFile" accept=".pdf,.txt,.docx,.pptx,image/*" multiple style="display: none;">
                    <p style="font-size: 0.9em; color: #666; margin-top: 15px;">Supporta: PDF, TXT, DOCX, PPTX, JPG, PNG</p>
                </div>
                
                <div id="fileInfo" style="margin: 15px 0; padding: 10px; background: #f5f7ff; border-radius: 8px; border-left: 4px solid var(--primary); display: none;">
                    <strong>File selezionati:</strong>
                    <div id="selectedFilesList"></div>
                </div>
                
                <button class="btn" onclick="loadMultiplePDFs()" style="width: 100%; background: var(--success);" id="uploadBtn" disabled> Carica File</button>
                
                <div id="uploadProgress" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #333;">Caricamento in corso...</span>
                        <span id="progressPercent" style="font-weight: bold; color: var(--primary);">0%</span>
                    </div>
                    <div style="background: #e0e0e0; height: 12px; border-radius: 6px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                        <div id="progressBar" style="background: linear-gradient(90deg, var(--primary), var(--secondary)); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 6px;"></div>
                    </div>
                    <p id="progressText" style="text-align: center; margin-top: 12px; font-size: 0.95em; color: #666; font-weight: 500; min-height: 24px;"></p>
                </div>
            </div>
            
            <p style="font-size: 0.9em; margin-top: 20px; color: #666;">Tutto salvato offline  Nessuna chiave API visibile</p>
        </div>

        <div id="mainApp" class="hidden">
            <!-- ========== NUOVE 4 CARDS - NAVIGAZIONE ========== -->
            <div class="category-selection" id="categorySelection">
                <div class="back-navigation">
                    <button class="back-btn" onclick="showLibrary()"> Torna alla Libreria</button>
                    <button class="back-btn hidden" id="backToCategories" onclick="showCategories()"> Indietro</button>
                </div>
                
                <div class="category-title-section">
                    <h1 class="category-main-title">Scegli come studiare</h1>
                    <p class="category-subtitle" id="currentStudyName">Seleziona una categoria</p>
                </div>

                <div class="category-grid">
                    <!-- Card 1: Comprendi -->
                    <div class="category-card comprendi" onclick="selectCategory('comprendi')">
                        <div class="category-card-content">
                            <span class="category-card-icon"></span>
                            <h2 class="category-card-title">Comprendi</h2>
                            <p class="category-card-description">Analizza i contenuti della lezione</p>
                        </div>
                    </div>

                    <!-- Card 2: Memorizza -->
                    <div class="category-card memorizza" onclick="selectCategory('memorizza')">
                        <div class="category-card-content">
                            <span class="category-card-icon"></span>
                            <h2 class="category-card-title">Memorizza</h2>
                            <p class="category-card-description">Fissa i concetti nella memoria</p>
                        </div>
                    </div>

                    <!-- Card 3: Approfondisci -->
                    <div class="category-card approfondisci" onclick="selectCategory('approfondisci')">
                        <div class="category-card-content">
                            <span class="category-card-icon"></span>
                            <h2 class="category-card-title">Approfondisci</h2>
                            <p class="category-card-description">Esplora e verifica le conoscenze</p>
                        </div>
                    </div>

                    <!-- Card 4: Personalizza -->
                    <div class="category-card personalizza" onclick="selectCategory('personalizza')">
                        <div class="category-card-content">
                            <span class="category-card-icon"></span>
                            <h2 class="category-card-title">Personalizza</h2>
                            <p class="category-card-description">Crea materiali su misura</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ========== FINE NUOVE 4 CARDS ========== -->

            <div class="tabs" id="tabs">
                <button class="tab-btn active" onclick="switchTab('library', event)"> Libreria Studi</button>
                <button class="tab-btn hidden" id="tabSummary" onclick="switchTab('summary', event)"> Riassunto</button>
                <button class="tab-btn hidden" id="tabHighlights" onclick="switchTab('highlights', event)"> Punti Salienti</button>
                <button class="tab-btn hidden" id="tabGlossary" onclick="switchTab('glossary', event)"> Glossario</button>
                <button class="tab-btn hidden" id="tabTimeline" onclick="switchTab('timeline', event)"> Timeline</button>
                <button class="tab-btn hidden" id="tabMindmap" onclick="switchTab('mindmap', event)"> Mappa Mentale</button>
                <button class="tab-btn hidden" id="tabStudyGuide" onclick="switchTab('studyguide', event)"> Guida di Studio</button>
                <button class="tab-btn hidden" id="tabConceptAnalysis" onclick="switchTab('conceptanalysis', event)"> Analisi Concetto</button>
                <button class="tab-btn hidden" id="tabCustomFormat" onclick="switchTab('customformat', event)"> Crea il Tuo</button>
                <button class="tab-btn hidden" id="tabFlashcards" onclick="switchTab('flashcards', event)"> Flashcard</button>
                <button class="tab-btn hidden" id="tabQuiz" onclick="switchTab('quiz', event)"> Quiz</button>
                <button class="tab-btn hidden" id="tabChat" onclick="switchTab('chat', event)"> Chat AI</button>
            </div>
            <div class="content-area" id="contentArea"></div>
        </div>
    </div>

    <script>
        let appState = {
            studies: JSON.parse(localStorage.getItem('mentorestudio_studies')) || {},
            currentStudyId: null,
            currentFlashcard: 0,
            currentFlashcardFiltered: 0,
            flashcardMode: 'all',
            currentQuiz: 0,
            currentQuizFiltered: 0,
            quizMode: 'all',
            quizScore: 0,
            quizAnswers: [],
            quizTimerEnabled: false,
            quizTimeRemaining: 0,
            quizTimerId: null,
            notes: JSON.parse(localStorage.getItem('flashcardNotes')) || {},
            darkMode: localStorage.getItem('darkMode') === 'true',
            chatHistory: JSON.parse(localStorage.getItem('chatHistory')) || {},
            isChatLoading: false
        };

        let flashcardStats = JSON.parse(localStorage.getItem('flashcardStats')) || {};
        let quizStats = JSON.parse(localStorage.getItem('quizStats')) || {};
        let selectedFiles = [];

        if (appState.darkMode) document.body.classList.add('dark-mode');

        function toggleDarkMode() {
            appState.darkMode = !appState.darkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', appState.darkMode);
        }

        // ========== GESTIONE UPLOAD MIGLIORATA ==========
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('pdfFile');
        const fileInfo = document.getElementById('fileInfo');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressText = document.getElementById('progressText');
        const selectedFilesList = document.getElementById('selectedFilesList');

        // Event listeners per drag & drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelection();
            }
        });

        // Click sull'area di upload
        uploadArea.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') {
                fileInput.click();
            }
        });

        // Cambiamento selezione file
        fileInput.addEventListener('change', handleFileSelection);

        function handleFileSelection() {
            selectedFiles = Array.from(fileInput.files);
            
            if (selectedFiles.length > 0) {
                // Mostra info file
                fileInfo.style.display = 'block';
                selectedFilesList.innerHTML = '';
                
                selectedFiles.forEach((file, index) => {
                    const fileElement = document.createElement('div');
                    fileElement.style.padding = '5px 0';
                    fileElement.style.borderBottom = index < selectedFiles.length - 1 ? '1px solid #e0e0e0' : 'none';
                    fileElement.innerHTML = `
                        <span style="font-weight: 500;">${file.name}</span>
                        <span style="color: #666; font-size: 0.9em;"> (${formatFileSize(file.size)})</span>
                    `;
                    selectedFilesList.appendChild(fileElement);
                });
                
                // Abilita pulsante caricamento
                uploadBtn.disabled = false;
                uploadBtn.style.background = 'var(--success)';
            } else {
                fileInfo.style.display = 'none';
                uploadBtn.disabled = true;
                uploadBtn.style.background = '#ccc';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateUploadProgress(current, total, message) {
            const percent = Math.round((current / total) * 100);
            progressBar.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
            progressText.textContent = message;
        }

        async function loadMultiplePDFs() {
            const files = selectedFiles;
            if (files.length === 0) { 
                alert('Seleziona almeno un file'); 
                return; 
            }

            // IMPORTANTE: NON nascondere la schermata di upload!
            // L'utente deve vedere cosa sta succedendo
            
            // Disabilita il pulsante e mostra il progresso
            uploadBtn.disabled = true;
            uploadBtn.textContent = ' Elaborazione in corso...';
            uploadBtn.classList.add('loading');
            
            // Mostra la barra di progresso
            uploadProgress.style.display = 'block';
            updateUploadProgress(0, files.length, 'Avvio elaborazione...');
            
            // Aspetta un attimo per mostrare la UI
            await new Promise(resolve => setTimeout(resolve, 300));
            
            let processedCount = 0;
            let successCount = 0;

            for (let file of files) {
                try {
                    // Mostra quale file stiamo elaborando
                    updateUploadProgress(processedCount, files.length, ` Elaborando: ${file.name}`);
                    
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    let text = '';
                    let fileType = '';
                    let fileIcon = '';

                    console.log(`Elaborazione file: ${file.name} (${fileExtension})`);
                    
                    // Estrazione testo
                    updateUploadProgress(processedCount, files.length, ` Lettura ${file.name}...`);
                    
                    switch(fileExtension) {
                        case 'pdf':
                            text = await extractPDFText(file);
                            fileType = 'PDF';
                            fileIcon = '';
                            break;
                        case 'txt':
                            text = await extractTextFromTXT(file);
                            fileType = 'TXT';
                            fileIcon = '';
                            break;
                        case 'docx':
                            text = await extractTextFromDOCX(file);
                            fileType = 'DOCX';
                            fileIcon = '';
                            break;
                        case 'pptx':
                            text = await extractTextFromPPTX(file);
                            fileType = 'PPTX';
                            fileIcon = '';
                            break;
                        case 'jpg': case 'jpeg': case 'png': case 'gif': case 'bmp':
                            text = await extractTextFromImage(file);
                            fileType = 'OCR';
                            fileIcon = '';
                            break;
                        default:
                            throw new Error(`Formato non supportato: .${fileExtension}`);
                    }

                    console.log(` ${file.name}: ${text.length} caratteri estratti`);
                    
                    if (!text || text.trim().length < 100) {
                        throw new Error(`Il file contiene troppo poco testo (minimo 100 caratteri)`);
                    }
                    
                    // Generazione contenuti con AI
                    updateUploadProgress(processedCount, files.length, ` Generazione contenuti AI per ${file.name}...`);
                    
                    const studyId = Date.now() + Math.random();
                    const data = await generateContent(text, document.getElementById('subjectSelect').value);
                    
                    appState.studies[studyId] = {
                        id: studyId,
                        name: file.name.replace(/\.[^/.]+$/, ''),
                        data: data,
                        date: new Date().toLocaleDateString('it-IT'),
                        subject: document.getElementById('subjectSelect').value,
                        fullText: text.substring(0, 8000),
                        type: fileExtension,
                        fileType: fileIcon + ' ' + fileType
                    };
                    
                    appState.chatHistory[studyId] = [];
                    
                    processedCount++;
                    successCount++;
                    updateUploadProgress(processedCount, files.length, ` ${file.name} completato!`);
                    
                    // Breve pausa per mostrare il successo
                    await new Promise(resolve => setTimeout(resolve, 400));
                    
                } catch (e) {
                    console.error(` Errore ${file.name}:`, e);
                    processedCount++;
                    updateUploadProgress(processedCount, files.length, ` Errore: ${file.name}`);
                    
                    // Mostra errore all'utente
                    alert(`Impossibile elaborare "${file.name}":\n${e.message}`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }

            // Salvataggio
            updateUploadProgress(files.length, files.length, ' Salvataggio dati...');
            saveStudies();
            saveChatHistory();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Mostra riepilogo finale
            updateUploadProgress(files.length, files.length, ` Elaborazione completata! ${successCount}/${files.length} file caricati`);
            uploadBtn.textContent = ' Completato!';
            uploadBtn.style.background = 'var(--success)';
            
            // Attendi prima di passare all'app
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Ora passa all'app principale
            showMainApp();
            renderLibrary();
            switchTab('library');
            
            // Reset upload dopo aver cambiato schermata
            setTimeout(() => {
                uploadProgress.style.display = 'none';
                progressBar.style.width = '0%';
                fileInput.value = '';
                selectedFiles = [];
                fileInfo.style.display = 'none';
                uploadBtn.disabled = true;
                uploadBtn.style.background = '#ccc';
                uploadBtn.textContent = ' Carica File';
                uploadBtn.classList.remove('loading');
            }, 500);
        }

        async function extractPDFText(file) {
            const reader = new FileReader();
            return new Promise((resolve) => {
                reader.onload = async (e) => {
                    const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
                    let text = '';
                    for (let i = 0; i < Math.min(pdf.numPages, 20); i++) {
                        const page = await pdf.getPage(i + 1);
                        const content = await page.getTextContent();
                        text += content.items.map(x => x.str).join(' ') + '\n';
                    }
                    resolve(text);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function extractTextFromTXT(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    if (!text || text.trim().length < 50) {
                        reject(new Error('Il file TXT non contiene abbastanza testo'));
                        return;
                    }
                    resolve(text);
                };
                reader.onerror = () => reject(new Error('Errore lettura file TXT'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        async function extractTextFromDOCX(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        
                        if (!result.value || result.value.trim().length < 50) {
                            reject(new Error('Il documento DOCX non contiene abbastanza testo'));
                            return;
                        }
                        
                        const cleanText = result.value
                            .replace(/\r\n/g, '\n')
                            .replace(/\n{3,}/g, '\n\n')
                            .trim();
                        
                        resolve(cleanText);
                    } catch (error) {
                        reject(new Error('Errore lettura DOCX: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('Errore caricamento DOCX'));
                reader.readAsArrayBuffer(file);
            });
        }

        async function extractTextFromPPTX(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const zip = await JSZip.loadAsync(arrayBuffer);
                        let allText = '';
                        
                        const slideFiles = Object.keys(zip.files)
                            .filter(name => name.startsWith('ppt/slides/slide') && name.endsWith('.xml'))
                            .sort((a, b) => {
                                const numA = parseInt(a.match(/slide(\d+)/)[1]);
                                const numB = parseInt(b.match(/slide(\d+)/)[1]);
                                return numA - numB;
                            });
                        
                        for (let i = 0; i < slideFiles.length; i++) {
                            const slideFile = slideFiles[i];
                            const content = await zip.files[slideFile].async('string');
                            
                            const textMatches = content.match(/<a:t>([^<]+)<\/a:t>/g);
                            
                            if (textMatches && textMatches.length > 0) {
                                const slideText = textMatches
                                    .map(match => match.replace(/<\/?a:t>/g, ''))
                                    .join(' ')
                                    .trim();
                                
                                if (slideText) {
                                    allText += `\n\n SLIDE ${i + 1} \n\n${slideText}`;
                                }
                            }
                        }
                        
                        if (allText.trim().length < 50) {
                            reject(new Error('La presentazione non contiene abbastanza testo estraibile'));
                            return;
                        }
                        
                        resolve(allText);
                    } catch (error) {
                        reject(new Error('Errore lettura PPTX: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('Errore caricamento PPTX'));
                reader.readAsArrayBuffer(file);
            });
        }

        async function extractTextFromImage(file) {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log(` Avvio OCR per: ${file.name}`);
                    
                    const { data: { text } } = await Tesseract.recognize(
                        file,
                        'ita+eng',
                        {
                            logger: progress => {
                                if (progress.status === 'recognizing text') {
                                    const percent = Math.round(progress.progress * 100);
                                    console.log(`OCR progress: ${percent}%`);
                                }
                            }
                        }
                    );
                    
                    console.log(` OCR completato: ${text.length} caratteri estratti`);
                    
                    if (!text || text.trim().length < 50) {
                        reject(new Error('OCR non ha estratto testo sufficiente'));
                        return;
                    }
                    
                    resolve(text.trim());
                    
                } catch (error) {
                    console.error(' Errore OCR:', error);
                    reject(new Error(`Errore OCR: ${error.message}`));
                }
            });
        }

        function showMainApp() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        async function generateContent(text, subject) {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text.substring(0, 8000), subject: subject })
            });

            if (!response.ok) throw new Error('Errore server: ' + response.status);
            return await response.json();
        }

        function saveStudies() {
            localStorage.setItem('mentorestudio_studies', JSON.stringify(appState.studies));
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(appState.chatHistory));
        }

        function switchTab(tab, e) {
            if (e) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
            }
            switch(tab) {
                case 'library': renderLibrary(); break;
                case 'summary': renderSummary(); break;
                case 'highlights': renderHighlights(); break;
                case 'glossary': renderGlossary(); break;
                case 'timeline': renderTimeline(); break;
                case 'mindmap': renderMindMap(); break;
                case 'studyguide': renderStudyGuide(); break;
                case 'conceptanalysis': renderConceptAnalysis(); break;
                case 'customformat': renderCustomFormat(); break;
                case 'flashcards': renderFlashcardsAdvanced(); break;
                case 'quiz': renderQuizAdvanced(); break;
                case 'chat': renderChat(); break;
            }
        }

        function renderLibrary() {
            let html = '<h2>Le tue lezioni</h2>';
            html += '<input type="text" class="search-box" id="librarySearch" placeholder="Cerca nelle lezioni..." onkeyup="filterLibrary()">';
            const studies = Object.values(appState.studies).sort((a, b) => b.id - a.id);
            
            if (studies.length === 0) {
                html += `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 4em; margin-bottom: 20px;"></div>
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Nessuna lezione caricata</h3>
                        <p style="color: #999; margin-bottom: 30px;">
                            La tua libreria  vuota. Inizia caricando i tuoi documenti!
                        </p>
                        <button class="btn" onclick="resetApp()" style="font-size: 1.1em; padding: 15px 30px;">
                             Carica Nuovi Documenti
                        </button>
                    </div>
                `;
            } else {
                studies.forEach(study => {
                    const totalFlashcards = study.data.flashcards?.length || 0;
                    const totalQuiz = study.data.quiz?.length || 0;
                    const completedFlashcards = study.completedFlashcards || 0;
                    const completedQuiz = study.completedQuiz || 0;
                    
                    const totalItems = totalFlashcards + totalQuiz;
                    const completedItems = completedFlashcards + completedQuiz;
                    const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                    
                    let status = 'new';
                    let statusText = 'Nuovo';
                    let ctaText = 'Inizia Studio ';
                    
                    if (progress > 0 && progress < 100) {
                        status = 'in-progress';
                        statusText = 'In Corso';
                        ctaText = 'Continua ';
                    } else if (progress === 100) {
                        status = 'completed';
                        statusText = 'Completato';
                        ctaText = 'Rivedi';
                    }
                    
                    html += `
                        <div class="study-item" 
                             onclick="selectStudy('${study.id}')" 
                             style="--progress: ${progress}%"
                             data-search="${study.name.toLowerCase()} ${(study.data.highlights || []).join(' ').toLowerCase()} ${(study.data.glossary || []).map(g => g.term.toLowerCase()).join(' ')}">
                            
                            <span class="study-status ${status}">${statusText}</span>
                            
                            <div class="study-left">
                                <strong>${study.fileType || 'PDF'} ${study.name}</strong>
                                <div class="study-info">
                                    <span>${study.date}</span>
                                    <span></span>
                                    <span>${study.subject}</span>
                                    <span></span>
                                    <span>${totalFlashcards} flashcard</span>
                                    <span></span>
                                    <span>${totalQuiz} quiz</span>
                                </div>
                                ${progress > 0 ? `<div class="study-progress-text"> ${progress}% completato</div>` : ''}
                            </div>
                            
                            <div class="study-actions">
                                <button class="study-cta" onclick="event.stopPropagation(); selectStudy('${study.id}')">
                                    ${ctaText}
                                </button>
                                <button class="btn btn-export" onclick="exportStudyPDF('${study.id}', event)" style="padding: 8px 12px; font-size: 13px;"></button>
                                <button class="btn btn-delete" onclick="deleteStudy('${study.id}', event)" style="padding: 8px 12px; font-size: 13px;"></button>
                            </div>
                        </div>
                    `;
                });
                html += `
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="resetApp()" style="width: 100%;"> Carica Altri Documenti</button>
                    </div>
                `;
            }
            document.getElementById('contentArea').innerHTML = html;
        }

        function filterLibrary() {
            const searchTerm = document.getElementById('librarySearch').value.toLowerCase();
            const items = document.querySelectorAll('.study-item');
            items.forEach(item => {
                const searchData = item.getAttribute('data-search');
                item.style.display = searchData.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function exportStudyPDF(studyId, e) {
            e.stopPropagation();
            const study = appState.studies[studyId];
            if (!study) return;

            const element = document.createElement('div');
            element.style.padding = '20px';
            
            element.innerHTML = `
                <h1>${study.name}</h1>
                <p><strong>Tipo:</strong> ${study.fileType || ' PDF'} | <strong>Materia:</strong> ${study.subject} | <strong>Data:</strong> ${study.date}</p>
                
                <h2> Riassunto Breve</h2>
                <p>${study.data.summary_short}</p>
                
                <h2> Riassunto Completo</h2>
                <p>${study.data.summary_long}</p>
                
                <h2> Punti Salienti</h2>
                <ul>
                    ${(study.data.highlights || []).map(h => `<li>${h}</li>`).join('')}
                </ul>
                
                <h2> Glossario</h2>
                ${(study.data.glossary || []).map(g => `
                    <div style="margin-bottom: 10px;">
                        <strong>${g.term}:</strong> ${g.definition}
                    </div>
                `).join('')}
                
                <h2> Flashcard</h2>
                ${(study.data.flashcards || []).map((f, i) => `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <strong>Domanda ${i+1}:</strong> ${f.q}<br>
                        <strong>Risposta:</strong> ${f.a}
                    </div>
                `).join('')}
                
                <h2> Quiz</h2>
                ${(study.data.quiz || []).map((q, i) => `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <strong>Quiz ${i+1}:</strong> ${q.q}<br>
                        ${q.options.map((o, j) => `<div style="margin-left: 20px;"> ${o}${j === q.correct ? ' ' : ''}</div>`).join('')}
                    </div>
                `).join('')}
            `;

            const opt = {
                margin: 10,
                filename: `${study.name.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };

            html2pdf().set(opt).from(element).save();
            alert(' PDF scaricato!');
        }

        function selectStudy(studyId) {
            appState.currentStudyId = studyId;
            appState.currentFlashcard = 0;
            appState.currentFlashcardFiltered = 0;
            appState.flashcardMode = 'all';
            appState.currentQuiz = 0;
            appState.currentQuizFiltered = 0;
            appState.quizMode = 'all';
            appState.quizScore = 0;
            appState.quizAnswers = [];
            
            if (!appState.chatHistory[studyId]) {
                appState.chatHistory[studyId] = [];
            }
            
            // Mostra le 4 cards
            document.getElementById('categorySelection').classList.add('active');
            document.getElementById('tabs').style.display = 'none';
            document.getElementById('contentArea').style.display = 'none';
            document.getElementById('backToCategories').classList.add('hidden');
            
            // Aggiorna il nome del documento
            const study = getCurrentStudy();
            if (study) {
                document.getElementById('currentStudyName').textContent = study.name;
            }
        }

        function deleteStudy(studyId, e) {
            e.stopPropagation();
            if (confirm('Eliminare questa lezione?')) {
                delete appState.studies[studyId];
                delete appState.chatHistory[studyId];
                saveStudies();
                saveChatHistory();
                renderLibrary();
            }
        }

        function getCurrentStudy() {
            return appState.studies[appState.currentStudyId];
        }

        function goBack() {
            if (appState.quizTimerId) {
                clearInterval(appState.quizTimerId);
                appState.quizTimerId = null;
            }
            switchTab('library');
        }

        function renderSummary() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="study-focus-mode">
                    <div class="study-breadcrumb">
                        <a href="#" onclick="goBack(); return false;">Libreria</a>
                        <span></span>
                        <span>${study.name}</span>
                    </div>
                    
                    <h2>Riassunto</h2>
                    <p style="color: #71717a; margin-bottom: 32px;">${study.fileType || 'PDF'}  ${study.subject}</p>
                    
                    <div class="section">
                        <h3>Sintesi Breve</h3>
                        <div class="card">${study.data.summary_short || 'Contenuto non disponibile'}</div>
                    </div>
                    
                    <div class="section">
                        <h3>Analisi Completa</h3>
                        <div class="card">${study.data.summary_long || 'Contenuto non disponibile'}</div>
                    </div>
                </div>
            `;
        }

        function renderHighlights() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="study-focus-mode">
                    <div class="study-breadcrumb">
                        <a href="#" onclick="goBack(); return false;">Libreria</a>
                        <span></span>
                        <span>${study.name}</span>
                    </div>
                    
                    <h2>Punti Chiave</h2>
                    <p style="color: #71717a; margin-bottom: 32px;">${(study.data.highlights || []).length} concetti principali identificati</p>
            `;
            
            if (!study.data.highlights || study.data.highlights.length === 0) {
                html += `
                    <div class="card" style="text-align: center; padding: 60px 40px;">
                        <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;"></div>
                        <h3 style="margin-bottom: 12px;">Nessun punto chiave trovato</h3>
                        <p style="margin-top: 10px; color: #71717a;">
                            I concetti principali verranno estratti automaticamente dal contenuto.
                        </p>
                    </div>
                `;
            } else {
                (study.data.highlights || []).forEach((h, i) => {
                    const highlightId = `highlight_${i}`;
                    const hasExplanation = study.data.highlightDetails && study.data.highlightDetails[i];
                    
                    html += `
                        <div class="highlight-item" onclick="toggleHighlight('${highlightId}')">
                            <div class="highlight-header">
                                <div class="highlight-title">${h}</div>
                                <span class="highlight-icon" style="color: #3b82f6;">${hasExplanation ? '' : '+'}</span>
                            </div>
                            <div class="highlight-details" id="${highlightId}" style="${hasExplanation ? '' : 'display: none;'}">
                                ${hasExplanation || '<em style="color: #a1a1aa;">Spiegazione in caricamento...</em>'}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `</div>`;
            document.getElementById('contentArea').innerHTML = html;
        }

        function toggleHighlight(highlightId) {
            const details = document.getElementById(`${highlightId}_details`);
            const icon = document.getElementById(`${highlightId}_icon`);
            
            if (details.style.display === 'none' || details.style.display === '') {
                details.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        async function generateHighlightExplanation(index, event) {
            event.stopPropagation();
            
            const study = getCurrentStudy();
            const highlight = study.data.highlights[index];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = ' Generazione in corso...';
            
            try {
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nContenuto: ${study.fullText.substring(0, 1000)}`;
                
                const prompt = `Fornisci una spiegazione dettagliata e approfondita di questo punto saliente:\n\n"${highlight}"\n\nContesto:\n${context}\n\nLa spiegazione deve essere:\n- Chiara e completa (4-6 frasi)\n- Con esempi concreti se possibile\n- Collegata al contesto della lezione\n- Utile per lo studio e la memorizzazione`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                if (!study.data.highlightDetails) {
                    study.data.highlightDetails = {};
                }
                study.data.highlightDetails[index] = data.response;
                
                saveStudies();
                renderHighlights();
                
                setTimeout(() => {
                    toggleHighlight(`highlight_${index}`);
                }, 100);
                
            } catch (error) {
                console.error('Errore:', error);
                alert(' Errore nella generazione: ' + error.message);
                btn.disabled = false;
                btn.textContent = ' Genera Spiegazione Dettagliata';
            }
        }

        function renderGlossary() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3> Glossario (${(study.data.glossary || []).length} termini)</h3>
                <p style="color: #666; margin-bottom: 15px;">Clicca su ogni termine per vedere definizione ed esempi</p>
            `;
            
            html += '<input type="text" class="search-box" id="glossarySearch" placeholder=" Cerca un termine..." onkeyup="filterGlossary()">';
            html += '<div id="glossaryContent">';
            
            if (!study.data.glossary || study.data.glossary.length === 0) {
                html += `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 15px;"></div>
                        <h3>Nessun termine nel glossario</h3>
                        <p style="margin-top: 10px; color: #666;">
                            I termini chiave verranno estratti automaticamente dal contenuto.
                        </p>
                    </div>
                `;
            } else {
                (study.data.glossary || []).forEach((item, i) => {
                    const glossaryId = `glossary_${i}`;
                    const hasExample = study.data.glossaryExamples && study.data.glossaryExamples[i];
                    
                    html += `
                        <div class="highlight-item" data-term="${item.term.toLowerCase()}" onclick="toggleHighlight('${glossaryId}')">
                            <div class="highlight-header">
                                <div class="highlight-title">
                                    <strong style="color: var(--secondary); font-size: 1.1em;">${item.term}</strong>
                                </div>
                                <span class="highlight-icon" id="${glossaryId}_icon"></span>
                            </div>
                            
                            <div class="highlight-details" id="${glossaryId}_details">
                                <p style="margin-bottom: 15px;"><strong>Definizione:</strong> ${item.definition}</p>
                                
                                ${hasExample ? `
                                    <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; margin-top: 10px;">
                                        <strong style="color: var(--primary);"> Esempio pratico:</strong>
                                        <p style="margin-top: 8px;">${study.data.glossaryExamples[i]}</p>
                                    </div>
                                ` : `
                                    <button class="generate-btn" onclick="generateGlossaryExample(${i}, event)">
                                         Genera Esempio Pratico
                                    </button>
                                `}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        function filterGlossary() {
            const searchTerm = document.getElementById('glossarySearch').value.toLowerCase();
            const items = document.querySelectorAll('#glossaryContent .highlight-item');
            items.forEach(item => {
                const term = item.getAttribute('data-term');
                item.style.display = term.includes(searchTerm) ? 'block' : 'none';
            });
        }

        async function generateGlossaryExample(index, event) {
            event.stopPropagation();
            
            const study = getCurrentStudy();
            const glossaryItem = study.data.glossary[index];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = ' Generazione esempio...';
            
            try {
                const prompt = `Fornisci un esempio pratico e concreto per questo termine:\n\nTermine: ${glossaryItem.term}\nDefinizione: ${glossaryItem.definition}\n\nMateria: ${study.subject}\n\nL'esempio deve essere:\n- Pratico e dalla vita reale\n- Facile da ricordare\n- Collegato alla materia di studio\n- Massimo 3 frasi`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                if (!study.data.glossaryExamples) {
                    study.data.glossaryExamples = {};
                }
                study.data.glossaryExamples[index] = data.response;
                
                saveStudies();
                renderGlossary();
                
                setTimeout(() => {
                    toggleHighlight(`glossary_${index}`);
                }, 100);
                
            } catch (error) {
                console.error('Errore:', error);
                alert(' Errore nella generazione: ' + error.message);
                btn.disabled = false;
                btn.textContent = ' Genera Esempio Pratico';
            }
        }

        function renderTimeline() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let timeline = study.data.timeline || [];
            
            if (timeline.length === 0 && study.data.highlights && study.data.highlights.length > 0) {
                timeline = study.data.highlights.slice(0, 8).map((highlight, index) => ({
                    date: `Punto ${index + 1}`,
                    event: highlight,
                    details: `Approfondimento su: ${highlight}`
                }));
            }
            
            if (timeline.length === 0) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                    <h2>${study.name}</h2>
                    <h3> Timeline Cronologica</h3>
                    <p style="color: #666; margin-bottom: 20px;">Clicca su ogni evento per vedere i dettagli</p>
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 15px;"></div>
                        <h3>Nessun evento temporale trovato</h3>
                        <p style="margin-top: 10px; color: #666;">
                            Questa lezione non contiene date o eventi cronologici specifici.
                        </p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3> Timeline Cronologica (${timeline.length} eventi)</h3>
                <p style="color: #666; margin-bottom: 20px;">Clicca su ogni evento per vedere i dettagli</p>
                <div style="position: relative; padding: 20px 0;">
                    <div style="position: absolute; left: 30px; top: 0; bottom: 0; width: 3px; background: linear-gradient(to bottom, var(--primary), var(--secondary));"></div>
            `;
            
            timeline.forEach((item, index) => {
                const itemId = `timeline_${index}`;
                html += `
                    <div style="display: flex; align-items: flex-start; margin: 20px 0; position: relative;">
                        <div style="position: absolute; left: 21px; width: 20px; height: 20px; background: white; border: 4px solid var(--primary); border-radius: 50%; z-index: 1;"></div>
                        <div style="margin-left: 60px; flex: 1;">
                            <div class="timeline-item" onclick="toggleTimelineItem('${itemId}')" style="cursor: pointer; transition: all 0.3s;">
                                <div class="card" style="margin: 0; border-left: 4px solid var(--primary);">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
                                                ${item.date || `Evento ${index + 1}`}
                                            </span>
                                        </div>
                                        <span id="${itemId}_icon" style="font-size: 1.2em; transition: transform 0.3s;"></span>
                                    </div>
                                    <p style="margin: 10px 0 0 0; line-height: 1.6; font-weight: 600;">
                                        ${item.event}
                                    </p>
                                    <div id="${itemId}_details" class="timeline-details" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                        <p style="color: #666; line-height: 1.8;">
                                            ${item.details || item.event}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        function toggleTimelineItem(itemId) {
            const details = document.getElementById(`${itemId}_details`);
            const icon = document.getElementById(`${itemId}_icon`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function renderMindMap() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="study-focus-mode">
                    <div class="study-breadcrumb">
                        <a href="#" onclick="goBack(); return false;">Libreria</a>
                        <span></span>
                        <span>${study.name}</span>
                    </div>
                    
                    <h2> Mappa Mentale Interattiva</h2>
                    <p style="color: #71717a; margin-bottom: 32px;">Esplora visualmente i concetti e le loro connessioni</p>
            `;
            
            const mindmap = study.data.mindmapDetailed;
            
            if (!mindmap) {
                html += `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3 class="empty-state-title">Mappa Mentale non ancora generata</h3>
                        <p class="empty-state-description">
                            Genera una mappa mentale interattiva con struttura gerarchica,
                            nodi colorati, connessioni visive e navigazione intuitiva.
                        </p>
                        <button class="btn btn-ripple" onclick="generateDetailedMindmap()">
                             Genera Mappa Mentale Completa
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <div class="context-tip">
                        <span class="context-tip-icon"></span>
                        <div>
                            <strong>Come usarla:</strong> Clicca sui nodi per evidenziare le connessioni, 
                            passa il mouse per vedere i dettagli, usa i controlli per zoom e export.
                        </div>
                    </div>
                    
                    <div class="mindmap-container" id="mindmapCanvas"></div>
                    
                    <div class="export-buttons" style="margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn" onclick="copyMindmapText()">
                             Copia come Testo
                        </button>
                        <button class="btn" onclick="downloadMindmap()">
                             Scarica TXT
                        </button>
                        <button class="btn" onclick="generateDetailedMindmap()">
                             Rigenera Mappa
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
            
            // Se c' la mappa, inizializzala
            if (mindmap) {
                setTimeout(() => {
                    const mindmapData = parseMindmapText(mindmap);
                    window.currentMindmap = new ProfessionalMindMap('mindmapCanvas', mindmapData);
                }, 100);
            }
        }

        function parseMindmapText(text) {
            // Estrae il titolo principale (tra le linee ===)
            const lines = text.split('\n');
            let title = 'Concetto Centrale';
            const children = [];
            
            // Cerca il titolo tra le linee di uguale
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line && !line.match(/^[]+$/)) {
                    const nextLine = lines[i + 1]?.trim() || '';
                    if (nextLine.match(/^[]+$/)) {
                        title = line;
                        break;
                    }
                }
            }
            
            // Analizza i rami principali e sotto-concetti
            let currentBranch = null;
            let currentSubBranch = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                
                // Skip linee vuote e separatori
                if (!trimmed || trimmed.match(/^[]+$/) || trimmed.includes('Collegamenti:')) {
                    continue;
                }
                
                // Ramo principale (inizia con  o )
                if (line.match(/^[]\s+/)) {
                    const text = trimmed.replace(/^[]\s+/, '').trim();
                    if (text) {
                        currentBranch = { text, children: [] };
                        children.push(currentBranch);
                        currentSubBranch = null;
                    }
                }
                // Sotto-concetto di primo livello (   o   )
                else if (line.match(/^\s+[]\s+/) && currentBranch) {
                    const text = trimmed.replace(/^[]\s+/, '').trim();
                    if (text) {
                        currentSubBranch = { text, children: [] };
                        currentBranch.children.push(currentSubBranch);
                    }
                }
                // Sotto-concetto di secondo livello (    )
                else if (line.match(/^\s+\s+[]\s+/) && currentSubBranch) {
                    const text = trimmed.replace(/^[\s]+/, '').trim();
                    if (text) {
                        currentSubBranch.children.push(text);
                    }
                }
            }
            
            // Se non ha trovato rami, crea una struttura base
            if (children.length === 0) {
                const words = title.split(' ');
                const mid = Math.ceil(words.length / 3);
                children.push({ text: words.slice(0, mid).join(' '), children: [] });
                children.push({ text: words.slice(mid, mid * 2).join(' '), children: [] });
                children.push({ text: words.slice(mid * 2).join(' '), children: [] });
            }
            
            return { title, children };
        }

        function copyMindmapText() {
            const study = getCurrentStudy();
            const mindmap = study.data.mindmapDetailed;
            if (mindmap) {
                navigator.clipboard.writeText(mindmap).then(() => {
                    alert(' Mappa mentale copiata negli appunti!');
                });
            }
        }


        async function generateDetailedMindmap() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3> Generazione Mappa Mentale</h3>
                    <p>Sto creando la struttura gerarchica completa...</p>
                </div>
            `;
            
            try {
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nRiassunto: ${study.data.summary_long}\n\nPunti chiave: ${(study.data.highlights || []).join(', ')}`;
                
                const prompt = `Crea una mappa mentale TESTUALE dettagliata e gerarchica per questo argomento:\n\n${context}\n\nUsa questa struttura ASCII:\n\n\n   CONCETTO CENTRALE\n\n\n Ramo principale 1\n   Sotto-concetto 1.1\n   Sotto-concetto 1.2\n   Sotto-concetto 1.3\n\n Ramo principale 2\n   Sotto-concetto 2.1\n     Dettaglio 2.1.1\n     Dettaglio 2.1.2\n   Sotto-concetto 2.2\n\n Ramo principale 3\n   Sotto-concetto 3.1\n   Sotto-concetto 3.2\n\n Collegamenti:\n    Collega concetto 1.1 con 2.1\n    Collega concetto 2.2 con 3.1\n\nCrea 3-4 rami principali con sotto-concetti dettagliati.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                study.data.mindmapDetailed = data.response;
                
                saveStudies();
                renderMindMap();
                
            } catch (error) {
                console.error('Errore:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="error-message">
                         Errore nella generazione: ${error.message}
                        <button class="btn" onclick="renderMindMap()" style="margin-top: 15px;">
                             Riprova
                        </button>
                    </div>
                `;
            }
        }

        function copyMindmap() {
            const study = getCurrentStudy();
            const mindmap = study.data.mindmapDetailed;
            
            if (!mindmap) return;
            
            navigator.clipboard.writeText(mindmap).then(() => {
                alert(' Mappa mentale copiata negli appunti!');
            }).catch(() => {
                alert(' Errore nella copia');
            });
        }

        function downloadMindmap() {
            const study = getCurrentStudy();
            const mindmap = study.data.mindmapDetailed;
            
            if (!mindmap) return;
            
            const blob = new Blob([mindmap], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MappaMentale_${study.name.replace(/[^a-z0-9]/gi, '_')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(' Mappa mentale scaricata!');
        }

        function renderStudyGuide() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3> Guida di Studio</h3>
                <p style="color: #666; margin-bottom: 30px;">Domande per saggi, esami orali e scritti</p>
            `;
            
            if (study.data.quiz && study.data.quiz.length > 0) {
                html += `
                    <div class="section">
                        <h3 style="color: var(--primary); margin-top: 30px;"> Quiz a Risposta Multipla</h3>
                        <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                            Vai alla sezione Quiz per esercitarti con ${study.data.quiz.length} domande
                        </p>
                        <button class="btn" onclick="switchTab('quiz')">
                             Vai ai Quiz
                        </button>
                    </div>
                `;
            }
            
            html += `
                <div class="section">
                    <h3 style="color: var(--primary); margin-top: 30px;"> Domande per Saggi ed Esami</h3>
                    <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                        Domande aperte che richiedono analisi critica e ragionamento approfondito
                    </p>
            `;
            
            const essayQuestions = study.data.essayQuestions || [];
            
            if (essayQuestions.length === 0) {
                html += `
                    <div class="card" style="text-align: center; padding: 30px;">
                        <p style="color: #999; margin-bottom: 15px;">
                            Nessuna domanda per saggio ancora generata
                        </p>
                        <button class="btn" onclick="generateEssayQuestions()">
                             Genera Domande per Saggio
                        </button>
                    </div>
                `;
            } else {
                essayQuestions.forEach((question, i) => {
                    html += `
                        <div class="question-card">
                            <span class="question-number">Domanda ${i + 1}</span>
                            <div class="question-text">${question}</div>
                        </div>
                    `;
                });
                
                html += `
                    <button class="btn" onclick="generateEssayQuestions()" style="margin-top: 15px;">
                         Genera Altre Domande
                    </button>
                `;
            }
            
            html += `</div>`;
            
            if (study.data.glossary && study.data.glossary.length > 0) {
                html += `
                    <div class="section">
                        <h3 style="color: var(--primary); margin-top: 30px;"> Glossario dei Termini</h3>
                        <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                            ${study.data.glossary.length} termini chiave da conoscere
                        </p>
                        <button class="btn" onclick="switchTab('glossary')">
                             Vai al Glossario
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        async function generateEssayQuestions() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3> Generazione Domande per Saggio</h3>
                    <p>Sto creando domande di analisi critica...</p>
                </div>
            `;
            
            try {
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nRiassunto: ${study.data.summary_short}\n\nPunti chiave: ${(study.data.highlights || []).slice(0, 5).join(', ')}`;
                
                const prompt = `Genera 5 domande per saggi/esami scritti su questo argomento:\n\n${context}\n\nLe domande devono:\n- Essere aperte e richiedere ragionamento critico\n- Iniziare con "Analizza...", "Discuti...", "Come...", "In che modo...", "Spiega..."\n- Essere adatte per esami universitari o superiori\n- Coprire aspetti diversi dell'argomento\n- Essere formulate in modo chiaro\n\nFormato: una domanda per riga, numerate da 1 a 5.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                const questions = data.response
                    .split('\n')
                    .filter(line => line.trim().length > 0)
                    .map(line => line.replace(/^\d+\.\s*/, '').trim())
                    .filter(q => q.length > 20);
                
                if (!study.data.essayQuestions) {
                    study.data.essayQuestions = [];
                }
                
                questions.forEach(q => {
                    if (!study.data.essayQuestions.includes(q)) {
                        study.data.essayQuestions.push(q);
                    }
                });
                
                saveStudies();
                renderStudyGuide();
                
            } catch (error) {
                console.error('Errore:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="error-message">
                         Errore nella generazione: ${error.message}
                        <button class="btn" onclick="renderStudyGuide()" style="margin-top: 15px;">
                             Riprova
                        </button>
                    </div>
                `;
            }
        }

        function renderConceptAnalysis() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3> Analisi del Concetto</h3>
                <p style="color: #666; margin-bottom: 30px;">I tre pilastri fondamentali che sostengono questa lezione</p>
            `;
            
            const analysis = study.data.conceptAnalysis;
            
            if (!analysis) {
                html += `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;"></div>
                        <h3>Analisi non ancora generata</h3>
                        <p style="color: #666; margin: 20px 0;">
                            L'analisi del concetto ti aiuta a comprendere i tre pilastri fondamentali<br>
                            dell'argomento e come si collegano tra loro.
                        </p>
                        <button class="btn" onclick="generateConceptAnalysis()">
                             Genera Analisi del Concetto
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <div class="pillar-card">
                        <div class="pillar-title">
                            <div class="pillar-icon">1</div>
                            <span>Primo Pilastro: ${analysis.pillar1_title || 'Definizione Base'}</span>
                        </div>
                        <div class="pillar-content">
                            ${analysis.pillar1_content || 'Contenuto non disponibile'}
                        </div>
                    </div>
                    
                    <div class="pillar-card">
                        <div class="pillar-title">
                            <div class="pillar-icon">2</div>
                            <span>Secondo Pilastro: ${analysis.pillar2_title || 'Applicazioni Pratiche'}</span>
                        </div>
                        <div class="pillar-content">
                            ${analysis.pillar2_content || 'Contenuto non disponibile'}
                        </div>
                    </div>
                    
                    <div class="pillar-card">
                        <div class="pillar-title">
                            <div class="pillar-icon">3</div>
                            <span>Terzo Pilastro: ${analysis.pillar3_title || 'Collegamenti Concettuali'}</span>
                        </div>
                        <div class="pillar-content">
                            ${analysis.pillar3_content || 'Contenuto non disponibile'}
                        </div>
                    </div>
                `;
                
                if (analysis.connections) {
                    html += `
                        <div class="connection-box">
                            <h4 style="margin-bottom: 10px; color: var(--accent);"> Come si Collegano i Tre Pilastri</h4>
                            <p style="line-height: 1.8;">${analysis.connections}</p>
                        </div>
                    `;
                }
                
                html += `
                    <button class="btn" onclick="generateConceptAnalysis()" style="margin-top: 30px;">
                         Rigenera Analisi
                    </button>
                `;
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        async function generateConceptAnalysis() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3> Analisi del Concetto in Corso</h3>
                    <p>Sto identificando i tre pilastri fondamentali...</p>
                </div>
            `;
            
            try {
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nRiassunto: ${study.data.summary_long}\n\nPunti chiave: ${(study.data.highlights || []).join(', ')}`;
                
                const prompt = `Analizza in profondit questo argomento identificando i TRE PILASTRI FONDAMENTALI:\n\n${context}\n\nPer ogni pilastro fornisci:\n1. TITOLO del pilastro (3-5 parole)\n2. CONTENUTO del pilastro (4-6 frasi di spiegazione approfondita)\n\nPoi spiega come i tre pilastri si COLLEGANO tra loro.\n\nFormato richiesto:\nPILASTRO 1: [titolo]\n[contenuto]\n\nPILASTRO 2: [titolo]\n[contenuto]\n\nPILASTRO 3: [titolo]\n[contenuto]\n\nCOLLEGAMENTI:\n[spiegazione dei collegamenti]`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                const text = data.response;
                const pillar1Match = text.match(/PILASTRO 1:\s*([^\n]+)\n([\s\S]*?)(?=PILASTRO 2:|$)/i);
                const pillar2Match = text.match(/PILASTRO 2:\s*([^\n]+)\n([\s\S]*?)(?=PILASTRO 3:|$)/i);
                const pillar3Match = text.match(/PILASTRO 3:\s*([^\n]+)\n([\s\S]*?)(?=COLLEGAMENTI:|$)/i);
                const connectionsMatch = text.match(/COLLEGAMENTI:\s*([\s\S]*?)$/i);
                
                study.data.conceptAnalysis = {
                    pillar1_title: pillar1Match ? pillar1Match[1].trim() : 'Definizione Base',
                    pillar1_content: pillar1Match ? pillar1Match[2].trim() : '',
                    pillar2_title: pillar2Match ? pillar2Match[1].trim() : 'Applicazioni Pratiche',
                    pillar2_content: pillar2Match ? pillar2Match[2].trim() : '',
                    pillar3_title: pillar3Match ? pillar3Match[1].trim() : 'Collegamenti Concettuali',
                    pillar3_content: pillar3Match ? pillar3Match[2].trim() : '',
                    connections: connectionsMatch ? connectionsMatch[1].trim() : ''
                };
                
                saveStudies();
                renderConceptAnalysis();
                
            } catch (error) {
                console.error('Errore:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="error-message">
                         Errore nella generazione: ${error.message}
                        <button class="btn" onclick="renderConceptAnalysis()" style="margin-top: 15px;">
                             Riprova
                        </button>
                    </div>
                `;
            }
        }

        function renderCustomFormat() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const history = study.data.customFormats || [];
            
            let html = `
                <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3> Crea il Tuo Formato</h3>
                <p style="color: #666; margin-bottom: 30px;">Trasforma il contenuto in qualsiasi formato desideri</p>
                
                <div class="section">
                    <h4 style="color: var(--primary); margin-bottom: 15px;"> Suggerimenti Rapidi</h4>
                    <p style="color: #666; font-size: 0.95em; margin-bottom: 20px;">Clicca su un formato per generarlo automaticamente</p>
                    
                    <div class="format-grid">
                        <div class="format-card" onclick="generateCustomFormat('slides')">
                            <div class="format-icon"></div>
                            <div class="format-title">Presentazione Slides</div>
                            <div class="format-desc">10 slides con titoli, punti chiave e note</div>
                        </div>
                        
                        <div class="format-card" onclick="generateCustomFormat('powerpoint')">
                            <div class="format-icon"></div>
                            <div class="format-title">PowerPoint (.pptx)</div>
                            <div class="format-desc">File PowerPoint scaricabile per presentazioni</div>
                        </div>
                        
                        <div class="format-card" onclick="generateCustomFormat('schema')">
                            <div class="format-icon"></div>
                            <div class="format-title">Schema di Studio</div>
                            <div class="format-desc">Schema avanzato con priorit e collegamenti</div>
                        </div>
                        
                        <div class="format-card" onclick="generateCustomFormat('tabella')">
                            <div class="format-icon"></div>
                            <div class="format-title">Tabella Comparativa</div>
                            <div class="format-desc">Confronto organizzato in formato tabella</div>
                        </div>
                        
                        <div class="format-card" onclick="generateCustomFormat('dialogo')">
                            <div class="format-icon"></div>
                            <div class="format-title">Dialogo Q&A</div>
                            <div class="format-desc">Conversazione Socratica domanda-risposta</div>
                        </div>
                    </div>
                </div>
                
                <div class="custom-input-box">
                    <h4 style="color: var(--primary); margin-bottom: 15px;"> Oppure Scrivi la Tua Richiesta</h4>
                    <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                        Esempio: "Crea un quiz interattivo", "Trasforma in infografica testuale", "Genera FAQ"
                    </p>
                    <textarea 
                        class="custom-textarea" 
                        id="customFormatInput" 
                        placeholder="Scrivi cosa vuoi creare (es: 'Trasforma in mappa concettuale con collegamenti tra argomenti')..."
                    ></textarea>
                    <button class="btn" onclick="generateCustomFormat('custom')" style="margin-top: 15px;">
                         Genera Formato Personalizzato
                    </button>
                </div>
                
                <div id="customFormatResult"></div>
            `;
            
            if (history.length > 0) {
                html += `
                    <div class="section" style="margin-top: 40px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;"> Storico Trasformazioni (${history.length})</h4>
                        <div id="formatHistory">
                `;
                
                history.slice().reverse().forEach((item, i) => {
                    const timeAgo = getTimeAgo(item.timestamp);
                    html += `
                        <div class="history-item" onclick="showHistoryItem(${history.length - 1 - i})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${item.icon} ${item.title}</strong>
                                    <div class="history-meta">${timeAgo}</div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-export" onclick="copyHistoryItem(${history.length - 1 - i}, event)" style="padding: 6px 12px; font-size: 0.85em;">
                                         Copia
                                    </button>
                                    <button class="btn btn-delete" onclick="deleteHistoryItem(${history.length - 1 - i}, event)" style="padding: 6px 12px; font-size: 0.85em;">
                                        
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        const formatTemplates = {
            'slides': {
                icon: '',
                title: 'Presentazione Slides',
                prompt: `Trasforma in una presentazione di 10 slides con questa struttura:

SLIDE 1: [Titolo accattivante]
- Sottotitolo
- Immagine suggerita: [descrizione]

SLIDE 2-9: [Contenuto principale]
Per ogni slide includi:
- Titolo della slide
- 3-5 punti chiave (bullet points)
- Note per il presentatore

SLIDE 10: Conclusione
- Riepilogo
- Call to action

Contenuto: {content}`
            },
            'schema': {
                icon: '',
                title: 'Schema di Studio Avanzato',
                prompt: `Crea uno schema di studio completo e strutturato:

 ARGOMENTO PRINCIPALE


 OBIETTIVI DI APPRENDIMENTO
- Cosa devi sapere
- Cosa devi saper fare

 CONCETTI FONDAMENTALI
[Organizza in ordine logico con priorit]
 Priorit ALTA
 Priorit MEDIA  
 Priorit BASSA

 COLLEGAMENTI
[Come si collegano i concetti]

 STRATEGIE DI MEMORIZZAZIONE
[Tecniche specifiche]

 CHECKLIST PADRONANZA
[Come verificare di aver capito]

Contenuto: {content}`
            },
            'tabella': {
                icon: '',
                title: 'Tabella Comparativa',
                prompt: `Crea una tabella comparativa ben strutturata:

Identifica 3-5 elementi da confrontare e almeno 5 criteri di confronto.

Formato:

|  CRITERIO       | Elemento 1 | Elemento 2 | Elemento 3 |

| Definizione     |            |            |            |
| Caratteristiche |            |            |            |
| Pro             |            |            |            |
| Contro          |            |            |            |
| Applicazioni    |            |            |            |


 Sintesi comparativa: [breve analisi]

Contenuto: {content}`
            },
            'dialogo': {
                icon: '',
                title: 'Dialogo Socratico',
                prompt: `Crea un dialogo Socratico (domanda-risposta) per esplorare l'argomento:

Personaggi:
 MAESTRO - Guida con domande
 STUDENTE - Scopre attraverso il ragionamento

Struttura:
MAESTRO: [Domanda aperta]
STUDENTE: [Risposta iniziale]
MAESTRO: [Domanda di approfondimento]
STUDENTE: [Riflessione pi profonda]
[continua per 8-10 scambi]

Finale: Lo studente arriva alla comprensione profonda

Contenuto: {content}`
            }
        };

        async function generateCustomFormat(formatType) {
            const study = getCurrentStudy();
            if (!study) return;
            
            let prompt = '';
            let formatInfo = null;
            
            if (formatType === 'powerpoint') {
                await generatePowerPoint();
                return;
            }
            
            if (formatType === 'custom') {
                const customInput = document.getElementById('customFormatInput').value.trim();
                if (!customInput) {
                    alert(' Inserisci una richiesta personalizzata!');
                    return;
                }
                prompt = `${customInput}\n\nContenuto da trasformare:\n${study.data.summary_long}\n\nPunti chiave: ${(study.data.highlights || []).join(', ')}`;
                formatInfo = { icon: '', title: customInput.substring(0, 50) };
            } else {
                formatInfo = formatTemplates[formatType];
                const content = `${study.data.summary_long}\n\nPunti chiave: ${(study.data.highlights || []).join(', ')}`;
                prompt = formatInfo.prompt.replace('{content}', content);
            }
            
            document.getElementById('customFormatResult').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3> Creazione in Corso</h3>
                    <p>Sto generando il formato "${formatInfo.title}"...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                const result = data.response;
                
                if (!study.data.customFormats) {
                    study.data.customFormats = [];
                }
                
                study.data.customFormats.push({
                    type: formatType,
                    icon: formatInfo.icon,
                    title: formatInfo.title,
                    content: result,
                    timestamp: Date.now()
                });
                
                saveStudies();
                displayFormatResult(result, formatInfo);
                
            } catch (error) {
                console.error('Errore:', error);
                document.getElementById('customFormatResult').innerHTML = `
                    <div class="error-message">
                         Errore nella generazione: ${error.message}
                        <button class="btn" onclick="renderCustomFormat()" style="margin-top: 15px;">
                             Riprova
                        </button>
                    </div>
                `;
            }
        }

        function displayFormatResult(content, formatInfo) {
            const resultHTML = `
                <div class="section" style="margin-top: 30px;">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">
                        ${formatInfo.icon} Risultato: ${formatInfo.title}
                    </h4>
                    
                    <div class="result-box">${content}</div>
                    
                    <div class="export-buttons">
                        <button class="btn" onclick="copyFormatResult()">
                             Copia negli Appunti
                        </button>
                        <button class="btn" onclick="downloadFormatResult('${formatInfo.title.replace(/[^a-z0-9]/gi, '_')}')">
                             Scarica TXT
                        </button>
                        <button class="btn" onclick="renderCustomFormat()">
                             Crea Altro Formato
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('customFormatResult').innerHTML = resultHTML;
            document.getElementById('customFormatResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function copyFormatResult() {
            const resultBox = document.querySelector('.result-box');
            if (!resultBox) return;
            
            const text = resultBox.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert(' Contenuto copiato negli appunti!');
            }).catch(() => {
                alert(' Errore nella copia');
            });
        }

        function downloadFormatResult(filename) {
            const resultBox = document.querySelector('.result-box');
            if (!resultBox) return;
            
            const text = resultBox.textContent;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(' File scaricato!');
        }

        function showHistoryItem(index) {
            const study = getCurrentStudy();
            const item = study.data.customFormats[index];
            if (!item) return;
            
            displayFormatResult(item.content, { icon: item.icon, title: item.title });
        }

        function copyHistoryItem(index, event) {
            event.stopPropagation();
            const study = getCurrentStudy();
            const item = study.data.customFormats[index];
            if (!item) return;
            
            navigator.clipboard.writeText(item.content).then(() => {
                alert(' Contenuto copiato!');
            });
        }

        function deleteHistoryItem(index, event) {
            event.stopPropagation();
            const study = getCurrentStudy();
            
            if (confirm('Eliminare questa trasformazione dallo storico?')) {
                study.data.customFormats.splice(index, 1);
                saveStudies();
                renderCustomFormat();
            }
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            
            if (seconds < 60) return 'Pochi secondi fa';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} minuti fa`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} ore fa`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} giorni fa`;
            
            return new Date(timestamp).toLocaleDateString('it-IT');
        }

        async function generatePowerPoint() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('customFormatResult').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3> Generazione PowerPoint</h3>
                    <p>Sto creando la presentazione...</p>
                </div>
            `;
            
            try {
                const pptx = new PptxGenJS();
                
                pptx.layout = 'LAYOUT_16x9';
                pptx.author = 'MentoreStudio';
                pptx.title = study.name;
                pptx.subject = study.subject;
                
                let slide = pptx.addSlide();
                slide.background = { color: '667eea' };
                slide.addText(study.name, {
                    x: 1, y: 2.5, w: 8, h: 1,
                    fontSize: 44, bold: true, color: 'FFFFFF',
                    align: 'center'
                });
                slide.addText(study.subject, {
                    x: 1, y: 3.5, w: 8, h: 0.5,
                    fontSize: 24, color: 'FFFFFF',
                    align: 'center'
                });
                
                slide = pptx.addSlide();
                slide.addText(' Introduzione', {
                    x: 0.5, y: 0.5, fontSize: 32, bold: true, color: '667eea'
                });
                slide.addText(study.data.summary_short, {
                    x: 0.5, y: 1.5, w: 9, h: 4,
                    fontSize: 16, valign: 'top'
                });
                
                (study.data.highlights || []).slice(0, 8).forEach((highlight, i) => {
                    slide = pptx.addSlide();
                    slide.addText(` Punto Chiave ${i+1}`, {
                        x: 0.5, y: 0.5, fontSize: 28, bold: true, color: '667eea'
                    });
                    slide.addText([
                        { text: highlight, options: { fontSize: 18, bullet: true } }
                    ], {
                        x: 0.5, y: 1.5, w: 9, h: 4
                    });
                });
                
                if (study.data.glossary && study.data.glossary.length > 0) {
                    slide = pptx.addSlide();
                    slide.addText(' Glossario', {
                        x: 0.5, y: 0.5, fontSize: 32, bold: true, color: '667eea'
                    });
                    
                    const rows = [
                        [{ text: 'Termine', options: { bold: true, fontSize: 14 } }, 
                         { text: 'Definizione', options: { bold: true, fontSize: 14 } }]
                    ];
                    
                    (study.data.glossary || []).slice(0, 6).forEach(g => {
                        rows.push([
                            { text: g.term, options: { fontSize: 12 } },
                            { text: g.definition, options: { fontSize: 12 } }
                        ]);
                    });
                    
                    slide.addTable(rows, {
                        x: 0.5, y: 1.2, w: 9, h: 4,
                        border: { pt: 1, color: '667eea' }
                    });
                }
                
                slide = pptx.addSlide();
                slide.addText(' Conclusione', {
                    x: 0.5, y: 0.5, fontSize: 32, bold: true, color: '667eea'
                });
                slide.addText(study.data.summary_long.substring(0, 400), {
                    x: 0.5, y: 1.5, w: 9, h: 4,
                    fontSize: 16
                });
                
                await pptx.writeFile({ fileName: `${study.name.replace(/[^a-z0-9]/gi, '_')}.pptx` });
                
                document.getElementById('customFormatResult').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4em; margin-bottom: 20px;"></div>
                        <h3>PowerPoint Generato con Successo!</h3>
                        <p style="margin: 20px 0; color: #666;">
                            Il file "${study.name}.pptx"  stato scaricato
                        </p>
                        <button class="btn" onclick="generatePowerPoint()">
                             Genera Altro PowerPoint
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Errore PowerPoint:', error);
                document.getElementById('customFormatResult').innerHTML = `
                    <div class="error-message">
                         Errore nella generazione PowerPoint: ${error.message}
                        <button class="btn" onclick="renderCustomFormat()" style="margin-top: 15px;">
                             Riprova
                        </button>
                    </div>
                `;
            }
        }

        function renderFlashcardsAdvanced() {
            const study = getCurrentStudy();
            if (!study || !study.data.flashcards) return;

            const allFlashcards = study.data.flashcards;
            const filteredFlashcards = filterFlashcardsByMode(allFlashcards);
            
            if (filteredFlashcards.length === 0) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                    <h2>${study.name}</h2>
                    <h3> Flashcard</h3>
                    <div class="card" style="text-align: center;">
                        <p>Nessuna flashcard trovata per il filtro selezionato.</p>
                        <button class="btn" onclick="appState.flashcardMode = 'all'; renderFlashcardsAdvanced()">Mostra Tutte</button>
                    </div>
                `;
                return;
            }

            const currentCard = filteredFlashcards[appState.currentFlashcardFiltered];
            const currentCardId = `${study.id}_${currentCard.q}`;
            const stats = flashcardStats[currentCardId] || { difficulty: 'medium', views: 0, correct: 0 };

            let html = `
                <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3> Flashcard (${appState.currentFlashcardFiltered + 1}/${filteredFlashcards.length})</h3>
                
                <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
                    <button class="btn ${appState.flashcardMode === 'all' ? 'active' : ''}" onclick="changeFlashcardMode('all')"> Tutte</button>
                    <button class="btn ${appState.flashcardMode === 'difficult' ? 'active' : ''}" onclick="changeFlashcardMode('difficult')"> Difficili</button>
                    <button class="btn ${appState.flashcardMode === 'medium' ? 'active' : ''}" onclick="changeFlashcardMode('medium')"> Medie</button>
                    <button class="btn ${appState.flashcardMode === 'easy' ? 'active' : ''}" onclick="changeFlashcardMode('easy')"> Facili</button>
                </div>

                <div class="flashcard ${stats.difficulty}" onclick="flipCard()">
                    <div class="flashcard-inner" id="flashcardInner">
                        <div class="flashcard-front">
                            <div class="flashcard-question">${currentCard.q}</div>
                            <div style="font-size: 0.8em; opacity: 0.8; margin-top: 15px;">
                                 Clicca per vedere la risposta
                            </div>
                        </div>
                        <div class="flashcard-back">
                            <div class="flashcard-answer">${currentCard.a}</div>
                            
                            <div id="flashcardExtras" style="width: 100%;">
                                ${currentCard.explanation ? `
                                    <div class="flashcard-extra">
                                        <div class="flashcard-extra-title"> Spiegazione Semplice:</div>
                                        <div>${currentCard.explanation}</div>
                                    </div>
                                ` : ''}
                                
                                ${currentCard.example ? `
                                    <div class="flashcard-extra">
                                        <div class="flashcard-extra-title"> Esempio Pratico:</div>
                                        <div>${currentCard.example}</div>
                                    </div>
                                ` : ''}
                                
                                ${currentCard.essay ? `
                                    <div class="flashcard-extra">
                                        <div class="flashcard-extra-title"> Domanda per Saggio:</div>
                                        <div>${currentCard.essay}</div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;" onclick="event.stopPropagation()">
                                ${!currentCard.explanation ? `<button class="expand-btn" onclick="generateExplanation('${currentCardId}', event)"> Spiega Semplice</button>` : ''}
                                ${!currentCard.example ? `<button class="expand-btn" onclick="generateExample('${currentCardId}', event)"> Esempio</button>` : ''}
                                ${!currentCard.essay ? `<button class="expand-btn" onclick="generateEssay('${currentCardId}', event)"> Domanda Saggio</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn" onclick="prevFlashcard()"> Precedente</button>
                    <button class="btn" onclick="flipCard()"> Gira</button>
                    <button class="btn" onclick="nextFlashcard()">Successiva </button>
                </div>

                <div class="controls" style="margin-top: 20px;">
                    <button class="btn" style="background: #4caf50;" onclick="markDifficulty('easy')"> Facile</button>
                    <button class="btn" style="background: #ffa726;" onclick="markDifficulty('medium')"> Medio</button>
                    <button class="btn" style="background: #f44336;" onclick="markDifficulty('difficult')"> Difficile</button>
                </div>

                <div class="note-section">
                    <strong> Note Personali:</strong>
                    <textarea class="note-input" id="flashcardNote" rows="3" placeholder="Aggiungi note per questa flashcard...">${appState.notes[currentCardId] || ''}</textarea>
                    <button class="btn" onclick="saveFlashcardNote('${currentCardId}')" style="margin-top: 10px;"> Salva Nota</button>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <strong> Statistiche:</strong> Visualizzata ${stats.views} volte | Difficolt: ${stats.difficulty === 'easy' ? ' Facile' : stats.difficulty === 'medium' ? ' Medio' : ' Difficile'}
                </div>
            `;

            document.getElementById('contentArea').innerHTML = html;
            updateFlashcardStats(currentCardId);
        }

        function filterFlashcardsByMode(flashcards) {
            if (appState.flashcardMode === 'all') return flashcards;
            
            const study = getCurrentStudy();
            return flashcards.filter(card => {
                const cardId = `${study.id}_${card.q}`;
                const stats = flashcardStats[cardId] || { difficulty: 'medium' };
                return stats.difficulty === appState.flashcardMode;
            });
        }

        function changeFlashcardMode(mode) {
            appState.flashcardMode = mode;
            appState.currentFlashcardFiltered = 0;
            renderFlashcardsAdvanced();
        }

        function flipCard() {
            document.getElementById('flashcardInner').classList.toggle('flipped');
        }

        function nextFlashcard() {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            appState.currentFlashcardFiltered = (appState.currentFlashcardFiltered + 1) % filtered.length;
            renderFlashcardsAdvanced();
        }

        function prevFlashcard() {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            appState.currentFlashcardFiltered = appState.currentFlashcardFiltered === 0 ? filtered.length - 1 : appState.currentFlashcardFiltered - 1;
            renderFlashcardsAdvanced();
        }

        function markDifficulty(difficulty) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            const cardId = `${study.id}_${currentCard.q}`;
            
            if (!flashcardStats[cardId]) flashcardStats[cardId] = { difficulty: 'medium', views: 0, correct: 0 };
            flashcardStats[cardId].difficulty = difficulty;
            
            localStorage.setItem('flashcardStats', JSON.stringify(flashcardStats));
            renderFlashcardsAdvanced();
        }

        function updateFlashcardStats(cardId) {
            if (!flashcardStats[cardId]) flashcardStats[cardId] = { difficulty: 'medium', views: 0, correct: 0 };
            flashcardStats[cardId].views++;
            localStorage.setItem('flashcardStats', JSON.stringify(flashcardStats));
        }

        function saveFlashcardNote(cardId) {
            const note = document.getElementById('flashcardNote').value;
            appState.notes[cardId] = note;
            localStorage.setItem('flashcardNotes', JSON.stringify(appState.notes));
            alert(' Nota salvata!');
        }

        async function generateExplanation(cardId, event) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = ' Generazione...';
            
            try {
                const prompt = `Spiega in modo molto semplice (come a un bambino di 10 anni) questo concetto:\n\nDomanda: ${currentCard.q}\nRisposta: ${currentCard.a}\n\nFornisci una spiegazione chiara, breve (max 3 frasi) e con esempi quotidiani.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore generazione');
                
                const data = await response.json();
                currentCard.explanation = data.response;
                
                saveStudies();
                renderFlashcardsAdvanced();
                
                setTimeout(() => {
                    document.getElementById('flashcardInner').classList.add('flipped');
                }, 100);
                
            } catch (error) {
                alert(' Errore: ' + error.message);
                btn.disabled = false;
                btn.textContent = ' Spiega Semplice';
            }
        }
        
        async function generateExample(cardId, event) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = ' Generazione...';
            
            try {
                const prompt = `Fornisci un esempio pratico e concreto per questo concetto:\n\nDomanda: ${currentCard.q}\nRisposta: ${currentCard.a}\n\nDai un esempio reale dalla vita quotidiana o dalla materia ${study.subject}. Max 3 frasi.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore generazione');
                
                const data = await response.json();
                currentCard.example = data.response;
                
                saveStudies();
                renderFlashcardsAdvanced();
                
                setTimeout(() => {
                    document.getElementById('flashcardInner').classList.add('flipped');
                }, 100);
                
            } catch (error) {
                alert(' Errore: ' + error.message);
                btn.disabled = false;
                btn.textContent = ' Esempio';
            }
        }
        
        async function generateEssay(cardId, event) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = ' Generazione...';
            
            try {
                const prompt = `Crea una domanda da saggio/tema d'esame su questo argomento:\n\nDomanda: ${currentCard.q}\nRisposta: ${currentCard.a}\n\nLa domanda deve essere aperta, richiedere ragionamento critico e analisi. Max 2 frasi. Inizia con "Come..." o "In che modo..." o "Analizza..." o "Discuti...".`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore generazione');
                
                const data = await response.json();
                currentCard.essay = data.response;
                
                saveStudies();
                renderFlashcardsAdvanced();
                
                setTimeout(() => {
                    document.getElementById('flashcardInner').classList.add('flipped');
                }, 100);
                
            } catch (error) {
                alert(' Errore: ' + error.message);
                btn.disabled = false;
                btn.textContent = ' Domanda Saggio';
            }
        }

        function renderQuizAdvanced() {
            const study = getCurrentStudy();
            if (!study || !study.data.quiz) return;

            const allQuestions = study.data.quiz;
            const filteredQuestions = filterQuizByMode(allQuestions);

            if (filteredQuestions.length === 0) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                    <h2>${study.name}</h2>
                    <h3> Quiz</h3>
                    <div class="card" style="text-align: center;">
                        <p>Nessuna domanda trovata per il filtro selezionato.</p>
                        <button class="btn" onclick="appState.quizMode = 'all'; renderQuizAdvanced()">Mostra Tutte</button>
                    </div>
                `;
                return;
            }

            if (appState.currentQuizFiltered >= filteredQuestions.length) {
                return renderQuizResults();
            }

            const currentQuestion = filteredQuestions[appState.currentQuizFiltered];

            let html = `
                <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3> Quiz (${appState.currentQuizFiltered + 1}/${filteredQuestions.length})</h3>

                <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
                    <button class="btn ${appState.quizMode === 'all' ? 'active' : ''}" onclick="changeQuizMode('all')"> Tutte</button>
                    <button class="btn ${appState.quizMode === 'wrong' ? 'active' : ''}" onclick="changeQuizMode('wrong')"> Sbagliate</button>
                    <button class="btn ${appState.quizMode === 'correct' ? 'active' : ''}" onclick="changeQuizMode('correct')"> Corrette</button>
                    <button class="btn ${appState.quizMode === 'unseen' ? 'active' : ''}" onclick="changeQuizMode('unseen')"> Non Viste</button>
                </div>

                <div style="display: flex; align-items: center; gap: 10px; margin: 20px 0;">
                    <label><input type="checkbox" id="timerCheckbox" ${appState.quizTimerEnabled ? 'checked' : ''} onchange="toggleQuizTimer()">  Timer (60s per domanda)</label>
                </div>
            `;

            if (appState.quizTimerEnabled) {
                html += `<div class="timer-display ${appState.quizTimeRemaining < 10 ? 'warning' : ''}" id="quizTimer">${appState.quizTimeRemaining}s</div>`;
            }

            html += `
                <div class="card">
                    <h4>${currentQuestion.q}</h4>
                </div>
            `;

            currentQuestion.options.forEach((option, i) => {
                const isAnswered = appState.quizAnswers[appState.currentQuizFiltered] !== undefined;
                const userAnswer = appState.quizAnswers[appState.currentQuizFiltered];
                let className = 'quiz-option';
                
                if (isAnswered) {
                    if (i === currentQuestion.correct) className += ' correct';
                    else if (i === userAnswer) className += ' incorrect';
                } else if (userAnswer === i) {
                    className += ' selected';
                }

                html += `<div class="${className}" onclick="${isAnswered ? '' : `selectQuizAnswer(${i})`}">${option}</div>`;
            });

            if (appState.quizAnswers[appState.currentQuizFiltered] === undefined) {
                html += `
                    <div class="controls">
                        <button class="btn" onclick="submitQuizAnswer()"> Conferma</button>
                    </div>
                `;
            } else {
                html += `
                    <div class="controls">
                        <button class="btn" onclick="nextQuizQuestion()">Prossima </button>
                    </div>
                `;
            }

            document.getElementById('contentArea').innerHTML = html;

            if (appState.quizTimerEnabled && !appState.quizTimerId) {
                startQuizTimer();
            }
        }

        function filterQuizByMode(questions) {
            if (appState.quizMode === 'all') return questions;
            
            const study = getCurrentStudy();
            return questions.filter(q => {
                const qId = `${study.id}_${q.q}`;
                const stats = quizStats[qId];
                
                if (appState.quizMode === 'unseen') return !stats;
                if (appState.quizMode === 'correct') return stats && stats.correct;
                if (appState.quizMode === 'wrong') return stats && !stats.correct;
                
                return true;
            });
        }

        function changeQuizMode(mode) {
            appState.quizMode = mode;
            appState.currentQuizFiltered = 0;
            appState.quizAnswers = [];
            appState.quizScore = 0;
            renderQuizAdvanced();
        }

        function toggleQuizTimer() {
            appState.quizTimerEnabled = document.getElementById('timerCheckbox').checked;
            if (appState.quizTimerEnabled) {
                appState.quizTimeRemaining = 60;
                startQuizTimer();
            } else {
                if (appState.quizTimerId) {
                    clearInterval(appState.quizTimerId);
                    appState.quizTimerId = null;
                }
            }
            renderQuizAdvanced();
        }

        function startQuizTimer() {
            appState.quizTimeRemaining = 60;
            if (appState.quizTimerId) clearInterval(appState.quizTimerId);
            
            appState.quizTimerId = setInterval(() => {
                appState.quizTimeRemaining--;
                const timerEl = document.getElementById('quizTimer');
                if (timerEl) {
                    timerEl.textContent = `${appState.quizTimeRemaining}s`;
                    if (appState.quizTimeRemaining < 10) {
                        timerEl.classList.add('warning');
                    }
                }
                
                if (appState.quizTimeRemaining <= 0) {
                    clearInterval(appState.quizTimerId);
                    appState.quizTimerId = null;
                    appState.quizAnswers[appState.currentQuizFiltered] = -1;
                    nextQuizQuestion();
                }
            }, 1000);
        }

        function selectQuizAnswer(index) {
            const currentAnswerIndex = appState.quizAnswers[appState.currentQuizFiltered];
            if (currentAnswerIndex === undefined) {
                appState.quizAnswers[appState.currentQuizFiltered] = index;
                renderQuizAdvanced();
            }
        }

        function submitQuizAnswer() {
            if (appState.quizTimerId) {
                clearInterval(appState.quizTimerId);
                appState.quizTimerId = null;
            }

            const study = getCurrentStudy();
            const filtered = filterQuizByMode(study.data.quiz);
            const currentQuestion = filtered[appState.currentQuizFiltered];
            const userAnswer = appState.quizAnswers[appState.currentQuizFiltered];

            if (userAnswer === undefined) {
                alert('Seleziona una risposta!');
                return;
            }

            const isCorrect = userAnswer === currentQuestion.correct;
            if (isCorrect) appState.quizScore++;

            const qId = `${study.id}_${currentQuestion.q}`;
            quizStats[qId] = { correct: isCorrect, timestamp: Date.now() };
            localStorage.setItem('quizStats', JSON.stringify(quizStats));

            renderQuizAdvanced();
        }

        function nextQuizQuestion() {
            const study = getCurrentStudy();
            const filtered = filterQuizByMode(study.data.quiz);
            
            appState.currentQuizFiltered++;
            
            if (appState.currentQuizFiltered >= filtered.length) {
                if (appState.quizTimerId) {
                    clearInterval(appState.quizTimerId);
                    appState.quizTimerId = null;
                }
                renderQuizResults();
            } else {
                if (appState.quizTimerEnabled) {
                    startQuizTimer();
                }
                renderQuizAdvanced();
            }
        }

        function renderQuizResults() {
            const study = getCurrentStudy();
            const filtered = filterQuizByMode(study.data.quiz);
            
            let correctCount = 0;
            filtered.forEach((q, i) => {
                const userAnswer = appState.quizAnswers[i];
                if (userAnswer === q.correct) {
                    correctCount++;
                }
            });
            
            const percentage = Math.round((correctCount / filtered.length) * 100);

            let emoji = '';
            if (percentage >= 90) emoji = '';
            else if (percentage >= 70) emoji = '';
            else if (percentage >= 50) emoji = '';

            let html = `
                <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3> Risultati Quiz</h3>

                <div class="card" style="text-align: center; font-size: 1.5em;">
                    <div style="font-size: 4em; margin: 20px 0;">${emoji}</div>
                    <p><strong>Punteggio: ${correctCount}/${filtered.length}</strong></p>
                    <p>${percentage}%</p>
                </div>

                <h3 style="margin-top: 30px;"> Riepilogo</h3>
            `;

            filtered.forEach((q, i) => {
                const userAnswer = appState.quizAnswers[i];
                const isCorrect = userAnswer === q.correct;
                html += `
                    <div class="review-item ${isCorrect ? 'correct' : 'wrong'}">
                        <strong>Domanda ${i + 1}:</strong> ${q.q}<br>
                        <strong>La tua risposta:</strong> ${userAnswer >= 0 ? q.options[userAnswer] : 'Nessuna risposta'}<br>
                        <strong>Risposta corretta:</strong> ${q.options[q.correct]}<br>
                        ${isCorrect ? ' Corretto!' : ' Sbagliato'}
                    </div>
                `;
            });

            html += `
                <div class="controls" style="margin-top: 30px;">
                    <button class="btn" onclick="resetQuiz()"> Rifai Quiz</button>
                    <button class="btn" onclick="switchTab('library')"> Torna alla Libreria</button>
                </div>
            `;

            document.getElementById('contentArea').innerHTML = html;
        }

        function resetQuiz() {
            appState.currentQuizFiltered = 0;
            appState.quizAnswers = [];
            appState.quizScore = 0;
            if (appState.quizTimerId) {
                clearInterval(appState.quizTimerId);
                appState.quizTimerId = null;
            }
            renderQuizAdvanced();
        }

        function renderChat() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const chatHistory = appState.chatHistory[study.id] || [];
            
            let html = `
                <div class="back-btn" onclick="goBack()"> Torna alla Libreria</div>
                <h2> Chat AI - ${study.name}</h2>
                
                <div class="chat-context-info">
                    <strong> Contesto attivo:</strong> ${study.subject} - ${study.name}
                    <br>
                    <small>L'AI ha accesso al contenuto della lezione e pu rispondere alle tue domande</small>
                </div>
                
                <div class="chat-suggestions">
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Spiegami i concetti principali di questa lezione')">
                         Concetti principali
                    </div>
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Crea un piano di studio per questa lezione')">
                         Piano di studio
                    </div>
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Quali sono le domande d\\'esame pi probabili?')">
                         Domande d'esame
                    </div>
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Dammi esempi pratici di applicazione')">
                         Esempi pratici
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        ${chatHistory.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;"></div>
                                <p>Inizia una conversazione!</p>
                                <p style="font-size: 0.9em; margin-top: 10px;">Fai domande sulla lezione o usa i suggerimenti sopra</p>
                            </div>
                        ` : chatHistory.map((msg, idx) => createChatMessageHTML(msg, `msg_${study.id}_${idx}`)).join('')}
                    </div>
                    
                    <div class="chat-input-container">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Scrivi la tua domanda..."
                            rows="1"
                            onkeypress="handleChatKeyPress(event)"
                        ></textarea>
                        <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
                            Invia 
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn" onclick="clearChatHistory()" style="padding: 8px 15px; font-size: 0.9em; background: var(--danger);">
                         Cancella Conversazione
                    </button>
                    <button class="btn" onclick="exportChatHistory()" style="padding: 8px 15px; font-size: 0.9em;">
                         Esporta Chat
                    </button>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
            scrollChatToBottom();
            
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
        }

        function createChatMessageHTML(message, messageId) {
            const isUser = message.role === 'user';
            const msgId = messageId || 'msg_' + Date.now() + Math.random();
            
            return `
                <div class="chat-message ${isUser ? 'user' : 'ai'}" data-message-id="${msgId}">
                    <div class="chat-avatar">${isUser ? '' : ''}</div>
                    <div style="flex: 1;">
                        <div class="chat-bubble">${escapeHTML(message.content)}</div>
                    </div>
                </div>
            `;
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function sendSuggestedQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendChatMessage();
        }

        async function sendChatMessage() {
            const study = getCurrentStudy();
            if (!study || appState.isChatLoading) return;
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const userMessageId = `msg_${study.id}_${appState.chatHistory[study.id].length}`;
            appState.chatHistory[study.id].push({
                role: 'user',
                content: message
            });
            
            input.value = '';
            input.style.height = 'auto';
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += createChatMessageHTML({
                role: 'user',
                content: message
            }, userMessageId);
            
            messagesContainer.innerHTML += `
                <div class="chat-message ai" id="typingIndicator">
                    <div class="chat-avatar"></div>
                    <div class="chat-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            scrollChatToBottom();
            
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Invio...';
            appState.isChatLoading = true;
            
            try {
                const summaryShort = (study.data.summary_short || '').substring(0, 300);
                const highlightsText = (study.data.highlights || []).slice(0, 3).join('. ').substring(0, 200);
                const contentSnippet = study.fullText ? study.fullText.substring(0, 400) : '';
                
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nRiassunto: ${summaryShort}\n\nPunti chiave: ${highlightsText}\n\nEstratto: ${contentSnippet}`;
                
                const conversationHistory = appState.chatHistory[study.id]
                    .slice(0, -1)
                    .slice(-5)
                    .map(msg => ({
                        role: msg.role,
                        content: msg.content.substring(0, 500)
                    }));
                
                const fullMessage = `[CONTESTO]\n${context}\n\n[DOMANDA]\n${message}`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: fullMessage,
                        conversationHistory: conversationHistory
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Errore server: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.response;
                
                document.getElementById('typingIndicator').remove();
                
                const aiMessageId = `msg_${study.id}_${appState.chatHistory[study.id].length}`;
                appState.chatHistory[study.id].push({
                    role: 'assistant',
                    content: aiResponse
                });
                
                messagesContainer.innerHTML += createChatMessageHTML({
                    role: 'assistant',
                    content: aiResponse
                }, aiMessageId);
                
                saveChatHistory();
                scrollChatToBottom();
                
            } catch (error) {
                console.error('Errore chat:', error);
                
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();
                
                messagesContainer.innerHTML += `
                    <div class="error-message">
                         Errore: ${error.message}. Riprova tra poco.
                    </div>
                `;
                
                appState.chatHistory[study.id].pop();
                
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Invia ';
                appState.isChatLoading = false;
                scrollChatToBottom();
            }
        }

        function scrollChatToBottom() {
            setTimeout(() => {
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, 100);
        }

        function clearChatHistory() {
            const study = getCurrentStudy();
            if (!study) return;
            
            if (confirm('Vuoi cancellare tutta la conversazione?')) {
                appState.chatHistory[study.id] = [];
                saveChatHistory();
                renderChat();
            }
        }

        function exportChatHistory() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const chatHistory = appState.chatHistory[study.id] || [];
            
            if (chatHistory.length === 0) {
                alert('Non ci sono messaggi da esportare');
                return;
            }
            
            let exportText = `Chat AI - ${study.name}\n`;
            exportText += `Data: ${new Date().toLocaleDateString('it-IT')}\n`;
            exportText += `Materia: ${study.subject}\n\n`;
            exportText += '='.repeat(50) + '\n\n';
            
            chatHistory.forEach((msg, i) => {
                const role = msg.role === 'user' ? ' Tu' : ' AI';
                exportText += `${role}:\n${msg.content}\n\n`;
            });
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${study.name.replace(/[^a-z0-9]/gi, '_')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(' Chat esportata!');
        }

        function resetApp() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('pdfFile').value = '';
            selectedFiles = [];
            fileInfo.style.display = 'none';
            uploadBtn.disabled = true;
            uploadBtn.style.background = '#ccc';
        }

        const categoryTabs = {
            'comprendi': ['summary', 'highlights', 'glossary', 'conceptanalysis'],
            'memorizza': ['flashcards', 'mindmap', 'timeline'],
            'approfondisci': ['chat', 'quiz', 'studyguide'],
            'personalizza': ['customformat']
        };
        
        const tabIdMap = {
            'summary': 'tabSummary',
            'highlights': 'tabHighlights',
            'glossary': 'tabGlossary',
            'conceptanalysis': 'tabConceptAnalysis',
            'flashcards': 'tabFlashcards',
            'mindmap': 'tabMindmap',
            'timeline': 'tabTimeline',
            'chat': 'tabChat',
            'quiz': 'tabQuiz',
            'studyguide': 'tabStudyGuide',
            'customformat': 'tabCustomFormat'
        };
        
        function selectCategory(category) {
            console.log('Categoria selezionata:', category);
            
            document.getElementById('categorySelection').classList.remove('active');
            
            const tabs = categoryTabs[category] || [];
            
            const allTabBtns = document.querySelectorAll('.tab-btn');
            allTabBtns.forEach(btn => {
                if (!btn.textContent.includes('Libreria')) {
                    btn.classList.add('hidden');
                }
            });
            
            tabs.forEach(tabName => {
                const tabId = tabIdMap[tabName];
                const tabBtn = document.getElementById(tabId);
                if (tabBtn) {
                    tabBtn.classList.remove('hidden');
                } else {
                    console.error('Tab non trovato:', tabId, 'per', tabName);
                }
            });
            
            document.getElementById('tabs').style.display = 'flex';
            document.getElementById('contentArea').style.display = 'block';
            document.getElementById('backToCategories').classList.remove('hidden');
            
            if (tabs.length > 0) {
                switchTab(tabs[0]);
            }
        }
        
        function showCategories() {
            document.getElementById('categorySelection').classList.add('active');
            document.getElementById('tabs').style.display = 'none';
            document.getElementById('contentArea').style.display = 'none';
            document.getElementById('backToCategories').classList.add('hidden');
            
            const study = getCurrentStudy();
            if (study) {
                document.getElementById('currentStudyName').textContent = study.name;
            }
        }
        
        function showLibrary() {
            document.getElementById('categorySelection').classList.remove('active');
            document.getElementById('tabs').style.display = 'flex';
            document.getElementById('contentArea').style.display = 'block';
            switchTab('library');
        }

        if (Object.keys(appState.studies).length > 0) {
            showMainApp();
            switchTab('library');
        }

        console.log(' MentoreStudio Multi-Formato Inizializzato!');
        console.log(' Librerie caricate:');
        console.log('  - PDF.js:', typeof pdfjsLib !== 'undefined' ? '' : '');
        console.log('  - Mammoth.js:', typeof mammoth !== 'undefined' ? '' : '');
        console.log('  - JSZip:', typeof JSZip !== 'undefined' ? '' : '');
        console.log('  - Tesseract.js:', typeof Tesseract !== 'undefined' ? '' : '');
        console.log(' Formati supportati: PDF, TXT, DOCX, PPTX, JPG/PNG (OCR)');
        
        if (typeof mammoth === 'undefined') {
            console.error(' ERRORE: Mammoth.js non caricato! I file DOCX non funzioneranno.');
        }
        if (typeof JSZip === 'undefined') {
            console.error(' ERRORE: JSZip non caricato! I file PPTX non funzioneranno.');
        }
        if (typeof Tesseract === 'undefined') {
            console.error(' ERRORE: Tesseract.js non caricato! L\'OCR non funzioner.');
        }

    

// === ENHANCEMENTS JAVASCRIPT ===

// 1. SKELETON LOADING
function showSkeletonLoading() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
    `;
}

// 2. FILTRI E SORTING
let currentSort = 'date';
let currentView = 'list';
let currentSubjectFilter = 'all';

function initializeFilters() {
    const contentArea = document.getElementById('contentArea');
    const filterHTML = `
        <div class="filter-bar">
            <select class="filter-select" onchange="filterBySubject(this.value)">
                <option value="all">Tutte le Materie</option>
                <option value="Generale">Generale</option>
                <option value="Storia">Storia</option>
                <option value="Matematica">Matematica</option>
                <option value="Diritto">Diritto</option>
                <option value="Informatica">Informatica</option>
            </select>
            
            <div class="sort-group">
                <button class="sort-btn active" onclick="sortStudies('date')">Data</button>
                <button class="sort-btn" onclick="sortStudies('name')">Nome</button>
                <button class="sort-btn" onclick="sortStudies('progress')">Progresso</button>
            </div>
            
            <div class="view-mode-toggle">
                <button class="view-mode-btn active" onclick="changeView('list')" data-tooltip="Vista Lista"></button>
                <button class="view-mode-btn" onclick="changeView('grid')" data-tooltip="Vista Griglia"></button>
            </div>
        </div>
    `;
    return filterHTML;
}

function filterBySubject(subject) {
    currentSubjectFilter = subject;
    renderLibrary();
}

function sortStudies(sortBy) {
    currentSort = sortBy;
    document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderLibrary();
}

function changeView(view) {
    currentView = view;
    document.querySelectorAll('.view-mode-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderLibrary();
}

// 3. STATS DASHBOARD
function calculateStats() {
    const studies = Object.values(appState.studies);
    
    const totalStudies = studies.length;
    const totalFlashcards = studies.reduce((sum, s) => sum + (s.data.flashcards?.length || 0), 0);
    const totalQuizzes = studies.reduce((sum, s) => sum + (s.data.quiz?.length || 0), 0);
    
    const completedStudies = studies.filter(s => {
        const total = (s.data.flashcards?.length || 0) + (s.data.quiz?.length || 0);
        const completed = (s.completedFlashcards || 0) + (s.completedQuiz || 0);
        return total > 0 && completed === total;
    }).length;
    
    return {
        totalStudies,
        completedStudies,
        totalFlashcards,
        totalQuizzes,
        completionRate: totalStudies > 0 ? Math.round((completedStudies / totalStudies) * 100) : 0
    };
}

function renderStats() {
    const stats = calculateStats();
    
    return `
        <div class="stats-overview stagger-item">
            <div class="stat-card">
                <div class="stat-label">Lezioni Totali</div>
                <div class="stat-value">${stats.totalStudies}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Completate</div>
                <div class="stat-value">${stats.completedStudies}</div>
                <div class="stat-change positive"> ${stats.completionRate}%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Flashcard</div>
                <div class="stat-value">${stats.totalFlashcards}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Quiz</div>
                <div class="stat-value">${stats.totalQuizzes}</div>
            </div>
        </div>
    `;
}

// 4. MOBILE BOTTOM NAV
function initMobileNav() {
    if (window.innerWidth <= 768 && !document.querySelector('.bottom-nav')) {
        const nav = document.createElement('div');
        nav.className = 'bottom-nav';
        nav.innerHTML = `
            <div class="bottom-nav-items">
                <a href="#" class="bottom-nav-item active" onclick="switchTab('library'); return false;">
                    <span class="bottom-nav-icon"></span>
                    <span class="bottom-nav-label">Libreria</span>
                </a>
                <a href="#" class="bottom-nav-item" onclick="return false;">
                    <span class="bottom-nav-icon"></span>
                    <span class="bottom-nav-label">Stats</span>
                </a>
                <a href="#" class="bottom-nav-item" onclick="return false;">
                    <span class="bottom-nav-icon"></span>
                    <span class="bottom-nav-label">Settings</span>
                </a>
            </div>
        `;
        document.body.appendChild(nav);
    }
}

// 5. FAB BUTTON
function initFAB() {
    if (window.innerWidth <= 768 && !document.querySelector('.fab')) {
        const fab = document.createElement('button');
        fab.className = 'fab';
        fab.innerHTML = '+';
        fab.onclick = () => resetApp();
        document.body.appendChild(fab);
    }
}

// Initialize on load
window.addEventListener('DOMContentLoaded', () => {
    initMobileNav();
    initFAB();
});

// Update on resize
let resizeTimer;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
        initMobileNav();
        initFAB();
    }, 250);
});




// === ENHANCEMENTS 6-10 JAVASCRIPT ===

// 6. DARK MODE PERFEZIONATO
let darkModeSettings = {
    mode: 'auto', // auto, light, dark, true-black
    schedule: { start: '20:00', end: '08:00' },
    enabled: false
};

function initDarkMode() {
    // Load saved settings
    const saved = localStorage.getItem('darkModeSettings');
    if (saved) {
        darkModeSettings = JSON.parse(saved);
    }
    
    // Apply saved mode
    applyDarkMode();
    
    // Setup schedule if auto
    if (darkModeSettings.mode === 'auto') {
        checkSchedule();
        setInterval(checkSchedule, 60000); // Check every minute
    }
}

function toggleDarkModeAdvanced() {
    const options = document.querySelector('.dark-mode-options');
    if (options) {
        options.classList.toggle('show');
    } else {
        createDarkModeOptions();
    }
}

function createDarkModeOptions() {
    const container = document.querySelector('.header-controls');
    const options = document.createElement('div');
    options.className = 'dark-mode-options show';
    options.innerHTML = `
        <div class="dark-mode-option ${darkModeSettings.mode === 'light' ? 'active' : ''}" onclick="setDarkMode('light')">
            <span class="dark-mode-option-icon"></span>
            <span class="dark-mode-option-text">Light</span>
        </div>
        <div class="dark-mode-option ${darkModeSettings.mode === 'dark' ? 'active' : ''}" onclick="setDarkMode('dark')">
            <span class="dark-mode-option-icon"></span>
            <span class="dark-mode-option-text">Dark</span>
        </div>
        <div class="dark-mode-option ${darkModeSettings.mode === 'true-black' ? 'active' : ''}" onclick="setDarkMode('true-black')">
            <span class="dark-mode-option-icon"></span>
            <span class="dark-mode-option-text">True Black</span>
        </div>
        <div class="dark-mode-option ${darkModeSettings.mode === 'auto' ? 'active' : ''}" onclick="setDarkMode('auto')">
            <span class="dark-mode-option-icon"></span>
            <span class="dark-mode-option-text">Auto <span class="schedule-badge">20:00-08:00</span></span>
        </div>
    `;
    container.style.position = 'relative';
    container.appendChild(options);
    
    // Close on click outside
    setTimeout(() => {
        document.addEventListener('click', (e) => {
            if (!container.contains(e.target)) {
                options.remove();
            }
        }, { once: true });
    }, 100);
}

function setDarkMode(mode) {
    darkModeSettings.mode = mode;
    localStorage.setItem('darkModeSettings', JSON.stringify(darkModeSettings));
    applyDarkMode();
    document.querySelector('.dark-mode-options')?.remove();
}

function applyDarkMode() {
    const body = document.body;
    body.classList.remove('dark-mode', 'true-black');
    
    if (darkModeSettings.mode === 'dark') {
        body.classList.add('dark-mode');
    } else if (darkModeSettings.mode === 'true-black') {
        body.classList.add('dark-mode', 'true-black');
    } else if (darkModeSettings.mode === 'auto') {
        if (isNightTime()) {
            body.classList.add('dark-mode');
        }
    }
}

function checkSchedule() {
    if (darkModeSettings.mode === 'auto') {
        applyDarkMode();
    }
}

function isNightTime() {
    const now = new Date();
    const hour = now.getHours();
    return hour >= 20 || hour < 8; // 20:00 - 08:00
}

// 7. EXPORT E SHARING
function showExportMenu(studyId, event) {
    event.stopPropagation();
    
    const button = event.target;
    const menu = document.createElement('div');
    menu.className = 'export-menu show';
    menu.innerHTML = `
        <div class="export-option" onclick="exportAs('${studyId}', 'pdf')">
            <span class="export-option-icon"></span>
            <span>Export PDF</span>
        </div>
        <div class="export-option" onclick="exportAs('${studyId}', 'markdown')">
            <span class="export-option-icon"></span>
            <span>Export Markdown</span>
        </div>
        <div class="export-option" onclick="exportAs('${studyId}', 'notion')">
            <span class="export-option-icon"></span>
            <span>Copy for Notion</span>
        </div>
        <div class="export-option" onclick="showShareModal('${studyId}')">
            <span class="export-option-icon"></span>
            <span>Share Link</span>
        </div>
        <div class="export-option" onclick="window.print()">
            <span class="export-option-icon"></span>
            <span>Print</span>
        </div>
    `;
    
    button.parentElement.style.position = 'relative';
    button.parentElement.appendChild(menu);
    
    setTimeout(() => {
        document.addEventListener('click', () => menu.remove(), { once: true });
    }, 100);
}

function exportAs(studyId, format) {
    const study = appState.studies[studyId];
    if (!study) return;
    
    let content = '';
    const date = new Date().toLocaleDateString('it-IT');
    
    if (format === 'markdown') {
        content = `# ${study.name}\n\n`;
        content += `**Data:** ${date}\n`;
        content += `**Materia:** ${study.subject}\n\n`;
        content += `## Riassunto\n\n${study.data.summary_short || ''}\n\n`;
        
        if (study.data.highlights) {
            content += `## Punti Chiave\n\n`;
            study.data.highlights.forEach((h, i) => {
                content += `${i+1}. ${h}\n`;
            });
        }
        
        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${study.name}.md`;
        a.click();
        URL.revokeObjectURL(url);
    }
    
    if (format === 'notion') {
        content = `${study.name}\n\n`;
        content += `${study.data.summary_short || ''}`;
        navigator.clipboard.writeText(content);
        alert(' Copiato negli appunti! Incolla in Notion.');
    }
}

function showShareModal(studyId) {
    const study = appState.studies[studyId];
    if (!study) return;
    
    const modal = document.createElement('div');
    modal.className = 'share-modal show';
    
    // Generate shareable link (base64 encoded study data)
    const shareData = btoa(JSON.stringify({
        name: study.name,
        subject: study.subject,
        summary: study.data.summary_short
    }));
    const shareLink = `${window.location.origin}${window.location.pathname}?share=${shareData}`;
    
    modal.innerHTML = `
        <div class="share-modal-content">
            <div class="share-modal-header">
                <h3 class="share-modal-title">Condividi Lezione</h3>
                <button class="share-modal-close" onclick="this.closest('.share-modal').remove()"></button>
            </div>
            <div class="share-link-box">
                <input type="text" class="share-link-input" value="${shareLink}" readonly>
                <button class="share-copy-btn" onclick="copyShareLink(this)">Copia</button>
            </div>
            <div class="qr-code-container">
                <p style="margin-bottom: 12px; font-size: 13px; color: #71717a;">Scansiona con smartphone</p>
                <div style="background: white; padding: 16px; display: inline-block; border-radius: 8px;">
                    <div style="width: 150px; height: 150px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 40px;"></div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function copyShareLink(button) {
    const input = button.previousElementSibling;
    input.select();
    document.execCommand('copy');
    
    button.textContent = ' Copiato!';
    button.classList.add('copied');
    
    setTimeout(() => {
        button.textContent = 'Copia';
        button.classList.remove('copied');
    }, 2000);
}

// 8. AI FEATURES ENHANCED
function showAISuggestions() {
    const studies = Object.values(appState.studies);
    if (studies.length === 0) return;
    
    // Calculate suggestions
    const suggestions = [];
    
    studies.forEach(study => {
        const progress = calculateProgress(study);
        if (progress < 50 && progress > 0) {
            suggestions.push({
                type: 'continue',
                studyId: study.id,
                text: `Continua a studiare "${study.name}" - Sei al ${progress}%!`,
                action: 'Riprendi'
            });
        }
    });
    
    return suggestions;
}

function calculateProgress(study) {
    const total = (study.data.flashcards?.length || 0) + (study.data.quiz?.length || 0);
    const completed = (study.completedFlashcards || 0) + (study.completedQuiz || 0);
    return total > 0 ? Math.round((completed / total) * 100) : 0;
}

function estimateDifficulty(study) {
    // Simple heuristic based on content length and complexity
    const textLength = study.data.summary_long?.length || 0;
    const highlightsCount = study.data.highlights?.length || 0;
    
    if (textLength > 5000 || highlightsCount > 10) return 'hard';
    if (textLength > 2000 || highlightsCount > 5) return 'medium';
    return 'easy';
}

// 9. ACCESSIBILITY
const keyboardShortcuts = {
    'l': () => switchTab('library'),
    'n': () => resetApp(),
    's': () => document.getElementById('librarySearch')?.focus(),
    '?': () => showKeyboardShortcuts(),
    'Escape': () => closeAllModals()
};

function initKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Don't trigger if typing in input
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        const handler = keyboardShortcuts[e.key];
        if (handler) {
            e.preventDefault();
            handler();
        }
    });
}

function showKeyboardShortcuts() {
    const modal = document.createElement('div');
    modal.className = 'shortcuts-modal show';
    modal.innerHTML = `
        <div class="shortcuts-content">
            <div class="share-modal-header">
                <h3 class="share-modal-title">Keyboard Shortcuts</h3>
                <button class="share-modal-close" onclick="this.closest('.shortcuts-modal').remove()"></button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-item">
                    <span class="shortcut-description">Libreria</span>
                    <div class="shortcut-keys"><span class="keyboard-hint">L</span></div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">Nuovo Documento</span>
                    <div class="shortcut-keys"><span class="keyboard-hint">N</span></div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">Cerca</span>
                    <div class="shortcut-keys"><span class="keyboard-hint">S</span></div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">Aiuto</span>
                    <div class="shortcut-keys"><span class="keyboard-hint">?</span></div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-description">Chiudi</span>
                    <div class="shortcut-keys"><span class="keyboard-hint">ESC</span></div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function closeAllModals() {
    document.querySelectorAll('.share-modal, .shortcuts-modal, .dark-mode-options, .export-menu').forEach(el => el.remove());
}

// 10. PERFORMANCE OPTIMIZATION
function initPerformanceOptimizations() {
    // Lazy load images
    const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.add('loaded');
                imageObserver.unobserve(img);
            }
        });
    });
    
    document.querySelectorAll('img[data-src]').forEach(img => imageObserver.observe(img));
    
    // Intersection observer for fade-in animations
    const fadeObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                fadeObserver.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });
    
    document.querySelectorAll('.fade-in-viewport').forEach(el => fadeObserver.observe(el));
    
    // Debounce resize
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            console.log('Resize complete');
        }, 250);
    });
}

// Initialize all enhancements
window.addEventListener('DOMContentLoaded', () => {
    initDarkMode();
    initKeyboardShortcuts();
    initPerformanceOptimizations();
});




// === PROFESSIONAL MINDMAP GENERATOR ===

class ProfessionalMindMap {
    constructor(containerId, data) {
        this.container = document.getElementById(containerId);
        this.data = data;
        this.width = 1000;
        this.height = 600;
        this.nodeRadius = { 0: 60, 1: 45, 2: 35, 3: 28 };
        this.colors = {
            0: '#0f172a',
            1: '#3b82f6',
            2: '#60a5fa',
            3: '#93c5fd'
        };
        this.nodes = [];
        this.connections = [];
        this.expandedNodes = new Set();
        
        this.init();
    }
    
    init() {
        this.createSVG();
        this.processData();
        this.render();
        this.setupControls();
    }
    
    createSVG() {
        this.svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        this.svg.setAttribute('class', 'mindmap-svg');
        this.svg.setAttribute('viewBox', `0 0 ${this.width} ${this.height}`);
        
        // Gruppo per connessioni
        this.connectionsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        this.svg.appendChild(this.connectionsGroup);
        
        // Gruppo per nodi
        this.nodesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        this.svg.appendChild(this.nodesGroup);
        
        this.container.appendChild(this.svg);
    }
    
    processData() {
        // Converte i dati gerarchici in posizioni (x, y)
        const centerX = this.width / 2;
        const centerY = this.height / 2;
        
        // Nodo centrale
        this.nodes.push({
            id: 'root',
            text: this.data.title,
            level: 0,
            x: centerX,
            y: centerY,
            children: this.data.children || []
        });
        
        // Calcola posizioni per i figli
        this.calculateChildrenPositions(this.nodes[0], centerX, centerY, 0);
    }
    
    calculateChildrenPositions(parent, x, y, level) {
        const children = parent.children;
        if (!children || children.length === 0) return;
        
        const radius = 200 - (level * 40);
        const angleStep = (2 * Math.PI) / children.length;
        const startAngle = level === 0 ? -Math.PI / 2 : 0;
        
        children.forEach((child, i) => {
            const angle = startAngle + (i * angleStep);
            const childX = x + radius * Math.cos(angle);
            const childY = y + radius * Math.sin(angle);
            
            const nodeData = {
                id: `node-${level}-${i}`,
                text: typeof child === 'string' ? child : child.text,
                level: level + 1,
                x: childX,
                y: childY,
                parent: parent.id,
                children: typeof child === 'object' ? child.children : []
            };
            
            this.nodes.push(nodeData);
            
            // Connessione
            this.connections.push({
                from: { x, y },
                to: { x: childX, y: childY },
                fromNode: parent.id,
                toNode: nodeData.id
            });
            
            // Ricorsione per i figli
            if (nodeData.children && nodeData.children.length > 0) {
                this.calculateChildrenPositions(nodeData, childX, childY, level + 1);
            }
        });
    }
    
    render() {
        // Disegna connessioni
        this.connections.forEach(conn => {
            this.drawConnection(conn);
        });
        
        // Disegna nodi
        this.nodes.forEach((node, index) => {
            setTimeout(() => {
                this.drawNode(node);
            }, index * 50);
        });
    }
    
    drawConnection(conn) {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        
        // Curva bezier per connessioni smooth
        const midX = (conn.from.x + conn.to.x) / 2;
        const midY = (conn.from.y + conn.to.y) / 2;
        
        const d = `M ${conn.from.x} ${conn.from.y} Q ${midX} ${midY} ${conn.to.x} ${conn.to.y}`;
        
        path.setAttribute('d', d);
        path.setAttribute('class', 'mindmap-connection');
        path.setAttribute('data-from', conn.fromNode);
        path.setAttribute('data-to', conn.toNode);
        
        this.connectionsGroup.appendChild(path);
    }
    
    drawNode(node) {
        const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        group.setAttribute('class', `mindmap-node level-${node.level}`);
        group.setAttribute('transform', `translate(${node.x}, ${node.y})`);
        group.setAttribute('data-node-id', node.id);
        
        // Cerchio
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('class', 'mindmap-node-circle');
        circle.setAttribute('r', this.nodeRadius[node.level] || 28);
        circle.setAttribute('cx', 0);
        circle.setAttribute('cy', 0);
        
        // Testo
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('class', 'mindmap-node-text');
        text.setAttribute('x', 0);
        text.setAttribute('y', 5);
        
        // Spezza il testo su pi righe se troppo lungo
        const words = node.text.split(' ');
        const maxCharsPerLine = node.level === 0 ? 15 : 12;
        let lines = [];
        let currentLine = '';
        
        words.forEach(word => {
            if ((currentLine + word).length > maxCharsPerLine && currentLine) {
                lines.push(currentLine.trim());
                currentLine = word + ' ';
            } else {
                currentLine += word + ' ';
            }
        });
        if (currentLine) lines.push(currentLine.trim());
        
        // Limita a 2 righe
        lines = lines.slice(0, 2);
        if (lines.length === 1) {
            text.textContent = lines[0];
        } else {
            const tspan1 = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
            tspan1.setAttribute('x', 0);
            tspan1.setAttribute('dy', -8);
            tspan1.textContent = lines[0];
            
            const tspan2 = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
            tspan2.setAttribute('x', 0);
            tspan2.setAttribute('dy', 14);
            tspan2.textContent = lines[1];
            
            text.appendChild(tspan1);
            text.appendChild(tspan2);
        }
        
        // Badge se ha figli
        if (node.children && node.children.length > 0) {
            const badge = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            badge.setAttribute('class', 'mindmap-badge');
            badge.setAttribute('cx', this.nodeRadius[node.level] * 0.6);
            badge.setAttribute('cy', -this.nodeRadius[node.level] * 0.6);
            badge.setAttribute('r', 12);
            
            const badgeText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            badgeText.setAttribute('class', 'mindmap-badge-text');
            badgeText.setAttribute('x', this.nodeRadius[node.level] * 0.6);
            badgeText.setAttribute('y', -this.nodeRadius[node.level] * 0.6 + 4);
            badgeText.textContent = node.children.length;
            
            group.appendChild(badge);
            group.appendChild(badgeText);
        }
        
        group.appendChild(circle);
        group.appendChild(text);
        
        // Eventi
        group.addEventListener('click', () => this.handleNodeClick(node));
        group.addEventListener('mouseenter', (e) => this.showTooltip(node, e));
        group.addEventListener('mouseleave', () => this.hideTooltip());
        
        this.nodesGroup.appendChild(group);
    }
    
    handleNodeClick(node) {
        console.log('Node clicked:', node.text);
        // Highlight connessioni
        this.highlightPath(node.id);
    }
    
    highlightPath(nodeId) {
        // Reset all
        document.querySelectorAll('.mindmap-connection').forEach(c => c.classList.remove('active'));
        
        // Highlight path to root
        let currentId = nodeId;
        while (currentId !== 'root') {
            const conn = this.connections.find(c => c.toNode === currentId);
            if (!conn) break;
            
            const pathEl = document.querySelector(`[data-to="${currentId}"]`);
            if (pathEl) pathEl.classList.add('active');
            
            currentId = conn.fromNode;
        }
    }
    
    showTooltip(node, event) {
        let tooltip = document.querySelector('.mindmap-tooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.className = 'mindmap-tooltip';
            this.container.appendChild(tooltip);
        }
        
        const childrenInfo = node.children && node.children.length > 0 
            ? `${node.children.length} concetti collegati` 
            : 'Nodo finale';
        
        tooltip.innerHTML = `
            <div class="mindmap-tooltip-title">${node.text}</div>
            <div class="mindmap-tooltip-content">${childrenInfo}</div>
        `;
        
        const rect = this.container.getBoundingClientRect();
        tooltip.style.left = (event.clientX - rect.left + 10) + 'px';
        tooltip.style.top = (event.clientY - rect.top + 10) + 'px';
        tooltip.classList.add('show');
    }
    
    hideTooltip() {
        const tooltip = document.querySelector('.mindmap-tooltip');
        if (tooltip) {
            tooltip.classList.remove('show');
        }
    }
    
    setupControls() {
        const controls = document.createElement('div');
        controls.className = 'mindmap-controls';
        controls.innerHTML = `
            <button class="mindmap-control-btn" onclick="window.currentMindmap.zoomIn()" data-tooltip="Zoom In">+</button>
            <button class="mindmap-control-btn" onclick="window.currentMindmap.zoomOut()" data-tooltip="Zoom Out"></button>
            <button class="mindmap-control-btn" onclick="window.currentMindmap.resetView()" data-tooltip="Reset"></button>
            <button class="mindmap-control-btn" onclick="window.currentMindmap.exportPNG()" data-tooltip="Export"></button>
        `;
        this.container.appendChild(controls);
    }
    
    zoomIn() {
        const currentScale = this.svg.style.transform.match(/scale\(([\d.]+)\)/);
        const scale = currentScale ? parseFloat(currentScale[1]) * 1.2 : 1.2;
        this.svg.style.transform = `scale(${scale})`;
        this.svg.style.transformOrigin = 'center center';
    }
    
    zoomOut() {
        const currentScale = this.svg.style.transform.match(/scale\(([\d.]+)\)/);
        const scale = currentScale ? parseFloat(currentScale[1]) / 1.2 : 0.8;
        this.svg.style.transform = `scale(${Math.max(0.5, scale)})`;
    }
    
    resetView() {
        this.svg.style.transform = 'scale(1)';
    }
    
    exportPNG() {
        // Crea un canvas e converte SVG in immagine
        alert('Feature Export PNG in sviluppo! ');
    }
}

// Funzione helper per generare la mappa da testo
function generateMindMapFromText(text) {
    const lines = text.split('\n').filter(line => line.trim());
    const root = {
        title: lines[0].replace(/```|+/g, '').trim(),
        children: []
    };
    
    let currentParent = null;
    let currentLevel = 0;
    
    lines.slice(1).forEach(line => {
        const trimmed = line.trim();
        if (!trimmed || trimmed.startsWith('```')) return;
        
        // Conta il livello di indentazione
        const indent = line.search(/\S/);
        const level = Math.floor(indent / 2);
        
        // Pulisci il testo
        const text = trimmed.replace(/[]/g, '').trim();
        if (!text) return;
        
        if (level === 0) {
            currentParent = { text, children: [] };
            root.children.push(currentParent);
        } else if (level === 1 && currentParent) {
            currentParent.children.push(text);
        }
    });
    
    return root;
}


</script>
</body>
</html>
