<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MentoreStudio - Il tuo mentore personale per lo studio intelligente">
    <title>üìö MentoreStudio - Studia Intelligente</title>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #4caf50;
            --danger: #f44336;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        body.dark-mode { background: #0f0f1e; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .header { background: #2a2a3e; color: #e0e0e0; }
        h1 { font-size: 1.8em; color: var(--primary); }
        body.dark-mode h1 { color: var(--accent); }
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }
        .header-controls { display: flex; gap: 10px; }
        .toggle-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .upload-section { background: #2a2a3e; color: #e0e0e0; }
        input[type="file"], input[type="text"] {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
        }
        body.dark-mode input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .subject-select {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            font-size: 1em;
        }
        body.dark-mode .subject-select { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-delete { background: var(--danger); padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .btn-export { background: #2196F3; padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .tabs { background: #2a2a3e; }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f0f0f0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        body.dark-mode .tab-btn { background: #1a1a2e; color: #e0e0e0; }
        .tab-btn.active { background: var(--primary); color: white; }
        .content-area {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 500px;
        }
        body.dark-mode .content-area { background: #2a2a3e; color: #e0e0e0; }
        .hidden { display: none !important; }
        .section { margin-bottom: 30px; }
        .section h2 { color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        body.dark-mode .section h2 { color: var(--accent); border-color: var(--accent); }
        .card { background: #f5f7ff; padding: 20px; border-radius: 10px; margin: 10px 0; border-left: 4px solid var(--primary); }
        body.dark-mode .card { background: #1a1a2e; border-left-color: var(--accent); }
        .study-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        body.dark-mode .study-item { background: #1a1a2e; }
        .study-item:hover { transform: translateX(5px); background: #e8eaff; }
        .study-info { font-size: 0.9em; color: #666; margin-top: 5px; }
        body.dark-mode .study-info { color: #aaa; }
        .study-left { flex: 1; }
        .study-right { display: flex; gap: 10px; }
        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
        }
        body.dark-mode .search-box { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f0f0f0; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar { background: #e0e0e0; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; transition: width 0.3s; }
        
        .flashcard { 
            perspective: 1000px; 
            min-height: 350px; 
            cursor: pointer; 
            margin: 20px 0; 
            border: 3px solid transparent;
            border-radius: 10px;
        }
        .flashcard.easy { border-color: #4caf50; }
        .flashcard.medium { border-color: #ffa726; }
        .flashcard.difficult { border-color: #f44336; }
        .flashcard-inner { position: relative; width: 100%; min-height: 350px; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard-inner.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; min-height: 350px; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; text-align: center; border-radius: 10px; }
        .flashcard-front { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .flashcard-back { background: linear-gradient(135deg, var(--accent), #f5576c); color: white; transform: rotateY(180deg); }
        .flashcard-question { font-size: 1.3em; font-weight: bold; margin-bottom: 15px; }
        .flashcard-answer { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; }
        .flashcard-extra { 
            font-size: 0.9em; 
            margin-top: 15px; 
            padding-top: 15px; 
            border-top: 2px solid rgba(255,255,255,0.3);
            text-align: left;
            width: 100%;
            line-height: 1.6;
        }
        .flashcard-extra-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .expand-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            margin: 5px;
            transition: all 0.3s;
        }
        .expand-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        .controls { display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
        .quiz-option { 
            background: #f5f7ff; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: all 0.3s;
        }
        body.dark-mode .quiz-option { background: #1a1a2e; }
        .quiz-option:hover { background: #e8eaff; transform: translateX(5px); }
        .quiz-option.selected { border-color: var(--primary); background: #e8eaff; }
        .quiz-option.correct { border-color: var(--success); background: #c8e6c9; }
        .quiz-option.incorrect { border-color: var(--danger); background: #ffcdd2; }
        .timer-display {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 10px;
            margin: 20px 0;
        }
        .timer-display.warning {
            background: linear-gradient(135deg, #ffa726, #fb8c00);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .note-section { background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ffc107; }
        body.dark-mode .note-section { background: #3d3d1a; color: #e0e0e0; }
        .note-input { width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9em; }
        body.dark-mode .note-input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .key-concept { 
            display: inline-block; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px; 
            margin: 3px; 
            font-size: 0.95em;
            font-weight: 600;
        }
        .back-btn { display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--primary); margin-bottom: 20px; font-weight: bold; }
        body.dark-mode .back-btn { color: var(--accent); }
        .review-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
        .review-item.wrong { border-left-color: var(--danger); background: #ffebee; }
        .review-item.correct { border-left-color: var(--success); background: #e8f5e9; }

        .highlight-item {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .highlight-item { background: #1a1a2e; }
        .highlight-item:hover { transform: translateX(5px); background: #e8eaff; }
        body.dark-mode .highlight-item:hover { background: #2a2a3e; }
        .highlight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        .highlight-title {
            flex: 1;
            font-weight: 600;
            line-height: 1.6;
        }
        .highlight-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        .highlight-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(102, 126, 234, 0.2);
            color: #555;
            line-height: 1.8;
            display: none;
        }
        body.dark-mode .highlight-details { color: #bbb; border-top-color: rgba(240, 147, 251, 0.2); }
        .generate-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* CHAT STYLES */
        .chat-container { display: flex; flex-direction: column; height: 600px; max-height: 70vh; }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        body.dark-mode .chat-messages { background: #1a1a2e; }
        .chat-message { display: flex; gap: 10px; animation: slideIn 0.3s ease; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.user { flex-direction: row-reverse; }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }
        .chat-message.user .chat-avatar { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .chat-message.ai .chat-avatar { background: linear-gradient(135deg, var(--accent), #f5576c); color: white; }
        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-bottom-right-radius: 5px;
        }
        .chat-message.ai .chat-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        body.dark-mode .chat-message.ai .chat-bubble { background: #2a2a3e; color: #e0e0e0; }
        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        body.dark-mode .chat-input-container { background: #2a2a3e; }
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
            resize: none;
            font-family: inherit;
        }
        body.dark-mode .chat-input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .chat-send-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .chat-send-btn:disabled { background: #ccc; cursor: not-allowed; }
        .typing-indicator { display: flex; gap: 5px; padding: 10px; }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        .chat-context-info {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            font-size: 0.9em;
        }
        body.dark-mode .chat-context-info { background: rgba(102, 126, 234, 0.2); }
        .chat-suggestions { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .chat-suggestion {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .chat-suggestion { background: #1a1a2e; color: #e0e0e0; }
        .chat-suggestion:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }
        body.dark-mode .error-message { background: rgba(198, 40, 40, 0.2); color: #ff5252; }
        
        /* STUDY GUIDE & CONCEPT ANALYSIS STYLES */
        .question-card {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }
        body.dark-mode .question-card { background: #1a1a2e; }
        .question-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .question-number {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.85em;
            display: inline-block;
            margin-bottom: 10px;
        }
        .question-text {
            font-size: 1.05em;
            line-height: 1.7;
            margin-top: 10px;
            color: #333;
        }
        body.dark-mode .question-text { color: #e0e0e0; }
        .pillar-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05));
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid var(--primary);
            transition: all 0.3s;
        }
        body.dark-mode .pillar-card { background: rgba(102, 126, 234, 0.15); }
        .pillar-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .pillar-title {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        body.dark-mode .pillar-title { color: var(--accent); }
        .pillar-icon {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }
        .pillar-content {
            line-height: 1.8;
            color: #444;
            font-size: 1.05em;
        }
        body.dark-mode .pillar-content { color: #ccc; }
        .connection-box {
            background: rgba(240, 147, 251, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 3px solid var(--accent);
        }
        body.dark-mode .connection-box { background: rgba(240, 147, 251, 0.15); }
        
        /* CUSTOM FORMAT STYLES */
        .format-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        .format-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05));
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            text-align: center;
        }
        body.dark-mode .format-card { background: rgba(102, 126, 234, 0.15); }
        .format-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }
        .format-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .format-title {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }
        body.dark-mode .format-title { color: var(--accent); }
        .format-desc {
            font-size: 0.9em;
            color: #666;
            line-height: 1.5;
        }
        body.dark-mode .format-desc { color: #aaa; }
        .custom-input-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .custom-input-box { background: #2a2a3e; }
        .custom-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }
        body.dark-mode .custom-textarea { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .result-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1.05em;
        }
        body.dark-mode .result-box { background: #1a1a2e; color: #e0e0e0; }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .history-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid var(--secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .history-item { background: #1a1a2e; }
        .history-item:hover { transform: translateX(5px); background: #e8eaff; }
        body.dark-mode .history-item:hover { background: #2a2a3e; }
        .history-meta {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
        }

        /* MINDMAP STYLES */
        .mindmap-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
        }
        body.dark-mode .mindmap-container { background: #1a1a2e; }
        .mindmap-tree {
            font-family: 'Courier New', monospace;
            line-height: 2;
            font-size: 1.05em;
        }
        .mindmap-node {
            margin-left: 20px;
            padding: 5px 0;
        }
        .mindmap-root {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
        }
        body.dark-mode .mindmap-root { color: var(--accent); }
        .mindmap-branch {
            color: var(--secondary);
            font-weight: 600;
        }
        body.dark-mode .mindmap-branch { color: #f093fb; }
        .mindmap-leaf {
            color: #555;
        }
        body.dark-mode .mindmap-leaf { color: #aaa; }
    
        /* === RICERCA GLOBALE === */
        .global-search-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .global-search-container { background: #2a2a3e; }
        .search-filters {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .search-result-item {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .search-result-item { background: #1a1a2e; }
        .search-result-item:hover { 
            transform: translateX(5px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        .search-result-title { 
            font-weight: bold; 
            font-size: 1.1em; 
            margin-bottom: 10px; 
            color: var(--primary); 
        }
        .search-result-context { 
            color: #666; 
            line-height: 1.6; 
        }
        body.dark-mode .search-result-context { color: #aaa; }
        .search-highlight { 
            background: yellow; 
            color: black; 
            padding: 2px 4px; 
            border-radius: 3px; 
            font-weight: bold; 
        }
        .search-meta { 
            font-size: 0.9em; 
            color: #999; 
            margin-top: 10px; 
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://github.com/Domenico374/mentorestudio/blob/main/images/MentoreStudio_logo.png?raw=true" alt="MentoreStudio Logo" style="width: 60px; height: 60px; object-fit: contain;">
                <h1>MentoreStudio</h1>
            </div>
            <div class="header-controls">
                <button class="toggle-btn" onclick="toggleDarkMode()">üåô</button>
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <h2>üöÄ Carica i tuoi PDF</h2>
            <p style="margin-bottom: 15px; color: #666;">Puoi caricare pi√π PDF contemporaneamente</p>
            
            <div style="max-width: 500px; margin: 30px auto;">
                <label style="font-weight: bold; margin-bottom: 10px; display: block;">üìö Materia:</label>
                <select id="subjectSelect" class="subject-select">
                    <option value="Generale">Generale</option>
                    <option value="Storia">Storia</option>
                    <option value="Matematica">Matematica</option>
                    <option value="Biologia">Biologia</option>
                    <option value="Diritto">Diritto</option>
                </select>
                <input type="file" id="pdfFile" accept=".pdf" multiple>
                <button class="btn" onclick="loadMultiplePDFs()" style="width: 100%;">üìÇ Carica PDF</button>
            </div>
            
            <p style="font-size: 0.9em; margin-top: 20px; color: #666;">Tutto salvato offline ‚Ä¢ Nessuna chiave API visibile</p>
        </div>

        <div id="mainApp" class="hidden">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('library', event)">üìö Libreria Studi</button>
                <button class="tab-btn hidden" id="tabSummary" onclick="switchTab('summary', event)">üìù Riassunto</button>
                <button class="tab-btn hidden" id="tabHighlights" onclick="switchTab('highlights', event)">‚≠ê Punti Salienti</button>
                <button class="tab-btn hidden" id="tabGlossary" onclick="switchTab('glossary', event)">üìñ Glossario</button>
                <button class="tab-btn hidden" id="tabTimeline" onclick="switchTab('timeline', event)">üìÖ Timeline</button>
                <button class="tab-btn hidden" id="tabMindmap" onclick="switchTab('mindmap', event)">üß† Mappa Mentale</button>
                <button class="tab-btn hidden" id="tabStudyGuide" onclick="switchTab('studyguide', event)">üìò Guida di Studio</button>
                <button class="tab-btn hidden" id="tabConceptAnalysis" onclick="switchTab('conceptanalysis', event)">üîç Analisi Concetto</button>
                <button class="tab-btn hidden" id="tabCustomFormat" onclick="switchTab('customformat', event)">‚ú® Crea il Tuo</button>
                <button class="tab-btn hidden" id="tabFlashcards" onclick="switchTab('flashcards', event)">üé¥ Flashcard</button>
                <button class="tab-btn hidden" id="tabQuiz" onclick="switchTab('quiz', event)">‚ùì Quiz</button>
                <button class="tab-btn hidden" id="tabChat" onclick="switchTab('chat', event)">üí¨ Chat AI</button>
                <button class="tab-btn" onclick="switchTab('globalsearch', event)">üîç Ricerca Globale</button>
            </div>
            <div class="content-area" id="contentArea"></div>
        </div>
    </div>

    <script>
        let appState = {
            studies: JSON.parse(localStorage.getItem('mentorestudio_studies')) || {},
            currentStudyId: null,
            currentFlashcard: 0,
            currentFlashcardFiltered: 0,
            flashcardMode: 'all',
            currentQuiz: 0,
            currentQuizFiltered: 0,
            quizMode: 'all',
            quizScore: 0,
            quizAnswers: [],
            quizTimerEnabled: false,
            quizTimeRemaining: 0,
            quizTimerId: null,
            notes: JSON.parse(localStorage.getItem('flashcardNotes')) || {},
            darkMode: localStorage.getItem('darkMode') === 'true',
            chatHistory: JSON.parse(localStorage.getItem('chatHistory')) || {},
            isChatLoading: false
        };

        let flashcardStats = JSON.parse(localStorage.getItem('flashcardStats')) || {};
        let quizStats = JSON.parse(localStorage.getItem('quizStats')) || {};

        if (appState.darkMode) document.body.classList.add('dark-mode');

        function toggleDarkMode() {
            appState.darkMode = !appState.darkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', appState.darkMode);
        }

        async function loadMultiplePDFs() {
            const files = document.getElementById('pdfFile').files;
            if (files.length === 0) { alert('Seleziona almeno un PDF'); return; }

            showMainApp();
            let processedCount = 0;

            for (let file of files) {
                try {
                    const text = await extractPDFText(file);
                    const studyId = Date.now() + Math.random();
                    
                    updateProgress(processedCount, files.length, `Elaborando: ${file.name}`);
                    
                    const data = await generateContent(text, document.getElementById('subjectSelect').value);
                    
                    appState.studies[studyId] = {
                        id: studyId,
                        name: file.name.replace('.pdf', ''),
                        data: data,
                        date: new Date().toLocaleDateString('it-IT'),
                        subject: document.getElementById('subjectSelect').value,
                        fullText: text.substring(0, 8000),
                        type: 'pdf'
                    };
                    
                    appState.chatHistory[studyId] = [];
                    
                    processedCount++;
                    updateProgress(processedCount, files.length, `Completato: ${file.name}`);
                } catch (e) {
                    alert(`Errore con ${file.name}: ${e.message}`);
                }
            }

            saveStudies();
            saveChatHistory();
            renderLibrary();
            switchTab('library');
        }
       async function extractPDFText(file) {
    const reader = new FileReader();
    return new Promise((resolve) => {
        reader.onload = async (e) => {
            const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
            let text = '';
            for (let i = 0; i < Math.min(pdf.numPages, 20); i++) {
                const page = await pdf.getPage(i + 1);
                const content = await page.getTextContent();
                text += content.items.map(x => x.str).join(' ') + '\n';
            }
            resolve(text);
        };
        reader.readAsArrayBuffer(file);
    });
}
        function showMainApp() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function updateProgress(current, total, message) {
            document.getElementById('contentArea').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(current/total)*100}%"></div>
                    </div>
                    <p>${current}/${total}</p>
                </div>
            `;
        }

        async function generateContent(text, subject) {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text.substring(0, 8000), subject: subject })
            });

            if (!response.ok) throw new Error('Errore server: ' + response.status);
            return await response.json();
        }

        function saveStudies() {
            localStorage.setItem('mentorestudio_studies', JSON.stringify(appState.studies));
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(appState.chatHistory));
        }

        function switchTab(tab, e) {
            if (e) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
            }
            switch(tab) {
                case 'library': renderLibrary(); break;
                case 'summary': renderSummary(); break;
                case 'highlights': renderHighlights(); break;
                case 'glossary': renderGlossary(); break;
                case 'timeline': renderTimeline(); break;
                case 'mindmap': renderMindMap(); break;
                case 'studyguide': renderStudyGuide(); break;
                case 'conceptanalysis': renderConceptAnalysis(); break;
                case 'customformat': renderCustomFormat(); break;
                case 'flashcards': renderFlashcardsAdvanced(); break;
                case 'quiz': renderQuizAdvanced(); break;
                case 'chat': renderChat(); break;
                case 'globalsearch': renderGlobalSearch(); break;
            }
        }

        function renderLibrary() {
    let html = '<h2>üìö Le tue lezioni</h2>';
    html += '<input type="text" class="search-box" id="librarySearch" placeholder="üîç Cerca un termine in tutte le lezioni..." onkeyup="filterLibrary()">';
    const studies = Object.values(appState.studies).sort((a, b) => b.id - a.id);
    
    if (studies.length === 0) {
        html += `
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 4em; margin-bottom: 20px;">üìö</div>
                <h3 style="color: var(--primary); margin-bottom: 15px;">Nessuna lezione caricata</h3>
                <p style="color: #999; margin-bottom: 30px;">
                    La tua libreria √® vuota. Inizia caricando i tuoi PDF!
                </p>
                <button class="btn" onclick="resetApp()" style="font-size: 1.1em; padding: 15px 30px;">
                    üìÇ Carica Nuovi PDF
                </button>
            </div>
        `;
    } else {
        studies.forEach(study => {
            html += `
                <div class="study-item" onclick="selectStudy('${study.id}')" data-search="${study.name.toLowerCase()} ${(study.data.highlights || []).join(' ').toLowerCase()} ${(study.data.glossary || []).map(g => g.term.toLowerCase()).join(' ')}">
                    <div class="study-left">
                        <strong>üìÑ ${study.name}</strong>
                        <div class="study-info">üìÖ ${study.date} ‚Ä¢ üìö ${study.subject} ‚Ä¢ üé¥ ${study.data.flashcards?.length || 0} flashcard ‚Ä¢ ‚ùì ${study.data.quiz?.length || 0} quiz</div>
                    </div>
                    <div class="study-right">
                        <button class="btn btn-export" onclick="exportStudyPDF('${study.id}', event)">üì• PDF</button>
                        <button class="btn btn-delete" onclick="deleteStudy('${study.id}', event)">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        });
        html += `
            <div style="margin-top: 20px;">
                <button class="btn" onclick="resetApp()" style="width: 100%;">üìÑ Carica Altri PDF</button>
            </div>
        `;
    }
    document.getElementById('contentArea').innerHTML = html;
}


        function filterLibrary() {
            const searchTerm = document.getElementById('librarySearch').value.toLowerCase();
            const items = document.querySelectorAll('.study-item');
            items.forEach(item => {
                const searchData = item.getAttribute('data-search');
                item.style.display = searchData.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function exportStudyPDF(studyId, e) {
            e.stopPropagation();
            const study = appState.studies[studyId];
            if (!study) return;

            const element = document.createElement('div');
            element.style.padding = '20px';
            
            element.innerHTML = `
                <h1>${study.name}</h1>
                <p><strong>Tipo:</strong> üìÑ PDF | <strong>Materia:</strong> ${study.subject} | <strong>Data:</strong> ${study.date}</p>
                
                <h2>üìù Riassunto Breve</h2>
                <p>${study.data.summary_short}</p>
                
                <h2>üìñ Riassunto Completo</h2>
                <p>${study.data.summary_long}</p>
                
                <h2>‚≠ê Punti Salienti</h2>
                <ul>
                    ${(study.data.highlights || []).map(h => `<li>${h}</li>`).join('')}
                </ul>
                
                <h2>üìñ Glossario</h2>
                ${(study.data.glossary || []).map(g => `
                    <div style="margin-bottom: 10px;">
                        <strong>${g.term}:</strong> ${g.definition}
                    </div>
                `).join('')}
                
                <h2>üé¥ Flashcard</h2>
                ${(study.data.flashcards || []).map((f, i) => `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <strong>Domanda ${i+1}:</strong> ${f.q}<br>
                        <strong>Risposta:</strong> ${f.a}
                    </div>
                `).join('')}
                
                <h2>‚ùì Quiz</h2>
                ${(study.data.quiz || []).map((q, i) => `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <strong>Quiz ${i+1}:</strong> ${q.q}<br>
                        ${q.options.map((o, j) => `<div style="margin-left: 20px;">‚Ä¢ ${o}${j === q.correct ? ' ‚úì' : ''}</div>`).join('')}
                    </div>
                `).join('')}
            `;

            const opt = {
                margin: 10,
                filename: `${study.name.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };

            html2pdf().set(opt).from(element).save();
            alert('‚úÖ PDF scaricato!');
        }

        function selectStudy(studyId) {
            appState.currentStudyId = studyId;
            appState.currentFlashcard = 0;
            appState.currentFlashcardFiltered = 0;
            appState.flashcardMode = 'all';
            appState.currentQuiz = 0;
            appState.currentQuizFiltered = 0;
            appState.quizMode = 'all';
            appState.quizScore = 0;
            appState.quizAnswers = [];
            
            if (!appState.chatHistory[studyId]) {
                appState.chatHistory[studyId] = [];
            }
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.add('hidden'));
            document.getElementById('tabSummary').classList.remove('hidden');
            document.getElementById('tabHighlights').classList.remove('hidden');
            document.getElementById('tabGlossary').classList.remove('hidden');
            document.getElementById('tabTimeline').classList.remove('hidden');
            document.getElementById('tabMindmap').classList.remove('hidden');
            document.getElementById('tabStudyGuide').classList.remove('hidden');
            document.getElementById('tabConceptAnalysis').classList.remove('hidden');
            document.getElementById('tabCustomFormat').classList.remove('hidden');
            document.getElementById('tabFlashcards').classList.remove('hidden');
            document.getElementById('tabQuiz').classList.remove('hidden');
            document.getElementById('tabChat').classList.remove('hidden');
            
            switchTab('summary');
        }

        function deleteStudy(studyId, e) {
            e.stopPropagation();
            if (confirm('Eliminare questa lezione?')) {
                delete appState.studies[studyId];
                delete appState.chatHistory[studyId];
                saveStudies();
                saveChatHistory();
                renderLibrary();
            }
        }

        function getCurrentStudy() {
            return appState.studies[appState.currentStudyId];
        }

        function goBack() {
            if (appState.quizTimerId) {
                clearInterval(appState.quizTimerId);
                appState.quizTimerId = null;
            }
            switchTab('library');
        }

        function renderSummary() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <p style="margin-bottom: 20px;"><strong>Tipo:</strong> üìÑ PDF</p>
                <div class="section"><h3>üìù Riassunto Breve</h3><div class="card">${study.data.summary_short || 'N/A'}</div></div>
                <div class="section"><h3>üìñ Riassunto Completo</h3><div class="card">${study.data.summary_long || 'N/A'}</div></div>
            `;
        }

        function renderHighlights() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>‚≠ê Punti Salienti (${(study.data.highlights || []).length})</h3>
                <p style="color: #666; margin-bottom: 20px;">Clicca su ogni punto per vedere la spiegazione dettagliata</p>
            `;
            
            if (!study.data.highlights || study.data.highlights.length === 0) {
                html += `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">‚≠ê</div>
                        <h3>Nessun punto saliente trovato</h3>
                        <p style="margin-top: 10px; color: #666;">
                            I punti chiave verranno estratti automaticamente dal contenuto.
                        </p>
                    </div>
                `;
            } else {
                (study.data.highlights || []).forEach((h, i) => {
                    const highlightId = `highlight_${i}`;
                    const hasExplanation = study.data.highlightDetails && study.data.highlightDetails[i];
                    
                    html += `
                        <div class="highlight-item" onclick="toggleHighlight('${highlightId}')">
                            <div class="highlight-header">
                                <div class="highlight-title">
                                    <strong style="color: var(--primary);">${i + 1}.</strong> 
                                    <span class="key-concept" style="display: inline; padding: 4px 10px;">${h}</span>
                                </div>
                                <span class="highlight-icon" id="${highlightId}_icon">‚ñº</span>
                            </div>
                            
                            <div class="highlight-details" id="${highlightId}_details">
                                ${hasExplanation ? `
                                    <p>${study.data.highlightDetails[i]}</p>
                                ` : `
                                    <p style="color: #999; font-style: italic;">
                                        Nessuna spiegazione disponibile. Generane una con l'AI!
                                    </p>
                                    <button class="generate-btn" onclick="generateHighlightExplanation(${i}, event)">
                                        ü§ñ Genera Spiegazione Dettagliata
                                    </button>
                                `}
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function toggleHighlight(highlightId) {
            const details = document.getElementById(`${highlightId}_details`);
            const icon = document.getElementById(`${highlightId}_icon`);
            
            if (details.style.display === 'none' || details.style.display === '') {
                details.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        async function generateHighlightExplanation(index, event) {
            event.stopPropagation();
            
            const study = getCurrentStudy();
            const highlight = study.data.highlights[index];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generazione in corso...';
            
            try {
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nContenuto: ${study.fullText.substring(0, 1000)}`;
                
                const prompt = `Fornisci una spiegazione dettagliata e approfondita di questo punto saliente:\n\n"${highlight}"\n\nContesto:\n${context}\n\nLa spiegazione deve essere:\n- Chiara e completa (4-6 frasi)\n- Con esempi concreti se possibile\n- Collegata al contesto della lezione\n- Utile per lo studio e la memorizzazione`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                if (!study.data.highlightDetails) {
                    study.data.highlightDetails = {};
                }
                study.data.highlightDetails[index] = data.response;
                
                saveStudies();
                renderHighlights();
                
                setTimeout(() => {
                    toggleHighlight(`highlight_${index}`);
                }, 100);
                
            } catch (error) {
                console.error('Errore:', error);
                alert('‚ùå Errore nella generazione: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'ü§ñ Genera Spiegazione Dettagliata';
            }
        }

        function renderGlossary() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>üìñ Glossario (${(study.data.glossary || []).length} termini)</h3>
                <p style="color: #666; margin-bottom: 15px;">Clicca su ogni termine per vedere definizione ed esempi</p>
            `;
            
            html += '<input type="text" class="search-box" id="glossarySearch" placeholder="üîç Cerca un termine..." onkeyup="filterGlossary()">';
            html += '<div id="glossaryContent">';
            
            if (!study.data.glossary || study.data.glossary.length === 0) {
                html += `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üìñ</div>
                        <h3>Nessun termine nel glossario</h3>
                        <p style="margin-top: 10px; color: #666;">
                            I termini chiave verranno estratti automaticamente dal contenuto.
                        </p>
                    </div>
                `;
            } else {
                (study.data.glossary || []).forEach((item, i) => {
                    const glossaryId = `glossary_${i}`;
                    const hasExample = study.data.glossaryExamples && study.data.glossaryExamples[i];
                    
                    html += `
                        <div class="highlight-item" data-term="${item.term.toLowerCase()}" onclick="toggleHighlight('${glossaryId}')">
                            <div class="highlight-header">
                                <div class="highlight-title">
                                    <strong style="color: var(--secondary); font-size: 1.1em;">${item.term}</strong>
                                </div>
                                <span class="highlight-icon" id="${glossaryId}_icon">‚ñº</span>
                            </div>
                            
                            <div class="highlight-details" id="${glossaryId}_details">
                                <p style="margin-bottom: 15px;"><strong>Definizione:</strong> ${item.definition}</p>
                                
                                ${hasExample ? `
                                    <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; margin-top: 10px;">
                                        <strong style="color: var(--primary);">üí° Esempio pratico:</strong>
                                        <p style="margin-top: 8px;">${study.data.glossaryExamples[i]}</p>
                                    </div>
                                ` : `
                                    <button class="generate-btn" onclick="generateGlossaryExample(${i}, event)">
                                        üí° Genera Esempio Pratico
                                    </button>
                                `}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        function filterGlossary() {
            const searchTerm = document.getElementById('glossarySearch').value.toLowerCase();
            const items = document.querySelectorAll('#glossaryContent .highlight-item');
            items.forEach(item => {
                const term = item.getAttribute('data-term');
                item.style.display = term.includes(searchTerm) ? 'block' : 'none';
            });
        }

        async function generateGlossaryExample(index, event) {
            event.stopPropagation();
            
            const study = getCurrentStudy();
            const glossaryItem = study.data.glossary[index];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generazione esempio...';
            
            try {
                const prompt = `Fornisci un esempio pratico e concreto per questo termine:\n\nTermine: ${glossaryItem.term}\nDefinizione: ${glossaryItem.definition}\n\nMateria: ${study.subject}\n\nL'esempio deve essere:\n- Pratico e dalla vita reale\n- Facile da ricordare\n- Collegato alla materia di studio\n- Massimo 3 frasi`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                if (!study.data.glossaryExamples) {
                    study.data.glossaryExamples = {};
                }
                study.data.glossaryExamples[index] = data.response;
                
                saveStudies();
                renderGlossary();
                
                setTimeout(() => {
                    toggleHighlight(`glossary_${index}`);
                }, 100);
                
            } catch (error) {
                console.error('Errore:', error);
                alert('‚ùå Errore nella generazione: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üí° Genera Esempio Pratico';
            }
        }

        function renderTimeline() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let timeline = study.data.timeline || [];
            
            if (timeline.length === 0 && study.data.highlights && study.data.highlights.length > 0) {
                timeline = study.data.highlights.slice(0, 8).map((highlight, index) => ({
                    date: `Punto ${index + 1}`,
                    event: highlight,
                    details: `Approfondimento su: ${highlight}`
                }));
            }
            
            if (timeline.length === 0) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                    <h2>${study.name}</h2>
                    <h3>üìÖ Timeline Cronologica</h3>
                    <p style="color: #666; margin-bottom: 20px;">Clicca su ogni evento per vedere i dettagli</p>
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üìÖ</div>
                        <h3>Nessun evento temporale trovato</h3>
                        <p style="margin-top: 10px; color: #666;">
                            Questa lezione non contiene date o eventi cronologici specifici.
                        </p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>üìÖ Timeline Cronologica (${timeline.length} eventi)</h3>
                <p style="color: #666; margin-bottom: 20px;">Clicca su ogni evento per vedere i dettagli</p>
                <div style="position: relative; padding: 20px 0;">
                    <div style="position: absolute; left: 30px; top: 0; bottom: 0; width: 3px; background: linear-gradient(to bottom, var(--primary), var(--secondary));"></div>
            `;
            
            timeline.forEach((item, index) => {
                const itemId = `timeline_${index}`;
                html += `
                    <div style="display: flex; align-items: flex-start; margin: 20px 0; position: relative;">
                        <div style="position: absolute; left: 21px; width: 20px; height: 20px; background: white; border: 4px solid var(--primary); border-radius: 50%; z-index: 1;"></div>
                        <div style="margin-left: 60px; flex: 1;">
                            <div class="timeline-item" onclick="toggleTimelineItem('${itemId}')" style="cursor: pointer; transition: all 0.3s;">
                                <div class="card" style="margin: 0; border-left: 4px solid var(--primary);">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
                                                ${item.date || `Evento ${index + 1}`}
                                            </span>
                                        </div>
                                        <span id="${itemId}_icon" style="font-size: 1.2em; transition: transform 0.3s;">‚ñº</span>
                                    </div>
                                    <p style="margin: 10px 0 0 0; line-height: 1.6; font-weight: 600;">
                                        ${item.event}
                                    </p>
                                    <div id="${itemId}_details" class="timeline-details" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                        <p style="color: #666; line-height: 1.8;">
                                            ${item.details || item.event}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        function toggleTimelineItem(itemId) {
            const details = document.getElementById(`${itemId}_details`);
            const icon = document.getElementById(`${itemId}_icon`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // ===== MAPPA MENTALE POTENZIATA =====
        
        function renderMindMap() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>üß† Mappa Mentale Completa</h3>
                <p style="color: #666; margin-bottom: 20px;">Struttura gerarchica con rami e collegamenti</p>
            `;
            
            const mindmap = study.data.mindmapDetailed;
            
            if (!mindmap) {
                html += `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üß†</div>
                        <h3>Mappa Mentale non ancora generata</h3>
                        <p style="color: #666; margin: 20px 0;">
                            Genera una mappa mentale dettagliata con struttura gerarchica,<br>
                            sotto-concetti e collegamenti tra i vari rami.
                        </p>
                        <button class="btn" onclick="generateDetailedMindmap()">
                            ü§ñ Genera Mappa Mentale Completa
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <div class="mindmap-container">
                        <div class="mindmap-tree">
                            ${mindmap}
                        </div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn" onclick="copyMindmap()">
                            üìã Copia Mappa
                        </button>
                        <button class="btn" onclick="downloadMindmap()">
                            üì• Scarica TXT
                        </button>
                        <button class="btn" onclick="generateDetailedMindmap()">
                            üîÑ Rigenera Mappa
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        async function generateDetailedMindmap() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>üß† Generazione Mappa Mentale</h3>
                    <p>Sto creando la struttura gerarchica completa...</p>
                </div>
            `;
            
            try {
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nRiassunto: ${study.data.summary_long}\n\nPunti chiave: ${(study.data.highlights || []).join(', ')}`;
                
                const prompt = `Crea una mappa mentale TESTUALE dettagliata e gerarchica per questo argomento:\n\n${context}\n\nUsa questa struttura ASCII:\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n   CONCETTO CENTRALE\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n‚îú‚îÄ Ramo principale 1\n‚îÇ  ‚îú‚îÄ Sotto-concetto 1.1\n‚îÇ  ‚îú‚îÄ Sotto-concetto 1.2\n‚îÇ  ‚îî‚îÄ Sotto-concetto 1.3\n‚îÇ\n‚îú‚îÄ Ramo principale 2\n‚îÇ  ‚îú‚îÄ Sotto-concetto 2.1\n‚îÇ  ‚îÇ  ‚îú‚îÄ Dettaglio 2.1.1\n‚îÇ  ‚îÇ  ‚îî‚îÄ Dettaglio 2.1.2\n‚îÇ  ‚îî‚îÄ Sotto-concetto 2.2\n‚îÇ\n‚îú‚îÄ Ramo principale 3\n‚îÇ  ‚îú‚îÄ Sotto-concetto 3.1\n‚îÇ  ‚îî‚îÄ Sotto-concetto 3.2\n‚îÇ\n‚îî‚îÄ Collegamenti:\n   ‚Ä¢ Collega concetto 1.1 con 2.1\n   ‚Ä¢ Collega concetto 2.2 con 3.1\n\nCrea 3-4 rami principali con sotto-concetti dettagliati.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                study.data.mindmapDetailed = data.response;
                
                saveStudies();
                renderMindMap();
                
            } catch (error) {
                console.error('Errore:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="error-message">
                        ‚ùå Errore nella generazione: ${error.message}
                        <button class="btn" onclick="renderMindMap()" style="margin-top: 15px;">
                            üîÑ Riprova
                        </button>
                    </div>
                `;
            }
        }

        function copyMindmap() {
            const study = getCurrentStudy();
            const mindmap = study.data.mindmapDetailed;
            
            if (!mindmap) return;
            
            navigator.clipboard.writeText(mindmap).then(() => {
                alert('‚úÖ Mappa mentale copiata negli appunti!');
            }).catch(() => {
                alert('‚ùå Errore nella copia');
            });
        }

        function downloadMindmap() {
            const study = getCurrentStudy();
            const mindmap = study.data.mindmapDetailed;
            
            if (!mindmap) return;
            
            const blob = new Blob([mindmap], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MappaMentale_${study.name.replace(/[^a-z0-9]/gi, '_')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Mappa mentale scaricata!');
        }

        // ===== GUIDA DI STUDIO =====
        
        function renderStudyGuide() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>üìò Guida di Studio</h3>
                <p style="color: #666; margin-bottom: 30px;">Domande per saggi, esami orali e scritti</p>
            `;
            
            if (study.data.quiz && study.data.quiz.length > 0) {
                html += `
                    <div class="section">
                        <h3 style="color: var(--primary); margin-top: 30px;">‚ùì Quiz a Risposta Multipla</h3>
                        <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                            Vai alla sezione Quiz per esercitarti con ${study.data.quiz.length} domande
                        </p>
                        <button class="btn" onclick="switchTab('quiz')">
                            üéØ Vai ai Quiz
                        </button>
                    </div>
                `;
            }
            
            html += `
                <div class="section">
                    <h3 style="color: var(--primary); margin-top: 30px;">‚úèÔ∏è Domande per Saggi ed Esami</h3>
                    <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                        Domande aperte che richiedono analisi critica e ragionamento approfondito
                    </p>
            `;
            
            const essayQuestions = study.data.essayQuestions || [];
            
            if (essayQuestions.length === 0) {
                html += `
                    <div class="card" style="text-align: center; padding: 30px;">
                        <p style="color: #999; margin-bottom: 15px;">
                            Nessuna domanda per saggio ancora generata
                        </p>
                        <button class="btn" onclick="generateEssayQuestions()">
                            ü§ñ Genera Domande per Saggio
                        </button>
                    </div>
                `;
            } else {
                essayQuestions.forEach((question, i) => {
                    html += `
                        <div class="question-card">
                            <span class="question-number">Domanda ${i + 1}</span>
                            <div class="question-text">${question}</div>
                        </div>
                    `;
                });
                
                html += `
                    <button class="btn" onclick="generateEssayQuestions()" style="margin-top: 15px;">
                        üîÑ Genera Altre Domande
                    </button>
                `;
            }
            
            html += `</div>`;
            
            if (study.data.glossary && study.data.glossary.length > 0) {
                html += `
                    <div class="section">
                        <h3 style="color: var(--primary); margin-top: 30px;">üìñ Glossario dei Termini</h3>
                        <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                            ${study.data.glossary.length} termini chiave da conoscere
                        </p>
                        <button class="btn" onclick="switchTab('glossary')">
                            üìö Vai al Glossario
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        async function generateEssayQuestions() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>ü§ñ Generazione Domande per Saggio</h3>
                    <p>Sto creando domande di analisi critica...</p>
                </div>
            `;
            
            try {
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nRiassunto: ${study.data.summary_short}\n\nPunti chiave: ${(study.data.highlights || []).slice(0, 5).join(', ')}`;
                
                const prompt = `Genera 5 domande per saggi/esami scritti su questo argomento:\n\n${context}\n\nLe domande devono:\n- Essere aperte e richiedere ragionamento critico\n- Iniziare con "Analizza...", "Discuti...", "Come...", "In che modo...", "Spiega..."\n- Essere adatte per esami universitari o superiori\n- Coprire aspetti diversi dell'argomento\n- Essere formulate in modo chiaro\n\nFormato: una domanda per riga, numerate da 1 a 5.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                const questions = data.response
                    .split('\n')
                    .filter(line => line.trim().length > 0)
                    .map(line => line.replace(/^\d+\.\s*/, '').trim())
                    .filter(q => q.length > 20);
                
                if (!study.data.essayQuestions) {
                    study.data.essayQuestions = [];
                }
                
                questions.forEach(q => {
                    if (!study.data.essayQuestions.includes(q)) {
                        study.data.essayQuestions.push(q);
                    }
                });
                
                saveStudies();
                renderStudyGuide();
                
            } catch (error) {
                console.error('Errore:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="error-message">
                        ‚ùå Errore nella generazione: ${error.message}
                        <button class="btn" onclick="renderStudyGuide()" style="margin-top: 15px;">
                            üîÑ Riprova
                        </button>
                    </div>
                `;
            }
        }

        // ===== ANALISI DEL CONCETTO =====
        
        function renderConceptAnalysis() {
            const study = getCurrentStudy();
            if (!study) return;
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>üîç Analisi del Concetto</h3>
                <p style="color: #666; margin-bottom: 30px;">I tre pilastri fondamentali che sostengono questa lezione</p>
            `;
            
            const analysis = study.data.conceptAnalysis;
            
            if (!analysis) {
                html += `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üîç</div>
                        <h3>Analisi non ancora generata</h3>
                        <p style="color: #666; margin: 20px 0;">
                            L'analisi del concetto ti aiuta a comprendere i tre pilastri fondamentali<br>
                            dell'argomento e come si collegano tra loro.
                        </p>
                        <button class="btn" onclick="generateConceptAnalysis()">
                            ü§ñ Genera Analisi del Concetto
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <div class="pillar-card">
                        <div class="pillar-title">
                            <div class="pillar-icon">1Ô∏è‚É£</div>
                            <span>Primo Pilastro: ${analysis.pillar1_title || 'Definizione Base'}</span>
                        </div>
                        <div class="pillar-content">
                            ${analysis.pillar1_content || 'Contenuto non disponibile'}
                        </div>
                    </div>
                    
                    <div class="pillar-card">
                        <div class="pillar-title">
                            <div class="pillar-icon">2Ô∏è‚É£</div>
                            <span>Secondo Pilastro: ${analysis.pillar2_title || 'Applicazioni Pratiche'}</span>
                        </div>
                        <div class="pillar-content">
                            ${analysis.pillar2_content || 'Contenuto non disponibile'}
                        </div>
                    </div>
                    
                    <div class="pillar-card">
                        <div class="pillar-title">
                            <div class="pillar-icon">3Ô∏è‚É£</div>
                            <span>Terzo Pilastro: ${analysis.pillar3_title || 'Collegamenti Concettuali'}</span>
                        </div>
                        <div class="pillar-content">
                            ${analysis.pillar3_content || 'Contenuto non disponibile'}
                        </div>
                    </div>
                `;
                
                if (analysis.connections) {
                    html += `
                        <div class="connection-box">
                            <h4 style="margin-bottom: 10px; color: var(--accent);">üîó Come si Collegano i Tre Pilastri</h4>
                            <p style="line-height: 1.8;">${analysis.connections}</p>
                        </div>
                    `;
                }
                
                html += `
                    <button class="btn" onclick="generateConceptAnalysis()" style="margin-top: 30px;">
                        üîÑ Rigenera Analisi
                    </button>
                `;
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        async function generateConceptAnalysis() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>üîç Analisi del Concetto in Corso</h3>
                    <p>Sto identificando i tre pilastri fondamentali...</p>
                </div>
            `;
            
            try {
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nRiassunto: ${study.data.summary_long}\n\nPunti chiave: ${(study.data.highlights || []).join(', ')}`;
                
                const prompt = `Analizza in profondit√† questo argomento identificando i TRE PILASTRI FONDAMENTALI:\n\n${context}\n\nPer ogni pilastro fornisci:\n1. TITOLO del pilastro (3-5 parole)\n2. CONTENUTO del pilastro (4-6 frasi di spiegazione approfondita)\n\nPoi spiega come i tre pilastri si COLLEGANO tra loro.\n\nFormato richiesto:\nPILASTRO 1: [titolo]\n[contenuto]\n\nPILASTRO 2: [titolo]\n[contenuto]\n\nPILASTRO 3: [titolo]\n[contenuto]\n\nCOLLEGAMENTI:\n[spiegazione dei collegamenti]`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                
                const text = data.response;
                const pillar1Match = text.match(/PILASTRO 1:\s*([^\n]+)\n([\s\S]*?)(?=PILASTRO 2:|$)/i);
                const pillar2Match = text.match(/PILASTRO 2:\s*([^\n]+)\n([\s\S]*?)(?=PILASTRO 3:|$)/i);
                const pillar3Match = text.match(/PILASTRO 3:\s*([^\n]+)\n([\s\S]*?)(?=COLLEGAMENTI:|$)/i);
                const connectionsMatch = text.match(/COLLEGAMENTI:\s*([\s\S]*?)$/i);
                
                study.data.conceptAnalysis = {
                    pillar1_title: pillar1Match ? pillar1Match[1].trim() : 'Definizione Base',
                    pillar1_content: pillar1Match ? pillar1Match[2].trim() : '',
                    pillar2_title: pillar2Match ? pillar2Match[1].trim() : 'Applicazioni Pratiche',
                    pillar2_content: pillar2Match ? pillar2Match[2].trim() : '',
                    pillar3_title: pillar3Match ? pillar3Match[1].trim() : 'Collegamenti Concettuali',
                    pillar3_content: pillar3Match ? pillar3Match[2].trim() : '',
                    connections: connectionsMatch ? connectionsMatch[1].trim() : ''
                };
                
                saveStudies();
                renderConceptAnalysis();
                
            } catch (error) {
                console.error('Errore:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="error-message">
                        ‚ùå Errore nella generazione: ${error.message}
                        <button class="btn" onclick="renderConceptAnalysis()" style="margin-top: 15px;">
                            üîÑ Riprova
                        </button>
                    </div>
                `;
            }
        }

        // ===== FORMATO PERSONALIZZATO (SENZA MAPPA MENTALE, VIDEO, POESIA, STORY) =====
        
        function renderCustomFormat() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const history = study.data.customFormats || [];
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>‚ú® Crea il Tuo Formato</h3>
                <p style="color: #666; margin-bottom: 30px;">Trasforma il contenuto in qualsiasi formato desideri</p>
                
                <div class="section">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">üìã Suggerimenti Rapidi</h4>
                    <p style="color: #666; font-size: 0.95em; margin-bottom: 20px;">Clicca su un formato per generarlo automaticamente</p>
                    
                    <div class="format-grid">
                        <div class="format-card" onclick="generateCustomFormat('slides')">
                            <div class="format-icon">üìä</div>
                            <div class="format-title">Presentazione Slides</div>
                            <div class="format-desc">10 slides con titoli, punti chiave e note</div>
                        </div>
                        
                        <div class="format-card" onclick="generateCustomFormat('powerpoint')">
                            <div class="format-icon">üìä</div>
                            <div class="format-title">PowerPoint (.pptx)</div>
                            <div class="format-desc">File PowerPoint scaricabile per presentazioni</div>
                        </div>
                        
                        <div class="format-card" onclick="generateCustomFormat('schema')">
                            <div class="format-icon">üìã</div>
                            <div class="format-title">Schema di Studio</div>
                            <div class="format-desc">Schema avanzato con priorit√† e collegamenti</div>
                        </div>
                        
                        <div class="format-card" onclick="generateCustomFormat('tabella')">
                            <div class="format-icon">üìä</div>
                            <div class="format-title">Tabella Comparativa</div>
                            <div class="format-desc">Confronto organizzato in formato tabella</div>
                        </div>
                        
                        <div class="format-card" onclick="generateCustomFormat('dialogo')">
                            <div class="format-icon">üí¨</div>
                            <div class="format-title">Dialogo Q&A</div>
                            <div class="format-desc">Conversazione Socratica domanda-risposta</div>
                        </div>
                    </div>
                </div>
                
                <div class="custom-input-box">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">‚úçÔ∏è Oppure Scrivi la Tua Richiesta</h4>
                    <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                        Esempio: "Crea un quiz interattivo", "Trasforma in infografica testuale", "Genera FAQ"
                    </p>
                    <textarea 
                        class="custom-textarea" 
                        id="customFormatInput" 
                        placeholder="Scrivi cosa vuoi creare (es: 'Trasforma in mappa concettuale con collegamenti tra argomenti')..."
                    ></textarea>
                    <button class="btn" onclick="generateCustomFormat('custom')" style="margin-top: 15px;">
                        üöÄ Genera Formato Personalizzato
                    </button>
                </div>
                
                <div id="customFormatResult"></div>
            `;
            
            if (history.length > 0) {
                html += `
                    <div class="section" style="margin-top: 40px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">üìú Storico Trasformazioni (${history.length})</h4>
                        <div id="formatHistory">
                `;
                
                history.slice().reverse().forEach((item, i) => {
                    const timeAgo = getTimeAgo(item.timestamp);
                    html += `
                        <div class="history-item" onclick="showHistoryItem(${history.length - 1 - i})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${item.icon} ${item.title}</strong>
                                    <div class="history-meta">${timeAgo}</div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-export" onclick="copyHistoryItem(${history.length - 1 - i}, event)" style="padding: 6px 12px; font-size: 0.85em;">
                                        üìã Copia
                                    </button>
                                    <button class="btn btn-delete" onclick="deleteHistoryItem(${history.length - 1 - i}, event)" style="padding: 6px 12px; font-size: 0.85em;">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        const formatTemplates = {
            'slides': {
                icon: 'üìä',
                title: 'Presentazione Slides',
                prompt: `Trasforma in una presentazione di 10 slides con questa struttura:

SLIDE 1: [Titolo accattivante]
- Sottotitolo
- Immagine suggerita: [descrizione]

SLIDE 2-9: [Contenuto principale]
Per ogni slide includi:
- Titolo della slide
- 3-5 punti chiave (bullet points)
- Note per il presentatore

SLIDE 10: Conclusione
- Riepilogo
- Call to action

Contenuto: {content}`
            },
            'schema': {
                icon: 'üìã',
                title: 'Schema di Studio Avanzato',
                prompt: `Crea uno schema di studio completo e strutturato:

üìö ARGOMENTO PRINCIPALE
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üéØ OBIETTIVI DI APPRENDIMENTO
- Cosa devi sapere
- Cosa devi saper fare

üìñ CONCETTI FONDAMENTALI
[Organizza in ordine logico con priorit√†]
‚òÖ‚òÖ‚òÖ Priorit√† ALTA
‚òÖ‚òÖ‚òÜ Priorit√† MEDIA  
‚òÖ‚òÜ‚òÜ Priorit√† BASSA

üîó COLLEGAMENTI
[Come si collegano i concetti]

üí° STRATEGIE DI MEMORIZZAZIONE
[Tecniche specifiche]

‚úÖ CHECKLIST PADRONANZA
[Come verificare di aver capito]

Contenuto: {content}`
            },
            'tabella': {
                icon: 'üìä',
                title: 'Tabella Comparativa',
                prompt: `Crea una tabella comparativa ben strutturata:

Identifica 3-5 elementi da confrontare e almeno 5 criteri di confronto.

Formato:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
|  CRITERIO       | Elemento 1 | Elemento 2 | Elemento 3 |
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
| Definizione     |            |            |            |
| Caratteristiche |            |            |            |
| Pro             |            |            |            |
| Contro          |            |            |            |
| Applicazioni    |            |            |            |
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí° Sintesi comparativa: [breve analisi]

Contenuto: {content}`
            },
            'dialogo': {
                icon: 'üí¨',
                title: 'Dialogo Socratico',
                prompt: `Crea un dialogo Socratico (domanda-risposta) per esplorare l'argomento:

Personaggi:
üë®‚Äçüè´ MAESTRO - Guida con domande
üë®‚Äçüéì STUDENTE - Scopre attraverso il ragionamento

Struttura:
MAESTRO: [Domanda aperta]
STUDENTE: [Risposta iniziale]
MAESTRO: [Domanda di approfondimento]
STUDENTE: [Riflessione pi√π profonda]
[continua per 8-10 scambi]

Finale: Lo studente arriva alla comprensione profonda

Contenuto: {content}`
            }
        };

        async function generateCustomFormat(formatType) {
            const study = getCurrentStudy();
            if (!study) return;
            
            let prompt = '';
            let formatInfo = null;
            
            if (formatType === 'powerpoint') {
                // Genera PowerPoint direttamente
                await generatePowerPoint();
                return;
            }
            
            if (formatType === 'custom') {
                const customInput = document.getElementById('customFormatInput').value.trim();
                if (!customInput) {
                    alert('‚ö†Ô∏è Inserisci una richiesta personalizzata!');
                    return;
                }
                prompt = `${customInput}\n\nContenuto da trasformare:\n${study.data.summary_long}\n\nPunti chiave: ${(study.data.highlights || []).join(', ')}`;
                formatInfo = { icon: '‚ú®', title: customInput.substring(0, 50) };
            } else {
                formatInfo = formatTemplates[formatType];
                const content = `${study.data.summary_long}\n\nPunti chiave: ${(study.data.highlights || []).join(', ')}`;
                prompt = formatInfo.prompt.replace('{content}', content);
            }
            
            document.getElementById('customFormatResult').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>‚ú® Creazione in Corso</h3>
                    <p>Sto generando il formato "${formatInfo.title}"...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore nella generazione');
                
                const data = await response.json();
                const result = data.response;
                
                if (!study.data.customFormats) {
                    study.data.customFormats = [];
                }
                
                study.data.customFormats.push({
                    type: formatType,
                    icon: formatInfo.icon,
                    title: formatInfo.title,
                    content: result,
                    timestamp: Date.now()
                });
                
                saveStudies();
                displayFormatResult(result, formatInfo);
                
            } catch (error) {
                console.error('Errore:', error);
                document.getElementById('customFormatResult').innerHTML = `
                    <div class="error-message">
                        ‚ùå Errore nella generazione: ${error.message}
                        <button class="btn" onclick="renderCustomFormat()" style="margin-top: 15px;">
                            üîÑ Riprova
                        </button>
                    </div>
                `;
            }
        }

        function displayFormatResult(content, formatInfo) {
            const resultHTML = `
                <div class="section" style="margin-top: 30px;">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">
                        ${formatInfo.icon} Risultato: ${formatInfo.title}
                    </h4>
                    
                    <div class="result-box">${content}</div>
                    
                    <div class="export-buttons">
                        <button class="btn" onclick="copyFormatResult()">
                            üìã Copia negli Appunti
                        </button>
                        <button class="btn" onclick="downloadFormatResult('${formatInfo.title.replace(/[^a-z0-9]/gi, '_')}')">
                            üì• Scarica TXT
                        </button>
                        <button class="btn" onclick="renderCustomFormat()">
                            ‚ú® Crea Altro Formato
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('customFormatResult').innerHTML = resultHTML;
            document.getElementById('customFormatResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function copyFormatResult() {
            const resultBox = document.querySelector('.result-box');
            if (!resultBox) return;
            
            const text = resultBox.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Contenuto copiato negli appunti!');
            }).catch(() => {
                alert('‚ùå Errore nella copia');
            });
        }

        function downloadFormatResult(filename) {
            const resultBox = document.querySelector('.result-box');
            if (!resultBox) return;
            
            const text = resultBox.textContent;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ File scaricato!');
        }

        function showHistoryItem(index) {
            const study = getCurrentStudy();
            const item = study.data.customFormats[index];
            if (!item) return;
            
            displayFormatResult(item.content, { icon: item.icon, title: item.title });
        }

        function copyHistoryItem(index, event) {
            event.stopPropagation();
            const study = getCurrentStudy();
            const item = study.data.customFormats[index];
            if (!item) return;
            
            navigator.clipboard.writeText(item.content).then(() => {
                alert('‚úÖ Contenuto copiato!');
            });
        }

        function deleteHistoryItem(index, event) {
            event.stopPropagation();
            const study = getCurrentStudy();
            
            if (confirm('Eliminare questa trasformazione dallo storico?')) {
                study.data.customFormats.splice(index, 1);
                saveStudies();
                renderCustomFormat();
            }
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            
            if (seconds < 60) return 'Pochi secondi fa';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} minuti fa`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} ore fa`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} giorni fa`;
            
            return new Date(timestamp).toLocaleDateString('it-IT');
        }

        // ===== POWERPOINT EXPORT =====
        
        async function generatePowerPoint() {
            const study = getCurrentStudy();
            if (!study) return;
            
            document.getElementById('customFormatResult').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>üìä Generazione PowerPoint</h3>
                    <p>Sto creando la presentazione...</p>
                </div>
            `;
            
            try {
                const pptx = new PptxGenJS();
                
                pptx.layout = 'LAYOUT_16x9';
                pptx.author = 'MentoreStudio';
                pptx.title = study.name;
                pptx.subject = study.subject;
                
                // Slide 1 - Titolo
                let slide = pptx.addSlide();
                slide.background = { color: '667eea' };
                slide.addText(study.name, {
                    x: 1, y: 2.5, w: 8, h: 1,
                    fontSize: 44, bold: true, color: 'FFFFFF',
                    align: 'center'
                });
                slide.addText(study.subject, {
                    x: 1, y: 3.5, w: 8, h: 0.5,
                    fontSize: 24, color: 'FFFFFF',
                    align: 'center'
                });
                
                // Slide 2 - Introduzione
                slide = pptx.addSlide();
                slide.addText('üìù Introduzione', {
                    x: 0.5, y: 0.5, fontSize: 32, bold: true, color: '667eea'
                });
                slide.addText(study.data.summary_short, {
                    x: 0.5, y: 1.5, w: 9, h: 4,
                    fontSize: 16, valign: 'top'
                });
                
                // Slides per Punti Salienti
                (study.data.highlights || []).slice(0, 8).forEach((highlight, i) => {
                    slide = pptx.addSlide();
                    slide.addText(`‚≠ê Punto Chiave ${i+1}`, {
                        x: 0.5, y: 0.5, fontSize: 28, bold: true, color: '667eea'
                    });
                    slide.addText([
                        { text: highlight, options: { fontSize: 18, bullet: true } }
                    ], {
                        x: 0.5, y: 1.5, w: 9, h: 4
                    });
                });
                
                // Slide Glossario
                if (study.data.glossary && study.data.glossary.length > 0) {
                    slide = pptx.addSlide();
                    slide.addText('üìñ Glossario', {
                        x: 0.5, y: 0.5, fontSize: 32, bold: true, color: '667eea'
                    });
                    
                    const rows = [
                        [{ text: 'Termine', options: { bold: true, fontSize: 14 } }, 
                         { text: 'Definizione', options: { bold: true, fontSize: 14 } }]
                    ];
                    
                    (study.data.glossary || []).slice(0, 6).forEach(g => {
                        rows.push([
                            { text: g.term, options: { fontSize: 12 } },
                            { text: g.definition, options: { fontSize: 12 } }
                        ]);
                    });
                    
                    slide.addTable(rows, {
                        x: 0.5, y: 1.2, w: 9, h: 4,
                        border: { pt: 1, color: '667eea' }
                    });
                }
                
                // Slide Conclusione
                slide = pptx.addSlide();
                slide.addText('‚úÖ Conclusione', {
                    x: 0.5, y: 0.5, fontSize: 32, bold: true, color: '667eea'
                });
                slide.addText(study.data.summary_long.substring(0, 400), {
                    x: 0.5, y: 1.5, w: 9, h: 4,
                    fontSize: 16
                });
                
                await pptx.writeFile({ fileName: `${study.name.replace(/[^a-z0-9]/gi, '_')}.pptx` });
                
                document.getElementById('customFormatResult').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üìä</div>
                        <h3>PowerPoint Generato con Successo!</h3>
                        <p style="margin: 20px 0; color: #666;">
                            Il file "${study.name}.pptx" √® stato scaricato
                        </p>
                        <button class="btn" onclick="generatePowerPoint()">
                            üîÑ Genera Altro PowerPoint
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Errore PowerPoint:', error);
                document.getElementById('customFormatResult').innerHTML = `
                    <div class="error-message">
                        ‚ùå Errore nella generazione PowerPoint: ${error.message}
                        <button class="btn" onclick="renderCustomFormat()" style="margin-top: 15px;">
                            üîÑ Riprova
                        </button>
                    </div>
                `;
            }
        }

        // ===== FLASHCARD E QUIZ (versioni complete dal codice precedente) =====
        
        function renderFlashcardsAdvanced() {
            const study = getCurrentStudy();
            if (!study || !study.data.flashcards) return;

            const allFlashcards = study.data.flashcards;
            const filteredFlashcards = filterFlashcardsByMode(allFlashcards);
            
            if (filteredFlashcards.length === 0) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                    <h2>${study.name}</h2>
                    <h3>üé¥ Flashcard</h3>
                    <div class="card" style="text-align: center;">
                        <p>Nessuna flashcard trovata per il filtro selezionato.</p>
                        <button class="btn" onclick="appState.flashcardMode = 'all'; renderFlashcardsAdvanced()">Mostra Tutte</button>
                    </div>
                `;
                return;
            }

            const currentCard = filteredFlashcards[appState.currentFlashcardFiltered];
            const currentCardId = `${study.id}_${currentCard.q}`;
            const stats = flashcardStats[currentCardId] || { difficulty: 'medium', views: 0, correct: 0 };

            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>üé¥ Flashcard (${appState.currentFlashcardFiltered + 1}/${filteredFlashcards.length})</h3>
                
                <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
                    <button class="btn ${appState.flashcardMode === 'all' ? 'active' : ''}" onclick="changeFlashcardMode('all')">üìö Tutte</button>
                    <button class="btn ${appState.flashcardMode === 'difficult' ? 'active' : ''}" onclick="changeFlashcardMode('difficult')">üî¥ Difficili</button>
                    <button class="btn ${appState.flashcardMode === 'medium' ? 'active' : ''}" onclick="changeFlashcardMode('medium')">üü† Medie</button>
                    <button class="btn ${appState.flashcardMode === 'easy' ? 'active' : ''}" onclick="changeFlashcardMode('easy')">üü¢ Facili</button>
                </div>

                <div class="flashcard ${stats.difficulty}" onclick="flipCard()">
                    <div class="flashcard-inner" id="flashcardInner">
                        <div class="flashcard-front">
                            <div class="flashcard-question">${currentCard.q}</div>
                            <div style="font-size: 0.8em; opacity: 0.8; margin-top: 15px;">
                                üëÜ Clicca per vedere la risposta
                            </div>
                        </div>
                        <div class="flashcard-back">
                            <div class="flashcard-answer">${currentCard.a}</div>
                            
                            <div id="flashcardExtras" style="width: 100%;">
                                ${currentCard.explanation ? `
                                    <div class="flashcard-extra">
                                        <div class="flashcard-extra-title">üí° Spiegazione Semplice:</div>
                                        <div>${currentCard.explanation}</div>
                                    </div>
                                ` : ''}
                                
                                ${currentCard.example ? `
                                    <div class="flashcard-extra">
                                        <div class="flashcard-extra-title">üìö Esempio Pratico:</div>
                                        <div>${currentCard.example}</div>
                                    </div>
                                ` : ''}
                                
                                ${currentCard.essay ? `
                                    <div class="flashcard-extra">
                                        <div class="flashcard-extra-title">‚úèÔ∏è Domanda per Saggio:</div>
                                        <div>${currentCard.essay}</div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;" onclick="event.stopPropagation()">
                                ${!currentCard.explanation ? `<button class="expand-btn" onclick="generateExplanation('${currentCardId}')">üí° Spiega Semplice</button>` : ''}
                                ${!currentCard.example ? `<button class="expand-btn" onclick="generateExample('${currentCardId}')">üìö Esempio</button>` : ''}
                                ${!currentCard.essay ? `<button class="expand-btn" onclick="generateEssay('${currentCardId}')">‚úèÔ∏è Domanda Saggio</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn" onclick="prevFlashcard()">‚¨ÖÔ∏è Precedente</button>
                    <button class="btn" onclick="flipCard()">üîÑ Gira</button>
                    <button class="btn" onclick="nextFlashcard()">Successiva ‚û°Ô∏è</button>
                </div>

                <div class="controls" style="margin-top: 20px;">
                    <button class="btn" style="background: #4caf50;" onclick="markDifficulty('easy')">üü¢ Facile</button>
                    <button class="btn" style="background: #ffa726;" onclick="markDifficulty('medium')">üü† Medio</button>
                    <button class="btn" style="background: #f44336;" onclick="markDifficulty('difficult')">üî¥ Difficile</button>
                </div>

                <div class="note-section">
                    <strong>üìù Note Personali:</strong>
                    <textarea class="note-input" id="flashcardNote" rows="3" placeholder="Aggiungi note per questa flashcard...">${appState.notes[currentCardId] || ''}</textarea>
                    <button class="btn" onclick="saveFlashcardNote('${currentCardId}')" style="margin-top: 10px;">üíæ Salva Nota</button>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <strong>üìä Statistiche:</strong> Visualizzata ${stats.views} volte | Difficolt√†: ${stats.difficulty === 'easy' ? 'üü¢ Facile' : stats.difficulty === 'medium' ? 'üü† Medio' : 'üî¥ Difficile'}
                </div>
            `;

            document.getElementById('contentArea').innerHTML = html;
            updateFlashcardStats(currentCardId);
        }

        function filterFlashcardsByMode(flashcards) {
            if (appState.flashcardMode === 'all') return flashcards;
            
            const study = getCurrentStudy();
            return flashcards.filter(card => {
                const cardId = `${study.id}_${card.q}`;
                const stats = flashcardStats[cardId] || { difficulty: 'medium' };
                return stats.difficulty === appState.flashcardMode;
            });
        }

        function changeFlashcardMode(mode) {
            appState.flashcardMode = mode;
            appState.currentFlashcardFiltered = 0;
            renderFlashcardsAdvanced();
        }

        function flipCard() {
            document.getElementById('flashcardInner').classList.toggle('flipped');
        }

        function nextFlashcard() {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            appState.currentFlashcardFiltered = (appState.currentFlashcardFiltered + 1) % filtered.length;
            renderFlashcardsAdvanced();
        }

        function prevFlashcard() {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            appState.currentFlashcardFiltered = appState.currentFlashcardFiltered === 0 ? filtered.length - 1 : appState.currentFlashcardFiltered - 1;
            renderFlashcardsAdvanced();
        }

        function markDifficulty(difficulty) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            const cardId = `${study.id}_${currentCard.q}`;
            
            if (!flashcardStats[cardId]) flashcardStats[cardId] = { difficulty: 'medium', views: 0, correct: 0 };
            flashcardStats[cardId].difficulty = difficulty;
            
            localStorage.setItem('flashcardStats', JSON.stringify(flashcardStats));
            renderFlashcardsAdvanced();
        }

        function updateFlashcardStats(cardId) {
            if (!flashcardStats[cardId]) flashcardStats[cardId] = { difficulty: 'medium', views: 0, correct: 0 };
            flashcardStats[cardId].views++;
            localStorage.setItem('flashcardStats', JSON.stringify(flashcardStats));
        }

        function saveFlashcardNote(cardId) {
            const note = document.getElementById('flashcardNote').value;
            appState.notes[cardId] = note;
            localStorage.setItem('flashcardNotes', JSON.stringify(appState.notes));
            alert('‚úÖ Nota salvata!');
        }

        async function generateExplanation(cardId) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generazione...';
            
            try {
                const prompt = `Spiega in modo molto semplice (come a un bambino di 10 anni) questo concetto:\n\nDomanda: ${currentCard.q}\nRisposta: ${currentCard.a}\n\nFornisci una spiegazione chiara, breve (max 3 frasi) e con esempi quotidiani.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore generazione');
                
                const data = await response.json();
                currentCard.explanation = data.response;
                
                saveStudies();
                renderFlashcardsAdvanced();
                
                setTimeout(() => {
                    document.getElementById('flashcardInner').classList.add('flipped');
                }, 100);
                
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üí° Spiega Semplice';
            }
        }
        
        async function generateExample(cardId) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generazione...';
            
            try {
                const prompt = `Fornisci un esempio pratico e concreto per questo concetto:\n\nDomanda: ${currentCard.q}\nRisposta: ${currentCard.a}\n\nDai un esempio reale dalla vita quotidiana o dalla materia ${study.subject}. Max 3 frasi.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore generazione');
                
                const data = await response.json();
                currentCard.example = data.response;
                
                saveStudies();
                renderFlashcardsAdvanced();
                
                setTimeout(() => {
                    document.getElementById('flashcardInner').classList.add('flipped');
                }, 100);
                
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üìö Esempio';
            }
        }
        
        async function generateEssay(cardId) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generazione...';
            
            try {
                const prompt = `Crea una domanda da saggio/tema d'esame su questo argomento:\n\nDomanda: ${currentCard.q}\nRisposta: ${currentCard.a}\n\nLa domanda deve essere aperta, richiedere ragionamento critico e analisi. Max 2 frasi. Inizia con "Come..." o "In che modo..." o "Analizza..." o "Discuti...".`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore generazione');
                
                const data = await response.json();
                currentCard.essay = data.response;
                
                saveStudies();
                renderFlashcardsAdvanced();
                
                setTimeout(() => {
                    document.getElementById('flashcardInner').classList.add('flipped');
                }, 100);
                
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
                btn.disabled = false;
                btn.textContent = '‚úèÔ∏è Domanda Saggio';
            }
        }

        function renderQuizAdvanced() {
            const study = getCurrentStudy();
            if (!study || !study.data.quiz) return;

            const allQuestions = study.data.quiz;
            const filteredQuestions = filterQuizByMode(allQuestions);

            if (filteredQuestions.length === 0) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                    <h2>${study.name}</h2>
                    <h3>‚ùì Quiz</h3>
                    <div class="card" style="text-align: center;">
                        <p>Nessuna domanda trovata per il filtro selezionato.</p>
                        <button class="btn" onclick="appState.quizMode = 'all'; renderQuizAdvanced()">Mostra Tutte</button>
                    </div>
                `;
                return;
            }

            if (appState.currentQuizFiltered >= filteredQuestions.length) {
                return renderQuizResults();
            }

            const currentQuestion = filteredQuestions[appState.currentQuizFiltered];

            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>‚ùì Quiz (${appState.currentQuizFiltered + 1}/${filteredQuestions.length})</h3>

                <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
                    <button class="btn ${appState.quizMode === 'all' ? 'active' : ''}" onclick="changeQuizMode('all')">üìö Tutte</button>
                    <button class="btn ${appState.quizMode === 'wrong' ? 'active' : ''}" onclick="changeQuizMode('wrong')">‚ùå Sbagliate</button>
                    <button class="btn ${appState.quizMode === 'correct' ? 'active' : ''}" onclick="changeQuizMode('correct')">‚úÖ Corrette</button>
                    <button class="btn ${appState.quizMode === 'unseen' ? 'active' : ''}" onclick="changeQuizMode('unseen')">üëÅÔ∏è Non Viste</button>
                </div>

                <div style="display: flex; align-items: center; gap: 10px; margin: 20px 0;">
                    <label><input type="checkbox" id="timerCheckbox" ${appState.quizTimerEnabled ? 'checked' : ''} onchange="toggleQuizTimer()"> ‚è±Ô∏è Timer (60s per domanda)</label>
                </div>
            `;

            if (appState.quizTimerEnabled) {
                html += `<div class="timer-display ${appState.quizTimeRemaining < 10 ? 'warning' : ''}" id="quizTimer">${appState.quizTimeRemaining}s</div>`;
            }

            html += `
                <div class="card">
                    <h4>${currentQuestion.q}</h4>
                </div>
            `;

            currentQuestion.options.forEach((option, i) => {
                const isAnswered = appState.quizAnswers[appState.currentQuizFiltered] !== undefined;
                const userAnswer = appState.quizAnswers[appState.currentQuizFiltered];
                let className = 'quiz-option';
                
                if (isAnswered) {
                    if (i === currentQuestion.correct) className += ' correct';
                    else if (i === userAnswer) className += ' incorrect';
                } else if (userAnswer === i) {
                    className += ' selected';
                }

                html += `<div class="${className}" onclick="${isAnswered ? '' : `selectQuizAnswer(${i})`}">${option}</div>`;
            });

            if (appState.quizAnswers[appState.currentQuizFiltered] === undefined) {
                html += `
                    <div class="controls">
                        <button class="btn" onclick="submitQuizAnswer()">‚úÖ Conferma</button>
                    </div>
                `;
            } else {
                html += `
                    <div class="controls">
                        <button class="btn" onclick="nextQuizQuestion()">Prossima ‚û°Ô∏è</button>
                    </div>
                `;
            }

            document.getElementById('contentArea').innerHTML = html;

            if (appState.quizTimerEnabled && !appState.quizTimerId) {
                startQuizTimer();
            }
        }

        function filterQuizByMode(questions) {
            if (appState.quizMode === 'all') return questions;
            
            const study = getCurrentStudy();
            return questions.filter(q => {
                const qId = `${study.id}_${q.q}`;
                const stats = quizStats[qId];
                
                if (appState.quizMode === 'unseen') return !stats;
                if (appState.quizMode === 'correct') return stats && stats.correct;
                if (appState.quizMode === 'wrong') return stats && !stats.correct;
                
                return true;
            });
        }

        function changeQuizMode(mode) {
            appState.quizMode = mode;
            appState.currentQuizFiltered = 0;
            appState.quizAnswers = [];
            appState.quizScore = 0;
            renderQuizAdvanced();
        }

        function toggleQuizTimer() {
            appState.quizTimerEnabled = document.getElementById('timerCheckbox').checked;
            if (appState.quizTimerEnabled) {
                appState.quizTimeRemaining = 60;
                startQuizTimer();
            } else {
                if (appState.quizTimerId) {
                    clearInterval(appState.quizTimerId);
                    appState.quizTimerId = null;
                }
            }
            renderQuizAdvanced();
        }

        function startQuizTimer() {
            appState.quizTimeRemaining = 60;
            if (appState.quizTimerId) clearInterval(appState.quizTimerId);
            
            appState.quizTimerId = setInterval(() => {
                appState.quizTimeRemaining--;
                const timerEl = document.getElementById('quizTimer');
                if (timerEl) {
                    timerEl.textContent = `${appState.quizTimeRemaining}s`;
                    if (appState.quizTimeRemaining < 10) {
                        timerEl.classList.add('warning');
                    }
                }
                
                if (appState.quizTimeRemaining <= 0) {
                    clearInterval(appState.quizTimerId);
                    appState.quizTimerId = null;
                    appState.quizAnswers[appState.currentQuizFiltered] = -1;
                    nextQuizQuestion();
                }
            }, 1000);
        }

        function selectQuizAnswer(index) {
            const currentAnswerIndex = appState.quizAnswers[appState.currentQuizFiltered];
            if (currentAnswerIndex === undefined) {
                appState.quizAnswers[appState.currentQuizFiltered] = index;
                renderQuizAdvanced();
            }
        }

        function submitQuizAnswer() {
            if (appState.quizTimerId) {
                clearInterval(appState.quizTimerId);
                appState.quizTimerId = null;
            }

            const study = getCurrentStudy();
            const filtered = filterQuizByMode(study.data.quiz);
            const currentQuestion = filtered[appState.currentQuizFiltered];
            const userAnswer = appState.quizAnswers[appState.currentQuizFiltered];

            if (userAnswer === undefined) {
                alert('Seleziona una risposta!');
                return;
            }

            const isCorrect = userAnswer === currentQuestion.correct;
            if (isCorrect) appState.quizScore++;

            const qId = `${study.id}_${currentQuestion.q}`;
            quizStats[qId] = { correct: isCorrect, timestamp: Date.now() };
            localStorage.setItem('quizStats', JSON.stringify(quizStats));

            renderQuizAdvanced();
        }

        function nextQuizQuestion() {
            const study = getCurrentStudy();
            const filtered = filterQuizByMode(study.data.quiz);
            
            appState.currentQuizFiltered++;
            
            if (appState.currentQuizFiltered >= filtered.length) {
                if (appState.quizTimerId) {
                    clearInterval(appState.quizTimerId);
                    appState.quizTimerId = null;
                }
                renderQuizResults();
            } else {
                if (appState.quizTimerEnabled) {
                    startQuizTimer();
                }
                renderQuizAdvanced();
            }
        }

        function renderQuizResults() {
            const study = getCurrentStudy();
            const filtered = filterQuizByMode(study.data.quiz);
            const percentage = Math.round((appState.quizScore / filtered.length) * 100);

            let emoji = 'üò¢';
            if (percentage >= 90) emoji = 'üéâ';
            else if (percentage >= 70) emoji = 'üòä';
            else if (percentage >= 50) emoji = 'üòê';

            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <h3>üéØ Risultati Quiz</h3>

                <div class="card" style="text-align: center; font-size: 1.5em;">
                    <div style="font-size: 4em; margin: 20px 0;">${emoji}</div>
                    <p><strong>Punteggio: ${appState.quizScore}/${filtered.length}</strong></p>
                    <p>${percentage}%</p>
                </div>

                <h3 style="margin-top: 30px;">üìù Riepilogo</h3>
            `;

            filtered.forEach((q, i) => {
                const userAnswer = appState.quizAnswers[i];
                const isCorrect = userAnswer === q.correct;
                html += `
                    <div class="review-item ${isCorrect ? 'correct' : 'wrong'}">
                        <strong>Domanda ${i + 1}:</strong> ${q.q}<br>
                        <strong>La tua risposta:</strong> ${userAnswer >= 0 ? q.options[userAnswer] : 'Nessuna risposta'}<br>
                        <strong>Risposta corretta:</strong> ${q.options[q.correct]}<br>
                        ${isCorrect ? '‚úÖ Corretto!' : '‚ùå Sbagliato'}
                    </div>
                `;
            });

            html += `
                <div class="controls" style="margin-top: 30px;">
                    <button class="btn" onclick="resetQuiz()">üîÑ Rifai Quiz</button>
                    <button class="btn" onclick="switchTab('library')">üìö Torna alla Libreria</button>
                </div>
            `;

            document.getElementById('contentArea').innerHTML = html;
        }

        function resetQuiz() {
            appState.currentQuizFiltered = 0;
            appState.quizAnswers = [];
            appState.quizScore = 0;
            if (appState.quizTimerId) {
                clearInterval(appState.quizTimerId);
                appState.quizTimerId = null;
            }
            renderQuizAdvanced();
        }

        // ===== CHAT AI =====
        
        function renderChat() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const chatHistory = appState.chatHistory[study.id] || [];
            
            let html = `
                <div class="back-btn" onclick="goBack()">‚Üê Torna alla Libreria</div>
                <h2>üí¨ Chat AI - ${study.name}</h2>
                
                <div class="chat-context-info">
                    <strong>‚ÑπÔ∏è Contesto attivo:</strong> ${study.subject} - ${study.name}
                    <br>
                    <small>L'AI ha accesso al contenuto della lezione e pu√≤ rispondere alle tue domande</small>
                </div>
                
                <div class="chat-suggestions">
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Spiegami i concetti principali di questa lezione')">
                        üí° Concetti principali
                    </div>
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Crea un piano di studio per questa lezione')">
                        üìÖ Piano di studio
                    </div>
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Quali sono le domande d\\'esame pi√π probabili?')">
                        üéØ Domande d'esame
                    </div>
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Dammi esempi pratici di applicazione')">
                        üîß Esempi pratici
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        ${chatHistory.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;">üí¨</div>
                                <p>Inizia una conversazione!</p>
                                <p style="font-size: 0.9em; margin-top: 10px;">Fai domande sulla lezione o usa i suggerimenti sopra</p>
                            </div>
                        ` : chatHistory.map((msg, idx) => createChatMessageHTML(msg, `msg_${study.id}_${idx}`)).join('')}
                    </div>
                    
                    <div class="chat-input-container">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Scrivi la tua domanda..."
                            rows="1"
                            onkeypress="handleChatKeyPress(event)"
                        ></textarea>
                        <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
                            Invia üì§
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn" onclick="clearChatHistory()" style="padding: 8px 15px; font-size: 0.9em; background: var(--danger);">
                        üóëÔ∏è Cancella Conversazione
                    </button>
                    <button class="btn" onclick="exportChatHistory()" style="padding: 8px 15px; font-size: 0.9em;">
                        üì• Esporta Chat
                    </button>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
            scrollChatToBottom();
            
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
        }

        function createChatMessageHTML(message, messageId) {
            const isUser = message.role === 'user';
            const msgId = messageId || 'msg_' + Date.now() + Math.random();
            
            return `
                <div class="chat-message ${isUser ? 'user' : 'ai'}" data-message-id="${msgId}">
                    <div class="chat-avatar">${isUser ? 'üë§' : 'ü§ñ'}</div>
                    <div style="flex: 1;">
                        <div class="chat-bubble">${escapeHTML(message.content)}</div>
                    </div>
                </div>
            `;
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function sendSuggestedQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendChatMessage();
        }

        async function sendChatMessage() {
            const study = getCurrentStudy();
            if (!study || appState.isChatLoading) return;
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const userMessageId = `msg_${study.id}_${appState.chatHistory[study.id].length}`;
            appState.chatHistory[study.id].push({
                role: 'user',
                content: message
            });
            
            input.value = '';
            input.style.height = 'auto';
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += createChatMessageHTML({
                role: 'user',
                content: message
            }, userMessageId);
            
            messagesContainer.innerHTML += `
                <div class="chat-message ai" id="typingIndicator">
                    <div class="chat-avatar">ü§ñ</div>
                    <div class="chat-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            scrollChatToBottom();
            
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Invio...';
            appState.isChatLoading = true;
            
            try {
                const summaryShort = (study.data.summary_short || '').substring(0, 300);
                const highlightsText = (study.data.highlights || []).slice(0, 3).join('. ').substring(0, 200);
                const contentSnippet = study.fullText ? study.fullText.substring(0, 400) : '';
                
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nRiassunto: ${summaryShort}\n\nPunti chiave: ${highlightsText}\n\nEstratto: ${contentSnippet}`;
                
                const conversationHistory = appState.chatHistory[study.id]
                    .slice(0, -1)
                    .slice(-5)
                    .map(msg => ({
                        role: msg.role,
                        content: msg.content.substring(0, 500)
                    }));
                
                const fullMessage = `[CONTESTO]\n${context}\n\n[DOMANDA]\n${message}`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: fullMessage,
                        conversationHistory: conversationHistory
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Errore server: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.response;
                
                document.getElementById('typingIndicator').remove();
                
                const aiMessageId = `msg_${study.id}_${appState.chatHistory[study.id].length}`;
                appState.chatHistory[study.id].push({
                    role: 'assistant',
                    content: aiResponse
                });
                
                messagesContainer.innerHTML += createChatMessageHTML({
                    role: 'assistant',
                    content: aiResponse
                }, aiMessageId);
                
                saveChatHistory();
                scrollChatToBottom();
                
            } catch (error) {
                console.error('Errore chat:', error);
                
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();
                
                messagesContainer.innerHTML += `
                    <div class="error-message">
                        ‚ùå Errore: ${error.message}. Riprova tra poco.
                    </div>
                `;
                
                appState.chatHistory[study.id].pop();
                
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Invia üì§';
                appState.isChatLoading = false;
                scrollChatToBottom();
            }
        }

        function scrollChatToBottom() {
            setTimeout(() => {
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, 100);
        }

        function clearChatHistory() {
            const study = getCurrentStudy();
            if (!study) return;
            
            if (confirm('Vuoi cancellare tutta la conversazione?')) {
                appState.chatHistory[study.id] = [];
                saveChatHistory();
                renderChat();
            }
        }

        function exportChatHistory() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const chatHistory = appState.chatHistory[study.id] || [];
            
            if (chatHistory.length === 0) {
                alert('Non ci sono messaggi da esportare');
                return;
            }
            
            let exportText = `Chat AI - ${study.name}\n`;
            exportText += `Data: ${new Date().toLocaleDateString('it-IT')}\n`;
            exportText += `Materia: ${study.subject}\n\n`;
            exportText += '='.repeat(50) + '\n\n';
            
            chatHistory.forEach((msg, i) => {
                const role = msg.role === 'user' ? 'üë§ Tu' : 'ü§ñ AI';
                exportText += `${role}:\n${msg.content}\n\n`;
            });
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${study.name.replace(/[^a-z0-9]/gi, '_')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Chat esportata!');
        }

        function resetApp() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('pdfFile').value = '';
        }

        
        // ============================================
        // üîç RICERCA GLOBALE
        // ============================================
        
        function renderGlobalSearch() {
            let html = '<div class="global-search-container">';
            html += '<h2>üîç Ricerca Globale</h2>';
            html += '<p style="color: #666; margin-bottom: 20px;">Cerca in tutte le tue lezioni, riassunti, flashcard e quiz</p>';
            
            // Campo di ricerca
            html += '<input type="text" class="search-box" id="globalSearchInput" placeholder="üîç Cerca termini, concetti, domande..." onkeyup="if(event.key===\'Enter\') performGlobalSearch()">';
            
            // Filtri
            html += '<div class="search-filters">';
            html += '<select id="searchSubjectFilter" class="subject-select" style="max-width: 200px;" onchange="performGlobalSearch()">';
            html += '<option value="all">üìö Tutte le materie</option>';
            
            const subjects = [...new Set(Object.values(appState.studies).map(s => s.subject))];
            subjects.forEach(subj => {
                html += `<option value="${subj}">${subj}</option>`;
            });
            html += '</select>';
            
            html += '<button class="btn" onclick="performGlobalSearch()">üîç Cerca</button>';
            html += '<button class="btn" onclick="clearGlobalSearch()" style="background: #666;">üîÑ Reset</button>';
            html += '</div>';
            
            // Risultati
            html += '<div id="searchResults" style="margin-top: 30px;">';
            html += '<p style="text-align: center; color: #999; padding: 40px;">Inserisci un termine di ricerca</p>';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function performGlobalSearch() {
            const query = document.getElementById('globalSearchInput').value.toLowerCase().trim();
            const subject = document.getElementById('searchSubjectFilter').value;
            
            if (!query) {
                document.getElementById('searchResults').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Inserisci un termine di ricerca</p>';
                return;
            }
            
            const results = [];
            
            // Cerca in tutte le lezioni
            Object.values(appState.studies).forEach(study => {
                // Filtra per materia
                if (subject !== 'all' && study.subject !== subject) return;
                
                // Cerca nel nome
                if (study.name.toLowerCase().includes(query)) {
                    results.push({
                        studyId: study.id,
                        studyName: study.name,
                        subject: study.subject,
                        date: study.date,
                        type: 'Nome Lezione',
                        context: study.name,
                        relevance: 10
                    });
                }
                
                // Cerca nel riassunto
                if (study.data.summary_short && study.data.summary_short.toLowerCase().includes(query)) {
                    const context = getContextAround(study.data.summary_short, query, 150);
                    results.push({
                        studyId: study.id,
                        studyName: study.name,
                        subject: study.subject,
                        date: study.date,
                        type: 'Riassunto',
                        context: highlightQuery(context, query),
                        relevance: 9
                    });
                }
                
                // Cerca nei punti salienti
                if (study.data.highlights) {
                    study.data.highlights.forEach(highlight => {
                        if (highlight.toLowerCase().includes(query)) {
                            results.push({
                                studyId: study.id,
                                studyName: study.name,
                                subject: study.subject,
                                date: study.date,
                                type: 'Punto Saliente',
                                context: highlightQuery(highlight, query),
                                relevance: 8
                            });
                        }
                    });
                }
                
                // Cerca nel glossario
                if (study.data.glossary) {
                    study.data.glossary.forEach(item => {
                        if (item.term.toLowerCase().includes(query) || item.definition.toLowerCase().includes(query)) {
                            results.push({
                                studyId: study.id,
                                studyName: study.name,
                                subject: study.subject,
                                date: study.date,
                                type: 'Glossario',
                                context: highlightQuery(`<strong>${item.term}:</strong> ${item.definition}`, query),
                                relevance: 7
                            });
                        }
                    });
                }
                
                // Cerca nelle flashcard
                if (study.data.flashcards) {
                    study.data.flashcards.forEach(card => {
                        if (card.question.toLowerCase().includes(query) || card.answer.toLowerCase().includes(query)) {
                            results.push({
                                studyId: study.id,
                                studyName: study.name,
                                subject: study.subject,
                                date: study.date,
                                type: 'Flashcard',
                                context: highlightQuery(`<strong>D:</strong> ${card.question}<br><strong>R:</strong> ${card.answer.substring(0, 100)}`, query),
                                relevance: 6
                            });
                        }
                    });
                }
                
                // Cerca nei quiz
                if (study.data.quiz) {
                    study.data.quiz.forEach(q => {
                        if (q.question.toLowerCase().includes(query)) {
                            results.push({
                                studyId: study.id,
                                studyName: study.name,
                                subject: study.subject,
                                date: study.date,
                                type: 'Quiz',
                                context: highlightQuery(q.question, query),
                                relevance: 5
                            });
                        }
                    });
                }
            });
            
            // Ordina per rilevanza
            results.sort((a, b) => b.relevance - a.relevance);
            
            displaySearchResults(query, results);
        }

        function displaySearchResults(query, results) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üîç</div>
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Nessun risultato trovato</h3>
                        <p style="color: #999;">Prova con altri termini di ricerca o modifica i filtri</p>
                    </div>
                `;
                return;
            }
            
            let html = `<h3 style="margin-bottom: 20px;">üìä Trovati ${results.length} risultati per "${query}"</h3>`;
            
            results.forEach(result => {
                html += `
                    <div class="search-result-item" onclick="openSearchResult('${result.studyId}', '${result.type}')">
                        <div class="search-result-title">
                            üìÑ ${result.studyName}
                            <span style="background: var(--primary); color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.8em; margin-left: 10px;">${result.type}</span>
                        </div>
                        <div class="search-result-context">${result.context}</div>
                        <div class="search-meta">üìö ${result.subject} ‚Ä¢ üìÖ ${result.date}</div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        function highlightQuery(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function getContextAround(text, query, length) {
            const lowerText = text.toLowerCase();
            const lowerQuery = query.toLowerCase();
            const index = lowerText.indexOf(lowerQuery);
            
            if (index === -1) return text.substring(0, length) + '...';
            
            const start = Math.max(0, index - length / 2);
            const end = Math.min(text.length, index + query.length + length / 2);
            
            let context = text.substring(start, end);
            if (start > 0) context = '...' + context;
            if (end < text.length) context = context + '...';
            
            return context;
        }

        function openSearchResult(studyId, type) {
            appState.currentStudyId = studyId;
            showStudyTabs();
            
            const typeToTab = {
                'Nome Lezione': 'summary',
                'Riassunto': 'summary',
                'Punto Saliente': 'highlights',
                'Glossario': 'glossary',
                'Flashcard': 'flashcards',
                'Quiz': 'quiz'
            };
            
            switchTab(typeToTab[type] || 'summary');
        }

        function clearGlobalSearch() {
            document.getElementById('globalSearchInput').value = '';
            document.getElementById('searchSubjectFilter').value = 'all';
            document.getElementById('searchResults').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Inserisci un termine di ricerca</p>';
        }


        if (Object.keys(appState.studies).length > 0) {
            showMainApp();
            switchTab('library');
        }
    </script>
</body>
</html>
