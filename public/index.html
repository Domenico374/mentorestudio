<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MentoreStudio - Il tuo mentore personale per lo studio intelligente">
    <title>📚 MentoreStudio - Studia Intelligente</title>
    
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // CORREZIONE: Configurazione worker PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
    
    <!-- Altre librerie -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #4caf50;
            --danger: #f44336;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        body.dark-mode { background: #0f0f1e; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        body.dark-mode .header { background: #2a2a3e; color: #e0e0e0; }
        
        h1 { font-size: 1.8em; color: var(--primary); }
        
        body.dark-mode h1 { color: var(--accent); }
        
        .header-controls { display: flex; gap: 10px; }
        
        .toggle-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .toggle-btn:hover { opacity: 0.9; }
        
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        body.dark-mode .upload-section { background: #2a2a3e; color: #e0e0e0; }
        
        input[type="file"], input[type="text"] {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
        }
        
        body.dark-mode input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        
        .subject-select {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            font-size: 1em;
        }
        
        body.dark-mode .subject-select { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s;
        }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-delete { background: var(--danger); padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .btn-export { background: #2196F3; padding: 8px 15px; margin: 0; font-size: 0.9em; }
        
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        body.dark-mode .tabs { background: #2a2a3e; }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f0f0f0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        body.dark-mode .tab-btn { background: #1a1a2e; color: #e0e0e0; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-btn:hover:not(.active) { background: #e0e0e0; }
        
        .content-area {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 500px;
        }
        
        body.dark-mode .content-area { background: #2a2a3e; color: #e0e0e0; }
        
        .hidden { display: none !important; }
        
        .section { margin-bottom: 30px; }
        .section h2 { 
            color: var(--primary); 
            margin-bottom: 15px; 
            border-bottom: 2px solid var(--primary); 
            padding-bottom: 10px; 
        }
        
        body.dark-mode .section h2 { color: var(--accent); border-color: var(--accent); }
        
        .card { 
            background: #f5f7ff; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 10px 0; 
            border-left: 4px solid var(--primary); 
        }
        
        body.dark-mode .card { background: #1a1a2e; border-left-color: var(--accent); }
        
        .study-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        body.dark-mode .study-item { background: #1a1a2e; }
        .study-item:hover { transform: translateX(5px); background: #e8eaff; }
        body.dark-mode .study-item:hover { background: #2a2a3e; }
        
        .study-info { font-size: 0.9em; color: #666; margin-top: 5px; }
        body.dark-mode .study-info { color: #aaa; }
        .study-left { flex: 1; }
        .study-right { display: flex; gap: 10px; }
        
        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
        }
        
        body.dark-mode .search-box { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        
        .loading { text-align: center; padding: 40px; }
        .spinner { 
            border: 4px solid #f0f0f0; 
            border-top: 4px solid var(--primary); 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .progress-bar { 
            background: #e0e0e0; 
            height: 10px; 
            border-radius: 5px; 
            margin: 15px 0; 
            overflow: hidden; 
        }
        
        .progress-fill { 
            background: var(--primary); 
            height: 100%; 
            transition: width 0.3s; 
        }
        
        /* Flashcards */
        .flashcard { 
            perspective: 1000px; 
            min-height: 350px; 
            cursor: pointer; 
            margin: 20px 0; 
            border: 3px solid transparent;
            border-radius: 10px;
        }
        
        .flashcard.easy { border-color: #4caf50; }
        .flashcard.medium { border-color: #ffa726; }
        .flashcard.difficult { border-color: #f44336; }
        
        .flashcard-inner { 
            position: relative; 
            width: 100%; 
            min-height: 350px; 
            transition: transform 0.6s; 
            transform-style: preserve-3d; 
        }
        
        .flashcard-inner.flipped { transform: rotateY(180deg); }
        
        .flashcard-front, .flashcard-back { 
            position: absolute; 
            width: 100%; 
            min-height: 350px; 
            backface-visibility: hidden; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 25px; 
            text-align: center; 
            border-radius: 10px; 
        }
        
        .flashcard-front { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
        }
        
        .flashcard-back { 
            background: linear-gradient(135deg, var(--accent), #f5576c); 
            color: white; 
            transform: rotateY(180deg); 
        }
        
        .flashcard-question { font-size: 1.3em; font-weight: bold; margin-bottom: 15px; }
        .flashcard-answer { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; }
        
        .flashcard-extra { 
            font-size: 0.9em; 
            margin-top: 15px; 
            padding-top: 15px; 
            border-top: 2px solid rgba(255,255,255,0.3);
            text-align: left;
            width: 100%;
            line-height: 1.6;
        }
        
        .flashcard-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .flashcard-nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: white;
            color: var(--primary);
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Quiz */
        .quiz-question {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        body.dark-mode .quiz-question { background: #1a1a2e; }
        
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .quiz-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quiz-option:hover { background: #f0f0f0; border-color: var(--primary); }
        .quiz-option.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .quiz-option.correct { background: var(--success); color: white; border-color: var(--success); }
        .quiz-option.wrong { background: var(--danger); color: white; border-color: var(--danger); }
        
        /* Chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        
        body.dark-mode .chat-container { border-color: #444; }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
        }
        
        body.dark-mode .chat-messages { background: #1a1a2e; }
        
        .chat-message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        
        .chat-message.user { flex-direction: row-reverse; }
        
        .chat-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }
        
        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            word-wrap: break-word;
        }
        
        .chat-message.user .chat-bubble {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .chat-message.ai .chat-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
        }
        
        body.dark-mode .chat-message.ai .chat-bubble {
            background: #2a2a3e;
            color: #e0e0e0;
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-top: 2px solid #ddd;
        }
        
        body.dark-mode .chat-input-area { 
            background: #2a2a3e; 
            border-top-color: #444; 
        }
        
        #chatInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            min-height: 40px;
            max-height: 120px;
            font-family: inherit;
        }
        
        body.dark-mode #chatInput {
            background: #1a1a2e;
            color: #e0e0e0;
            border-color: #444;
        }
        
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 10px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }
        
        body.dark-mode .error-message {
            background: #3d1f1f;
            color: #ff6b6b;
        }
        
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2e7d32;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { flex-direction: column; gap: 15px; }
            h1 { font-size: 1.4em; }
            .tabs { padding: 10px; }
            .tab-btn { padding: 8px 15px; font-size: 0.9em; }
            .content-area { padding: 20px; }
            .chat-bubble { max-width: 85%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📚 MentoreStudio</h1>
            <div class="header-controls">
                <button class="toggle-btn" onclick="toggleDarkMode()">🌙 Dark Mode</button>
            </div>
        </div>

        <!-- Upload Section -->
        <div id="uploadSection" class="upload-section">
            <h2>Carica il tuo PDF per iniziare</h2>
            <p>Trasforma i tuoi documenti in materiale di studio intelligente!</p>
            <br>
            
            <input type="file" id="pdfFile" accept=".pdf" />
            <br>
            <input type="text" id="studyName" placeholder="Nome della lezione (es: Capitolo 3 - Matematica)" />
            <br>
            
            <select id="subjectSelect" class="subject-select">
                <option value="">Seleziona materia...</option>
                <option value="Matematica">📐 Matematica</option>
                <option value="Fisica">⚛️ Fisica</option>
                <option value="Chimica">🧪 Chimica</option>
                <option value="Biologia">🧬 Biologia</option>
                <option value="Storia">📜 Storia</option>
                <option value="Geografia">🗺️ Geografia</option>
                <option value="Italiano">📖 Italiano</option>
                <option value="Inglese">🇬🇧 Inglese</option>
                <option value="Filosofia">💭 Filosofia</option>
                <option value="Informatica">💻 Informatica</option>
                <option value="Economia">💰 Economia</option>
                <option value="Diritto">⚖️ Diritto</option>
                <option value="Arte">🎨 Arte</option>
                <option value="Musica">🎵 Musica</option>
                <option value="Altro">📚 Altro</option>
            </select>
            <br>
            
            <button class="btn" onclick="processPDF()">🚀 Analizza PDF</button>
            
            <div id="uploadStatus" class="hidden">
                <div class="loading">
                    <div class="spinner"></div>
                    <p id="statusText">Elaborazione in corso...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App (Hidden initially) -->
        <div id="mainApp" class="hidden">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="library" onclick="switchTab('library')">📚 Libreria</button>
                <button class="tab-btn" data-tab="summary" onclick="switchTab('summary')">📝 Riassunto</button>
                <button class="tab-btn" data-tab="flashcards" onclick="switchTab('flashcards')">🎴 Flashcard</button>
                <button class="tab-btn" data-tab="quiz" onclick="switchTab('quiz')">❓ Quiz</button>
                <button class="tab-btn" data-tab="chat" onclick="switchTab('chat')">💬 Chat AI</button>
            </div>

            <!-- Content Areas -->
            <div class="content-area" id="tabContent">
                <!-- Library Tab -->
                <div id="library" class="tab-content">
                    <h2>Le tue lezioni</h2>
                    <input type="text" class="search-box" placeholder="🔍 Cerca lezioni..." oninput="filterStudies(this.value)">
                    <div id="studiesList"></div>
                </div>

                <!-- Summary Tab -->
                <div id="summary" class="tab-content hidden">
                    <h2>Riassunto</h2>
                    <div id="summaryContent"></div>
                </div>

                <!-- Flashcards Tab -->
                <div id="flashcards" class="tab-content hidden">
                    <h2>Flashcard</h2>
                    <div id="flashcardsContent"></div>
                </div>

                <!-- Quiz Tab -->
                <div id="quiz" class="tab-content hidden">
                    <h2>Quiz</h2>
                    <div id="quizContent"></div>
                </div>

                <!-- Chat Tab -->
                <div id="chat" class="tab-content hidden">
                    <h2>Chat con l'AI</h2>
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="chat-input-area">
                            <textarea id="chatInput" placeholder="Fai una domanda sulla lezione..." rows="1" onkeypress="handleChatKeyPress(event)"></textarea>
                            <button class="btn" id="chatSendBtn" onclick="sendChatMessage()">Invia 📤</button>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-export" onclick="exportChatHistory()">💾 Esporta Chat</button>
                        <button class="btn btn-delete" onclick="clearChatHistory()">🗑️ Cancella Chat</button>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="resetApp()">➕ Carica nuovo PDF</button>
            </div>
        </div>
    </div>

    <script>
        // ========== STATE MANAGEMENT ==========
        const appState = {
            studies: JSON.parse(localStorage.getItem('mentoreStudio_studies') || '{}'),
            currentStudyId: localStorage.getItem('mentoreStudio_currentStudy') || null,
            currentTab: 'library',
            flashcardIndex: 0,
            quizIndex: 0,
            quizAnswers: [],
            chatHistory: JSON.parse(localStorage.getItem('mentoreStudio_chatHistory') || '{}'),
            isChatLoading: false
        };

        // ========== UTILITY FUNCTIONS ==========
        function saveStudies() {
            localStorage.setItem('mentoreStudio_studies', JSON.stringify(appState.studies));
        }

        function saveChatHistory() {
            localStorage.setItem('mentoreStudio_chatHistory', JSON.stringify(appState.chatHistory));
        }

        function getCurrentStudy() {
            return appState.studies[appState.currentStudyId] || null;
        }

        function setCurrentStudy(id) {
            appState.currentStudyId = id;
            localStorage.setItem('mentoreStudio_currentStudy', id);
            if (!appState.chatHistory[id]) {
                appState.chatHistory[id] = [];
                saveChatHistory();
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // Ripristina dark mode da localStorage
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        // ========== PDF PROCESSING ==========
        async function processPDF() {
            const fileInput = document.getElementById('pdfFile');
            const nameInput = document.getElementById('studyName');
            const subjectSelect = document.getElementById('subjectSelect');
            
            const file = fileInput.files[0];
            const studyName = nameInput.value.trim();
            const subject = subjectSelect.value;
            
            // Validazione input
            if (!file) {
                alert('⚠️ Seleziona un file PDF!');
                return;
            }
            
            if (!studyName) {
                alert('⚠️ Inserisci un nome per la lezione!');
                return;
            }
            
            if (!subject) {
                alert('⚠️ Seleziona una materia!');
                return;
            }
            
            // Mostra loading
            document.getElementById('uploadStatus').classList.remove('hidden');
            updateStatus('📄 Lettura PDF...', 10);
            
            try {
                // Estrai testo dal PDF
                const text = await extractTextFromPDF(file);
                
                if (!text || text.length < 100) {
                    throw new Error('Il PDF sembra vuoto o troppo corto');
                }
                
                updateStatus('🤖 Analisi con AI in corso...', 30);
                
                // Invia al backend per analisi
                const response = await fetch('/api/analyze-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        subject: subject
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Errore server: ${response.status}`);
                }
                
                updateStatus('✨ Creazione materiali...', 70);
                
                const data = await response.json();
                
                // Crea nuovo studio
                const studyId = Date.now().toString();
                appState.studies[studyId] = {
                    id: studyId,
                    name: studyName,
                    subject: subject,
                    date: new Date().toISOString(),
                    fullText: text,
                    data: data
                };
                
                saveStudies();
                setCurrentStudy(studyId);
                
                updateStatus('✅ Completato!', 100);
                
                setTimeout(() => {
                    showMainApp();
                    switchTab('summary');
                }, 1000);
                
            } catch (error) {
                console.error('Errore processing:', error);
                document.getElementById('statusText').innerHTML = `
                    <div class="error-message">
                        ❌ Errore: ${error.message}
                        <br><br>
                        <small>Assicurati che il server backend sia attivo e configurato correttamente.</small>
                    </div>
                `;
                updateStatus('', 0);
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
                
                updateStatus(`📄 Lettura pagina ${i}/${pdf.numPages}...`, 10 + (i / pdf.numPages) * 20);
            }
            
            return fullText.trim();
        }

        function updateStatus(text, progress) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // ========== UI FUNCTIONS ==========
        function showMainApp() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            renderLibrary();
        }

        function switchTab(tabName) {
            // Aggiorna pulsanti
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Aggiorna contenuti
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName).classList.remove('hidden');
            
            appState.currentTab = tabName;
            
            // Renderizza contenuto specifico
            switch(tabName) {
                case 'library':
                    renderLibrary();
                    break;
                case 'summary':
                    renderSummary();
                    break;
                case 'flashcards':
                    renderFlashcards();
                    break;
                case 'quiz':
                    renderQuiz();
                    break;
                case 'chat':
                    renderChat();
                    break;
            }
        }

        // ========== LIBRARY ==========
        function renderLibrary() {
            const container = document.getElementById('studiesList');
            const studies = Object.values(appState.studies);
            
            if (studies.length === 0) {
                container.innerHTML = '<p>Nessuna lezione ancora. Carica un PDF per iniziare!</p>';
                return;
            }
            
            container.innerHTML = studies.map(study => `
                <div class="study-item" onclick="selectStudy('${study.id}')">
                    <div class="study-left">
                        <strong>${study.subject}</strong> - ${study.name}
                        <div class="study-info">
                            📅 ${new Date(study.date).toLocaleDateString('it-IT')}
                        </div>
                    </div>
                    <div class="study-right">
                        <button class="btn btn-export" onclick="event.stopPropagation(); exportStudy('${study.id}')">📥</button>
                        <button class="btn btn-delete" onclick="event.stopPropagation(); deleteStudy('${study.id}')">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function filterStudies(searchTerm) {
            const studies = Object.values(appState.studies);
            const filtered = studies.filter(study => 
                study.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                study.subject.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            const container = document.getElementById('studiesList');
            container.innerHTML = filtered.map(study => `
                <div class="study-item" onclick="selectStudy('${study.id}')">
                    <div class="study-left">
                        <strong>${study.subject}</strong> - ${study.name}
                        <div class="study-info">
                            📅 ${new Date(study.date).toLocaleDateString('it-IT')}
                        </div>
                    </div>
                    <div class="study-right">
                        <button class="btn btn-export" onclick="event.stopPropagation(); exportStudy('${study.id}')">📥</button>
                        <button class="btn btn-delete" onclick="event.stopPropagation(); deleteStudy('${study.id}')">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function selectStudy(id) {
            setCurrentStudy(id);
            switchTab('summary');
        }

        function deleteStudy(id) {
            if (confirm('Sei sicuro di voler eliminare questa lezione?')) {
                delete appState.studies[id];
                delete appState.chatHistory[id];
                saveStudies();
                saveChatHistory();
                
                if (appState.currentStudyId === id) {
                    appState.currentStudyId = null;
                }
                
                renderLibrary();
            }
        }

        function exportStudy(id) {
            const study = appState.studies[id];
            const exportData = {
                name: study.name,
                subject: study.subject,
                date: study.date,
                summary: study.data.summary_long,
                highlights: study.data.highlights,
                flashcards: study.data.flashcards,
                quiz: study.data.quiz
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${study.name.replace(/[^a-z0-9]/gi, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========== SUMMARY ==========
        function renderSummary() {
            const study = getCurrentStudy();
            if (!study) {
                document.getElementById('summaryContent').innerHTML = '<p>Seleziona una lezione dalla libreria</p>';
                return;
            }
            
            const data = study.data;
            const html = `
                <div class="section">
                    <h2>📋 Riassunto Breve</h2>
                    <div class="card">
                        ${data.summary_short || 'Nessun riassunto disponibile'}
                    </div>
                </div>
                
                <div class="section">
                    <h2>📖 Riassunto Dettagliato</h2>
                    <div class="card">
                        ${data.summary_long || 'Nessun riassunto disponibile'}
                    </div>
                </div>
                
                <div class="section">
                    <h2>✨ Punti Chiave</h2>
                    ${(data.highlights || []).map(highlight => `
                        <div class="card">• ${highlight}</div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('summaryContent').innerHTML = html;
        }

        // ========== FLASHCARDS ==========
        function renderFlashcards() {
            const study = getCurrentStudy();
            if (!study) {
                document.getElementById('flashcardsContent').innerHTML = '<p>Seleziona una lezione dalla libreria</p>';
                return;
            }
            
            const flashcards = study.data.flashcards || [];
            if (flashcards.length === 0) {
                document.getElementById('flashcardsContent').innerHTML = '<p>Nessuna flashcard disponibile</p>';
                return;
            }
            
            appState.flashcardIndex = Math.min(appState.flashcardIndex, flashcards.length - 1);
            const card = flashcards[appState.flashcardIndex];
            
            const html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <strong>Carta ${appState.flashcardIndex + 1} di ${flashcards.length}</strong>
                </div>
                
                <div class="flashcard ${card.difficulty || 'medium'}" onclick="flipFlashcard()">
                    <div class="flashcard-inner" id="flashcardInner">
                        <div class="flashcard-front">
                            <div class="flashcard-question">${card.question}</div>
                            <div style="font-size: 0.9em; opacity: 0.8; margin-top: 20px;">
                                Clicca per vedere la risposta
                            </div>
                        </div>
                        <div class="flashcard-back">
                            <div class="flashcard-answer">${card.answer}</div>
                            ${card.explanation ? `
                                <div class="flashcard-extra">
                                    <strong>💡 Spiegazione:</strong><br>
                                    ${card.explanation}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="flashcard-controls">
                    <button class="flashcard-nav-btn" onclick="previousFlashcard()" ${appState.flashcardIndex === 0 ? 'disabled' : ''}>
                        ⬅️ Precedente
                    </button>
                    <button class="flashcard-nav-btn" onclick="nextFlashcard()" ${appState.flashcardIndex === flashcards.length - 1 ? 'disabled' : ''}>
                        Successiva ➡️
                    </button>
                </div>
            `;
            
            document.getElementById('flashcardsContent').innerHTML = html;
        }

        function flipFlashcard() {
            document.getElementById('flashcardInner').classList.toggle('flipped');
        }

        function nextFlashcard() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const flashcards = study.data.flashcards || [];
            if (appState.flashcardIndex < flashcards.length - 1) {
                appState.flashcardIndex++;
                renderFlashcards();
            }
        }

        function previousFlashcard() {
            if (appState.flashcardIndex > 0) {
                appState.flashcardIndex--;
                renderFlashcards();
            }
        }

        // ========== QUIZ ==========
        function renderQuiz() {
            const study = getCurrentStudy();
            if (!study) {
                document.getElementById('quizContent').innerHTML = '<p>Seleziona una lezione dalla libreria</p>';
                return;
            }
            
            const quiz = study.data.quiz || [];
            if (quiz.length === 0) {
                document.getElementById('quizContent').innerHTML = '<p>Nessun quiz disponibile</p>';
                return;
            }
            
            if (appState.quizIndex >= quiz.length) {
                renderQuizResults();
                return;
            }
            
            const question = quiz[appState.quizIndex];
            
            const html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <strong>Domanda ${appState.quizIndex + 1} di ${quiz.length}</strong>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(appState.quizIndex / quiz.length) * 100}%"></div>
                    </div>
                </div>
                
                <div class="quiz-question">
                    <h3>${question.question}</h3>
                    <div class="quiz-options">
                        ${question.options.map((option, index) => `
                            <div class="quiz-option" onclick="selectQuizOption(${index})">
                                ${String.fromCharCode(65 + index)}. ${option}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="submitQuizAnswer()">Conferma Risposta</button>
                </div>
            `;
            
            document.getElementById('quizContent').innerHTML = html;
        }

        function selectQuizOption(index) {
            document.querySelectorAll('.quiz-option').forEach((opt, i) => {
                opt.classList.remove('selected');
                if (i === index) {
                    opt.classList.add('selected');
                }
            });
            appState.selectedQuizOption = index;
        }

        function submitQuizAnswer() {
            if (appState.selectedQuizOption === undefined) {
                alert('Seleziona una risposta!');
                return;
            }
            
            const study = getCurrentStudy();
            const question = study.data.quiz[appState.quizIndex];
            const isCorrect = appState.selectedQuizOption === question.correct;
            
            appState.quizAnswers.push({
                question: question.question,
                selected: appState.selectedQuizOption,
                correct: question.correct,
                isCorrect: isCorrect
            });
            
            // Mostra feedback visivo
            const options = document.querySelectorAll('.quiz-option');
            options[question.correct].classList.add('correct');
            if (!isCorrect) {
                options[appState.selectedQuizOption].classList.add('wrong');
            }
            
            // Mostra spiegazione
            if (question.explanation) {
                const quizQuestion = document.querySelector('.quiz-question');
                quizQuestion.innerHTML += `
                    <div class="card" style="margin-top: 15px;">
                        <strong>${isCorrect ? '✅ Corretto!' : '❌ Sbagliato!'}</strong><br>
                        ${question.explanation}
                    </div>
                `;
            }
            
            setTimeout(() => {
                appState.selectedQuizOption = undefined;
                appState.quizIndex++;
                renderQuiz();
            }, 3000);
        }

        function renderQuizResults() {
            const correctAnswers = appState.quizAnswers.filter(a => a.isCorrect).length;
            const totalQuestions = appState.quizAnswers.length;
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            let emoji = '🎉';
            let message = 'Eccellente!';
            if (percentage < 50) {
                emoji = '📚';
                message = 'Continua a studiare!';
            } else if (percentage < 75) {
                emoji = '👍';
                message = 'Buon lavoro!';
            }
            
            const html = `
                <div style="text-align: center;">
                    <h2>${emoji} Quiz Completato! ${emoji}</h2>
                    <div class="card" style="max-width: 500px; margin: 20px auto;">
                        <h1 style="color: var(--primary); font-size: 3em; margin: 20px 0;">
                            ${percentage}%
                        </h1>
                        <p style="font-size: 1.2em; margin: 10px 0;">
                            ${correctAnswers} su ${totalQuestions} corrette
                        </p>
                        <p style="font-size: 1.1em; color: #666; margin: 10px 0;">
                            ${message}
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                        <button class="btn" onclick="restartQuiz()">🔄 Ricomincia Quiz</button>
                        <button class="btn" onclick="switchTab('summary')">📖 Torna al Riassunto</button>
                    </div>
                </div>
            `;
            
            document.getElementById('quizContent').innerHTML = html;
        }

        function restartQuiz() {
            appState.quizIndex = 0;
            appState.quizAnswers = [];
            appState.selectedQuizOption = undefined;
            renderQuiz();
        }

        // ========== CHAT ==========
        function renderChat() {
            const study = getCurrentStudy();
            if (!study) {
                document.getElementById('chatMessages').innerHTML = '<p>Seleziona una lezione dalla libreria</p>';
                return;
            }
            
            const chatHistory = appState.chatHistory[study.id] || [];
            
            if (chatHistory.length === 0) {
                document.getElementById('chatMessages').innerHTML = `
                    <div class="chat-message ai">
                        <div class="chat-avatar">🤖</div>
                        <div class="chat-bubble">
                            Ciao! Sono il tuo assistente AI. Fammi qualsiasi domanda su: <strong>${study.name}</strong>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('chatMessages').innerHTML = chatHistory.map((msg, i) => 
                    createChatMessageHTML(msg, `msg_${study.id}_${i}`)
                ).join('');
            }
            
            scrollChatToBottom();
        }

        function createChatMessageHTML(msg, id) {
            const isUser = msg.role === 'user';
            return `
                <div class="chat-message ${isUser ? 'user' : 'ai'}" id="${id}">
                    <div class="chat-avatar">${isUser ? '👤' : '🤖'}</div>
                    <div class="chat-bubble">${msg.content}</div>
                </div>
            `;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const study = getCurrentStudy();
            if (!study || appState.isChatLoading) return;
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Aggiungi messaggio utente
            appState.chatHistory[study.id].push({
                role: 'user',
                content: message
            });
            
            input.value = '';
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += createChatMessageHTML({
                role: 'user',
                content: message
            }, `msg_${study.id}_${appState.chatHistory[study.id].length - 1}`);
            
            // Mostra indicatore di digitazione
            messagesContainer.innerHTML += `
                <div class="chat-message ai" id="typingIndicator">
                    <div class="chat-avatar">🤖</div>
                    <div class="chat-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            scrollChatToBottom();
            
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Invio...';
            appState.isChatLoading = true;
            
            try {
                // Prepara contesto
                const summaryShort = (study.data.summary_short || '').substring(0, 300);
                const highlightsText = (study.data.highlights || []).slice(0, 3).join('. ').substring(0, 200);
                const contentSnippet = study.fullText ? study.fullText.substring(0, 400) : '';
                
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nRiassunto: ${summaryShort}\n\nPunti chiave: ${highlightsText}\n\nEstratto: ${contentSnippet}`;
                
                const conversationHistory = appState.chatHistory[study.id]
                    .slice(0, -1)
                    .slice(-5)
                    .map(msg => ({
                        role: msg.role,
                        content: msg.content.substring(0, 500)
                    }));
                
                const fullMessage = `[CONTESTO]\n${context}\n\n[DOMANDA]\n${message}`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: fullMessage,
                        conversationHistory: conversationHistory
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Errore server: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.response;
                
                // Rimuovi indicatore
                document.getElementById('typingIndicator').remove();
                
                // Aggiungi risposta AI
                appState.chatHistory[study.id].push({
                    role: 'assistant',
                    content: aiResponse
                });
                
                messagesContainer.innerHTML += createChatMessageHTML({
                    role: 'assistant',
                    content: aiResponse
                }, `msg_${study.id}_${appState.chatHistory[study.id].length - 1}`);
                
                saveChatHistory();
                scrollChatToBottom();
                
            } catch (error) {
                console.error('Errore chat:', error);
                
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();
                
                messagesContainer.innerHTML += `
                    <div class="error-message">
                        ❌ Errore: ${error.message}. 
                        <br><small>Assicurati che il server backend sia attivo.</small>
                    </div>
                `;
                
                appState.chatHistory[study.id].pop();
                
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Invia 📤';
                appState.isChatLoading = false;
                scrollChatToBottom();
            }
        }

        function scrollChatToBottom() {
            setTimeout(() => {
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, 100);
        }

        function clearChatHistory() {
            const study = getCurrentStudy();
            if (!study) return;
            
            if (confirm('Vuoi cancellare tutta la conversazione?')) {
                appState.chatHistory[study.id] = [];
                saveChatHistory();
                renderChat();
            }
        }

        function exportChatHistory() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const chatHistory = appState.chatHistory[study.id] || [];
            
            if (chatHistory.length === 0) {
                alert('Non ci sono messaggi da esportare');
                return;
            }
            
            let exportText = `Chat AI - ${study.name}\n`;
            exportText += `Data: ${new Date().toLocaleDateString('it-IT')}\n`;
            exportText += `Materia: ${study.subject}\n\n`;
            exportText += '='.repeat(50) + '\n\n';
            
            chatHistory.forEach((msg) => {
                const role = msg.role === 'user' ? '👤 Tu' : '🤖 AI';
                exportText += `${role}:\n${msg.content}\n\n`;
            });
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${study.name.replace(/[^a-z0-9]/gi, '_')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('✅ Chat esportata!');
        }

        // ========== RESET ==========
        function resetApp() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('pdfFile').value = '';
            document.getElementById('studyName').value = '';
            document.getElementById('subjectSelect').value = '';
        }

        // ========== INITIALIZATION ==========
        if (Object.keys(appState.studies).length > 0) {
            showMainApp();
            if (appState.currentStudyId) {
                switchTab('summary');
            } else {
                switchTab('library');
            }
        }
    </script>
</body>
</html>
