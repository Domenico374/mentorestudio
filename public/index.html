<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MentoreStudio - Il tuo mentore personale per lo studio intelligente">
    <title>📚 MentoreStudio - Studia Intelligente</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #4caf50;
            --danger: #f44336;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        body.dark-mode { background: #0f0f1e; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .header { background: #2a2a3e; color: #e0e0e0; }
        h1 { font-size: 1.8em; color: var(--primary); }
        body.dark-mode h1 { color: var(--accent); }
        .header-controls { display: flex; gap: 10px; }
        .toggle-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .upload-section { background: #2a2a3e; color: #e0e0e0; }
        input[type="file"] {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
        }
        body.dark-mode input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .subject-select {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            font-size: 1em;
        }
        body.dark-mode .subject-select { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-delete { background: var(--danger); padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .btn-export { background: #2196F3; padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .tabs { background: #2a2a3e; }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f0f0f0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        body.dark-mode .tab-btn { background: #1a1a2e; color: #e0e0e0; }
        .tab-btn.active { background: var(--primary); color: white; }
        .content-area {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 500px;
        }
        body.dark-mode .content-area { background: #2a2a3e; color: #e0e0e0; }
        .hidden { display: none !important; }
        .section { margin-bottom: 30px; }
        .section h2 { color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        body.dark-mode .section h2 { color: var(--accent); border-color: var(--accent); }
        .card { background: #f5f7ff; padding: 20px; border-radius: 10px; margin: 10px 0; border-left: 4px solid var(--primary); }
        body.dark-mode .card { background: #1a1a2e; border-left-color: var(--accent); }
        .study-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        body.dark-mode .study-item { background: #1a1a2e; }
        .study-item:hover { transform: translateX(5px); background: #e8eaff; }
        .study-info { font-size: 0.9em; color: #666; margin-top: 5px; }
        body.dark-mode .study-info { color: #aaa; }
        .study-left { flex: 1; }
        .study-right { display: flex; gap: 10px; }
        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
        }
        body.dark-mode .search-box { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f0f0f0; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar { background: #e0e0e0; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; transition: width 0.3s; }
        .flashcard { 
            perspective: 1000px; 
            height: 300px; 
            cursor: pointer; 
            margin: 20px 0; 
            border: 3px solid transparent;
            border-radius: 10px;
        }
        .flashcard.easy { border-color: #4caf50; }
        .flashcard.medium { border-color: #ffa726; }
        .flashcard.difficult { border-color: #f44336; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard-inner.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; border-radius: 10px; font-size: 1.2em; font-weight: bold; }
        .flashcard-front { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .flashcard-back { background: linear-gradient(135deg, var(--accent), #f5576c); color: white; transform: rotateY(180deg); }
        .controls { display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
        .quiz-option { 
            background: #f5f7ff; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: all 0.3s;
            position: relative;
        }
        body.dark-mode .quiz-option { background: #1a1a2e; }
        .quiz-option:hover { background: #e8eaff; transform: translateX(5px); }
        .quiz-option.selected { border-color: var(--primary); background: #e8eaff; }
        .quiz-option.correct { border-color: var(--success); background: #c8e6c9; }
        .quiz-option.incorrect { border-color: var(--danger); background: #ffcdd2; }
        .quiz-option.show-correct { border-color: var(--success); background: #e8f5e9; }
        .timer-display {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 10px;
            margin: 20px 0;
        }
        .timer-display.warning {
            background: linear-gradient(135deg, #ffa726, #fb8c00);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .note-section { background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ffc107; }
        body.dark-mode .note-section { background: #3d3d1a; color: #e0e0e0; }
        .note-input { width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9em; }
        body.dark-mode .note-input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .key-concept { display: inline-block; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 4px 10px; border-radius: 15px; margin: 3px; font-size: 0.85em; }
        .back-btn { display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--primary); margin-bottom: 20px; font-weight: bold; }
        body.dark-mode .back-btn { color: var(--accent); }
        .audio-section {
            text-align: center;
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        body.dark-mode .audio-section {
            background: rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.3);
        }
        .audio-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            margin-top: 20px;
            justify-content: center;
        }
        .audio-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .review-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
        .review-item.wrong {
            border-left-color: var(--danger);
            background: #ffebee;
        }
        .review-item.correct {
            border-left-color: var(--success);
            background: #e8f5e9;
        }

        /* CHAT STYLES */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            max-height: 70vh;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        body.dark-mode .chat-messages {
            background: #1a1a2e;
        }
        .chat-message {
            display: flex;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.user {
            flex-direction: row-reverse;
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }
        .chat-message.user .chat-avatar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .chat-message.ai .chat-avatar {
            background: linear-gradient(135deg, var(--accent), #f5576c);
            color: white;
        }
        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-bottom-right-radius: 5px;
        }
        .chat-message.ai .chat-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        body.dark-mode .chat-message.ai .chat-bubble {
            background: #2a2a3e;
            color: #e0e0e0;
        }
        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        body.dark-mode .chat-input-container {
            background: #2a2a3e;
        }
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
            resize: none;
            font-family: inherit;
        }
        body.dark-mode .chat-input {
            background: #1a1a2e;
            color: #e0e0e0;
            border-color: var(--secondary);
        }
        .chat-send-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .chat-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 10px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        .chat-context-info {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            font-size: 0.9em;
        }
        body.dark-mode .chat-context-info {
            background: rgba(102, 126, 234, 0.2);
        }
        .chat-suggestions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .chat-suggestion {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .chat-suggestion {
            background: #1a1a2e;
            color: #e0e0e0;
        }
        .chat-suggestion:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }
        body.dark-mode .error-message {
            background: rgba(198, 40, 40, 0.2);
            color: #ff5252;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 MentoreStudio</h1>
            <div class="header-controls">
                <button class="toggle-btn" onclick="toggleDarkMode()">🌙</button>
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <h2>🚀 Carica i tuoi PDF di lezioni</h2>
            <p style="margin-bottom: 15px; color: #666;">Puoi caricare più PDF contemporaneamente o uno per volta</p>
            <label style="font-weight: bold; margin-bottom: 10px; display: block;">📚 Seleziona la materia:</label>
            <select id="subjectSelect" class="subject-select">
                <option value="Generale">Generale</option>
                <option value="Storia">Storia</option>
                <option value="Matematica">Matematica</option>
                <option value="Biologia">Biologia</option>
                <option value="Diritto">Diritto</option>
            </select>
            <input type="file" id="pdfFile" accept=".pdf" multiple>
            <button class="btn" onclick="loadMultiplePDFs()" style="width: 100%; max-width: 400px;">📂 Carica e Genera</button>
            <p style="font-size: 0.9em; margin-top: 10px; color: #666;">Tutto salvato offline • Nessuna chiave API visibile</p>
        </div>

        <div id="mainApp" class="hidden">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('library', event)">📚 Libreria Studi</button>
                <button class="tab-btn hidden" id="tabSummary" onclick="switchTab('summary', event)">📝 Riassunto</button>
                <button class="tab-btn hidden" id="tabHighlights" onclick="switchTab('highlights', event)">⭐ Punti Salienti</button>
                <button class="tab-btn hidden" id="tabGlossary" onclick="switchTab('glossary', event)">📖 Glossario</button>
                <button class="tab-btn hidden" id="tabTimeline" onclick="switchTab('timeline', event)">📅 Timeline</button>
                <button class="tab-btn hidden" id="tabMindmap" onclick="switchTab('mindmap', event)">🧠 Mappa Mentale</button>
                <button class="tab-btn hidden" id="tabFlashcards" onclick="switchTab('flashcards', event)">🎴 Flashcard</button>
                <button class="tab-btn hidden" id="tabQuiz" onclick="switchTab('quiz', event)">❓ Quiz</button>
                <button class="tab-btn hidden" id="tabChat" onclick="switchTab('chat', event)">💬 Chat AI</button>
            </div>
            <div class="content-area" id="contentArea"></div>
        </div>
    </div>

    <script>
        let appState = {
            studies: JSON.parse(localStorage.getItem('mentorestudio_studies')) || {},
            currentStudyId: null,
            currentFlashcard: 0,
            currentFlashcardFiltered: 0,
            flashcardMode: 'all',
            currentQuiz: 0,
            currentQuizFiltered: 0,
            quizMode: 'all',
            quizScore: 0,
            quizAnswers: [],
            quizTimerEnabled: false,
            quizTimeRemaining: 0,
            quizTimerId: null,
            notes: JSON.parse(localStorage.getItem('flashcardNotes')) || {},
            darkMode: localStorage.getItem('darkMode') === 'true',
            chatHistory: JSON.parse(localStorage.getItem('chatHistory')) || {},
            isChatLoading: false
        };

        let flashcardStats = JSON.parse(localStorage.getItem('flashcardStats')) || {};
        let quizStats = JSON.parse(localStorage.getItem('quizStats')) || {};

        if (appState.darkMode) document.body.classList.add('dark-mode');

        function toggleDarkMode() {
            appState.darkMode = !appState.darkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', appState.darkMode);
        }

        async function loadMultiplePDFs() {
            const files = document.getElementById('pdfFile').files;
            if (files.length === 0) { alert('Seleziona almeno un PDF'); return; }

            showMainApp();
            let processedCount = 0;

            for (let file of files) {
                try {
                    const text = await extractPDFText(file);
                    const studyId = Date.now() + Math.random();
                    
                    updateProgress(processedCount, files.length, `Elaborando: ${file.name}`);
                    
                    const data = await generateContent(text, document.getElementById('subjectSelect').value);
                    
                    appState.studies[studyId] = {
                        id: studyId,
                        name: file.name.replace('.pdf', ''),
                        data: data,
                        date: new Date().toLocaleDateString('it-IT'),
                        subject: document.getElementById('subjectSelect').value,
                        fullText: text.substring(0, 8000)
                    };
                    
                    appState.chatHistory[studyId] = [];
                    
                    processedCount++;
                    updateProgress(processedCount, files.length, `Completato: ${file.name}`);
                } catch (e) {
                    alert(`Errore con ${file.name}: ${e.message}`);
                }
            }

            saveStudies();
            saveChatHistory();
            renderLibrary();
            switchTab('library');
        }

        async function extractPDFText(file) {
            const reader = new FileReader();
            return new Promise((resolve) => {
                reader.onload = async (e) => {
                    const pdf = await pdfjsLib.getDocument(e.target.result).promise;
                    let text = '';
                    for (let i = 0; i < Math.min(pdf.numPages, 20); i++) {
                        const page = await pdf.getPage(i + 1);
                        const content = await page.getTextContent();
                        text += content.items.map(x => x.str).join(' ') + '\n';
                    }
                    resolve(text);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function showMainApp() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function updateProgress(current, total, message) {
            document.getElementById('contentArea').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(current/total)*100}%"></div>
                    </div>
                    <p>${current}/${total}</p>
                </div>
            `;
        }

        async function generateContent(text, subject) {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text.substring(0, 8000), subject: subject })
            });

            if (!response.ok) throw new Error('Errore server: ' + response.status);
            return await response.json();
        }

        function saveStudies() {
            localStorage.setItem('mentorestudio_studies', JSON.stringify(appState.studies));
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(appState.chatHistory));
        }

        function switchTab(tab, e) {
            if (e) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
            }
            switch(tab) {
                case 'library': renderLibrary(); break;
                case 'summary': renderSummary(); break;
                case 'highlights': renderHighlights(); break;
                case 'glossary': renderGlossary(); break;
                case 'timeline': renderTimeline(); break;
                case 'mindmap': renderMindMap(); break;
                case 'flashcards': renderFlashcardsAdvanced(); break;
                case 'quiz': renderQuizAdvanced(); break;
                case 'chat': renderChat(); break;
            }
        }

        function renderLibrary() {
            let html = '<h2>📚 Le tue lezioni</h2>';
            html += '<input type="text" class="search-box" id="librarySearch" placeholder="🔍 Cerca un termine in tutte le lezioni..." onkeyup="filterLibrary()">';
            const studies = Object.values(appState.studies).sort((a, b) => b.id - a.id);
            
            if (studies.length === 0) {
                html += '<p style="text-align: center; color: #999; margin-top: 20px;">Nessuna lezione caricata. Carica i tuoi PDF sopra.</p>';
            } else {
                studies.forEach(study => {
                    html += `
                        <div class="study-item" onclick="selectStudy('${study.id}')" data-search="${study.name.toLowerCase()} ${(study.data.highlights || []).join(' ').toLowerCase()} ${(study.data.glossary || []).map(g => g.term.toLowerCase()).join(' ')}">
                            <div class="study-left">
                                <strong>${study.name}</strong>
                                <div class="study-info">📅 ${study.date} • 📚 ${study.subject} • 🎴 ${study.data.flashcards?.length || 0} flashcard • ❓ ${study.data.quiz?.length || 0} quiz</div>
                            </div>
                            <div class="study-right">
                                <button class="btn btn-export" onclick="exportStudyPDF('${study.id}', event)">📥 PDF</button>
                                <button class="btn btn-delete" onclick="deleteStudy('${study.id}', event)">🗑️</button>
                            </div>
                        </div>
                    `;
                });
                html += '<button class="btn" onclick="resetApp()" style="width: 100%; margin-top: 20px;">➕ Carica altre lezioni</button>';
            }
            document.getElementById('contentArea').innerHTML = html;
        }

        function filterLibrary() {
            const searchTerm = document.getElementById('librarySearch').value.toLowerCase();
            const items = document.querySelectorAll('.study-item');
            items.forEach(item => {
                const searchData = item.getAttribute('data-search');
                item.style.display = searchData.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function exportStudyPDF(studyId, e) {
            e.stopPropagation();
            const study = appState.studies[studyId];
            if (!study) return;

            const element = document.createElement('div');
            element.style.padding = '20px';
            element.innerHTML = `
                <h1>${study.name}</h1>
                <p><strong>Materia:</strong> ${study.subject} | <strong>Data:</strong> ${study.date}</p>
                
                <h2>📝 Riassunto Breve</h2>
                <p>${study.data.summary_short}</p>
                
                <h2>📖 Riassunto Completo</h2>
                <p>${study.data.summary_long}</p>
                
                <h2>⭐ Punti Salienti</h2>
                <ul>
                    ${(study.data.highlights || []).map(h => `<li>${h}</li>`).join('')}
                </ul>
                
                <h2>📖 Glossario</h2>
                ${(study.data.glossary || []).map(g => `
                    <div style="margin-bottom: 10px;">
                        <strong>${g.term}:</strong> ${g.definition}
                    </div>
                `).join('')}
                
                <h2>🎴 Flashcard</h2>
                ${(study.data.flashcards || []).map((f, i) => `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <strong>Domanda ${i+1}:</strong> ${f.q}<br>
                        <strong>Risposta:</strong> ${f.a}
                    </div>
                `).join('')}
                
                <h2>❓ Quiz</h2>
                ${(study.data.quiz || []).map((q, i) => `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <strong>Quiz ${i+1}:</strong> ${q.q}<br>
                        ${q.options.map((o, j) => `<div style="margin-left: 20px;">• ${o}${j === q.correct ? ' ✓' : ''}</div>`).join('')}
                    </div>
                `).join('')}
            `;

            const opt = {
                margin: 10,
                filename: `${study.name.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };

            html2pdf().set(opt).from(element).save();
            alert('✅ PDF scaricato!');
        }

        function selectStudy(studyId) {
            appState.currentStudyId = studyId;
            appState.currentFlashcard = 0;
            appState.currentFlashcardFiltered = 0;
            appState.flashcardMode = 'all';
            appState.currentQuiz = 0;
            appState.currentQuizFiltered = 0;
            appState.quizMode = 'all';
            appState.quizScore = 0;
            appState.quizAnswers = [];
            
            if (!appState.chatHistory[studyId]) {
                appState.chatHistory[studyId] = [];
            }
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.add('hidden'));
            document.getElementById('tabSummary').classList.remove('hidden');
            document.getElementById('tabHighlights').classList.remove('hidden');
            document.getElementById('tabGlossary').classList.remove('hidden');
            document.getElementById('tabTimeline').classList.remove('hidden');
            document.getElementById('tabMindmap').classList.remove('hidden');
            document.getElementById('tabFlashcards').classList.remove('hidden');
            document.getElementById('tabQuiz').classList.remove('hidden');
            document.getElementById('tabChat').classList.remove('hidden');
            
            switchTab('summary');
        }

        function deleteStudy(studyId, e) {
            e.stopPropagation();
            if (confirm('Eliminare questa lezione?')) {
                delete appState.studies[studyId];
                delete appState.chatHistory[studyId];
                saveStudies();
                saveChatHistory();
                renderLibrary();
            }
        }

        function getCurrentStudy() {
            return appState.studies[appState.currentStudyId];
        }

        function goBack() {
            if (appState.quizTimerId) {
                clearInterval(appState.quizTimerId);
                appState.quizTimerId = null;
            }
            switchTab('library');
        }

        function renderSummary() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const summaryText = `${study.data.summary_short || ''}\n\n${study.data.summary_long || ''}`;
            const encodedTitle = encodeURIComponent(study.name);
            const audioUrl = `audio.html?lesson=${study.id}&title=${encodedTitle}`;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="back-btn" onclick="goBack()">← Torna alla Libreria</div>
                <h2>${study.name}</h2>
                <div class="section"><h3>📝 Riassunto Breve</h3><div class="card">${study.data.summary_short || 'N/A'}</div></div>
                <div class="section"><h3>📖 Riassunto Completo</h3><div class="card">${study.data.summary_long || 'N/A'}</div></div>
                
                <div class="audio-section">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">🎧 Modalità Audio</h3>
                    <p style="margin-bottom: 15px; color: #666;">Ascolta il riassunto con sintesi vocale mentre fai altro!</p>
                    <a href="${audioUrl}" class="audio-btn">
                        🎙️ Ascolta Audio Riassunto
                    </a>
                </div>
            `;
        }

        function renderHighlights() {
            const study = getCurrentStudy();
            if (!study) return;
            let html = `<div class="back-btn" onclick="goBack()">← Torna alla Libreria</div><h2>${study.name}</h2><h3>⭐ Punti Salienti</h3>`;
            (study.data.highlights || []).forEach((h, i) => { 
                html += `<div class="card"><strong>${i+1}.</strong> <span class="key-concept">${h}</span></div>`; 
            });
            document.getElementById('contentArea').innerHTML = html;
        }

        function renderGlossary() {
            const study = getCurrentStudy();
            if (!study) return;
            let html = `<div class="back-btn" onclick="goBack()">← Torna alla Libreria</div><h2>${study.name}</h2><h3>📖 Glossario</h3>`;
            html += '<input type="text" class="search-box" id="glossarySearch" placeholder="🔍 Cerca un termine..." onkeyup="filterGlossary()">';
            html += '<div id="glossaryContent">';
            (study.data.glossary || []).forEach(item => { 
                html += `<div class="card" data-term="${item.term.toLowerCase()}"><strong>${item.term}</strong><p>${item.definition}</p></div>`; 
            });
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        function filterGlossary() {
            const searchTerm = document.getElementById('glossarySearch').value.toLowerCase();
            const cards = document.querySelectorAll('#glossaryContent .card');
            cards.forEach(card => {
                const term = card.getAttribute('data-term');
                card.style.display = term.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function renderTimeline() {
            const study = getCurrentStudy();
            if (!study) return;
            let html = `<div class="back-btn" onclick="goBack()">← Torna alla Libreria</div><h2>${study.name}</h2><h3>📅 Timeline</h3>`;
            (study.data.timeline || []).forEach(item => { 
                html += `<div class="card"><strong>${item.date}</strong><p>${item.event}</p></div>`; 
            });
            document.getElementById('contentArea').innerHTML = html;
        }

        function renderMindMap() {
            const study = getCurrentStudy();
            if (!study) return;
            let html = `<div class="back-btn" onclick="goBack()">← Torna alla Libreria</div><h2>${study.name}</h2><h3>🧠 Mappa Mentale</h3><div style="display: flex; flex-wrap: wrap; gap: 15px;">`;
            (study.data.mind_map || []).forEach(c => { 
                html += `<div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold;">${c}</div>`; 
            });
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        // ===== CHAT AI SYSTEM =====

        function renderChat() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const chatHistory = appState.chatHistory[study.id] || [];
            
            let html = `
                <div class="back-btn" onclick="goBack()">← Torna alla Libreria</div>
                <h2>💬 Chat AI - ${study.name}</h2>
                
                <div class="chat-context-info">
                    <strong>ℹ️ Contesto attivo:</strong> ${study.subject} - ${study.name}
                    <br>
                    <small>L'AI ha accesso al contenuto della lezione e può rispondere alle tue domande</small>
                </div>
                
                <div class="chat-suggestions">
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Spiegami i concetti principali di questa lezione')">
                        💡 Concetti principali
                    </div>
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Crea un piano di studio per questa lezione')">
                        📅 Piano di studio
                    </div>
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Quali sono le domande d\'esame più probabili?')">
                        🎯 Domande d'esame
                    </div>
                    <div class="chat-suggestion" onclick="sendSuggestedQuestion('Dammi esempi pratici di applicazione')">
                        🔧 Esempi pratici
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        ${chatHistory.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;">💬</div>
                                <p>Inizia una conversazione!</p>
                                <p style="font-size: 0.9em; margin-top: 10px;">Fai domande sulla lezione o usa i suggerimenti sopra</p>
                            </div>
                        ` : chatHistory.map(msg => createChatMessageHTML(msg)).join('')}
                    </div>
                    
                    <div class="chat-input-container">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Scrivi la tua domanda..."
                            rows="1"
                            onkeypress="handleChatKeyPress(event)"
                        ></textarea>
                        <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
                            Invia 📤
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn" onclick="clearChatHistory()" style="padding: 8px 15px; font-size: 0.9em; background: var(--danger);">
                        🗑️ Cancella Conversazione
                    </button>
                    <button class="btn" onclick="exportChatHistory()" style="padding: 8px 15px; font-size: 0.9em;">
                        📥 Esporta Chat
                    </button>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
            scrollChatToBottom();
            
            // Auto-resize textarea
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
        }

        function createChatMessageHTML(message) {
            const isUser = message.role === 'user';
            return `
                <div class="chat-message ${isUser ? 'user' : 'ai'}">
                    <div class="chat-avatar">${isUser ? '👤' : '🤖'}</div>
                    <div class="chat-bubble">${escapeHTML(message.content)}</div>
                </div>
            `;
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function sendSuggestedQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendChatMessage();
        }

        async function sendChatMessage() {
            const study = getCurrentStudy();
            if (!study || appState.isChatLoading) return;
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            appState.chatHistory[study.id].push({
                role: 'user',
                content: message
            });
            
            input.value = '';
            input.style.height = 'auto';
            
            // Update UI
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += createChatMessageHTML({
                role: 'user',
                content: message
            });
            
            // Show typing indicator
            messagesContainer.innerHTML += `
                <div class="chat-message ai" id="typingIndicator">
                    <div class="chat-avatar">🤖</div>
                    <div class="chat-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            scrollChatToBottom();
            
            // Disable send button
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Invio...';
            appState.isChatLoading = true;
            
            try {
                // Prepare context from study
                const context = `
                    Materia: ${study.subject}
                    Lezione: ${study.name}
                    
                    Riassunto: ${study.data.summary_short}
                    
                    Punti chiave: ${(study.data.highlights || []).join(', ')}
                    
                    Contenuto completo (estratto): ${study.fullText ? study.fullText.substring(0, 3000) : ''}
                `;
                
                // Prepare conversation history for API
                const conversationHistory = appState.chatHistory[study.id].slice(0, -1).map(msg => ({
                    role: msg.role,
                    content: msg.content
                }));
                
                // Call chat API
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Contesto della lezione:\n${context}\n\nDomanda dello studente: ${message}`,
                        conversationHistory: conversationHistory
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Errore server: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.response;
                
                // Remove typing indicator
                document.getElementById('typingIndicator').remove();
                
                // Add AI response
                appState.chatHistory[study.id].push({
                    role: 'assistant',
                    content: aiResponse
                });
                
                messagesContainer.innerHTML += createChatMessageHTML({
                    role: 'assistant',
                    content: aiResponse
                });
                
                saveChatHistory();
                scrollChatToBottom();
                
            } catch (error) {
                console.error('Errore chat:', error);
                
                // Remove typing indicator
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();
                
                // Show error
                messagesContainer.innerHTML += `
                    <div class="error-message">
                        ❌ Errore: ${error.message}. Riprova tra poco.
                    </div>
                `;
                
                // Remove last user message from history
                appState.chatHistory[study.id].pop();
                
            } finally {
                // Re-enable send button
                sendBtn.disabled = false;
                sendBtn.textContent = 'Invia 📤';
                appState.isChatLoading = false;
                scrollChatToBottom();
            }
        }

        function scrollChatToBottom() {
            setTimeout(() => {
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, 100);
        }

        function clearChatHistory() {
            const study = getCurrentStudy();
            if (!study) return;
            
            if (confirm('Vuoi cancellare tutta la conversazione?')) {
                appState.chatHistory[study.id] = [];
                saveChatHistory();
                renderChat();
            }
        }

        function exportChatHistory() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const chatHistory = appState.chatHistory[study.id] || [];
            
            if (chatHistory.length === 0) {
                alert('Non ci sono messaggi da esportare');
                return;
            }
            
            let exportText = `Chat AI - ${study.name}\n`;
            exportText += `Data: ${new Date().toLocaleDateString('it-IT')}\n`;
            exportText += `Materia: ${study.subject}\n\n`;
            exportText += '='.repeat(50) + '\n\n';
            
            chatHistory.forEach((msg, i) => {
                const role = msg.role === 'user' ? '👤 Tu' : '🤖 AI';
                exportText += `${role}:\n${msg.content}\n\n`;
            });
            
            // Create download
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${study.name.replace(/[^a-z0-9]/gi, '_')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('✅ Chat esportata!');
        }

        // ===== FLASHCARD SYSTEM =====

        function initFlashcardStats(studyId, totalCards) {
            if (!flashcardStats[studyId]) {
                flashcardStats[studyId] = {
                    cards: Array(totalCards).fill(null).map(() => ({
                        difficulty: 0,
                        reviews: 0,
                        lastReview: null,
                        nextReview: null
                    })),
                    sessionStart: Date.now(),
                    totalTime: 0
                };
                saveFlashcardStats();
            }
        }

        function saveFlashcardStats() {
            localStorage.setItem('flashcardStats', JSON.stringify(flashcardStats));
        }

        function getCardStats(studyId, cardIndex) {
            return flashcardStats[studyId]?.cards[cardIndex] || null;
        }

        function updateCardDifficulty(studyId, cardIndex, difficulty) {
            if (!flashcardStats[studyId]) return;
            
            const card = flashcardStats[studyId].cards[cardIndex];
            card.difficulty = difficulty;
            card.reviews++;
            card.lastReview = Date.now();
            
            const intervals = {
                1: 24 * 60 * 60 * 1000,
                2: 4 * 60 * 60 * 1000,
                3: 10 * 60 * 1000
            };
            
            card.nextReview = Date.now() + (intervals[difficulty] || 0);
            saveFlashcardStats();
        }

        function getFilteredCards(study, mode) {
            const studyId = study.id;
            const cards = study.data.flashcards || [];
            
            if (!flashcardStats[studyId]) {
                initFlashcardStats(studyId, cards.length);
            }
            
            let indices = cards.map((_, i) => i);
            const stats = flashcardStats[studyId];
            
            switch(mode) {
                case 'unreviewed':
                    indices = indices.filter(i => stats.cards[i].reviews === 0);
                    break;
                case 'difficult':
                    indices = indices.filter(i => stats.cards[i].difficulty === 3);
                    break;
                case 'due':
                    indices = indices.filter(i => {
                        const card = stats.cards[i];
                        return card.nextReview && card.nextReview <= Date.now();
                    });
                    break;
                case 'random':
                    indices = indices.sort(() => Math.random() - 0.5);
                    break;
            }
            
            return indices;
        }

        function getProgressStats(studyId) {
            if (!flashcardStats[studyId]) return null;
            
            const cards = flashcardStats[studyId].cards;
            const total = cards.length;
            const reviewed = cards.filter(c => c.reviews > 0).length;
            const easy = cards.filter(c => c.difficulty === 1).length;
            const medium = cards.filter(c => c.difficulty === 2).length;
            const difficult = cards.filter(c => c.difficulty === 3).length;
            const due = cards.filter(c => c.nextReview && c.nextReview <= Date.now()).length;
            
            return {
                total,
                reviewed,
                unreviewed: total - reviewed,
                easy,
                medium,
                difficult,
                due,
                mastered: easy,
                needsReview: medium + difficult
            };
        }

        function renderFlashcardsAdvanced() {
            const study = getCurrentStudy();
            if (!study || !study.data.flashcards || study.data.flashcards.length === 0) return;
            
            const studyId = study.id;
            initFlashcardStats(studyId, study.data.flashcards.length);
            
            const mode = appState.flashcardMode || 'all';
            const filteredIndices = getFilteredCards(study, mode);
            
            if (filteredIndices.length === 0) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="back-btn" onclick="goBack()">← Torna alla Libreria</div>
                    <h2>${study.name}</h2>
                    <div class="card" style="text-align: center; padding: 40px;">
                        <h3>🎉 Ottimo lavoro!</h3>
                        <p style="margin: 20px 0;">Non ci sono carte da rivedere in questa modalità.</p>
                        <button class="btn" onclick="appState.flashcardMode = 'all'; renderFlashcardsAdvanced();">
                            Rivedi tutte le carte
                        </button>
                    </div>
                `;
                return;
            }
            
            if (appState.currentFlashcardFiltered >= filteredIndices.length) {
                appState.currentFlashcardFiltered = 0;
            }
            
            const currentFilteredIndex = appState.currentFlashcardFiltered || 0;
            const actualCardIndex = filteredIndices[currentFilteredIndex];
            const fc = study.data.flashcards[actualCardIndex];
            const cardStats = getCardStats(studyId, actualCardIndex);
            const stats = getProgressStats(studyId);
            
            const difficultyClass = cardStats.difficulty === 1 ? 'easy' : 
                                  cardStats.difficulty === 2 ? 'medium' : 
                                  cardStats.difficulty === 3 ? 'difficult' : '';
            
            let html = `
                <div class="back-btn" onclick="goBack()">← Torna alla Libreria</div>
                <h2>${study.name}</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div class="card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.mastered}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Padroneggiate ✅</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.needsReview}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Da Rivedere 🔄</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.unreviewed}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Non Viste 👁️</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); color: white; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.due}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Da Ripassare ⏰</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn" style="padding: 8px 15px; ${mode === 'all' ? 'background: var(--primary);' : ''}" 
                            onclick="appState.flashcardMode = 'all'; appState.currentFlashcardFiltered = 0; renderFlashcardsAdvanced();">
                        📚 Tutte (${study.data.flashcards.length})
                    </button>
                    <button class="btn" style="padding: 8px 15px; ${mode === 'unreviewed' ? 'background: var(--primary);' : ''}" 
                            onclick="appState.flashcardMode = 'unreviewed'; appState.currentFlashcardFiltered = 0; renderFlashcardsAdvanced();">
                        👁️ Non Viste (${stats.unreviewed})
                    </button>
                    <button class="btn" style="padding: 8px 15px; ${mode === 'difficult' ? 'background: var(--primary);' : ''}" 
                            onclick="appState.flashcardMode = 'difficult'; appState.currentFlashcardFiltered = 0; renderFlashcardsAdvanced();">
                        ❌ Difficili (${stats.difficult})
                    </button>
                    <button class="btn" style="padding: 8px 15px; ${mode === 'due' ? 'background: var(--primary);' : ''}" 
                            onclick="appState.flashcardMode = 'due'; appState.currentFlashcardFiltered = 0; renderFlashcardsAdvanced();">
                        ⏰ Da Ripassare (${stats.due})
                    </button>
                    <button class="btn" style="padding: 8px 15px; ${mode === 'random' ? 'background: var(--primary);' : ''}" 
                            onclick="appState.flashcardMode = 'random'; appState.currentFlashcardFiltered = 0; renderFlashcardsAdvanced();">
                        🎲 Casuale
                    </button>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${((currentFilteredIndex + 1) / filteredIndices.length * 100).toFixed(0)}%"></div>
                </div>
                <p style="text-align: center; margin: 10px 0;">
                    Carta ${currentFilteredIndex + 1}/${filteredIndices.length}
                    ${cardStats.reviews > 0 ? `<span style="color: #666; font-size: 0.9em;"> • Rivista ${cardStats.reviews} ${cardStats.reviews === 1 ? 'volta' : 'volte'}</span>` : ''}
                </p>
                
                <div class="flashcard ${difficultyClass}" onclick="this.querySelector('.flashcard-inner').classList.toggle('flipped')">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 10px;">DOMANDA</div>
                            ${fc.q || 'Domanda'}
                        </div>
                        <div class="flashcard-back">
                            <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 10px;">RISPOSTA</div>
                            ${fc.a || 'Risposta'}
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
                    <button class="btn" style="background: #f44336; color: white; padding: 12px 20px; border-radius: 8px;" 
                            onclick="rateCard(${actualCardIndex}, 3)">
                        ❌ Difficile
                    </button>
                    <button class="btn" style="background: #ffa726; color: white; padding: 12px 20px; border-radius: 8px;" 
                            onclick="rateCard(${actualCardIndex}, 2)">
                        🤔 Medio
                    </button>
                    <button class="btn" style="background: #4caf50; color: white; padding: 12px 20px; border-radius: 8px;" 
                            onclick="rateCard(${actualCardIndex}, 1)">
                        ✅ Facile
                    </button>
                </div>
                
                <div class="controls">
                    <button class="btn" onclick="prevFlashAdvanced()" ${currentFilteredIndex === 0 ? 'disabled' : ''}>← Indietro</button>
                    <button class="btn" onclick="nextFlashAdvanced()" ${currentFilteredIndex === filteredIndices.length - 1 ? 'disabled' : ''}>Avanti →</button>
                </div>
                
                <div class="note-section">
                    <strong>📝 Le tue note su questa carta:</strong>
                    <textarea class="note-input" id="flashcardNote" placeholder="Aggiungi note personali..." style="max-height: 100px;">${appState.notes[`note_${studyId}_${actualCardIndex}`] || ''}</textarea>
                    <button class="btn" onclick="saveFlashcardNote(${actualCardIndex})" style="margin-top: 8px; padding: 8px 15px; font-size: 0.9em;">💾 Salva nota</button>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function rateCard(cardIndex, difficulty) {
            const study = getCurrentStudy();
            if (!study) return;
            
            updateCardDifficulty(study.id, cardIndex, difficulty);
            nextFlashAdvanced();
        }

        function nextFlashAdvanced() {
            const study = getCurrentStudy();
            const mode = appState.flashcardMode || 'all';
            const filteredIndices = getFilteredCards(study, mode);
            
            if ((appState.currentFlashcardFiltered || 0) < filteredIndices.length - 1) {
                appState.currentFlashcardFiltered = (appState.currentFlashcardFiltered || 0) + 1;
                renderFlashcardsAdvanced();
            }
        }

        function prevFlashAdvanced() {
            if ((appState.currentFlashcardFiltered || 0) > 0) {
                appState.currentFlashcardFiltered = (appState.currentFlashcardFiltered || 0) - 1;
                renderFlashcardsAdvanced();
            }
        }

        function saveFlashcardNote(actualCardIndex) {
            const noteKey = `note_${appState.currentStudyId}_${actualCardIndex}`;
            appState.notes[noteKey] = document.getElementById('flashcardNote').value;
            localStorage.setItem('flashcardNotes', JSON.stringify(appState.notes));
            alert('✅ Nota salvata!');
        }

        // ===== QUIZ SYSTEM AVANZATO =====

        function initQuizStats(studyId, totalQuestions) {
            if (!quizStats[studyId]) {
                quizStats[studyId] = {
                    questions: Array(totalQuestions).fill(null).map(() => ({
                        attempts: 0,
                        correct: 0,
                        wrong: 0,
                        lastAttempt: null
                    })),
                    sessions: [],
                    totalScore: 0,
                    totalAttempts: 0
                };
                saveQuizStats();
            }
        }

        function saveQuizStats() {
            localStorage.setItem('quizStats', JSON.stringify(quizStats));
        }

        function getQuizStats(studyId) {
            return quizStats[studyId] || null;
        }

        function updateQuizQuestion(studyId, questionIndex, isCorrect) {
            if (!quizStats[studyId]) return;
            
            const question = quizStats[studyId].questions[questionIndex];
            question.attempts++;
            if (isCorrect) {
                question.correct++;
            } else {
                question.wrong++;
            }
            question.lastAttempt = Date.now();
            saveQuizStats();
        }

        function saveQuizSession(studyId, score, total, answers, timeTaken) {
            if (!quizStats[studyId]) return;
            
            quizStats[studyId].sessions.push({
                date: Date.now(),
                score: score,
                total: total,
                percentage: (score / total * 100).toFixed(1),
                timeTaken: timeTaken,
                answers: answers
            });
            
            quizStats[studyId].totalScore += score;
            quizStats[studyId].totalAttempts += total;
            
            saveQuizStats();
        }

        function getFilteredQuizQuestions(study, mode) {
            const studyId = study.id;
            const questions = study.data.quiz || [];
            
            if (!quizStats[studyId]) {
                initQuizStats(studyId, questions.length);
            }
            
            let indices = questions.map((_, i) => i);
            const stats = quizStats[studyId];
            
            switch(mode) {
                case 'unanswered':
                    indices = indices.filter(i => stats.questions[i].attempts === 0);
                    break;
                case 'wrong':
                    indices = indices.filter(i => stats.questions[i].wrong > 0);
                    break;
                case 'random':
                    indices = indices.sort(() => Math.random() - 0.5);
                    break;
            }
            
            return indices;
        }

        function getQuizProgressStats(studyId) {
            if (!quizStats[studyId]) return null;
            
            const questions = quizStats[studyId].questions;
            const total = questions.length;
            const attempted = questions.filter(q => q.attempts > 0).length;
            const correct = questions.reduce((sum, q) => sum + q.correct, 0);
            const wrong = questions.reduce((sum, q) => sum + q.wrong, 0);
            const totalAttempts = correct + wrong;
            const accuracy = totalAttempts > 0 ? ((correct / totalAttempts) * 100).toFixed(1) : 0;
            
            return {
                total,
                attempted,
                unattempted: total - attempted,
                correct,
                wrong,
                accuracy,
                sessions: quizStats[studyId].sessions.length
            };
        }

        function renderQuizAdvanced() {
            const study = getCurrentStudy();
            if (!study || !study.data.quiz || study.data.quiz.length === 0) return;
            
            const studyId = study.id;
            initQuizStats(studyId, study.data.quiz.length);
            
            const mode = appState.quizMode || 'all';
            const filteredIndices = getFilteredQuizQuestions(study, mode);
            
            if (filteredIndices.length === 0) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="back-btn" onclick="goBack()">← Torna alla Libreria</div>
                    <h2>${study.name}</h2>
                    <div class="card" style="text-align: center; padding: 40px;">
                        <h3>🎉 Ben fatto!</h3>
                        <p style="margin: 20px 0;">Non ci sono domande da fare in questa modalità.</p>
                        <button class="btn" onclick="appState.quizMode = 'all'; appState.currentQuizFiltered = 0; renderQuizAdvanced();">
                            Rivedi tutte le domande
                        </button>
                    </div>
                `;
                return;
            }
            
            if (appState.currentQuizFiltered >= filteredIndices.length) {
                showQuizResults(study, filteredIndices);
                return;
            }
            
            const currentFilteredIndex = appState.currentQuizFiltered || 0;
            const actualQuestionIndex = filteredIndices[currentFilteredIndex];
            const q = study.data.quiz[actualQuestionIndex];
            const stats = getQuizProgressStats(studyId);
            const prog = ((currentFilteredIndex + 1) / filteredIndices.length * 100).toFixed(0);
            
            let html = `
                <div class="back-btn" onclick="goBack()">← Torna alla Libreria</div>
                <h2>${study.name}</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div class="card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.accuracy}%</div>
                        <div style="font-size: 12px; opacity: 0.9;">Precisione ✅</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.attempted}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Tentate 📝</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.wrong}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Sbagliate ❌</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); color: white; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.sessions}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Sessioni 🎯</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn" style="padding: 8px 15px; ${mode === 'all' ? 'background: var(--primary);' : ''}" 
                            onclick="resetQuizMode('all')">
                        📚 Tutte (${study.data.quiz.length})
                    </button>
                    <button class="btn" style="padding: 8px 15px; ${mode === 'unanswered' ? 'background: var(--primary);' : ''}" 
                            onclick="resetQuizMode('unanswered')">
                        👁️ Non Tentate (${stats.unattempted})
                    </button>
                    <button class="btn" style="padding: 8px 15px; ${mode === 'wrong' ? 'background: var(--primary);' : ''}" 
                            onclick="resetQuizMode('wrong')">
                        ❌ Sbagliate (${stats.wrong})
                    </button>
                    <button class="btn" style="padding: 8px 15px; ${mode === 'random' ? 'background: var(--primary);' : ''}" 
                            onclick="resetQuizMode('random')">
                        🎲 Casuale
                    </button>
                    <button class="btn" style="padding: 8px 15px; ${appState.quizTimerEnabled ? 'background: var(--danger);' : ''}" 
                            onclick="toggleQuizTimer()">
                        ⏱️ Timer ${appState.quizTimerEnabled ? 'ON' : 'OFF'}
                    </button>
                </div>
                
                ${appState.quizTimerEnabled ? `
                    <div class="timer-display ${appState.quizTimeRemaining <= 10 ? 'warning' : ''}">
                        ⏱️ ${appState.quizTimeRemaining}s
                    </div>
                ` : ''}
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${prog}%"></div>
                </div>
                <p style="text-align: center; margin: 10px 0;">Domanda ${currentFilteredIndex + 1}/${filteredIndices.length}</p>
                
                <h3 style="margin: 30px 0; font-size: 1.3em;">${q.q || 'Domanda'}</h3>
            `;
            
            (q.options || []).forEach((o, i) => {
                html += `<div class="quiz-option" onclick="selectQuizAnswer(${i}, ${actualQuestionIndex})">${o}</div>`;
            });
            
            html += `
                <div class="controls">
                    <button class="btn" onclick="submitQuizAnswer(${actualQuestionIndex}, ${q.correct})">Conferma Risposta</button>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
            
            if (appState.quizTimerEnabled && !appState.quizTimerId) {
                startQuizTimer();
            }
        }

        function resetQuizMode(mode) {
            appState.quizMode = mode;
            appState.currentQuizFiltered = 0;
            appState.quizAnswers = [];
            appState.quizScore = 0;
            renderQuizAdvanced();
        }

        function toggleQuizTimer() {
            appState.quizTimerEnabled = !appState.quizTimerEnabled;
            if (appState.quizTimerEnabled) {
                appState.quizTimeRemaining = 30;
            } else {
                if (appState.quizTimerId) {
                    clearInterval(appState.quizTimerId);
                    appState.quizTimerId = null;
                }
            }
            renderQuizAdvanced();
        }

        function startQuizTimer() {
            appState.quizTimeRemaining = 30;
            appState.quizTimerId = setInterval(() => {
                appState.quizTimeRemaining--;
                const timerEl = document.querySelector('.timer-display');
                if (timerEl) {
                    timerEl.textContent = `⏱️ ${appState.quizTimeRemaining}s`;
                    if (appState.quizTimeRemaining <= 10) {
                        timerEl.classList.add('warning');
                    }
                }
                
                if (appState.quizTimeRemaining <= 0) {
                    clearInterval(appState.quizTimerId);
                    appState.quizTimerId = null;
                    alert('⏰ Tempo scaduto!');
                    const study = getCurrentStudy();
                    const mode = appState.quizMode || 'all';
                    const filteredIndices = getFilteredQuizQuestions(study, mode);
                    const actualQuestionIndex = filteredIndices[appState.currentQuizFiltered];
                    
                    appState.quizAnswers.push({
                        question: actualQuestionIndex,
                        selected: null,
                        correct: study.data.quiz[actualQuestionIndex].correct,
                        isCorrect: false,
                        timeTaken: 30
                    });
                    
                    updateQuizQuestion(study.id, actualQuestionIndex, false);
                    nextQuizAdvanced();
                }
            }, 1000);
        }

        let selectedAnswerIndex = null;

        function selectQuizAnswer(index, questionIndex) {
            selectedAnswerIndex = index;
            document.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelectorAll('.quiz-option')[index].classList.add('selected');
        }

        function submitQuizAnswer(questionIndex, correctIndex) {
            if (selectedAnswerIndex === null) {
                alert('⚠️ Seleziona una risposta prima di confermare!');
                return;
            }
            
            if (appState.quizTimerId) {
                clearInterval(appState.quizTimerId);
                appState.quizTimerId = null;
            }
            
            const timeTaken = appState.quizTimerEnabled ? (30 - appState.quizTimeRemaining) : 0;
            const isCorrect = selectedAnswerIndex === correctIndex;
            
            const study = getCurrentStudy();
            appState.quizAnswers.push({
                question: questionIndex,
                selected: selectedAnswerIndex,
                correct: correctIndex,
                isCorrect: isCorrect,
                timeTaken: timeTaken
            });
            
            if (isCorrect) {
                appState.quizScore++;
            }
            
            updateQuizQuestion(study.id, questionIndex, isCorrect);
            
            document.querySelectorAll('.quiz-option').forEach((opt, i) => {
                opt.style.pointerEvents = 'none';
                if (i === correctIndex) {
                    opt.classList.add('correct');
                } else if (i === selectedAnswerIndex && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });
            
            setTimeout(() => {
                selectedAnswerIndex = null;
                nextQuizAdvanced();
            }, 1500);
        }

        function nextQuizAdvanced() {
            const study = getCurrentStudy();
            const mode = appState.quizMode || 'all';
            const filteredIndices = getFilteredQuizQuestions(study, mode);
            
            if ((appState.currentQuizFiltered || 0) < filteredIndices.length - 1) {
                appState.currentQuizFiltered = (appState.currentQuizFiltered || 0) + 1;
                renderQuizAdvanced();
            } else {
                showQuizResults(study, filteredIndices);
            }
        }

        function showQuizResults(study, filteredIndices) {
            if (appState.quizTimerId) {
                clearInterval(appState.quizTimerId);
                appState.quizTimerId = null;
            }
            
            const totalTime = appState.quizAnswers.reduce((sum, a) => sum + a.timeTaken, 0);
            const avgTime = appState.quizAnswers.length > 0 ? (totalTime / appState.quizAnswers.length).toFixed(1) : 0;
            const perc = (appState.quizScore / filteredIndices.length * 100).toFixed(1);
            
            saveQuizSession(study.id, appState.quizScore, filteredIndices.length, appState.quizAnswers, totalTime);
            
            let html = `
                <div class="back-btn" onclick="goBack()">← Torna alla Libreria</div>
                <h2 style="text-align: center;">🏆 Quiz Completato!</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;">${appState.quizScore}/${filteredIndices.length}</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Corrette</div>
                    </div>
                    <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;">${perc}%</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Percentuale</div>
                    </div>
                    ${appState.quizTimerEnabled ? `
                        <div style="background: linear-gradient(135deg, #ffa726, #fb8c00); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2em; font-weight: bold;">${avgTime}s</div>
                            <div style="font-size: 0.9em; margin-top: 5px;">Tempo Medio</div>
                        </div>
                    ` : ''}
                </div>
                
                <h3 style="margin: 20px 0;">📋 Rivedi le Risposte</h3>
            `;
            
            appState.quizAnswers.forEach((answer, i) => {
                const q = study.data.quiz[answer.question];
                const userAnswer = answer.selected !== null ? q.options[answer.selected] : 'Nessuna risposta';
                const correctAnswer = q.options[answer.correct];
                
                html += `
                    <div class="review-item ${answer.isCorrect ? 'correct' : 'wrong'}">
                        <strong>Domanda ${i + 1}:</strong> ${q.q}
                        <div style="margin-top: 10px;">
                            <div><strong>La tua risposta:</strong> ${userAnswer} ${answer.isCorrect ? '✅' : '❌'}</div>
                            ${!answer.isCorrect ? `<div><strong>Risposta corretta:</strong> ${correctAnswer}</div>` : ''}
                            ${appState.quizTimerEnabled ? `<div style="font-size: 0.9em; color: #666; margin-top: 5px;">⏱️ Tempo: ${answer.timeTaken}s</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div class="controls">
                    <button class="btn" onclick="restartQuiz()" style="width: 100%;">🔄 Rifai il Quiz</button>
                    <button class="btn" onclick="goBack()" style="width: 100%;">← Torna alla Libreria</button>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function restartQuiz() {
            appState.currentQuizFiltered = 0;
            appState.quizScore = 0;
            appState.quizAnswers = [];
            renderQuizAdvanced();
        }

        function resetApp() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('pdfFile').value = '';
        }
    </script>
</body>
</html>
