<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MentoreStudio - Il tuo mentore personale per lo studio intelligente">
    <title>üìö MentoreStudio - Studia Intelligente</title>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ffa726;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        body.dark-mode { background: #0f0f1e; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .header { background: #2a2a3e; color: #e0e0e0; }
        h1 { font-size: 1.8em; color: var(--primary); }
        body.dark-mode h1 { color: var(--accent); }
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }
        .header-controls { display: flex; gap: 10px; }
        .toggle-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .toggle-btn:hover { transform: scale(1.05); }
        
        /* DASHBOARD STATISTICS */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        body.dark-mode .stat-card { background: #2a2a3e; }
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-icon {
            font-size: 2em;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }
        body.dark-mode .stat-value { color: var(--accent); }
        .stat-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }
        body.dark-mode .stat-label { color: #aaa; }
        .stat-detail {
            font-size: 0.8em;
            color: #999;
        }
        .streak-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        /* FILTERS AND SEARCH */
        .filters-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .filters-section { background: #2a2a3e; }
        .filters-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9em;
            color: #666;
        }
        body.dark-mode .filter-group label { color: #aaa; }
        .filter-select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
            background: white;
        }
        body.dark-mode .filter-select { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .filter-buttons {
            display: flex;
            gap: 10px;
        }
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: white;
            color: var(--primary);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .filter-btn:hover, .filter-btn.active {
            background: var(--primary);
            color: white;
        }
        body.dark-mode .filter-btn {
            background: #1a1a2e;
            color: var(--accent);
            border-color: var(--accent);
        }
        body.dark-mode .filter-btn:hover, body.dark-mode .filter-btn.active {
            background: var(--accent);
            color: #1a1a2e;
        }
        
        /* VIEW TOGGLE */
        .view-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .view-toggle {
            display: flex;
            gap: 5px;
            background: white;
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        body.dark-mode .view-toggle { background: #2a2a3e; }
        .view-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }
        .view-btn.active {
            background: var(--primary);
        }
        .view-btn:hover {
            transform: scale(1.1);
        }
        
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .upload-section { background: #2a2a3e; color: #e0e0e0; }
        input[type="file"], input[type="text"] {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
        }
        body.dark-mode input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .subject-select {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            font-size: 1em;
        }
        body.dark-mode .subject-select { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-delete { background: var(--danger); padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .btn-export { background: #2196F3; padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .tabs { background: #2a2a3e; }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f0f0f0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        body.dark-mode .tab-btn { background: #1a1a2e; color: #e0e0e0; }
        .tab-btn.active { background: var(--primary); color: white; }
        .content-area {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 500px;
        }
        body.dark-mode .content-area { background: #2a2a3e; color: #e0e0e0; }
        .hidden { display: none !important; }
        .section { margin-bottom: 30px; }
        .section h2 { color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        body.dark-mode .section h2 { color: var(--accent); border-color: var(--accent); }
        .card { background: #f5f7ff; padding: 20px; border-radius: 10px; margin: 10px 0; border-left: 4px solid var(--primary); }
        body.dark-mode .card { background: #1a1a2e; border-left-color: var(--accent); }
        
        /* STUDY ITEMS - GRID AND LIST VIEWS */
        .studies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        .studies-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .study-item {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            border: 2px solid transparent;
        }
        body.dark-mode .study-item { background: #1a1a2e; }
        .study-item:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            border-color: var(--primary);
        }
        
        /* Grid View Specific */
        .studies-grid .study-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* List View Specific */
        .studies-list .study-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
        }
        
        .study-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .study-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        body.dark-mode .study-title { color: var(--accent); }
        
        /* Progress Bar */
        .study-progress {
            margin: 10px 0;
        }
        .progress-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        body.dark-mode .progress-label { color: #aaa; }
        .progress-bar-container {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        body.dark-mode .progress-bar-container { background: #3a3a4e; }
        .progress-bar-fill {
            background: linear-gradient(90deg, var(--success), var(--primary));
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-new { background: #e3f2fd; color: #1976d2; }
        .status-in-progress { background: #fff3e0; color: #f57c00; }
        .status-completed { background: #e8f5e9; color: #388e3c; }
        body.dark-mode .status-new { background: #1a237e; color: #64b5f6; }
        body.dark-mode .status-in-progress { background: #e65100; color: #ffb74d; }
        body.dark-mode .status-completed { background: #1b5e20; color: #81c784; }
        
        .study-info {
            font-size: 0.9em;
            color: #666;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 8px;
        }
        body.dark-mode .study-info { color: #aaa; }
        .study-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Action Menu */
        .study-actions {
            position: relative;
        }
        .action-menu-btn {
            background: transparent;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .action-menu-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        .action-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            min-width: 180px;
            z-index: 1000;
            overflow: hidden;
        }
        body.dark-mode .action-menu { background: #1a1a2e; }
        .action-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }
        .action-menu-item:hover {
            background: #f0f0f0;
        }
        body.dark-mode .action-menu-item:hover {
            background: #2a2a3e;
        }
        .action-menu-item.danger {
            color: var(--danger);
        }
        .action-menu-item.danger:hover {
            background: rgba(244, 67, 54, 0.1);
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
        }
        body.dark-mode .search-box { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f0f0f0; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* TUTORIAL/ONBOARDING */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tutorial-box {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        body.dark-mode .tutorial-box { background: #2a2a3e; color: #e0e0e0; }
        .tutorial-step {
            text-align: center;
        }
        .tutorial-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        .tutorial-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
        }
        body.dark-mode .tutorial-title { color: var(--accent); }
        .tutorial-description {
            font-size: 1em;
            line-height: 1.6;
            color: #666;
            margin-bottom: 25px;
        }
        body.dark-mode .tutorial-description { color: #aaa; }
        .tutorial-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .tutorial-dots {
            display: flex;
            gap: 8px;
        }
        .tutorial-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s;
        }
        .tutorial-dot.active {
            background: var(--primary);
            width: 30px;
            border-radius: 5px;
        }
        .tutorial-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .tutorial-btn:hover {
            transform: scale(1.05);
        }
        .tutorial-btn-secondary {
            background: transparent;
            color: var(--primary);
        }
        body.dark-mode .tutorial-btn-secondary {
            color: var(--accent);
        }
        
        .flashcard { 
            perspective: 1000px; 
            min-height: 350px; 
            cursor: pointer; 
            margin: 20px 0; 
            border: 3px solid transparent;
            border-radius: 10px;
        }
        .flashcard.easy { border-color: #4caf50; }
        .flashcard.medium { border-color: #ffa726; }
        .flashcard.difficult { border-color: #f44336; }
        .flashcard-inner { position: relative; width: 100%; min-height: 350px; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard-inner.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; min-height: 350px; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; text-align: center; border-radius: 10px; }
        .flashcard-front { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .flashcard-back { background: linear-gradient(135deg, var(--accent), #f5576c); color: white; transform: rotateY(180deg); }
        .flashcard-question { font-size: 1.3em; font-weight: bold; margin-bottom: 15px; }
        .flashcard-answer { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; }
        .flashcard-extra { 
            font-size: 0.9em; 
            margin-top: 15px; 
            padding-top: 15px; 
            border-top: 2px solid rgba(255,255,255,0.3);
            text-align: left;
            width: 100%;
        }
        .flashcard-hint { 
            font-size: 0.85em; 
            opacity: 0.8; 
            margin-top: 10px;
            font-style: italic;
        }
        .flashcard-counter {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .flashcard-category {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .flashcard-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .flashcard-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .flashcard-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-easy { background: #4caf50; color: white; }
        .btn-medium { background: #ffa726; color: white; }
        .btn-difficult { background: #f44336; color: white; }
        .btn-next { background: var(--primary); color: white; }
        .flashcard-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 20px;
            background: #f5f7ff;
            border-radius: 10px;
        }
        body.dark-mode .flashcard-stats { background: #1a1a2e; }
        .flashcard-stat {
            text-align: center;
        }
        .flashcard-stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary);
        }
        body.dark-mode .flashcard-stat-value { color: var(--accent); }
        .flashcard-stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        body.dark-mode .flashcard-stat-label { color: #aaa; }
        .quiz-question { background: #f5f7ff; padding: 25px; border-radius: 10px; margin: 20px 0; border-left: 4px solid var(--primary); }
        body.dark-mode .quiz-question { background: #1a1a2e; border-left-color: var(--accent); }
        .quiz-question h3 { color: var(--primary); margin-bottom: 15px; }
        body.dark-mode .quiz-question h3 { color: var(--accent); }
        .quiz-options { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .quiz-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        body.dark-mode .quiz-option { background: #1a1a2e; border-color: #3a3a4e; color: #e0e0e0; }
        .quiz-option:hover { border-color: var(--primary); background: #f0f4ff; }
        body.dark-mode .quiz-option:hover { background: #2a2a3e; border-color: var(--accent); }
        .quiz-option.selected { border-color: var(--primary); background: #e8eaff; font-weight: bold; }
        body.dark-mode .quiz-option.selected { background: #3a3a5e; border-color: var(--accent); }
        .quiz-option.correct { border-color: var(--success); background: #e8f5e9; color: var(--success); }
        .quiz-option.incorrect { border-color: var(--danger); background: #ffebee; color: var(--danger); }
        .quiz-result {
            background: linear-gradient(135deg, var(--success), #66bb6a);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }
        .quiz-score {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
        }
        .quiz-controls { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .mind-map-container { width: 100%; min-height: 600px; border: 2px solid #ddd; border-radius: 10px; background: #fafafa; }
        body.dark-mode .mind-map-container { background: #1a1a2e; border-color: #3a3a4e; }
        .timeline { position: relative; padding: 20px 0; }
        .timeline::before {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background: var(--primary);
        }
        .timeline-item {
            position: relative;
            margin-bottom: 40px;
            padding: 0 20px;
        }
        .timeline-item:nth-child(odd) { text-align: right; padding-right: calc(50% + 40px); }
        .timeline-item:nth-child(even) { text-align: left; padding-left: calc(50% + 40px); }
        .timeline-content {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .timeline-content { background: #1a1a2e; }
        .timeline-marker {
            position: absolute;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            border: 4px solid white;
            top: 20px;
        }
        body.dark-mode .timeline-marker { border-color: #2a2a3e; }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            background: #f5f7ff;
            border-radius: 10px;
            overflow: hidden;
        }
        body.dark-mode .chat-container { background: #1a1a2e; }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .chat-message {
            display: flex;
            gap: 10px;
            max-width: 80%;
        }
        .chat-message.user { align-self: flex-end; flex-direction: row-reverse; }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }
        .chat-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        body.dark-mode .chat-bubble { background: #2a2a3e; }
        .chat-message.user .chat-bubble {
            background: var(--primary);
            color: white;
        }
        .chat-input-area {
            padding: 20px;
            border-top: 2px solid #ddd;
            display: flex;
            gap: 10px;
        }
        body.dark-mode .chat-input-area { border-color: #3a3a4e; }
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
            resize: none;
        }
        body.dark-mode .chat-input { background: #2a2a3e; color: #e0e0e0; border-color: var(--accent); }
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 10px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .suggested-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px;
            border-top: 2px solid #ddd;
        }
        body.dark-mode .suggested-questions { border-color: #3a3a4e; }
        .suggested-question {
            padding: 8px 15px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        body.dark-mode .suggested-question { background: #2a2a3e; border-color: var(--accent); color: #e0e0e0; }
        .suggested-question:hover {
            background: var(--primary);
            color: white;
        }
        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .filters-row { flex-direction: column; }
            .studies-grid { grid-template-columns: 1fr; }
            .timeline-item { padding-left: 40px !important; text-align: left !important; }
            .timeline-item:nth-child(odd) { padding-right: 20px !important; }
            .timeline::before { left: 10px; }
            .timeline-marker { left: 10px; }
        }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23667eea'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3Eü¶â%3C/text%3E%3C/svg%3E" alt="Logo" class="logo-img">
                <h1>üìö MentoreStudio</h1>
            </div>
            <div class="header-controls">
                <button class="toggle-btn" onclick="toggleDarkMode()">üåô</button>
                <button class="toggle-btn" onclick="showTutorial()">‚ùì Tutorial</button>
            </div>
        </div>

        <div id="uploadSection" class="upload-section">
            <h2>üéì Carica il tuo materiale di studio</h2>
            <p style="margin: 20px 0; color: #666;">Supportiamo PDF, immagini e file di testo</p>
            <input type="file" id="pdfFile" accept=".pdf,image/*,.txt,.doc,.docx" onchange="handleFileUpload(event)">
            <br>
            <input type="text" id="studyName" placeholder="Nome della lezione (es. Capitolo 3)">
            <br>
            <select id="studySubject" class="subject-select">
                <option value="">Seleziona materia...</option>
                <option value="Generale">üìö Generale</option>
                <option value="Matematica">üî¢ Matematica</option>
                <option value="Fisica">‚öõÔ∏è Fisica</option>
                <option value="Chimica">üß™ Chimica</option>
                <option value="Biologia">üß¨ Biologia</option>
                <option value="Storia">üìú Storia</option>
                <option value="Geografia">üåç Geografia</option>
                <option value="Letteratura">üìñ Letteratura</option>
                <option value="Filosofia">üí≠ Filosofia</option>
                <option value="Lingue">üó£Ô∏è Lingue</option>
                <option value="Informatica">üíª Informatica</option>
                <option value="Arte">üé® Arte</option>
                <option value="Musica">üéµ Musica</option>
                <option value="Economia">üí∞ Economia</option>
                <option value="Diritto">‚öñÔ∏è Diritto</option>
            </select>
            <br>
            <button class="btn" onclick="analyzeDocument()" id="analyzeBtn" disabled>üöÄ Analizza Documento</button>
        </div>

        <div id="mainApp" class="hidden">
            <!-- Dashboard Statistics -->
            <div class="dashboard" id="dashboard">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value" id="totalLessons">0</div>
                            <div class="stat-label">Lezioni Totali</div>
                        </div>
                        <div class="stat-icon">üìö</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value" id="completedQuizzes">0</div>
                            <div class="stat-label">Quiz Completati</div>
                            <div class="stat-detail" id="avgScore">Media: --</div>
                        </div>
                        <div class="stat-icon">‚úÖ</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value" id="studyTime">0h</div>
                            <div class="stat-label">Tempo di Studio</div>
                            <div class="stat-detail" id="thisWeek">Questa settimana</div>
                        </div>
                        <div class="stat-icon">‚è±Ô∏è</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value"><span class="streak-badge" id="streak">0üî•</span></div>
                            <div class="stat-label">Streak</div>
                            <div class="stat-detail">Giorni consecutivi</div>
                        </div>
                        <div class="stat-icon">üî•</div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('library')">üìö Riassunto</button>
                <button class="tab-btn" onclick="switchTab('highlights')">‚≠ê Punti Salienti</button>
                <button class="tab-btn" onclick="switchTab('glossary')">üìñ Glossario</button>
                <button class="tab-btn" onclick="switchTab('timeline')">üìÖ Timeline</button>
                <button class="tab-btn" onclick="switchTab('mindmap')">üß† Mappa Mentale</button>
                <button class="tab-btn" onclick="switchTab('study')">üìò Guida di Studio</button>
                <button class="tab-btn" onclick="switchTab('concepts')">üîç Analisi Concetto</button>
                <button class="tab-btn" onclick="switchTab('create')">‚ú® Crea il Tuo</button>
                <button class="tab-btn" onclick="switchTab('flashcards')">üé¥ Flashcard</button>
                <button class="tab-btn" onclick="switchTab('quiz')">‚ùì Quiz</button>
                <button class="tab-btn" onclick="switchTab('chat')">üí¨ Chat AI</button>
            </div>

            <div class="content-area">
                <!-- Library Tab with Filters -->
                <div id="libraryTab" class="tab-content">
                    <h2>üìö Le tue lezioni</h2>
                    
                    <!-- Filters Section -->
                    <div class="filters-section">
                        <div class="filters-row">
                            <div class="filter-group">
                                <label>üîç Cerca</label>
                                <input type="text" id="searchInput" class="search-box" placeholder="Cerca un termine in tutte le lezioni..." onkeyup="applyFilters()">
                            </div>
                            <div class="filter-group">
                                <label>üìö Materia</label>
                                <select id="subjectFilter" class="filter-select" onchange="applyFilters()">
                                    <option value="">Tutte le materie</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>üìÖ Periodo</label>
                                <select id="dateFilter" class="filter-select" onchange="applyFilters()">
                                    <option value="all">Tutto</option>
                                    <option value="today">Oggi</option>
                                    <option value="week">Ultima settimana</option>
                                    <option value="month">Ultimo mese</option>
                                    <option value="custom">Personalizzato</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>‚úÖ Stato</label>
                                <select id="statusFilter" class="filter-select" onchange="applyFilters()">
                                    <option value="all">Tutti</option>
                                    <option value="new">Nuovi</option>
                                    <option value="in-progress">In corso</option>
                                    <option value="completed">Completati</option>
                                </select>
                            </div>
                        </div>
                        <div class="filters-row" style="margin-top: 15px;">
                            <div class="filter-group">
                                <label>üìä Ordina per</label>
                                <select id="sortFilter" class="filter-select" onchange="applyFilters()">
                                    <option value="recent">Pi√π recenti</option>
                                    <option value="oldest">Pi√π vecchi</option>
                                    <option value="name">Nome (A-Z)</option>
                                    <option value="progress">Progresso</option>
                                </select>
                            </div>
                            <div class="filter-buttons">
                                <button class="filter-btn" onclick="resetFilters()">üîÑ Reset</button>
                            </div>
                        </div>
                    </div>

                    <!-- View Controls -->
                    <div class="view-controls">
                        <div style="font-size: 0.9em; color: #666;">
                            <span id="resultsCount">0</span> risultati
                        </div>
                        <div class="view-toggle">
                            <button class="view-btn active" id="gridViewBtn" onclick="setView('grid')" title="Vista griglia">üì±</button>
                            <button class="view-btn" id="listViewBtn" onclick="setView('list')" title="Vista lista">üìã</button>
                        </div>
                    </div>

                    <!-- Studies Container -->
                    <div id="studiesList" class="studies-grid"></div>
                </div>

                <div id="highlightsTab" class="tab-content hidden">
                    <h2>‚≠ê Punti Salienti</h2>
                    <div id="highlightsContent"></div>
                </div>

                <div id="glossaryTab" class="tab-content hidden">
                    <h2>üìñ Glossario</h2>
                    <div id="glossaryContent"></div>
                </div>

                <div id="timelineTab" class="tab-content hidden">
                    <h2>üìÖ Timeline</h2>
                    <div id="timelineContent" class="timeline"></div>
                </div>

                <div id="mindmapTab" class="tab-content hidden">
                    <h2>üß† Mappa Mentale</h2>
                    <div id="mindmapContent" class="mind-map-container"></div>
                </div>

                <div id="studyTab" class="tab-content hidden">
                    <h2>üìò Guida di Studio</h2>
                    <div id="studyContent"></div>
                </div>

                <div id="conceptsTab" class="tab-content hidden">
                    <h2>üîç Analisi Concetto</h2>
                    <div id="conceptsContent"></div>
                </div>

                <div id="createTab" class="tab-content hidden">
                    <h2>‚ú® Crea il Tuo</h2>
                    <div id="createContent"></div>
                </div>

                <div id="flashcardsTab" class="tab-content hidden">
                    <h2>üé¥ Flashcard</h2>
                    <div id="flashcardsContent"></div>
                </div>

                <div id="quizTab" class="tab-content hidden">
                    <h2>‚ùì Quiz</h2>
                    <div id="quizContent"></div>
                </div>

                <div id="chatTab" class="tab-content hidden">
                    <h2>üí¨ Chat AI</h2>
                    <div class="chat-container">
                        <div id="chatMessages" class="chat-messages"></div>
                        <div class="suggested-questions" id="suggestedQuestions"></div>
                        <div class="chat-input-area">
                            <textarea id="chatInput" class="chat-input" placeholder="Fai una domanda..." rows="1" onkeypress="handleChatKeyPress(event)" oninput="autoResizeTextarea(this)"></textarea>
                            <button class="btn" id="chatSendBtn" onclick="sendChatMessage()">Invia üì§</button>
                        </div>
                        <div style="padding: 10px 20px; text-align: right;">
                            <button class="btn btn-export" onclick="exportChatHistory()">Esporta Chat</button>
                            <button class="btn btn-delete" onclick="clearChatHistory()">Cancella Chat</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutorial Overlay -->
        <div id="tutorialOverlay" class="tutorial-overlay hidden">
            <div class="tutorial-box">
                <div class="tutorial-step" id="tutorialStep"></div>
                <div class="tutorial-navigation">
                    <button class="tutorial-btn tutorial-btn-secondary" onclick="skipTutorial()">Salta</button>
                    <div class="tutorial-dots" id="tutorialDots"></div>
                    <button class="tutorial-btn" onclick="nextTutorialStep()">Avanti</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        let appState = {
            studies: {},
            currentStudy: null,
            currentTab: 'library',
            currentFlashcardIndex: 0,
            currentQuizIndex: 0,
            quizAnswers: {},
            chatHistory: {},
            isChatLoading: false,
            filters: {
                search: '',
                subject: '',
                date: 'all',
                status: 'all',
                sort: 'recent'
            },
            view: 'grid',
            stats: {
                totalStudyTime: 0,
                weeklyStudyTime: 0,
                streak: 0,
                lastStudyDate: null,
                quizScores: []
            },
            tutorialStep: 0,
            tutorialShown: false
        };

        const tutorialSteps = [
            {
                icon: 'üëã',
                title: 'Benvenuto in MentoreStudio!',
                description: 'Il tuo assistente personale per studiare in modo pi√π efficace. Ti guider√≤ attraverso le funzionalit√† principali.'
            },
            {
                icon: 'üì§',
                title: 'Carica i tuoi materiali',
                description: 'Puoi caricare PDF, immagini o file di testo. L\'AI analizzer√† automaticamente il contenuto e creer√† materiali di studio personalizzati.'
            },
            {
                icon: 'üîç',
                title: 'Filtra e cerca',
                description: 'Usa i filtri avanzati per trovare rapidamente le tue lezioni per materia, data o stato di completamento. La ricerca cerca in tutto il contenuto.'
            },
            {
                icon: 'üìä',
                title: 'Monitora i tuoi progressi',
                description: 'La dashboard mostra le tue statistiche: lezioni completate, quiz fatti, tempo di studio e il tuo streak di giorni consecutivi!'
            },
            {
                icon: 'üé¥',
                title: 'Studia con flashcard e quiz',
                description: 'Genera automaticamente flashcard e quiz dal tuo materiale. Segna la difficolt√† delle flashcard per ripassarle meglio.'
            },
            {
                icon: 'üí¨',
                title: 'Chat con l\'AI',
                description: 'Hai domande? Chatta con l\'AI che conosce tutto il tuo materiale di studio. Perfetto per chiarire dubbi!'
            },
            {
                icon: 'üéâ',
                title: 'Sei pronto!',
                description: 'Ora puoi iniziare a studiare in modo pi√π intelligente. Carica il tuo primo documento e lascia che MentoreStudio faccia la magia!'
            }
        ];

        function loadState() {
            const saved = localStorage.getItem('mentoreStudio');
            if (saved) {
                const parsed = JSON.parse(saved);
                appState.studies = parsed.studies || {};
                appState.chatHistory = parsed.chatHistory || {};
                appState.stats = parsed.stats || appState.stats;
                appState.tutorialShown = parsed.tutorialShown || false;
                
                if (localStorage.getItem('darkMode') === 'true') {
                    document.body.classList.add('dark-mode');
                }
            }
        }

        function saveState() {
            localStorage.setItem('mentoreStudio', JSON.stringify({
                studies: appState.studies,
                chatHistory: appState.chatHistory,
                stats: appState.stats,
                tutorialShown: appState.tutorialShown
            }));
        }

        function saveChatHistory() {
            saveState();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        function showTutorial() {
            appState.tutorialStep = 0;
            document.getElementById('tutorialOverlay').classList.remove('hidden');
            renderTutorialStep();
        }

        function renderTutorialStep() {
            const step = tutorialSteps[appState.tutorialStep];
            const stepHtml = `
                <div class="tutorial-icon">${step.icon}</div>
                <div class="tutorial-title">${step.title}</div>
                <div class="tutorial-description">${step.description}</div>
            `;
            document.getElementById('tutorialStep').innerHTML = stepHtml;
            
            const dotsHtml = tutorialSteps.map((_, i) => 
                `<div class="tutorial-dot ${i === appState.tutorialStep ? 'active' : ''}"></div>`
            ).join('');
            document.getElementById('tutorialDots').innerHTML = dotsHtml;
        }

        function nextTutorialStep() {
            appState.tutorialStep++;
            if (appState.tutorialStep >= tutorialSteps.length) {
                closeTutorial();
            } else {
                renderTutorialStep();
            }
        }

        function skipTutorial() {
            closeTutorial();
        }

        function closeTutorial() {
            document.getElementById('tutorialOverlay').classList.add('hidden');
            appState.tutorialShown = true;
            saveState();
        }

        function updateDashboard() {
            const studies = Object.values(appState.studies);
            
            // Total lessons
            document.getElementById('totalLessons').textContent = studies.length;
            
            // Completed quizzes
            let completedQuizzes = 0;
            let totalScore = 0;
            studies.forEach(study => {
                if (study.quizCompleted) {
                    completedQuizzes++;
                    totalScore += study.quizScore || 0;
                }
            });
            document.getElementById('completedQuizzes').textContent = completedQuizzes;
            const avgScore = completedQuizzes > 0 ? Math.round(totalScore / completedQuizzes) : 0;
            document.getElementById('avgScore').textContent = `Media: ${avgScore}%`;
            
            // Study time
            const hours = Math.floor(appState.stats.weeklyStudyTime / 60);
            const minutes = appState.stats.weeklyStudyTime % 60;
            document.getElementById('studyTime').textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            
            // Streak
            updateStreak();
            document.getElementById('streak').textContent = appState.stats.streak + 'üî•';
        }

        function updateStreak() {
            const today = new Date().toDateString();
            const lastStudy = appState.stats.lastStudyDate;
            
            if (!lastStudy) {
                appState.stats.streak = 1;
                appState.stats.lastStudyDate = today;
            } else if (lastStudy !== today) {
                const lastDate = new Date(lastStudy);
                const todayDate = new Date(today);
                const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    appState.stats.streak++;
                } else if (diffDays > 1) {
                    appState.stats.streak = 1;
                }
                appState.stats.lastStudyDate = today;
            }
            
            saveState();
        }

        function addStudyTime(minutes) {
            appState.stats.weeklyStudyTime += minutes;
            appState.stats.totalStudyTime += minutes;
            updateStreak();
            updateDashboard();
            saveState();
        }

        function getStudyStatus(study) {
            if (!study.quizCompleted && !study.flashcardsReviewed) {
                return 'new';
            } else if (study.quizCompleted && study.quizScore >= 80) {
                return 'completed';
            } else {
                return 'in-progress';
            }
        }

        function getStudyProgress(study) {
            let progress = 0;
            let total = 4; // Riassunto, highlights, quiz, flashcards
            
            if (study.summaryViewed) progress++;
            if (study.highlightsViewed) progress++;
            if (study.quizCompleted) progress++;
            if (study.flashcardsReviewed) progress++;
            
            return Math.round((progress / total) * 100);
        }

        function setView(viewType) {
            appState.view = viewType;
            document.getElementById('gridViewBtn').classList.toggle('active', viewType === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', viewType === 'list');
            
            const studiesList = document.getElementById('studiesList');
            studiesList.className = viewType === 'grid' ? 'studies-grid' : 'studies-list';
            
            renderLibrary();
        }

        function resetFilters() {
            appState.filters = {
                search: '',
                subject: '',
                date: 'all',
                status: 'all',
                sort: 'recent'
            };
            
            document.getElementById('searchInput').value = '';
            document.getElementById('subjectFilter').value = '';
            document.getElementById('dateFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('sortFilter').value = 'recent';
            
            applyFilters();
        }

        function applyFilters() {
            appState.filters.search = document.getElementById('searchInput').value.toLowerCase();
            appState.filters.subject = document.getElementById('subjectFilter').value;
            appState.filters.date = document.getElementById('dateFilter').value;
            appState.filters.status = document.getElementById('statusFilter').value;
            appState.filters.sort = document.getElementById('sortFilter').value;
            
            renderLibrary();
        }

        function filterStudies(studies) {
            return studies.filter(study => {
                // Search filter
                if (appState.filters.search) {
                    const searchLower = appState.filters.search;
                    const matchesName = study.name.toLowerCase().includes(searchLower);
                    const matchesSubject = study.subject.toLowerCase().includes(searchLower);
                    const matchesContent = study.fullText && study.fullText.toLowerCase().includes(searchLower);
                    
                    if (!matchesName && !matchesSubject && !matchesContent) {
                        return false;
                    }
                }
                
                // Subject filter
                if (appState.filters.subject && study.subject !== appState.filters.subject) {
                    return false;
                }
                
                // Date filter
                if (appState.filters.date !== 'all') {
                    const studyDate = new Date(study.id);
                    const now = new Date();
                    const daysDiff = Math.floor((now - studyDate) / (1000 * 60 * 60 * 24));
                    
                    if (appState.filters.date === 'today' && daysDiff > 0) return false;
                    if (appState.filters.date === 'week' && daysDiff > 7) return false;
                    if (appState.filters.date === 'month' && daysDiff > 30) return false;
                }
                
                // Status filter
                if (appState.filters.status !== 'all') {
                    const status = getStudyStatus(study);
                    if (status !== appState.filters.status) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        function sortStudies(studies) {
            const sorted = [...studies];
            
            switch (appState.filters.sort) {
                case 'recent':
                    sorted.sort((a, b) => b.id - a.id);
                    break;
                case 'oldest':
                    sorted.sort((a, b) => a.id - b.id);
                    break;
                case 'name':
                    sorted.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'progress':
                    sorted.sort((a, b) => getStudyProgress(b) - getStudyProgress(a));
                    break;
            }
            
            return sorted;
        }

        function toggleActionMenu(studyId, event) {
            event.stopPropagation();
            
            // Close all other menus
            document.querySelectorAll('.action-menu').forEach(menu => {
                if (menu.id !== `menu-${studyId}`) {
                    menu.remove();
                }
            });
            
            // Toggle current menu
            const existingMenu = document.getElementById(`menu-${studyId}`);
            if (existingMenu) {
                existingMenu.remove();
                return;
            }
            
            const menu = document.createElement('div');
            menu.className = 'action-menu';
            menu.id = `menu-${studyId}`;
            menu.innerHTML = `
                <div class="action-menu-item" onclick="duplicateStudy('${studyId}'); event.stopPropagation();">
                    üìã Duplica
                </div>
                <div class="action-menu-item" onclick="archiveStudy('${studyId}'); event.stopPropagation();">
                    üì¶ Archivia
                </div>
                <div class="action-menu-item" onclick="exportStudy('${studyId}'); event.stopPropagation();">
                    üíæ Esporta
                </div>
                <div class="action-menu-item danger" onclick="deleteStudyWithConfirm('${studyId}'); event.stopPropagation();">
                    üóëÔ∏è Elimina
                </div>
            `;
            
            event.target.closest('.study-actions').appendChild(menu);
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 0);
        }

        function duplicateStudy(studyId) {
            const study = appState.studies[studyId];
            if (!study) return;
            
            const newId = Date.now();
            appState.studies[newId] = {
                ...study,
                id: newId,
                name: study.name + ' (Copia)',
                quizCompleted: false,
                flashcardsReviewed: false
            };
            
            saveState();
            renderLibrary();
            alert('‚úÖ Lezione duplicata!');
        }

        function archiveStudy(studyId) {
            const study = appState.studies[studyId];
            if (!study) return;
            
            study.archived = !study.archived;
            saveState();
            renderLibrary();
            alert(study.archived ? 'üì¶ Lezione archiviata!' : 'üìÇ Lezione ripristinata!');
        }

        function exportStudy(studyId) {
            const study = appState.studies[studyId];
            if (!study) return;
            
            const exportData = {
                name: study.name,
                subject: study.subject,
                summary: study.data.summary,
                highlights: study.data.highlights,
                glossary: study.data.glossary,
                timeline: study.data.timeline,
                flashcards: study.data.flashcards,
                quiz: study.data.quiz
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${study.name.replace(/[^a-z0-9]/gi, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Lezione esportata!');
        }

        function deleteStudyWithConfirm(studyId) {
            if (confirm('Sei sicuro di voler eliminare questa lezione? L\'operazione non pu√≤ essere annullata.')) {
                deleteStudy(studyId);
            }
        }

        function renderLibrary() {
            const studies = Object.values(appState.studies).filter(s => !s.archived);
            const filtered = filterStudies(studies);
            const sorted = sortStudies(filtered);
            
            document.getElementById('resultsCount').textContent = sorted.length;
            
            const html = sorted.map(study => {
                const status = getStudyStatus(study);
                const progress = getStudyProgress(study);
                const statusClass = `status-${status}`;
                const statusText = {
                    'new': 'Nuovo',
                    'in-progress': 'In corso',
                    'completed': 'Completato'
                }[status];
                
                const date = new Date(study.id).toLocaleDateString('it-IT');
                
                if (appState.view === 'grid') {
                    return `
                        <div class="study-item" onclick="selectStudy('${study.id}')">
                            <div class="study-header">
                                <div class="study-left">
                                    <div class="study-title">üìÑ ${study.name}</div>
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                </div>
                                <div class="study-actions">
                                    <button class="action-menu-btn" onclick="toggleActionMenu('${study.id}', event)">‚ãÆ</button>
                                </div>
                            </div>
                            <div class="study-progress">
                                <div class="progress-label">
                                    <span>Progresso</span>
                                    <span><strong>${progress}%</strong></span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <div class="study-info">
                                <div class="study-info-item">üìö ${study.subject}</div>
                                <div class="study-info-item">üìÖ ${date}</div>
                                <div class="study-info-item">üé¥ ${study.data.flashcards?.length || 0} card</div>
                                <div class="study-info-item">‚ùì ${study.data.quiz?.length || 0} quiz</div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="study-item" onclick="selectStudy('${study.id}')">
                            <div class="study-left">
                                <div class="study-title">üìÑ ${study.name}</div>
                                <div class="study-info">
                                    <div class="study-info-item">üìö ${study.subject}</div>
                                    <div class="study-info-item">üìÖ ${date}</div>
                                    <div class="study-info-item">üé¥ ${study.data.flashcards?.length || 0}</div>
                                    <div class="study-info-item">‚ùì ${study.data.quiz?.length || 0}</div>
                                </div>
                            </div>
                            <div style="min-width: 200px;">
                                <div class="progress-label">
                                    <span>Progresso</span>
                                    <span><strong>${progress}%</strong></span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                                <div class="study-actions">
                                    <button class="action-menu-btn" onclick="toggleActionMenu('${study.id}', event)">‚ãÆ</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            document.getElementById('studiesList').innerHTML = html || '<p style="text-align: center; color: #666; padding: 40px;">Nessuna lezione trovata. Prova a modificare i filtri.</p>';
            
            // Update subject filter options
            const subjects = [...new Set(studies.map(s => s.subject))].sort();
            const subjectFilterHtml = subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('subjectFilter').innerHTML = '<option value="">Tutte le materie</option>' + subjectFilterHtml;
        }

        function selectStudy(studyId) {
            appState.currentStudy = studyId;
            addStudyTime(2); // Add 2 minutes of study time
            showMainApp();
            switchTab('library');
            renderCurrentStudy();
        }

        function getCurrentStudy() {
            return appState.studies[appState.currentStudy];
        }

        function renderCurrentStudy() {
            const study = getCurrentStudy();
            if (!study) return;

            study.summaryViewed = true;
            saveState();

            document.getElementById('highlightsContent').innerHTML = `
                <div class="section">
                    <h3>‚≠ê Concetti Chiave</h3>
                    ${study.data.highlights.map(h => `<div class="card">‚Ä¢ ${h}</div>`).join('')}
                </div>
            `;

            document.getElementById('glossaryContent').innerHTML = `
                <div class="section">
                    ${Object.entries(study.data.glossary).map(([term, def]) => `
                        <div class="card">
                            <strong style="color: var(--primary);">${term}:</strong> ${def}
                        </div>
                    `).join('')}
                </div>
            `;

            if (study.data.timeline && study.data.timeline.length > 0) {
                document.getElementById('timelineContent').innerHTML = study.data.timeline.map((item, i) => `
                    <div class="timeline-item">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <h3>${item.event}</h3>
                            <p><strong>${item.date}</strong></p>
                            <p>${item.description}</p>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('mindmapContent').innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <h3>üß† Mappa Mentale</h3>
                    <p style="margin: 20px 0;">Visualizzazione dei concetti principali di "${study.name}"</p>
                    <div style="max-width: 800px; margin: 0 auto; text-align: left;">
                        ${study.data.mind_map ? study.data.mind_map.map(node => `
                            <div class="card" style="margin: 15px 0;">
                                <strong style="font-size: 1.1em; color: var(--primary);">${node.concept}</strong>
                                ${node.connections && node.connections.length > 0 ? `
                                    <ul style="margin-top: 10px; padding-left: 20px;">
                                        ${node.connections.map(c => `<li>${c}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        `).join('') : '<p>Nessuna mappa mentale disponibile</p>'}
                    </div>
                </div>
            `;

            document.getElementById('studyContent').innerHTML = `
                <div class="section">
                    <h3>üìö Obiettivi di Apprendimento</h3>
                    ${(study.data.study_guide?.learning_objectives || []).map(obj => 
                        `<div class="card">‚Ä¢ ${obj}</div>`
                    ).join('')}
                </div>
                <div class="section">
                    <h3>üéØ Tecniche di Studio Consigliate</h3>
                    ${(study.data.study_guide?.study_techniques || []).map(tech => 
                        `<div class="card">‚Ä¢ ${tech}</div>`
                    ).join('')}
                </div>
            `;

            document.getElementById('conceptsContent').innerHTML = `
                <div class="section">
                    ${(study.data.concept_analysis || []).map(concept => `
                        <div class="card">
                            <h3 style="color: var(--primary);">${concept.concept}</h3>
                            <p style="margin: 10px 0;"><strong>Spiegazione:</strong> ${concept.explanation}</p>
                            <p style="margin: 10px 0;"><strong>Esempio:</strong> ${concept.example}</p>
                            ${concept.related_concepts ? `
                                <p style="margin: 10px 0;"><strong>Concetti correlati:</strong> ${concept.related_concepts.join(', ')}</p>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('createContent').innerHTML = `
                <div class="section">
                    <h3>‚úçÔ∏è Crea Materiali Personalizzati</h3>
                    <div class="card">
                        <p>Genera contenuti basati su "${study.name}":</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                            <button class="btn" onclick="generateCustomSummary()">üìù Riassunto Breve</button>
                            <button class="btn" onclick="generatePracticeProblems()">üßÆ Esercizi Pratici</button>
                            <button class="btn" onclick="generateStudyPlan()">üìÖ Piano di Studio</button>
                            <button class="btn" onclick="generateMnemonics()">üß† Mnemotecniche</button>
                        </div>
                    </div>
                </div>
            `;

            renderFlashcards();
            renderQuiz();
            renderChat();
        }

        function renderFlashcards() {
            const study = getCurrentStudy();
            if (!study || !study.data.flashcards) return;

            const flashcards = study.data.flashcards;
            if (flashcards.length === 0) {
                document.getElementById('flashcardsContent').innerHTML = '<p>Nessuna flashcard disponibile.</p>';
                return;
            }

            const current = flashcards[appState.currentFlashcardIndex];
            const difficulty = current.difficulty || 'medium';

            const stats = flashcards.reduce((acc, card) => {
                acc[card.difficulty || 'medium']++;
                return acc;
            }, { easy: 0, medium: 0, difficult: 0 });

            document.getElementById('flashcardsContent').innerHTML = `
                <div class="flashcard ${difficulty}">
                    <div class="flashcard-inner" id="flashcardInner" onclick="flipFlashcard()">
                        <div class="flashcard-front">
                            <div class="flashcard-counter">${appState.currentFlashcardIndex + 1} / ${flashcards.length}</div>
                            <div class="flashcard-category">${current.category || 'Generale'}</div>
                            <div class="flashcard-question">${current.question}</div>
                            ${current.hint ? `<div class="flashcard-hint">üí° Suggerimento: ${current.hint}</div>` : ''}
                            <p style="margin-top: 20px; opacity: 0.7;">üëÜ Clicca per vedere la risposta</p>
                        </div>
                        <div class="flashcard-back">
                            <div class="flashcard-counter">${appState.currentFlashcardIndex + 1} / ${flashcards.length}</div>
                            <div class="flashcard-category">${current.category || 'Generale'}</div>
                            <div class="flashcard-answer">${current.answer}</div>
                            ${current.extra_info ? `<div class="flashcard-extra"><strong>Info Extra:</strong><br>${current.extra_info}</div>` : ''}
                        </div>
                    </div>
                </div>
                <div class="flashcard-controls">
                    <button class="flashcard-btn btn-difficult" onclick="markDifficulty('difficult')">
                        üò∞ Difficile
                    </button>
                    <button class="flashcard-btn btn-medium" onclick="markDifficulty('medium')">
                        ü§î Normale
                    </button>
                    <button class="flashcard-btn btn-easy" onclick="markDifficulty('easy')">
                        üòä Facile
                    </button>
                </div>
                <div class="flashcard-controls">
                    <button class="flashcard-btn btn-next" onclick="previousFlashcard()" ${appState.currentFlashcardIndex === 0 ? 'disabled' : ''}>
                        ‚¨ÖÔ∏è Precedente
                    </button>
                    <button class="flashcard-btn btn-next" onclick="nextFlashcard()">
                        ${appState.currentFlashcardIndex === flashcards.length - 1 ? 'üîÑ Ricomincia' : 'Successiva ‚û°Ô∏è'}
                    </button>
                </div>
                <div class="flashcard-stats">
                    <div class="flashcard-stat">
                        <div class="flashcard-stat-value" style="color: #4caf50;">${stats.easy}</div>
                        <div class="flashcard-stat-label">Facili</div>
                    </div>
                    <div class="flashcard-stat">
                        <div class="flashcard-stat-value" style="color: #ffa726;">${stats.medium}</div>
                        <div class="flashcard-stat-label">Normali</div>
                    </div>
                    <div class="flashcard-stat">
                        <div class="flashcard-stat-value" style="color: #f44336;">${stats.difficult}</div>
                        <div class="flashcard-stat-label">Difficili</div>
                    </div>
                </div>
            `;
        }

        function flipFlashcard() {
            document.getElementById('flashcardInner').classList.toggle('flipped');
        }

        function markDifficulty(difficulty) {
            const study = getCurrentStudy();
            if (!study) return;
            
            study.data.flashcards[appState.currentFlashcardIndex].difficulty = difficulty;
            study.flashcardsReviewed = true;
            saveState();
            nextFlashcard();
        }

        function nextFlashcard() {
            const study = getCurrentStudy();
            if (!study) return;
            
            if (appState.currentFlashcardIndex >= study.data.flashcards.length - 1) {
                appState.currentFlashcardIndex = 0;
            } else {
                appState.currentFlashcardIndex++;
            }
            renderFlashcards();
        }

        function previousFlashcard() {
            if (appState.currentFlashcardIndex > 0) {
                appState.currentFlashcardIndex--;
                renderFlashcards();
            }
        }

        function renderQuiz() {
            const study = getCurrentStudy();
            if (!study || !study.data.quiz) return;

            const quiz = study.data.quiz;
            if (quiz.length === 0) {
                document.getElementById('quizContent').innerHTML = '<p>Nessun quiz disponibile.</p>';
                return;
            }

            if (appState.currentQuizIndex >= quiz.length) {
                showQuizResults();
                return;
            }

            const q = quiz[appState.currentQuizIndex];
            const userAnswer = appState.quizAnswers[appState.currentQuizIndex];
            const isAnswered = userAnswer !== undefined;

            let optionsHtml = q.options.map((opt, i) => {
                let optClass = 'quiz-option';
                if (isAnswered) {
                    if (i === userAnswer) optClass += ' selected';
                    if (i === q.correct) optClass += ' correct';
                    if (i === userAnswer && i !== q.correct) optClass += ' incorrect';
                }
                return `
                    <div class="${optClass}" onclick="${isAnswered ? '' : `selectQuizOption(${i})`}">
                        ${String.fromCharCode(65 + i)}. ${opt}
                    </div>
                `;
            }).join('');

            document.getElementById('quizContent').innerHTML = `
                <div class="quiz-question">
                    <h3>Domanda ${appState.currentQuizIndex + 1} / ${quiz.length}</h3>
                    <p style="font-size: 1.1em; margin: 15px 0;">${q.question}</p>
                    <div class="quiz-options">${optionsHtml}</div>
                    ${isAnswered && q.explanation ? `
                        <div style="margin-top: 20px; padding: 15px; background: rgba(102,126,234,0.1); border-radius: 8px;">
                            <strong>üí° Spiegazione:</strong> ${q.explanation}
                        </div>
                    ` : ''}
                </div>
                <div class="quiz-controls">
                    ${appState.currentQuizIndex > 0 ? `
                        <button class="btn" onclick="previousQuiz()">‚¨ÖÔ∏è Precedente</button>
                    ` : ''}
                    ${isAnswered ? `
                        <button class="btn" onclick="nextQuiz()">
                            ${appState.currentQuizIndex === quiz.length - 1 ? '‚úÖ Termina Quiz' : 'Successiva ‚û°Ô∏è'}
                        </button>
                    ` : ''}
                </div>
            `;
        }

        function selectQuizOption(optionIndex) {
            appState.quizAnswers[appState.currentQuizIndex] = optionIndex;
            renderQuiz();
        }

        function nextQuiz() {
            appState.currentQuizIndex++;
            renderQuiz();
        }

        function previousQuiz() {
            if (appState.currentQuizIndex > 0) {
                appState.currentQuizIndex--;
                renderQuiz();
            }
        }

        function showQuizResults() {
            const study = getCurrentStudy();
            if (!study) return;

            const quiz = study.data.quiz;
            let correct = 0;
            quiz.forEach((q, i) => {
                if (appState.quizAnswers[i] === q.correct) correct++;
            });

            const score = Math.round((correct / quiz.length) * 100);
            study.quizCompleted = true;
            study.quizScore = score;
            
            appState.stats.quizScores.push(score);
            addStudyTime(10); // Add 10 minutes for completing quiz
            
            saveState();
            updateDashboard();

            document.getElementById('quizContent').innerHTML = `
                <div class="quiz-result">
                    <h2>üéâ Quiz Completato!</h2>
                    <div class="quiz-score">${score}%</div>
                    <p style="font-size: 1.2em;">Hai risposto correttamente a ${correct} su ${quiz.length} domande!</p>
                    ${score >= 80 ? `
                        <p style="margin-top: 20px;">üåü Eccellente! Hai una buona padronanza dell'argomento!</p>
                    ` : score >= 60 ? `
                        <p style="margin-top: 20px;">üëç Buon lavoro! Continua a ripassare per migliorare.</p>
                    ` : `
                        <p style="margin-top: 20px;">üìö Ripassa il materiale e riprova. Ce la puoi fare!</p>
                    `}
                </div>
                <div class="quiz-controls">
                    <button class="btn" onclick="restartQuiz()">üîÑ Ricomincia Quiz</button>
                    <button class="btn" onclick="switchTab('flashcards')">üé¥ Studia con Flashcard</button>
                </div>
            `;
        }

        function restartQuiz() {
            appState.currentQuizIndex = 0;
            appState.quizAnswers = {};
            renderQuiz();
        }

        function renderChat() {
            const study = getCurrentStudy();
            if (!study) return;

            if (!appState.chatHistory[study.id]) {
                appState.chatHistory[study.id] = [];
            }

            const messages = appState.chatHistory[study.id];
            
            let messagesHtml = '';
            if (messages.length === 0) {
                messagesHtml = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üí¨</div>
                        <h3>Inizia una conversazione!</h3>
                        <p style="margin-top: 10px;">Fai domande su "${study.name}" e ricevi risposte personalizzate.</p>
                    </div>
                `;
            } else {
                messagesHtml = messages.map((msg, i) => createChatMessageHTML(msg, `msg_${study.id}_${i}`)).join('');
            }

            document.getElementById('chatMessages').innerHTML = messagesHtml;

            const suggestedQuestions = [
                `Qual √® il concetto principale di ${study.name}?`,
                `Spiegami ${study.data.highlights[0]?.substring(0, 30) || 'il primo punto'}...`,
                `Fammi degli esempi pratici`,
                `Come posso ricordare meglio questi concetti?`,
                `Quali sono le domande pi√π comuni su questo argomento?`
            ];

            document.getElementById('suggestedQuestions').innerHTML = suggestedQuestions.map(q => 
                `<div class="suggested-question" onclick="sendSuggestedQuestion('${q.replace(/'/g, "\\'")}')">${q}</div>`
            ).join('');

            scrollChatToBottom();
        }

        function createChatMessageHTML(msg, id) {
            const isUser = msg.role === 'user';
            return `
                <div class="chat-message ${isUser ? 'user' : 'ai'}" id="${id}">
                    <div class="chat-avatar">${isUser ? 'üë§' : 'ü§ñ'}</div>
                    <div class="chat-bubble">${msg.content.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function sendSuggestedQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendChatMessage();
        }

        async function sendChatMessage() {
            const study = getCurrentStudy();
            if (!study || appState.isChatLoading) return;
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const userMessageId = `msg_${study.id}_${appState.chatHistory[study.id].length}`;
            appState.chatHistory[study.id].push({
                role: 'user',
                content: message
            });
            
            input.value = '';
            input.style.height = 'auto';
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += createChatMessageHTML({
                role: 'user',
                content: message
            }, userMessageId);
            
            messagesContainer.innerHTML += `
                <div class="chat-message ai" id="typingIndicator">
                    <div class="chat-avatar">ü§ñ</div>
                    <div class="chat-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            scrollChatToBottom();
            
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Invio...';
            appState.isChatLoading = true;
            
            try {
                const summaryShort = (study.data.summary_short || '').substring(0, 300);
                const highlightsText = (study.data.highlights || []).slice(0, 3).join('. ').substring(0, 200);
                const contentSnippet = study.fullText ? study.fullText.substring(0, 400) : '';
                
                const context = `Materia: ${study.subject}\nLezione: ${study.name}\n\nRiassunto: ${summaryShort}\n\nPunti chiave: ${highlightsText}\n\nEstratto: ${contentSnippet}`;
                
                const conversationHistory = appState.chatHistory[study.id]
                    .slice(0, -1)
                    .slice(-5)
                    .map(msg => ({
                        role: msg.role,
                        content: msg.content.substring(0, 500)
                    }));
                
                const fullMessage = `[CONTESTO]\n${context}\n\n[DOMANDA]\n${message}`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: fullMessage,
                        conversationHistory: conversationHistory
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Errore server: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.response;
                
                document.getElementById('typingIndicator').remove();
                
                const aiMessageId = `msg_${study.id}_${appState.chatHistory[study.id].length}`;
                appState.chatHistory[study.id].push({
                    role: 'assistant',
                    content: aiResponse
                });
                
                messagesContainer.innerHTML += createChatMessageHTML({
                    role: 'assistant',
                    content: aiResponse
                }, aiMessageId);
                
                saveChatHistory();
                scrollChatToBottom();
                
            } catch (error) {
                console.error('Errore chat:', error);
                
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();
                
                messagesContainer.innerHTML += `
                    <div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        ‚ùå Errore: ${error.message}. Riprova tra poco.
                    </div>
                `;
                
                appState.chatHistory[study.id].pop();
                
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Invia üì§';
                appState.isChatLoading = false;
                scrollChatToBottom();
            }
        }

        function scrollChatToBottom() {
            setTimeout(() => {
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, 100);
        }

        function clearChatHistory() {
            const study = getCurrentStudy();
            if (!study) return;
            
            if (confirm('Vuoi cancellare tutta la conversazione?')) {
                appState.chatHistory[study.id] = [];
                saveChatHistory();
                renderChat();
            }
        }

        function exportChatHistory() {
            const study = getCurrentStudy();
            if (!study) return;
            
            const chatHistory = appState.chatHistory[study.id] || [];
            
            if (chatHistory.length === 0) {
                alert('Non ci sono messaggi da esportare');
                return;
            }
            
            let exportText = `Chat AI - ${study.name}\n`;
            exportText += `Data: ${new Date().toLocaleDateString('it-IT')}\n`;
            exportText += `Materia: ${study.subject}\n\n`;
            exportText += '='.repeat(50) + '\n\n';
            
            chatHistory.forEach((msg, i) => {
                const role = msg.role === 'user' ? 'üë§ Tu' : 'ü§ñ AI';
                exportText += `${role}:\n${msg.content}\n\n`;
            });
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${study.name.replace(/[^a-z0-9]/gi, '_')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Chat esportata!');
        }

        function generateCustomSummary() {
            alert('üöß Funzione in sviluppo: Generazione riassunto personalizzato');
        }

        function generatePracticeProblems() {
            alert('üöß Funzione in sviluppo: Generazione esercizi pratici');
        }

        function generateStudyPlan() {
            alert('üöß Funzione in sviluppo: Generazione piano di studio');
        }

        function generateMnemonics() {
            alert('üöß Funzione in sviluppo: Generazione mnemotecniche');
        }

        function switchTab(tabName) {
            const study = getCurrentStudy();
            
            // Mark views as completed for progress tracking
            if (study) {
                if (tabName === 'highlights') study.highlightsViewed = true;
                if (tabName === 'quiz') addStudyTime(1);
                if (tabName === 'flashcards') addStudyTime(1);
                saveState();
                updateDashboard();
            }
            
            appState.currentTab = tabName;
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            event?.target.classList.add('active');
            
            if (tabName === 'library') {
                document.getElementById('libraryTab').classList.remove('hidden');
                renderLibrary();
            } else if (study) {
                document.getElementById(`${tabName}Tab`)?.classList.remove('hidden');
                
                if (tabName === 'flashcards') renderFlashcards();
                if (tabName === 'quiz') renderQuiz();
                if (tabName === 'chat') renderChat();
            }
        }

        function showMainApp() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateDashboard();
            renderLibrary();
        }

        function deleteStudy(studyId) {
            delete appState.studies[studyId];
            delete appState.chatHistory[studyId];
            
            if (appState.currentStudy === studyId) {
                appState.currentStudy = null;
            }
            
            saveState();
            
            if (Object.keys(appState.studies).length === 0) {
                resetApp();
            } else {
                updateDashboard();
                renderLibrary();
            }
        }

        let uploadedFile = null;

        function handleFileUpload(event) {
            uploadedFile = event.target.files[0];
            if (uploadedFile) {
                document.getElementById('analyzeBtn').disabled = false;
                if (!document.getElementById('studyName').value) {
                    document.getElementById('studyName').value = uploadedFile.name.replace(/\.[^/.]+$/, "");
                }
            }
        }

        async function analyzeDocument() {
            if (!uploadedFile) {
                alert('Carica un file prima!');
                return;
            }

            const studyName = document.getElementById('studyName').value.trim() || uploadedFile.name;
            const subject = document.getElementById('studySubject').value || 'Generale';

            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'üîÑ Analisi in corso...';

            try {
                let extractedText = '';

                if (uploadedFile.type === 'application/pdf') {
                    extractedText = await extractPDFText(uploadedFile);
                } else if (uploadedFile.type.startsWith('image/')) {
                    extractedText = `[Contenuto immagine: ${uploadedFile.name}]\n\nAnalisi visiva dell'immagine richiesta.`;
                } else {
                    extractedText = await uploadedFile.text();
                }

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: extractedText,
                        subject: subject,
                        filename: uploadedFile.name
                    })
                });

                if (!response.ok) {
                    throw new Error(`Errore server: ${response.status}`);
                }

                const analysisData = await response.json();

                const studyId = Date.now().toString();
                appState.studies[studyId] = {
                    id: studyId,
                    name: studyName,
                    subject: subject,
                    data: analysisData,
                    fullText: extractedText,
                    quizCompleted: false,
                    flashcardsReviewed: false,
                    summaryViewed: false,
                    highlightsViewed: false
                };

                appState.chatHistory[studyId] = [];
                appState.currentStudy = studyId;

                saveState();
                showMainApp();
                addStudyTime(5); // Add 5 minutes for uploading new material

                alert('‚úÖ Documento analizzato con successo!');

            } catch (error) {
                console.error('Errore durante l\'analisi:', error);
                alert('‚ùå Errore: ' + error.message);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'üöÄ Analizza Documento';
            }
        }

        async function extractPDFText(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }

                return fullText;
            } catch (error) {
                console.error('Errore estrazione PDF:', error);
                throw new Error('Impossibile leggere il PDF');
            }
        }

        function resetApp() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('pdfFile').value = '';
            uploadedFile = null;
        }

        // Initialize app
        loadState();
        updateDashboard();
        
        if (Object.keys(appState.studies).length > 0) {
            showMainApp();
            switchTab('library');
        } else if (!appState.tutorialShown) {
            // Show tutorial on first visit
            setTimeout(showTutorial, 1000);
        }
    </script>
</body>
</html>
