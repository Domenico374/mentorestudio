<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MentoreStudio ‚Äî Studio Intelligente</title>

  <!-- pdf.js (solo per lettura PDF lato client) -->
  <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    }
  </script>

  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --card:#111827;      /* gray-900  */
      --muted:#94a3b8;     /* slate-400 */
      --text:#e5e7eb;      /* gray-200  */
      --primary:#22d3ee;   /* cyan-400  */
      --accent:#a78bfa;    /* violet-400*/
      --danger:#ef4444;    /* red-500   */
      --ok:#22c55e;        /* green-500 */
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0; padding:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,Arial,sans-serif}
    a{color:var(--primary); text-decoration:none}
    .wrap{max-width:1080px; margin:0 auto; padding:24px}
    header{display:flex; align-items:center; gap:14px; margin-bottom:20px}
    .logo{width:42px; height:42px; border-radius:12px; background:linear-gradient(135deg,var(--primary),var(--accent)); box-shadow:var(--shadow)}
    h1{font-size:1.5rem; margin:0}
    .muted{color:var(--muted)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow)}
    .section{padding:22px}
    .grid{display:grid; gap:16px}
    .two{grid-template-columns: 1fr 1fr}
    .btn{background:linear-gradient(135deg,var(--primary),#06b6d4); color:#002b36; border:none; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer; box-shadow:var(--shadow)}
    .btn:hover{filter:brightness(1.05)}
    .btn-ghost{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.15)}
    .btn-delete{background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff}
    .btn-export{background:linear-gradient(135deg,#22c55e,#16a34a); color:#06240f}
    input[type="file"], input[type="text"]{
      width:100%; background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:12px; outline:none;
    }
    .hidden{display:none}
    nav.tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap}
    nav.tabs .tab{padding:10px 12px; border:1px solid rgba(255,255,255,.1); border-radius:10px; cursor:pointer}
    nav.tabs .tab.active{background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.25)}
    .study-item{display:flex; align-items:center; justify-content:space-between; gap:10px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.07); border-radius:14px; padding:14px; margin:10px 0; cursor:pointer}
    .study-item:hover{background:rgba(255,255,255,.05)}
    .study-left{display:flex; flex-direction:column; gap:4px}
    .study-right{display:flex; gap:8px}
    .study-info{color:var(--muted); font-size:.92rem}
    .search-box{margin:10px 0 4px 0}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); font-size:.85rem}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .content{min-height:260px}
    .kpi{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px}
    .kpi .box{background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px}
    .chat-wrap{display:flex; flex-direction:column; gap:10px}
    .chat-log{height:240px; overflow:auto; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px}
    .chat-msg{margin:6px 0}
    .chat-msg.me{color:#a7f3d0}
    .chat-input{display:flex; gap:8px}
    .footer{margin-top:24px; color:var(--muted); font-size:.9rem; text-align:center}
    @media (max-width:900px){ .two{grid-template-columns:1fr} .kpi{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <div>
        <h1>MentoreStudio</h1>
        <div class="muted">Dal PDF al ripasso: riassunti, flashcard, quiz e chat sul tuo materiale.</div>
      </div>
    </header>

    <!-- Sezione Upload -->
    <section id="uploadSection" class="card section">
      <h2>üìÇ Carica PDF</h2>
      <p class="muted">Carica uno o pi√π PDF. Verranno letti localmente nel browser.</p>
      <div class="grid two">
        <div>
          <input id="pdfFile" type="file" accept="application/pdf" multiple />
        </div>
        <div class="row">
          <button class="btn" onclick="handleUpload()">Analizza PDF</button>
          <button class="btn btn-ghost" onclick="demoSeed()">Inserisci demo</button>
        </div>
      </div>
      <div class="footer">Nessun dato inviato finch√© non configuri un backend per le funzioni AI.</div>
    </section>

    <!-- App principale -->
    <section id="mainApp" class="card section hidden">
      <div class="row" style="justify-content:space-between; margin-bottom:6px;">
        <h2 style="margin:0">üìö Libreria</h2>
        <div class="row">
          <span class="pill">Backend: <strong id="backendStatus">offline</strong></span>
          <button class="btn btn-ghost" onclick="resetApp()">Ôºã Carica altri PDF</button>
        </div>
      </div>
      <div id="contentArea" class="content"></div>
    </section>

    <div class="footer">Made with ‚ù§Ô∏è ‚Äî funziona su pagine statiche; abilita il backend per generazione AI.</div>
  </div>

  <script>
  // ==============================
  // STATO APP
  // ==============================
  const appState = {
    studies: {},   // id -> { id, name, date, subject, text, data: {...} }
    selectedId: null,
    counter: 1
  };

  // ==============================
  // UTIL
  // ==============================
  function todayStr(){
    const d=new Date();
    const p = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
  }

  function humanId(){
    return String(Date.now()) + "-" + (appState.counter++);
  }

  function setBackendStatus(online){
    document.getElementById('backendStatus').textContent = online ? 'online' : 'offline';
    document.getElementById('backendStatus').style.color = online ? '#22c55e' : '#f97316';
  }

  // Ping "gentile" al backend (opzionale). Non blocca nulla.
  (async function pingBackend(){
    try{
      const res = await fetch('/api/health', {method:'GET'});
      setBackendStatus(res.ok);
    }catch(e){
      setBackendStatus(false);
    }
  })();

  // ==============================
  // FALLBACK FETCH JSON (per /api/generate, /api/chat)
  // ==============================
  async function safeFetchJSON(url, payload){
    try{
      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload || {})
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }catch(err){
      console.warn('Endpoint non disponibile:', url, err);
      alert('‚ö†Ô∏è Funzione AI non disponibile: configura il backend per ' + url + '. Verr√† usato un contenuto segnaposto.');
      return {
        summary_short: '(N/D: backend non attivo)',
        summary_long: '(Contenuto di esempio ‚Äî attiva il backend per generare il riassunto completo.)',
        highlights: [],
        glossary: [],
        flashcards: [],
        quiz: []
      };
    }
  }

  async function generateContent(text, subject){
    // taglia il testo per non saturare eventuali proxy
    return await safeFetchJSON('/api/generate', {
      text: (text || '').slice(0, 8000),
      subject: subject || 'Generico'
    });
  }

  async function apiChat(message){
    return await safeFetchJSON('/api/chat', {
      message,
      conversationHistory: []
    });
  }

  // ==============================
  // LETTURA PDF
  // ==============================
  async function extractPDFText(file){
    const reader = new FileReader();
    return new Promise((resolve, reject) => {
      reader.onload = async (e) => {
        try{
          const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
          let text = '';
          const MAX_PAGES = Math.min(pdf.numPages, 100); // alzato da 20 a 100
          for(let i=1;i<=MAX_PAGES;i++){
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(x => x.str).join(' ') + '\n';
          }
          resolve(text);
        }catch(err){ reject(err); }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  // ==============================
  // UPLOAD HANDLER
  // ==============================
  async function handleUpload(){
    const input = document.getElementById('pdfFile');
    if(!input || !input.files || input.files.length===0){
      alert('Seleziona almeno un PDF.'); return;
    }

    // passa alla vista principale
    document.getElementById('uploadSection').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');

    // processa in sequenza i PDF
    for(const f of input.files){
      const id = humanId();
      const base = f.name.replace(/\.pdf$/i,'');
      const subject = guessSubjectFromName(base);

      let rawText = '';
      try{
        rawText = await extractPDFText(f);
      }catch(e){
        console.error('Errore estrazione PDF:', e);
        rawText = '';
      }

      // Contenuti AI (con fallback se backend non c'√®)
      const data = await generateContent(rawText, subject);

      appState.studies[id] = {
        id, name: base, date: todayStr(), subject,
        text: rawText,
        data: {
          summary_short: data.summary_short || '',
          summary_long: data.summary_long || '',
          highlights: data.highlights || [],
          glossary: data.glossary || [],
          flashcards: data.flashcards || [],
          quiz: data.quiz || []
        }
      };
    }

    renderLibrary();
  }

  function guessSubjectFromName(name){
    // euristica semplice sul nome file
    const s = name.toLowerCase();
    if(s.includes('agcom')) return 'AGCOM';
    if(s.includes('econom')||s.includes('market')) return 'Economia';
    if(s.includes('rete')||s.includes('network')) return 'Reti';
    if(s.includes('ai')||s.includes('gpt')||s.includes('machine')) return 'AI/ML';
    return 'Generico';
    }

  function demoSeed(){
    const id = humanId();
    appState.studies[id] = {
      id, name:'Esempio ‚Äî Tiny Shakespeare', date: todayStr(), subject:'Letteratura',
      text: 'To be, or not to be...',
      data:{
        summary_short:'Breve riassunto di esempio.',
        summary_long:'Questo √® un sommario dimostrativo. Abilita il backend per generare riassunti reali a partire dai tuoi PDF.',
        highlights:['Amleto: dubbio esistenziale','Monologo celebre'],
        glossary:[{term:'Soliloquio',def:'Discorso interiore pronunciato da un personaggio.'}],
        flashcards:[
          {q:'Chi √® il protagonista del monologo ‚ÄúTo be or not to be‚Äù?', a:'Amleto'},
          {q:'Cos‚Äô√® un soliloquio?', a:'Discorso interiore di un personaggio.'}
        ],
        quiz:[
          {q:'Il monologo tratta di‚Ä¶', choices:['Guerra','Dubbio esistenziale','Amore'], answer:1}
        ]
      }
    };
    document.getElementById('uploadSection').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    renderLibrary();
  }

  // ==============================
  // LIBRERIA
  // ==============================
  function renderLibrary(){
    let html = '<h2>üìö Le tue lezioni</h2>';
    html += '<input type="text" class="search-box" id="librarySearch" placeholder="üîç Cerca un termine in tutte le lezioni..." onkeyup="filterLibrary()">';

    const studies = Object.values(appState.studies).sort((a,b)=> b.id.localeCompare(a.id));

    if(studies.length===0){
      html += `
        <div style="text-align:center; padding:60px 20px;">
          <div style="font-size:4em; margin-bottom:20px;">üìö</div>
          <h3 style="color:var(--primary); margin-bottom:15px;">Nessuna lezione caricata</h3>
          <p class="muted" style="margin-bottom:20px;">La tua libreria √® vuota. Inizia caricando i tuoi PDF!</p>
          <button class="btn" onclick="resetApp()" style="font-size:1.05em; padding:14px 24px;">üìÇ Carica Nuovi PDF</button>
        </div>`;
    }else{
      studies.forEach(study=>{
        const searchData = [
          study.name.toLowerCase(),
          (study.data.highlights||[]).join(' ').toLowerCase(),
          (study.data.glossary||[]).map(g=>g.term.toLowerCase()).join(' ')
        ].join(' ');
        html += `
          <div class="study-item" onclick="selectStudy('${study.id}')" data-search="${searchData}">
            <div class="study-left">
              <strong>üìÑ ${escapeHtml(study.name)}</strong>
              <div class="study-info">üìÖ ${study.date} ‚Ä¢ üìö ${study.subject} ‚Ä¢ üé¥ ${study.data.flashcards?.length||0} flashcard ‚Ä¢ ‚ùì ${study.data.quiz?.length||0} quiz</div>
            </div>
            <div class="study-right">
              <button class="btn btn-export" onclick="exportStudyPDF('${study.id}', event)">üì• PDF</button>
              <button class="btn btn-delete" onclick="deleteStudy('${study.id}', event)">üóëÔ∏è</button>
            </div>
          </div>
        `;
      });

      html += `
        <div style="margin-top: 16px;">
          <button class="btn btn-ghost" onclick="resetApp()" style="width:100%;">Ôºã Carica Altri PDF</button>
        </div>`;
    }

    document.getElementById('contentArea').innerHTML = html;
  }

  function filterLibrary(){
    const q = (document.getElementById('librarySearch').value || '').toLowerCase();
    Array.from(document.querySelectorAll('.study-item')).forEach(el=>{
      const hay = (el.getAttribute('data-search')||'') + ' ' + el.innerText.toLowerCase();
      el.style.display = hay.includes(q) ? '' : 'none';
    });
  }

  function selectStudy(id){
    appState.selectedId = id;
    renderStudyDetail();
  }

  function deleteStudy(id, ev){
    ev?.stopPropagation();
    if(confirm('Eliminare questa lezione dalla libreria?')){
      delete appState.studies[id];
      if(appState.selectedId===id) appState.selectedId = null;
      renderLibrary();
    }
  }

  function exportStudyPDF(id, ev){
    ev?.stopPropagation();
    const s = appState.studies[id];
    if(!s){ alert('Lezione non trovata'); return; }

    // Semplice ‚Äústampa‚Äù in una finestra (puoi sostituire con jsPDF se preferisci)
    const w = window.open('', '_blank');
    w.document.write(`
      <html><head><title>${escapeHtml(s.name)} ‚Äî Export</title></head>
      <body>
        <h1>${escapeHtml(s.name)}</h1>
        <p><strong>Data:</strong> ${s.date} ‚Äî <strong>Materia:</strong> ${s.subject}</p>
        <h2>Riassunto</h2>
        <p>${escapeHtml(s.data.summary_long||s.data.summary_short||'(N/D)')}</p>
        <h2>Highlights</h2>
        <ul>${(s.data.highlights||[]).map(h=>'<li>'+escapeHtml(h)+'</li>').join('')}</ul>
        <h2>Glossario</h2>
        <ul>${(s.data.glossary||[]).map(g=>'<li><strong>'+escapeHtml(g.term)+'</strong>: '+escapeHtml(g.def||'')+'</li>').join('')}</ul>
        <h2>Flashcards</h2>
        <ul>${(s.data.flashcards||[]).map(f=>'<li><strong>Q:</strong> '+escapeHtml(f.q)+'<br/><strong>A:</strong> '+escapeHtml(f.a)+'</li>').join('')}</ul>
        <h2>Quiz</h2>
        <ol>${(s.data.quiz||[]).map(q=>{
          const ch = (q.choices||[]).map((c,i)=> (i===q.answer? '‚úÖ ':'')+escapeHtml(c)).join(' | ');
          return '<li>'+escapeHtml(q.q)+'<br/><small>'+ch+'</small></li>';
        }).join('')}</ol>
        <hr/>
        <small>Generato con MentoreStudio</small>
        <script>window.print();</script>
      </body></html>
    `);
    w.document.close();
  }

  // ==============================
  // DETTAGLIO LEZIONE
  // ==============================
  function renderStudyDetail(){
    const s = appState.studies[appState.selectedId];
    if(!s){ renderLibrary(); return; }

    let html = `
      <div class="row" style="justify-content:space-between; margin-bottom:8px;">
        <div>
          <h2 style="margin:0">üìÑ ${escapeHtml(s.name)}</h2>
          <div class="muted">${s.date} ‚Ä¢ ${s.subject}</div>
        </div>
        <div class="row">
          <button class="btn btn-export" onclick="exportStudyPDF('${s.id}')">üì• Esporta</button>
          <button class="btn btn-delete" onclick="deleteStudy('${s.id}')">üóëÔ∏è Elimina</button>
        </div>
      </div>

      <nav class="tabs">
        <div class="tab active" id="tab-overview" onclick="switchTab('overview')">Overview</div>
        <div class="tab" id="tab-chat" onclick="switchTab('chat')">Chat</div>
        <div class="tab" id="tab-flash" onclick="switchTab('flashcards')">Flashcards</div>
        <div class="tab" id="tab-quiz" onclick="switchTab('quiz')">Quiz</div>
        <div class="tab" id="tab-text" onclick="switchTab('text')">Testo</div>
      </nav>

      <div id="panel-overview">
        <div class="kpi" style="margin-bottom:14px;">
          <div class="box"><div class="muted">Flashcards</div><div style="font-size:1.6rem;">${s.data.flashcards?.length||0}</div></div>
          <div class="box"><div class="muted">Domande Quiz</div><div style="font-size:1.6rem;">${s.data.quiz?.length||0}</div></div>
          <div class="box"><div class="muted">Parole (estratte)</div><div style="font-size:1.6rem;">${(s.text||'').split(/\s+/).filter(Boolean).length}</div></div>
          <div class="box"><div class="muted">Backend</div><div style="font-size:1.2rem;" id="kpi-backend">‚Äî</div></div>
        </div>
        <h3>Riassunto</h3>
        <p>${escapeHtml(s.data.summary_long||s.data.summary_short||'(N/D)')}</p>
        <h3>Highlights</h3>
        <ul>${(s.data.highlights||[]).map(h=>'<li>'+escapeHtml(h)+'</li>').join('') || '<li class="muted">(N/D)</li>'}</ul>
        <h3>Glossario</h3>
        <ul>${(s.data.glossary||[]).map(g=>'<li><strong>'+escapeHtml(g.term)+'</strong>: '+escapeHtml(g.def||'')+'</li>').join('') || '<li class="muted">(N/D)</li>'}</ul>
      </div>

      <div id="panel-chat" class="hidden">
        <div class="chat-wrap">
          <div id="chatLog" class="chat-log"></div>
          <div class="chat-input">
            <input id="chatInput" type="text" placeholder="Fai una domanda sulla lezione‚Ä¶" />
            <button class="btn" onclick="sendChat()">Invia</button>
          </div>
        </div>
      </div>

      <div id="panel-flash" class="hidden">
        <h3>Flashcards</h3>
        <div id="flashList">
          ${(s.data.flashcards||[]).map((f,i)=>`
            <div class="card section" style="margin:10px 0;">
              <div><strong>Q${i+1}.</strong> ${escapeHtml(f.q)}</div>
              <details style="margin-top:6px;"><summary>Mostra risposta</summary><div style="margin-top:6px;">${escapeHtml(f.a)}</div></details>
            </div>
          `).join('') || '<p class="muted">(N/D)</p>'}
        </div>
      </div>

      <div id="panel-quiz" class="hidden">
        <h3>Quiz</h3>
        <div id="quizList">
          ${(s.data.quiz||[]).map((q,i)=>`
            <div class="card section" style="margin:10px 0;">
              <div><strong>Q${i+1}.</strong> ${escapeHtml(q.q)}</div>
              <div style="margin-top:8px;">
                ${(q.choices||[]).map((c,idx)=>`
                  <label style="display:block; margin:4px 0;">
                    <input type="radio" name="q${i}" value="${idx}" /> ${escapeHtml(c)}
                  </label>
                `).join('')}
              </div>
              <button class="btn btn-ghost" style="margin-top:8px;" onclick="checkQuiz(${i})">Verifica</button>
              <div id="quizResult${i}" class="muted" style="margin-top:6px;"></div>
            </div>
          `).join('') || '<p class="muted">(N/D)</p>'}
        </div>
      </div>

      <div id="panel-text" class="hidden">
        <h3>Testo estratto</h3>
        <div class="card section" style="white-space:pre-wrap; max-height:420px; overflow:auto;">${escapeHtml((s.text||'').slice(0,200000) || '(N/D)')}</div>
      </div>
    `;

    document.getElementById('contentArea').innerHTML = html;
    document.getElementById('kpi-backend').textContent =
      (document.getElementById('backendStatus').textContent==='online'?'Online':'Offline');
  }

  function switchTab(name){
    const tabs = ['overview','chat','flash','quiz','text'];
    tabs.forEach(t=>{
      document.getElementById('tab-'+t)?.classList.remove('active');
      document.getElementById('panel-'+t)?.classList.add('hidden');
    });
    document.getElementById('tab-'+name)?.classList.add('active');
    document.getElementById('panel-'+name)?.classList.remove('hidden');
  }

  function checkQuiz(i){
    const s = appState.studies[appState.selectedId];
    if(!s) return;
    const q = (s.data.quiz||[])[i];
    if(!q) return;
    const chosen = document.querySelector(`input[name="q${i}"]:checked`);
    const el = document.getElementById(`quizResult${i}`);
    if(!chosen){ el.textContent='Seleziona una risposta.'; return; }
    const ok = Number(chosen.value) === Number(q.answer);
    el.textContent = ok ? 'Corretto ‚úÖ' : 'Risposta errata ‚ùå';
    el.style.color = ok ? '#22c55e' : '#ef4444';
  }

  // ==============================
  // CHAT (stub con backend-fallback)
  // ==============================
  async function sendChat(){
    const input = document.getElementById('chatInput');
    const log = document.getElementById('chatLog');
    const msg = (input.value||'').trim();
    if(!msg) return;
    const s = appState.studies[appState.selectedId];
    if(!s) return;

    log.appendChild(renderMsg('me', msg));
    input.value = '';

    const res = await apiChat(`Contesto: ${s.name} ‚Äî ${s.subject}\nDomanda: ${msg}`);
    const answer = res.answer || res.summary_short || '(N/D: backend non attivo)';
    log.appendChild(renderMsg('bot', answer));
    log.scrollTop = log.scrollHeight;
  }

  function renderMsg(role, text){
    const div = document.createElement('div');
    div.className = 'chat-msg '+(role==='me'?'me':'');
    div.textContent = (role==='me'?'Tu: ':'Mentore: ')+ text;
    return div;
  }

  // ==============================
  // MISC
  // ==============================
  function resetApp(){
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('uploadSection').classList.remove('hidden');
    const input = document.getElementById('pdfFile');
    if(input) input.value = '';
    document.getElementById('contentArea').innerHTML = '';
  }

  function escapeHtml(s=''){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // bootstrap view
  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('uploadSection').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
  });
  </script>
</body>
</html>
