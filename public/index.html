<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MentoreStudio - Il tuo mentore personale per lo studio intelligente">
    <title>üìö MentoreStudio - Studia Intelligente</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

   <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #4caf50;
            --danger: #f44336;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        body.dark-mode { background: #0f0f1e; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .header { background: #2a2a3e; color: #e0e0e0; }
        
        /* LOGO DEL GUFO */
        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .owl-logo {
            font-size: 2.5em;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        h1 { font-size: 1.8em; color: var(--primary); margin: 0; }
        body.dark-mode h1 { color: var(--accent); }
        
        .header-controls { display: flex; gap: 10px; }
        .toggle-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        body.dark-mode .upload-section { background: #2a2a3e; color: #e0e0e0; }
        input[type="file"], input[type="text"] {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
        }
        body.dark-mode input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .subject-select {
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            font-size: 1em;
        }
        body.dark-mode .subject-select { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-delete { background: var(--danger); padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .btn-export { background: #2196F3; padding: 8px 15px; margin: 0; font-size: 0.9em; }
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: white;
            color: var(--primary);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        body.dark-mode .tab-btn { background: #2a2a3e; color: #e0e0e0; }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }
        .hidden { display: none !important; }
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.dark-mode .card { background: #2a2a3e; color: #e0e0e0; }
        .study-item {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        body.dark-mode .study-item { background: #2a2a3e; color: #e0e0e0; }
        .study-item:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .study-left { flex: 1; }
        .study-right { display: flex; gap: 10px; }
        .study-info { font-size: 0.85em; color: #999; margin-top: 5px; }
        .search-box {
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 100%;
            font-size: 1em;
        }
        body.dark-mode .search-box { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .flashcard-container {
            perspective: 1000px;
            min-height: 400px;
            margin: 20px 0;
        }
        .flashcard {
            width: 100%;
            height: 400px;
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.2em;
            line-height: 1.6;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .flashcard-front { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .flashcard-back { background: white; color: #333; transform: rotateY(180deg); }
        body.dark-mode .flashcard-back { background: #2a2a3e; color: #e0e0e0; }
        .flashcard-extra {
            margin-top: 20px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            text-align: left;
            max-width: 90%;
        }
        .flashcard-extra-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary);
        }
        body.dark-mode .flashcard-extra { background: rgba(240, 147, 251, 0.1); }
        body.dark-mode .flashcard-extra-title { color: var(--accent); }
        .expand-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            margin: 5px;
            transition: all 0.3s;
        }
        .expand-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        .controls { display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
        .quiz-option { 
            background: #f5f7ff; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: all 0.3s;
        }
        body.dark-mode .quiz-option { background: #1a1a2e; }
        .quiz-option:hover { background: #e8eaff; transform: translateX(5px); }
        .quiz-option.selected { border-color: var(--primary); background: #e8eaff; }
        .quiz-option.correct { border-color: var(--success); background: #c8e6c9; }
        .quiz-option.incorrect { border-color: var(--danger); background: #ffcdd2; }
        .timer-display {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 10px;
            margin: 20px 0;
        }
        .timer-display.warning {
            background: linear-gradient(135deg, #ffa726, #fb8c00);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .note-section { background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ffc107; }
        body.dark-mode .note-section { background: #3d3d1a; color: #e0e0e0; }
        .note-input { width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9em; }
        body.dark-mode .note-input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .key-concept { 
            display: inline-block; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px; 
            margin: 3px; 
            font-size: 0.95em;
            font-weight: 600;
        }
        
        /* BOTTONE "TORNA ALLA HOME" */
        .back-to-home-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .back-to-home-btn:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        body.dark-mode .back-to-home-btn { background: var(--secondary); }
        
        .review-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
        .review-item.wrong { border-left-color: var(--danger); background: #ffebee; }
        .review-item.correct { border-left-color: var(--success); background: #e8f5e9; }

        .highlight-item {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .highlight-item { background: #1a1a2e; }
        .highlight-item:hover { transform: translateX(5px); background: #e8eaff; }
        body.dark-mode .highlight-item:hover { background: #2a2a3e; }
        .highlight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        .highlight-title {
            flex: 1;
            font-weight: 600;
            line-height: 1.6;
        }
        .highlight-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        .highlight-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(102, 126, 234, 0.2);
            color: #555;
            line-height: 1.8;
            display: none;
        }
        body.dark-mode .highlight-details { color: #bbb; border-top-color: rgba(240, 147, 251, 0.2); }
        .generate-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* CHAT STYLES */
        .chat-container { display: flex; flex-direction: column; height: 600px; max-height: 70vh; }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        body.dark-mode .chat-messages { background: #1a1a2e; }
        .chat-message { display: flex; gap: 10px; animation: slideIn 0.3s ease; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.user { flex-direction: row-reverse; }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }
        .chat-message.user .chat-avatar { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .chat-message.ai .chat-avatar { background: linear-gradient(135deg, var(--accent), #f5576c); color: white; }
        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-bottom-right-radius: 5px;
        }
        .chat-message.ai .chat-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        body.dark-mode .chat-message.ai .chat-bubble { background: #2a2a3e; color: #e0e0e0; }
        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        body.dark-mode .chat-input-container { background: #2a2a3e; }
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1em;
            resize: none;
            font-family: inherit;
        }
        body.dark-mode .chat-input { background: #1a1a2e; color: #e0e0e0; border-color: var(--secondary); }
        .chat-send-btn {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .chat-send-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .chat-send-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .chat-suggested-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        .suggested-question {
            padding: 8px 15px;
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid var(--primary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        body.dark-mode .suggested-question { background: rgba(240, 147, 251, 0.1); border-color: var(--accent); }
        .suggested-question:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .glossary-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
        body.dark-mode .glossary-item { background: #1a1a2e; }
        .glossary-term {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--primary);
            margin-bottom: 8px;
        }
        body.dark-mode .glossary-term { color: var(--accent); }
        
        .timeline-item {
            position: relative;
            padding-left: 40px;
            margin: 20px 0;
        }
        .timeline-item::before {
            content: '‚óè';
            position: absolute;
            left: 0;
            top: 0;
            color: var(--primary);
            font-size: 1.5em;
        }
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 8px;
            top: 25px;
            width: 2px;
            height: calc(100% + 20px);
            background: var(--primary);
        }
        .timeline-item:last-child::after { display: none; }
        .timeline-date {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        body.dark-mode .timeline-date { color: var(--accent); }
        
        .template-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .template-card { background: #2a2a3e; }
        .template-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .template-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .template-description {
            color: #666;
            font-size: 0.9em;
        }
        body.dark-mode .template-description { color: #aaa; }
        
        .result-box {
            background: #f5f7ff;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1.05em;
        }
        body.dark-mode .result-box { background: #1a1a2e; color: #e0e0e0; }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .history-item {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid var(--secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .history-item { background: #1a1a2e; }
        .history-item:hover { transform: translateX(5px); background: #e8eaff; }
        body.dark-mode .history-item:hover { background: #2a2a3e; }
        .history-meta {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
        }

        /* MINDMAP STYLES */
        .mindmap-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
        }
        body.dark-mode .mindmap-container { background: #1a1a2e; }
        .mindmap-tree {
            font-family: 'Courier New', monospace;
            line-height: 2;
            font-size: 1.05em;
        }
        .mindmap-node {
            margin-left: 20px;
            padding: 5px 0;
        }
        .mindmap-root {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
        }
        body.dark-mode .mindmap-root { color: var(--accent); }
        .mindmap-branch {
            color: var(--secondary);
            font-weight: 600;
        }
        body.dark-mode .mindmap-branch { color: #f093fb; }
        .mindmap-leaf {
            color: #555;
        }
        body.dark-mode .mindmap-leaf { color: #aaa; }

        /* ===== NEW DESIGN: 2X2 CARD SYSTEM ===== */
        :root {
            --comprendi-color: #10B981;
            --comprendi-bg: #D1FAE5;
            --memorizza-color: #3B82F6;
            --memorizza-bg: #DBEAFE;
            --approfondisci-color: #6366F1;
            --approfondisci-bg: #E0E7FF;
            --personalizza-color: #F97316;
            --personalizza-bg: #FFEDD5;
        }

        .new-home-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .new-home-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .new-home-header h2 {
            font-size: 2.2em;
            color: #1f2937;
            margin-bottom: 10px;
            font-weight: 700;
        }

        body.dark-mode .new-home-header h2 {
            color: #e0e0e0;
        }

        .new-home-header p {
            font-size: 1.1em;
            color: #6b7280;
        }

        body.dark-mode .new-home-header p {
            color: #9ca3af;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        @media (max-width: 1100px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        .function-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border-left: 4px solid;
        }

        body.dark-mode .function-card {
            background: #2a2a3e;
        }

        .function-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .function-card.comprendi {
            background-color: var(--comprendi-bg);
            border-left-color: var(--comprendi-color);
        }

        body.dark-mode .function-card.comprendi {
            background-color: rgba(16, 185, 129, 0.1);
        }

        .function-card.memorizza {
            background-color: var(--memorizza-bg);
            border-left-color: var(--memorizza-color);
        }

        body.dark-mode .function-card.memorizza {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .function-card.approfondisci {
            background-color: var(--approfondisci-bg);
            border-left-color: var(--approfondisci-color);
        }

        body.dark-mode .function-card.approfondisci {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .function-card.personalizza {
            background-color: var(--personalizza-bg);
            border-left-color: var(--personalizza-color);
        }

        body.dark-mode .function-card.personalizza {
            background-color: rgba(249, 115, 22, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .comprendi .card-icon {
            background-color: rgba(16, 185, 129, 0.15);
        }

        .memorizza .card-icon {
            background-color: rgba(59, 130, 246, 0.15);
        }

        .approfondisci .card-icon {
            background-color: rgba(99, 102, 241, 0.15);
        }

        .personalizza .card-icon {
            background-color: rgba(249, 115, 22, 0.15);
        }

        .card-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        body.dark-mode .card-title {
            color: #e0e0e0;
        }

        .card-description {
            font-size: 0.95em;
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        body.dark-mode .card-description {
            color: #9ca3af;
        }

        .card-divider {
            height: 1px;
            background: rgba(0,0,0,0.08);
            margin: 20px 0;
        }

        body.dark-mode .card-divider {
            background: rgba(255,255,255,0.1);
        }

        .card-functions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .function-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: rgba(255,255,255,0.5);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1em;
            text-align: left;
        }

        body.dark-mode .function-item {
            background: rgba(255,255,255,0.05);
            color: #e0e0e0;
        }

        .function-item:hover {
            background: rgba(255,255,255,0.8);
            transform: translateX(4px);
        }

        body.dark-mode .function-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .function-icon {
            font-size: 1.2em;
            margin-right: 10px;
        }

        .function-name {
            flex: 1;
            font-weight: 600;
        }

        .function-arrow {
            font-size: 1.2em;
            transition: transform 0.2s;
        }

        .function-item:hover .function-arrow {
            transform: translateX(4px);
        }

        .card-footer {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(0,0,0,0.08);
        }

        body.dark-mode .card-footer {
            border-top-color: rgba(255,255,255,0.1);
        }

        .card-footer-text {
            font-size: 0.85em;
            color: #9ca3af;
            font-weight: 500;
        }

        body.dark-mode .card-footer-text {
            color: #6b7280;
        }

        /* Back to home button in card system */
        .back-to-home-simple {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .back-to-home-simple:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(-5px);
        }

        body.dark-mode .back-to-home-simple {
            background: rgba(42, 42, 62, 0.8);
            border-color: rgba(240, 147, 251, 0.3);
        }

        body.dark-mode .back-to-home-simple:hover {
            background: rgba(42, 42, 62, 1);
            border-color: rgba(240, 147, 251, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logo">
                <div class="owl-logo">ü¶â</div>
                <h1>MentoreStudio</h1>
            </div>
            <div class="header-controls">
                <button class="toggle-btn" onclick="toggleDarkMode()">üåô</button>
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <h2>üöÄ Carica i tuoi PDF</h2>
            <p style="margin-bottom: 15px; color: #666;">Puoi caricare pi√π PDF contemporaneamente</p>
            
            <div style="max-width: 500px; margin: 30px auto;">
                <label style="font-weight: bold; margin-bottom: 10px; display: block;">üìö Materia:</label>
                <select id="subjectSelect" class="subject-select">
                    <option value="Generale">Generale</option>
                    <option value="Storia">Storia</option>
                    <option value="Matematica">Matematica</option>
                    <option value="Biologia">Biologia</option>
                    <option value="Diritto">Diritto</option>
                </select>
                <input type="file" id="pdfFile" accept=".pdf" multiple>
                <button class="btn" onclick="loadMultiplePDFs()" style="width: 100%;">üìÇ Carica PDF</button>
            </div>
            
            <p style="font-size: 0.9em; margin-top: 20px; color: #666;">Tutto salvato offline ‚Ä¢ Nessuna chiave API visibile</p>
        </div>

        <div id="mainApp" class="hidden">

            <!-- NEW: Home Screen with 4 Cards -->
            <div id="newHomeScreen" class="new-home-container">
                <div class="new-home-header">
                    <h2>Scegli come studiare</h2>
                    <p>Seleziona una categoria per iniziare</p>
                </div>
                
                <div class="cards-grid">
                    <!-- Card 1: Comprendi -->
                    <div class="function-card comprendi">
                        <div class="card-header">
                            <div class="card-icon">üìö</div>
                            <h3 class="card-title">Comprendi</h3>
                        </div>
                        <p class="card-description">Analizza e comprendi i contenuti della lezione</p>
                        <div class="card-divider"></div>
                        <div class="card-functions">
                            <button class="function-item" onclick="navigateToFunction('summary')">
                                <span class="function-icon">üìù</span>
                                <span class="function-name">Riassunto</span>
                                <span class="function-arrow">‚Üí</span>
                            </button>
                            <button class="function-item" onclick="navigateToFunction('highlights')">
                                <span class="function-icon">‚≠ê</span>
                                <span class="function-name">Punti Salienti</span>
                                <span class="function-arrow">‚Üí</span>
                            </button>
                            <button class="function-item" onclick="navigateToFunction('glossary')">
                                <span class="function-icon">üìñ</span>
                                <span class="function-name">Glossario</span>
                                <span class="function-arrow">‚Üí</span>
                            </button>
                            <button class="function-item" onclick="navigateToFunction('timeline')">
                                <span class="function-icon">üìÖ</span>
                                <span class="function-name">Timeline</span>
                                <span class="function-arrow">‚Üí</span>
                            </button>
                        </div>
                        <div class="card-footer">
                            <span class="card-footer-text">4 strumenti disponibili</span>
                        </div>
                    </div>

                    <!-- Card 2: Memorizza -->
                    <div class="function-card memorizza">
                        <div class="card-header">
                            <div class="card-icon">üß†</div>
                            <h3 class="card-title">Memorizza</h3>
                        </div>
                        <p class="card-description">Consolida le conoscenze con strumenti di memorizzazione</p>
                        <div class="card-divider"></div>
                        <div class="card-functions">
                            <button class="function-item" onclick="navigateToFunction('flashcards')">
                                <span class="function-icon">üé¥</span>
                                <span class="function-name">Flashcard</span>
                                <span class="function-arrow">‚Üí</span>
                            </button>
                            <button class="function-item" onclick="navigateToFunction('quiz')">
                                <span class="function-icon">‚ùì</span>
                                <span class="function-name">Quiz</span>
                                <span class="function-arrow">‚Üí</span>
                            </button>
                            <button class="function-item" onclick="navigateToFunction('mindmap')">
                                <span class="function-icon">üß†</span>
                                <span class="function-name">Mappa Mentale</span>
                                <span class="function-arrow">‚Üí</span>
                            </button>
                        </div>
                        <div class="card-footer">
                            <span class="card-footer-text">3 strumenti disponibili</span>
                        </div>
                    </div>

                    <!-- Card 3: Approfondisci -->
                    <div class="function-card approfondisci">
                        <div class="card-header">
                            <div class="card-icon">ü§ñ</div>
                            <h3 class="card-title">Approfondisci</h3>
                        </div>
                        <p class="card-description">Esplora i concetti in profondit√† con l'AI</p>
                        <div class="card-divider"></div>
                        <div class="card-functions">
                            <button class="function-item" onclick="navigateToFunction('chat')">
                                <span class="function-icon">üí¨</span>
                                <span class="function-name">Chat AI</span>
                                <span class="function-arrow">‚Üí</span>
                            </button>
                            <button class="function-item" onclick="navigateToFunction('studyguide')">
                                <span class="function-icon">üìò</span>
                                <span class="function-name">Guida di Studio</span>
                                <span class="function-arrow">‚Üí</span>
                            </button>
                            <button class="function-item" onclick="navigateToFunction('conceptanalysis')">
                                <span class="function-icon">üîç</span>
                                <span class="function-name">Analisi Concetto</span>
                                <span class="function-arrow">‚Üí</span>
                            </button>
                        </div>
                        <div class="card-footer">
                            <span class="card-footer-text">3 strumenti disponibili</span>
                        </div>
                    </div>

                    <!-- Card 4: Personalizza -->
                    <div class="function-card personalizza">
                        <div class="card-header">
                            <div class="card-icon">‚ú®</div>
                            <h3 class="card-title">Personalizza</h3>
                        </div>
                        <p class="card-description">Crea materiali di studio nel formato che preferisci</p>
                        <div class="card-divider"></div>
                        <div class="card-functions">
                            <button class="function-item" onclick="navigateToFunction('customformat')">
                                <span class="function-icon">üé®</span>
                                <span class="function-name">Crea il Tuo Formato</span>
                                <span class="function-arrow">‚Üí</span>
                            </button>
                        </div>
                        <div class="card-footer">
                            <span class="card-footer-text">1 strumento disponibile</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area (shown when function is selected) -->
            <div id="functionContentArea" class="hidden">
                <button class="back-to-home-btn" onclick="backToHome()">
                    <span>‚Üê</span>
                    <span>Torna alla Home</span>
                </button>
                <div id="contentArea"></div>
            </div>
        </div>
    </div>

    <script>
        let appState = {
            studies: JSON.parse(localStorage.getItem('mentorestudio_studies')) || {},
            currentStudyId: null,
            currentFlashcard: 0,
            currentFlashcardFiltered: 0,
            flashcardMode: 'all',
            currentQuiz: 0,
            currentQuizFiltered: 0,
            quizMode: 'all',
            quizScore: 0,
            quizAnswers: [],
            quizTimerEnabled: false,
            quizTimeRemaining: 0,
            quizTimerId: null,
            notes: JSON.parse(localStorage.getItem('flashcardNotes')) || {},
            darkMode: localStorage.getItem('darkMode') === 'true',
            chatHistory: JSON.parse(localStorage.getItem('chatHistory')) || {},
            isChatLoading: false
        };

        let flashcardStats = JSON.parse(localStorage.getItem('flashcardStats')) || {};
        let customFormatHistory = JSON.parse(localStorage.getItem('customFormatHistory')) || [];

        function toggleDarkMode() {
            appState.darkMode = !appState.darkMode;
            document.body.classList.toggle('dark-mode', appState.darkMode);
            localStorage.setItem('darkMode', appState.darkMode);
        }

        if (appState.darkMode) {
            document.body.classList.add('dark-mode');
        }

        // ===== NAVIGAZIONE DIRETTA =====
        function navigateToFunction(functionName) {
            // Nascondi la home
            document.getElementById('newHomeScreen').classList.add('hidden');
            // Mostra il content area con il bottone "Torna alla Home"
            document.getElementById('functionContentArea').classList.remove('hidden');
            
            // Chiama direttamente la funzione di rendering senza mostrare i tab
            const functionMap = {
                'summary': renderSummary,
                'highlights': renderHighlights,
                'glossary': renderGlossary,
                'timeline': renderTimeline,
                'flashcards': renderFlashcardsAdvanced,
                'quiz': renderQuizAdvanced,
                'mindmap': renderMindMap,
                'chat': renderChat,
                'studyguide': renderStudyGuide,
                'conceptanalysis': renderConceptAnalysis,
                'customformat': renderCustomFormat
            };
            
            if (functionMap[functionName]) {
                functionMap[functionName]();
            }
        }

        function backToHome() {
            document.getElementById('newHomeScreen').classList.remove('hidden');
            document.getElementById('functionContentArea').classList.add('hidden');
        }

        // ===== PDF LOADING =====
        async function loadMultiplePDFs() {
            const files = document.getElementById('pdfFile').files;
            if (!files.length) { alert('Seleziona almeno un PDF'); return; }

            for (let file of files) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + '\n\n';
                    }

                    const subject = document.getElementById('subjectSelect').value;
                    const studyId = Date.now();
                    const processedData = await analyzeTextWithAI(text);

                    appState.studies[studyId] = {
                        id: studyId,
                        name: file.name.replace('.pdf', ''),
                        date: new Date().toLocaleDateString('it-IT'),
                        type: 'PDF',
                        subject: subject,
                        data: processedData,
                        rawText: text
                    };

                    saveStudies();
                } catch (error) {
                    console.error('Errore caricamento PDF:', error);
                    alert('Errore nel caricamento del PDF: ' + file.name);
                }
            }

            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('newHomeScreen').classList.remove('hidden');
        }

        async function analyzeTextWithAI(text) {
            try {
                const response = await fetch('/api/analyze-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                if (!response.ok) throw new Error('Errore API');
                return await response.json();
            } catch (error) {
                console.error('Errore analisi:', error);
                return generateBasicAnalysis(text);
            }
        }

        function generateBasicAnalysis(text) {
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 20);
            const words = text.split(/\s+/).filter(w => w.length > 5);
            
            return {
                summary_short: sentences.slice(0, 3).join('. ') + '.',
                summary_long: sentences.slice(0, 10).join('. ') + '.',
                highlights: sentences.slice(0, 5),
                glossary: [...new Set(words.slice(0, 10))].map(term => ({
                    term: term,
                    definition: `Termine chiave trovato nel testo: ${term}`
                })),
                flashcards: sentences.slice(0, 8).map((s, i) => ({
                    q: `Domanda ${i + 1}`,
                    a: s.trim()
                })),
                quiz: sentences.slice(0, 5).map((s, i) => ({
                    q: `Domanda ${i + 1}?`,
                    options: [`Opzione A`, `Opzione B`, `Opzione C`, `Opzione D`],
                    correct: 0
                })),
                timeline: [],
                mindmap: { root: 'Documento', branches: [] }
            };
        }

        function saveStudies() {
            localStorage.setItem('mentorestudio_studies', JSON.stringify(appState.studies));
        }

        function getCurrentStudy() {
            if (!appState.currentStudyId) {
                const firstStudy = Object.values(appState.studies)[0];
                if (firstStudy) appState.currentStudyId = firstStudy.id;
            }
            return appState.studies[appState.currentStudyId];
        }

        // ===== RENDER FUNCTIONS =====
        function renderSummary() {
            const study = getCurrentStudy();
            if (!study) { document.getElementById('contentArea').innerHTML = '<p>Nessuno studio selezionato</p>'; return; }

            let html = `
                <div class="card">
                    <h2>üìù Riassunto Breve</h2>
                    <div class="result-box">${study.data.summary_short || 'Nessun riassunto disponibile'}</div>
                </div>
                <div class="card">
                    <h2>üìñ Riassunto Completo</h2>
                    <div class="result-box">${study.data.summary_long || 'Nessun riassunto disponibile'}</div>
                </div>
            `;
            document.getElementById('contentArea').innerHTML = html;
        }

        function renderHighlights() {
            const study = getCurrentStudy();
            if (!study) { document.getElementById('contentArea').innerHTML = '<p>Nessuno studio selezionato</p>'; return; }

            let html = '<div class="card"><h2>‚≠ê Punti Salienti</h2>';
            
            if (!study.data.highlights || study.data.highlights.length === 0) {
                html += '<p>Nessun punto saliente disponibile</p>';
            } else {
                study.data.highlights.forEach((highlight, index) => {
                    html += `
                        <div class="highlight-item" onclick="toggleHighlightDetails(${index})">
                            <div class="highlight-header">
                                <div class="highlight-title">${highlight}</div>
                                <div class="highlight-icon" id="icon-${index}">‚ñº</div>
                            </div>
                            <div class="highlight-details" id="details-${index}">
                                <strong>üí° Perch√© √® importante:</strong><br>
                                Questo punto √® fondamentale per la comprensione del topic.
                                <button class="generate-btn" onclick="generateHighlightExplanation(${index}, event)">ü§ñ Genera Spiegazione AI</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        function toggleHighlightDetails(index) {
            const details = document.getElementById(`details-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            
            if (details.style.display === 'block') {
                details.style.display = 'none';
                icon.textContent = '‚ñº';
            } else {
                details.style.display = 'block';
                icon.textContent = '‚ñ≤';
            }
        }

        async function generateHighlightExplanation(index, event) {
            event.stopPropagation();
            const study = getCurrentStudy();
            const highlight = study.data.highlights[index];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generazione...';
            
            try {
                const prompt = `Spiega perch√© questo punto √® importante per lo studio:\n\n"${highlight}"\n\nFornisci una spiegazione dettagliata (3-4 frasi).`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore generazione');
                
                const data = await response.json();
                const detailsDiv = document.getElementById(`details-${index}`);
                detailsDiv.innerHTML = `<strong>üí° Perch√© √® importante:</strong><br>${data.response}`;
                
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'ü§ñ Genera Spiegazione AI';
            }
        }

        function renderGlossary() {
            const study = getCurrentStudy();
            if (!study) { document.getElementById('contentArea').innerHTML = '<p>Nessuno studio selezionato</p>'; return; }

            let html = '<div class="card"><h2>üìñ Glossario</h2>';
            html += '<input type="text" class="search-box" id="glossarySearch" placeholder="üîç Cerca un termine..." onkeyup="filterGlossary()">';
            
            if (!study.data.glossary || study.data.glossary.length === 0) {
                html += '<p>Nessun termine nel glossario</p>';
            } else {
                study.data.glossary.forEach(item => {
                    html += `
                        <div class="glossary-item">
                            <div class="glossary-term">${item.term}</div>
                            <div>${item.definition}</div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        function filterGlossary() {
            const searchTerm = document.getElementById('glossarySearch').value.toLowerCase();
            const items = document.querySelectorAll('.glossary-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function renderTimeline() {
            const study = getCurrentStudy();
            if (!study) { document.getElementById('contentArea').innerHTML = '<p>Nessuno studio selezionato</p>'; return; }

            let html = '<div class="card"><h2>üìÖ Timeline</h2>';
            
            if (!study.data.timeline || study.data.timeline.length === 0) {
                html += '<p>Nessun evento in timeline</p>';
            } else {
                study.data.timeline.forEach(event => {
                    html += `
                        <div class="timeline-item">
                            <div class="timeline-date">${event.date}</div>
                            <div>${event.description}</div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        function renderFlashcardsAdvanced() {
            const study = getCurrentStudy();
            if (!study || !study.data.flashcards || study.data.flashcards.length === 0) {
                document.getElementById('contentArea').innerHTML = '<div class="card"><p>Nessuna flashcard disponibile</p></div>';
                return;
            }

            const filtered = filterFlashcardsByMode(study.data.flashcards);
            if (filtered.length === 0) {
                document.getElementById('contentArea').innerHTML = '<div class="card"><p>Nessuna flashcard con questa difficolt√†</p></div>';
                return;
            }

            const currentCard = filtered[appState.currentFlashcardFiltered];
            const currentCardId = `${study.id}_${currentCard.q}`;
            const stats = flashcardStats[currentCardId] || { difficulty: 'medium', views: 0, correct: 0 };

            let html = `
                <div class="card">
                    <h2>üé¥ Flashcard (${appState.currentFlashcardFiltered + 1}/${filtered.length})</h2>
                    
                    <div style="margin: 20px 0; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn ${appState.flashcardMode === 'all' ? 'active' : ''}" onclick="changeFlashcardMode('all')">Tutte</button>
                        <button class="btn ${appState.flashcardMode === 'easy' ? 'active' : ''}" onclick="changeFlashcardMode('easy')">üü¢ Facili</button>
                        <button class="btn ${appState.flashcardMode === 'medium' ? 'active' : ''}" onclick="changeFlashcardMode('medium')">üü† Medie</button>
                        <button class="btn ${appState.flashcardMode === 'difficult' ? 'active' : ''}" onclick="changeFlashcardMode('difficult')">üî¥ Difficili</button>
                    </div>

                    <div class="flashcard-container">
                        <div class="flashcard" id="flashcardInner">
                            <div class="flashcard-face flashcard-front">
                                <div style="font-size: 1.4em; font-weight: bold; margin-bottom: 20px;">üìå Domanda</div>
                                <div>${currentCard.q}</div>
                            </div>
                            <div class="flashcard-face flashcard-back">
                                <div style="font-size: 1.4em; font-weight: bold; margin-bottom: 20px;">‚úÖ Risposta</div>
                                <div>${currentCard.a}</div>
                                
                                ${currentCard.explanation ? `
                                    <div class="flashcard-extra">
                                        <div class="flashcard-extra-title">üí° Spiegazione Semplice:</div>
                                        <div>${currentCard.explanation}</div>
                                    </div>
                                ` : ''}
                                
                                ${currentCard.example ? `
                                    <div class="flashcard-extra">
                                        <div class="flashcard-extra-title">üìö Esempio Pratico:</div>
                                        <div>${currentCard.example}</div>
                                    </div>
                                ` : ''}
                                
                                ${currentCard.essay ? `
                                    <div class="flashcard-extra">
                                        <div class="flashcard-extra-title">‚úèÔ∏è Domanda per Saggio:</div>
                                        <div>${currentCard.essay}</div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;" onclick="event.stopPropagation()">
                                ${!currentCard.explanation ? `<button class="expand-btn" onclick="generateExplanation('${currentCardId}')">üí° Spiega Semplice</button>` : ''}
                                ${!currentCard.example ? `<button class="expand-btn" onclick="generateExample('${currentCardId}')">üìö Esempio</button>` : ''}
                                ${!currentCard.essay ? `<button class="expand-btn" onclick="generateEssay('${currentCardId}')">‚úèÔ∏è Domanda Saggio</button>` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="controls">
                        <button class="btn" onclick="prevFlashcard()">‚¨ÖÔ∏è Precedente</button>
                        <button class="btn" onclick="flipCard()">üîÑ Gira</button>
                        <button class="btn" onclick="nextFlashcard()">Successiva ‚û°Ô∏è</button>
                    </div>

                    <div class="controls" style="margin-top: 20px;">
                        <button class="btn" style="background: #4caf50;" onclick="markDifficulty('easy')">üü¢ Facile</button>
                        <button class="btn" style="background: #ffa726;" onclick="markDifficulty('medium')">üü† Medio</button>
                        <button class="btn" style="background: #f44336;" onclick="markDifficulty('difficult')">üî¥ Difficile</button>
                    </div>

                    <div class="note-section">
                        <strong>üìù Note Personali:</strong>
                        <textarea class="note-input" id="flashcardNote" rows="3" placeholder="Aggiungi note per questa flashcard...">${appState.notes[currentCardId] || ''}</textarea>
                        <button class="btn" onclick="saveFlashcardNote('${currentCardId}')" style="margin-top: 10px;">üíæ Salva Nota</button>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <strong>üìä Statistiche:</strong> Visualizzata ${stats.views} volte | Difficolt√†: ${stats.difficulty === 'easy' ? 'üü¢ Facile' : stats.difficulty === 'medium' ? 'üü† Medio' : 'üî¥ Difficile'}
                    </div>
                </div>
            `;

            document.getElementById('contentArea').innerHTML = html;
            updateFlashcardStats(currentCardId);
        }

        function filterFlashcardsByMode(flashcards) {
            if (appState.flashcardMode === 'all') return flashcards;
            
            const study = getCurrentStudy();
            return flashcards.filter(card => {
                const cardId = `${study.id}_${card.q}`;
                const stats = flashcardStats[cardId] || { difficulty: 'medium' };
                return stats.difficulty === appState.flashcardMode;
            });
        }

        function changeFlashcardMode(mode) {
            appState.flashcardMode = mode;
            appState.currentFlashcardFiltered = 0;
            renderFlashcardsAdvanced();
        }

        function flipCard() {
            document.getElementById('flashcardInner').classList.toggle('flipped');
        }

        function nextFlashcard() {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            appState.currentFlashcardFiltered = (appState.currentFlashcardFiltered + 1) % filtered.length;
            renderFlashcardsAdvanced();
        }

        function prevFlashcard() {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            appState.currentFlashcardFiltered = appState.currentFlashcardFiltered === 0 ? filtered.length - 1 : appState.currentFlashcardFiltered - 1;
            renderFlashcardsAdvanced();
        }

        function markDifficulty(difficulty) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            const cardId = `${study.id}_${currentCard.q}`;
            
            if (!flashcardStats[cardId]) flashcardStats[cardId] = { difficulty: 'medium', views: 0, correct: 0 };
            flashcardStats[cardId].difficulty = difficulty;
            
            localStorage.setItem('flashcardStats', JSON.stringify(flashcardStats));
            renderFlashcardsAdvanced();
        }

        function updateFlashcardStats(cardId) {
            if (!flashcardStats[cardId]) flashcardStats[cardId] = { difficulty: 'medium', views: 0, correct: 0 };
            flashcardStats[cardId].views++;
            localStorage.setItem('flashcardStats', JSON.stringify(flashcardStats));
        }

        function saveFlashcardNote(cardId) {
            const note = document.getElementById('flashcardNote').value;
            appState.notes[cardId] = note;
            localStorage.setItem('flashcardNotes', JSON.stringify(appState.notes));
            alert('‚úÖ Nota salvata!');
        }

        async function generateExplanation(cardId) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generazione...';
            
            try {
                const prompt = `Spiega in modo molto semplice (come a un bambino di 10 anni) questo concetto:\n\nDomanda: ${currentCard.q}\nRisposta: ${currentCard.a}\n\nFornisci una spiegazione chiara, breve (max 3 frasi) e con esempi quotidiani.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore generazione');
                
                const data = await response.json();
                currentCard.explanation = data.response;
                
                saveStudies();
                renderFlashcardsAdvanced();
                
                setTimeout(() => {
                    document.getElementById('flashcardInner').classList.add('flipped');
                }, 100);
                
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üí° Spiega Semplice';
            }
        }
        
        async function generateExample(cardId) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generazione...';
            
            try {
                const prompt = `Fornisci un esempio pratico e concreto per questo concetto:\n\nDomanda: ${currentCard.q}\nRisposta: ${currentCard.a}\n\nDai un esempio reale dalla vita quotidiana o dalla materia ${study.subject}. Max 3 frasi.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore generazione');
                
                const data = await response.json();
                currentCard.example = data.response;
                
                saveStudies();
                renderFlashcardsAdvanced();
                
                setTimeout(() => {
                    document.getElementById('flashcardInner').classList.add('flipped');
                }, 100);
                
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üìö Esempio';
            }
        }
        
        async function generateEssay(cardId) {
            const study = getCurrentStudy();
            const filtered = filterFlashcardsByMode(study.data.flashcards);
            const currentCard = filtered[appState.currentFlashcardFiltered];
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generazione...';
            
            try {
                const prompt = `Genera una domanda per un saggio/tema basata su questo concetto:\n\nDomanda: ${currentCard.q}\nRisposta: ${currentCard.a}\n\nLa domanda deve essere aperta, stimolare la riflessione critica, e richiedere una risposta articolata. Max 2 frasi.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore generazione');
                
                const data = await response.json();
                currentCard.essay = data.response;
                
                saveStudies();
                renderFlashcardsAdvanced();
                
                setTimeout(() => {
                    document.getElementById('flashcardInner').classList.add('flipped');
                }, 100);
                
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
                btn.disabled = false;
                btn.textContent = '‚úèÔ∏è Domanda Saggio';
            }
        }

        function renderQuizAdvanced() {
            const study = getCurrentStudy();
            if (!study || !study.data.quiz || study.data.quiz.length === 0) {
                document.getElementById('contentArea').innerHTML = '<div class="card"><p>Nessun quiz disponibile</p></div>';
                return;
            }

            const filtered = filterQuizByMode(study.data.quiz);
            if (filtered.length === 0) {
                document.getElementById('contentArea').innerHTML = '<div class="card"><p>Nessun quiz con questa difficolt√†</p></div>';
                return;
            }

            const currentQuiz = filtered[appState.currentQuizFiltered];

            let html = `
                <div class="card">
                    <h2>‚ùì Quiz (${appState.currentQuizFiltered + 1}/${filtered.length})</h2>
                    
                    ${appState.quizTimerEnabled ? `
                        <div class="timer-display ${appState.quizTimeRemaining < 10 ? 'warning' : ''}">
                            ‚è±Ô∏è Tempo rimanente: ${appState.quizTimeRemaining}s
                        </div>
                    ` : ''}
                    
                    <div style="margin: 20px 0;">
                        <strong>${currentQuiz.q}</strong>
                    </div>
                    
                    <div>
                        ${currentQuiz.options.map((option, i) => `
                            <div class="quiz-option" onclick="selectQuizOption(${i})" id="quizOption${i}">
                                ${String.fromCharCode(65 + i)}. ${option}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="controls">
                        <button class="btn" onclick="submitQuizAnswer()">‚úÖ Conferma Risposta</button>
                        <button class="btn" onclick="nextQuizQuestion()">Prossima Domanda ‚û°Ô∏è</button>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <strong>üìä Punteggio Attuale:</strong> ${appState.quizScore} / ${appState.currentQuizFiltered}
                    </div>
                </div>
            `;

            document.getElementById('contentArea').innerHTML = html;
        }

        function filterQuizByMode(quiz) {
            return quiz; // Placeholder per filtro difficolt√† quiz
        }

        function selectQuizOption(optionIndex) {
            document.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById(`quizOption${optionIndex}`).classList.add('selected');
            appState.quizSelectedOption = optionIndex;
        }

        function submitQuizAnswer() {
            const study = getCurrentStudy();
            const filtered = filterQuizByMode(study.data.quiz);
            const currentQuiz = filtered[appState.currentQuizFiltered];
            
            if (appState.quizSelectedOption === undefined) {
                alert('Seleziona una risposta!');
                return;
            }
            
            const isCorrect = appState.quizSelectedOption === currentQuiz.correct;
            
            if (isCorrect) {
                appState.quizScore++;
                document.getElementById(`quizOption${appState.quizSelectedOption}`).classList.add('correct');
            } else {
                document.getElementById(`quizOption${appState.quizSelectedOption}`).classList.add('incorrect');
                document.getElementById(`quizOption${currentQuiz.correct}`).classList.add('correct');
            }
            
            appState.quizAnswers.push({
                question: currentQuiz.q,
                selected: appState.quizSelectedOption,
                correct: currentQuiz.correct,
                isCorrect: isCorrect
            });
            
            alert(isCorrect ? '‚úÖ Corretto!' : '‚ùå Sbagliato!');
        }

        function nextQuizQuestion() {
            const study = getCurrentStudy();
            const filtered = filterQuizByMode(study.data.quiz);
            
            appState.quizSelectedOption = undefined;
            appState.currentQuizFiltered++;
            
            if (appState.currentQuizFiltered >= filtered.length) {
                showQuizResults();
            } else {
                renderQuizAdvanced();
            }
        }

        function showQuizResults() {
            const study = getCurrentStudy();
            const percentage = Math.round((appState.quizScore / appState.quizAnswers.length) * 100);
            
            let html = `
                <div class="card">
                    <h2>üéâ Quiz Completato!</h2>
                    <div style="text-align: center; padding: 40px 0;">
                        <div style="font-size: 3em; margin-bottom: 20px;">
                            ${percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'üëç' : 'üìö'}
                        </div>
                        <h3 style="font-size: 2em; color: var(--primary);">${appState.quizScore} / ${appState.quizAnswers.length}</h3>
                        <p style="font-size: 1.5em; margin-top: 10px;">${percentage}% Corretto</p>
                        <p style="margin-top: 20px; color: #666;">
                            ${percentage >= 80 ? 'Eccellente! Hai una grande padronanza del materiale! üéä' : 
                              percentage >= 60 ? 'Buon lavoro! Continua cos√¨! üí™' : 
                              'Continua a studiare, ce la farai! üìñ'}
                        </p>
                    </div>
                    
                    <h3>üìã Revisione Risposte:</h3>
                    ${appState.quizAnswers.map((answer, i) => `
                        <div class="review-item ${answer.isCorrect ? 'correct' : 'wrong'}">
                            <strong>Domanda ${i + 1}:</strong> ${answer.question}<br>
                            <strong>Tua risposta:</strong> ${answer.isCorrect ? '‚úÖ Corretta' : '‚ùå Sbagliata'}<br>
                            ${!answer.isCorrect ? `<strong>Risposta corretta:</strong> Opzione ${String.fromCharCode(65 + answer.correct)}` : ''}
                        </div>
                    `).join('')}
                    
                    <div class="controls">
                        <button class="btn" onclick="restartQuiz()">üîÑ Riprova Quiz</button>
                        <button class="btn" onclick="backToHome()">‚Üê Torna alla Home</button>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function restartQuiz() {
            appState.currentQuizFiltered = 0;
            appState.quizScore = 0;
            appState.quizAnswers = [];
            appState.quizSelectedOption = undefined;
            renderQuizAdvanced();
        }

        function renderMindMap() {
            const study = getCurrentStudy();
            if (!study) { document.getElementById('contentArea').innerHTML = '<p>Nessuno studio selezionato</p>'; return; }

            let html = '<div class="card"><h2>üß† Mappa Mentale</h2>';
            html += '<div class="mindmap-container"><div class="mindmap-tree">';
            
            if (!study.data.mindmap || !study.data.mindmap.root) {
                html += '<p>Nessuna mappa mentale disponibile</p>';
            } else {
                html += `<div class="mindmap-root">üìå ${study.data.mindmap.root}</div>`;
                
                if (study.data.mindmap.branches && study.data.mindmap.branches.length > 0) {
                    study.data.mindmap.branches.forEach(branch => {
                        html += `<div class="mindmap-node"><span class="mindmap-branch">‚îú‚îÄ ${branch.name}</span>`;
                        if (branch.items && branch.items.length > 0) {
                            branch.items.forEach((item, i) => {
                                const isLast = i === branch.items.length - 1;
                                html += `<div class="mindmap-node"><span class="mindmap-leaf">${isLast ? '‚îî‚îÄ' : '‚îú‚îÄ'} ${item}</span></div>`;
                            });
                        }
                        html += '</div>';
                    });
                }
            }
            
            html += '</div></div></div>';
            document.getElementById('contentArea').innerHTML = html;
        }

        function renderChat() {
            const study = getCurrentStudy();
            if (!study) { document.getElementById('contentArea').innerHTML = '<p>Nessuno studio selezionato</p>'; return; }

            const chatId = `chat_${study.id}`;
            const messages = appState.chatHistory[chatId] || [];

            let html = `
                <div class="card">
                    <h2>üí¨ Chat AI - ${study.name}</h2>
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            ${messages.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: #999;">
                                    <div style="font-size: 3em; margin-bottom: 15px;">ü§ñ</div>
                                    <p>Ciao! Sono qui per aiutarti a studiare "${study.name}"</p>
                                    <p style="margin-top: 10px;">Fai una domanda sul materiale!</p>
                                </div>
                            ` : messages.map(msg => `
                                <div class="chat-message ${msg.role}">
                                    <div class="chat-avatar">${msg.role === 'user' ? 'üë§' : 'ü§ñ'}</div>
                                    <div class="chat-bubble">${msg.content}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="chat-input-container">
                            <textarea class="chat-input" id="chatInput" rows="2" placeholder="Scrivi la tua domanda..."></textarea>
                            <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">üì§ Invia</button>
                        </div>
                    </div>
                    
                    <div class="chat-suggested-questions">
                        <strong style="display: block; margin-bottom: 10px;">üí° Domande suggerite:</strong>
                        <span class="suggested-question" onclick="askSuggestedQuestion('Riassumi i punti principali')">Riassumi i punti principali</span>
                        <span class="suggested-question" onclick="askSuggestedQuestion('Quali sono i concetti chiave?')">Quali sono i concetti chiave?</span>
                        <span class="suggested-question" onclick="askSuggestedQuestion('Fammi delle domande per verificare la comprensione')">Verifica la mia comprensione</span>
                    </div>
                </div>
            `;

            document.getElementById('contentArea').innerHTML = html;
            
            // Scroll to bottom
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        function askSuggestedQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendChatMessage();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const study = getCurrentStudy();
            const chatId = `chat_${study.id}`;
            
            if (!appState.chatHistory[chatId]) {
                appState.chatHistory[chatId] = [];
            }
            
            // Add user message
            appState.chatHistory[chatId].push({
                role: 'user',
                content: message
            });
            
            input.value = '';
            input.disabled = true;
            document.getElementById('chatSendBtn').disabled = true;
            document.getElementById('chatSendBtn').textContent = '‚è≥ Pensando...';
            
            renderChat();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        context: study.rawText || study.data.summary_long,
                        conversationHistory: appState.chatHistory[chatId].slice(-6)
                    })
                });
                
                if (!response.ok) throw new Error('Errore API');
                
                const data = await response.json();
                
                appState.chatHistory[chatId].push({
                    role: 'ai',
                    content: data.response
                });
                
                localStorage.setItem('chatHistory', JSON.stringify(appState.chatHistory));
                
            } catch (error) {
                console.error('Errore chat:', error);
                appState.chatHistory[chatId].push({
                    role: 'ai',
                    content: '‚ùå Mi dispiace, ho avuto un problema. Riprova!'
                });
            }
            
            input.disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
            document.getElementById('chatSendBtn').textContent = 'üì§ Invia';
            
            renderChat();
        }

        function renderStudyGuide() {
            const study = getCurrentStudy();
            if (!study) { document.getElementById('contentArea').innerHTML = '<p>Nessuno studio selezionato</p>'; return; }

            let html = `
                <div class="card">
                    <h2>üìò Guida di Studio</h2>
                    <p style="margin-bottom: 20px;">Una guida completa per studiare efficacemente questo materiale</p>
                    
                    <h3>üéØ Obiettivi di Apprendimento</h3>
                    <div class="result-box">
                        Dopo aver studiato questo materiale, dovresti essere in grado di:
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>Comprendere i concetti principali</li>
                            <li>Applicare le conoscenze acquisite</li>
                            <li>Analizzare e valutare le informazioni</li>
                        </ul>
                    </div>
                    
                    <h3>üìö Strategia di Studio Consigliata</h3>
                    <div class="result-box">
                        1. <strong>Lettura attiva:</strong> Leggi il riassunto e prendi appunti<br>
                        2. <strong>Flashcard:</strong> Usa le flashcard per memorizzare i concetti chiave<br>
                        3. <strong>Quiz:</strong> Testa la tua comprensione con i quiz<br>
                        4. <strong>Chat AI:</strong> Fai domande per approfondire<br>
                        5. <strong>Ripasso:</strong> Rivedi regolarmente il materiale
                    </div>
                    
                    <h3>‚è∞ Piano di Studio Suggerito</h3>
                    <div class="result-box">
                        <strong>Sessione 1 (30 min):</strong> Lettura riassunto e punti salienti<br>
                        <strong>Sessione 2 (45 min):</strong> Flashcard e memorizzazione<br>
                        <strong>Sessione 3 (30 min):</strong> Quiz e verifica comprensione<br>
                        <strong>Sessione 4 (20 min):</strong> Ripasso generale
                    </div>
                </div>
            `;

            document.getElementById('contentArea').innerHTML = html;
        }

        function renderConceptAnalysis() {
            let html = `
                <div class="card">
                    <h2>üîç Analisi Concetto</h2>
                    <p style="margin-bottom: 20px;">Analizza in profondit√† un concetto specifico del materiale</p>
                    
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">üìù Quale concetto vuoi analizzare?</label>
                    <input type="text" id="conceptInput" class="search-box" placeholder="Es: La Legge 104, I diritti delle persone con disabilit√†..." style="margin-bottom: 15px;">
                    
                    <button class="btn" onclick="analyzeConcept()">üîç Analizza Concetto</button>
                    
                    <div id="conceptResult" style="margin-top: 20px;"></div>
                </div>
            `;

            document.getElementById('contentArea').innerHTML = html;
        }

        async function analyzeConcept() {
            const concept = document.getElementById('conceptInput').value.trim();
            if (!concept) {
                alert('Inserisci un concetto da analizzare');
                return;
            }
            
            const study = getCurrentStudy();
            if (!study) return;
            
            const resultDiv = document.getElementById('conceptResult');
            resultDiv.innerHTML = '<div class="result-box">‚è≥ Sto analizzando il concetto...</div>';
            
            try {
                const prompt = `Analizza in profondit√† il concetto "${concept}" basandoti su questo materiale:\n\n${study.data.summary_long}\n\nFornisci:\n1. Definizione chiara\n2. Contesto e importanza\n3. Applicazioni pratiche\n4. Collegamenti con altri concetti\n5. Punti critici da ricordare`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore API');
                
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="result-box">
                        <h3>üìä Analisi di: ${concept}</h3>
                        <div style="margin-top: 15px;">${data.response.replace(/\n/g, '<br>')}</div>
                    </div>
                    <div class="export-buttons">
                        <button class="btn" onclick="exportAnalysisPDF()">üì• Esporta PDF</button>
                        <button class="btn" onclick="saveAnalysisToHistory()">üíæ Salva</button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Errore:', error);
                resultDiv.innerHTML = '<div class="result-box">‚ùå Errore durante l\'analisi. Riprova!</div>';
            }
        }

        function renderCustomFormat() {
            let html = `
                <div class="card">
                    <h2>‚ú® Crea il Tuo Formato</h2>
                    <p style="margin-bottom: 20px;">Genera materiali di studio personalizzati nel formato che preferisci</p>
                    
                    <h3>üìã Scegli un Template</h3>
                    <div style="margin: 20px 0;">
                        <div class="template-card" onclick="selectTemplate('schema')">
                            <div class="template-name">üìä Schema Riassuntivo</div>
                            <div class="template-description">Crea uno schema strutturato con i punti principali</div>
                        </div>
                        <div class="template-card" onclick="selectTemplate('domande')">
                            <div class="template-name">‚ùì Lista Domande</div>
                            <div class="template-description">Genera domande di studio per l'autovalutazione</div>
                        </div>
                        <div class="template-card" onclick="selectTemplate('confronto')">
                            <div class="template-name">‚öñÔ∏è Tabella Comparativa</div>
                            <div class="template-description">Confronta concetti simili in una tabella</div>
                        </div>
                        <div class="template-card" onclick="selectTemplate('appunti')">
                            <div class="template-name">üìù Appunti Strutturati</div>
                            <div class="template-description">Organizza le informazioni in appunti dettagliati</div>
                        </div>
                    </div>
                    
                    <h3>üé® O Crea il Tuo Formato Personalizzato</h3>
                    <textarea id="customFormatInput" class="note-input" rows="4" placeholder="Descrivi il formato che vuoi creare... Es: 'Crea una lista di concetti chiave con definizioni brevi e esempi pratici per ciascuno'"></textarea>
                    <button class="btn" onclick="generateCustomFormat()" style="margin-top: 10px;">‚ú® Genera Formato</button>
                    
                    <div id="customFormatResult" style="margin-top: 20px;"></div>
                    
                    ${customFormatHistory.length > 0 ? `
                        <h3 style="margin-top: 30px;">üìö Storico Formati Creati</h3>
                        ${customFormatHistory.map((item, index) => `
                            <div class="history-item" onclick="loadCustomFormat(${index})">
                                <strong>${item.type}</strong>
                                <div class="history-meta">Creato il ${item.date}</div>
                            </div>
                        `).join('')}
                    ` : ''}
                </div>
            `;

            document.getElementById('contentArea').innerHTML = html;
        }

        function selectTemplate(templateType) {
            const templates = {
                'schema': 'Crea uno schema riassuntivo strutturato con i punti principali organizzati gerarchicamente. Usa bullet points e sotto-punti per una visualizzazione chiara.',
                'domande': 'Genera una lista di 15 domande di studio progressive (da facili a difficili) per l\'autovalutazione, con brevi suggerimenti per le risposte.',
                'confronto': 'Crea una tabella comparativa che mette a confronto i concetti principali, evidenziando similitudini e differenze in colonne chiare.',
                'appunti': 'Organizza le informazioni in appunti strutturati in stile Cornell: colonna sinistra per concetti chiave, colonna destra per dettagli, e spazio in basso per riassunto.'
            };
            
            document.getElementById('customFormatInput').value = templates[templateType];
        }

        async function generateCustomFormat() {
            const formatRequest = document.getElementById('customFormatInput').value.trim();
            if (!formatRequest) {
                alert('Descrivi il formato che vuoi creare');
                return;
            }
            
            const study = getCurrentStudy();
            if (!study) return;
            
            const resultDiv = document.getElementById('customFormatResult');
            resultDiv.innerHTML = '<div class="result-box">‚è≥ Sto generando il formato personalizzato...</div>';
            
            try {
                const prompt = `Basandoti su questo materiale:\n\n${study.data.summary_long}\n\nCrea il seguente formato personalizzato:\n${formatRequest}\n\nFormatta il risultato in modo chiaro e strutturato.`;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        conversationHistory: []
                    })
                });
                
                if (!response.ok) throw new Error('Errore API');
                
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="result-box">
                        <h3>‚ú® Formato Personalizzato</h3>
                        <div style="margin-top: 15px;">${data.response.replace(/\n/g, '<br>')}</div>
                    </div>
                    <div class="export-buttons">
                        <button class="btn" onclick="exportCustomFormatPDF()">üì• Esporta PDF</button>
                        <button class="btn" onclick="saveCustomFormat()">üíæ Salva nello Storico</button>
                        <button class="btn" onclick="copyCustomFormat()">üìã Copia</button>
                    </div>
                `;
                
                // Save to history
                customFormatHistory.unshift({
                    type: formatRequest.substring(0, 50) + (formatRequest.length > 50 ? '...' : ''),
                    content: data.response,
                    date: new Date().toLocaleDateString('it-IT')
                });
                
                if (customFormatHistory.length > 10) {
                    customFormatHistory = customFormatHistory.slice(0, 10);
                }
                
                localStorage.setItem('customFormatHistory', JSON.stringify(customFormatHistory));
                
            } catch (error) {
                console.error('Errore:', error);
                resultDiv.innerHTML = '<div class="result-box">‚ùå Errore durante la generazione. Riprova!</div>';
            }
        }

        function loadCustomFormat(index) {
            const item = customFormatHistory[index];
            document.getElementById('customFormatResult').innerHTML = `
                <div class="result-box">
                    <h3>‚ú® Formato Personalizzato</h3>
                    <div style="margin-top: 15px;">${item.content.replace(/\n/g, '<br>')}</div>
                </div>
                <div class="export-buttons">
                    <button class="btn" onclick="exportCustomFormatPDF()">üì• Esporta PDF</button>
                    <button class="btn" onclick="copyCustomFormat()">üìã Copia</button>
                </div>
            `;
        }

        function copyCustomFormat() {
            const content = document.querySelector('#customFormatResult .result-box').innerText;
            navigator.clipboard.writeText(content);
            alert('‚úÖ Contenuto copiato negli appunti!');
        }

        function resetApp() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('newHomeScreen').classList.add('hidden');
            document.getElementById('functionContentArea').classList.add('hidden');
        }

        // Initialize
        if (Object.keys(appState.studies).length > 0) {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('newHomeScreen').classList.remove('hidden');
        }
    </script>
</body>
</html>
